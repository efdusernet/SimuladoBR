<!-- Password verification modal for accessing settings -->
<div id="settingsPasswordModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 9999; background: rgba(0,0,0,0.6); align-items: center; justify-content: center;">
  <div style="background: white; border-radius: 12px; padding: 24px; max-width: 400px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
    <h2 style="margin: 0 0 12px; font-size: 1.3rem; color: #1e293b;">ðŸ”’ VerificaÃ§Ã£o de SeguranÃ§a</h2>
    <p style="color: #64748b; font-size: 0.9rem; margin: 0 0 20px;">Para acessar ConfiguraÃ§Ãµes, confirme sua senha atual:</p>
    
    <div id="settingsPasswordAlert" style="margin-bottom: 12px;"></div>
    
    <form id="settingsPasswordForm">
      <div style="margin-bottom: 16px;">
        <label for="settingsPasswordInput" style="display: block; font-weight: 600; margin-bottom: 6px; color: #475569; font-size: 0.9rem;">Senha Atual</label>
        <input type="password" id="settingsPasswordInput" placeholder="Digite sua senha" style="width: 100%; padding: 10px 12px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.95rem; box-sizing: border-box;" autofocus />
      </div>
      
      <div style="display: flex; gap: 8px; justify-content: flex-end;">
        <button type="button" id="settingsPasswordCancel" style="padding: 10px 20px; border: 1px solid #cbd5e1; border-radius: 6px; background: white; color: #64748b; font-weight: 600; cursor: pointer; font-size: 0.9rem;">Cancelar</button>
        <button type="submit" id="settingsPasswordConfirm" style="padding: 10px 20px; border: none; border-radius: 6px; background: #3b82f6; color: white; font-weight: 600; cursor: pointer; font-size: 0.9rem;">Confirmar</button>
      </div>
    </form>
  </div>
</div>

<script>
(function() {
  const modal = document.getElementById('settingsPasswordModal');
  const form = document.getElementById('settingsPasswordForm');
  const input = document.getElementById('settingsPasswordInput');
  const alertDiv = document.getElementById('settingsPasswordAlert');
  const cancelBtn = document.getElementById('settingsPasswordCancel');
  const confirmBtn = document.getElementById('settingsPasswordConfirm');
  
  let resolveCallback = null;
  let rejectCallback = null;
  
  function showAlert(message, type = 'error') {
    alertDiv.innerHTML = `<div style="padding: 10px 12px; border-radius: 6px; font-size: 0.85rem; background: ${type === 'error' ? '#fee2e2' : '#dbeafe'}; color: ${type === 'error' ? '#991b1b' : '#1e40af'}; border: 1px solid ${type === 'error' ? '#fca5a5' : '#93c5fd'};">${message}</div>`;
    setTimeout(() => { alertDiv.innerHTML = ''; }, 4000);
  }
  
  function openModal() {
    return new Promise((resolve, reject) => {
      resolveCallback = resolve;
      rejectCallback = reject;
      modal.style.display = 'flex';
      input.value = '';
      input.focus();
      alertDiv.innerHTML = '';
    });
  }
  
  function closeModal(success = false) {
    modal.style.display = 'none';
    input.value = '';
    alertDiv.innerHTML = '';
    if (success && resolveCallback) {
      resolveCallback();
    } else if (!success && rejectCallback) {
      rejectCallback();
    }
    resolveCallback = null;
    rejectCallback = null;
  }
  
  cancelBtn.addEventListener('click', () => closeModal(false));
  
  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal(false);
  });
  
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const password = input.value.trim();
    
    if (!password) {
      showAlert('Digite sua senha');
      return;
    }
    
    confirmBtn.disabled = true;
    confirmBtn.textContent = 'Verificando...';
    
    try {
      const token = localStorage.getItem('sessionToken') || '';
      const res = await fetch('/api/users/me/verify-password', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Session-Token': token
        },
        body: JSON.stringify({ password })
      });
      
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.message || 'Senha incorreta');
      }
      
      closeModal(true);
    } catch (error) {
      showAlert(error.message);
      input.value = '';
      input.focus();
    } finally {
      confirmBtn.disabled = false;
      confirmBtn.textContent = 'Confirmar';
    }
  });
  
  // Expose globally
  window.verifyPasswordForSettings = openModal;
})();
</script>
