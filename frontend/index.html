<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>SimuladosBR</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Simulados completos para certifica√ß√£o PMP com quest√µes reais e indicadores detalhados">
    <meta name="theme-color" content="#4f46e5">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SimuladosBR">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <!-- iOS/Apple Touch Icon -->
    <link rel="apple-touch-icon" sizes="192x192" href="/assets/icon-192.png">
    <!-- Standard Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="/assets/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/assets/icon-512.png">
    
    <!-- Layout Manager -->
    <script src="/utils/layoutManager.js"></script>
    <!-- Controlled Logging System (must load before other scripts) -->
    <script src="/utils/logger.js"></script>
    <script src="/utils/dicaDoDiaHello.js"></script>
    <script src="/utils/auth.js"></script>
    <!-- Logout Utility -->
    <script src="/utils/logout.js"></script>
    <!-- CSRF Protection -->
    <script src="/utils/csrf.js"></script>

    <!-- Support chat widget (premium-only + desktop-only) -->
    <script src="/utils/chatWidgetGate.js"></script>
    
    <!-- Layout Styles (loaded conditionally by layoutManager) -->
    <link rel="stylesheet" href="/layouts/mobile-layout.css">
    <link rel="stylesheet" href="/layouts/desktop-layout.css" media="(min-width: 768px)">
    <link rel="stylesheet" href="/layouts/fullscreen-layout.css">
    
    <style>
        :root{
            --bg: #0f172a;
            --panel: #111827;
            --text: #e5e7eb;
            --muted: #94a3b8;
            --primary: #4f46e5;
            --primary-press: #4338ca;
            --border: #1f2937;
            --shadow: 0 8px 20px rgba(0,0,0,.35);
        }
        *{ box-sizing: border-box }
        html, body{ height: 100% }
        body{
            margin: 0; padding: 0;
            display: flex; flex-direction: column; min-height: 100vh;
            background: radial-gradient(1200px 600px at 10% -10%, rgba(79,70,229,.35), transparent),
                        radial-gradient(900px 500px at 90% 10%, rgba(17,24,39,.7), transparent),
                        linear-gradient(180deg, #0b1020 0%, #0f172a 100%);
            color: #111827;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, 'Helvetica Neue', Arial, 'Apple Color Emoji','Segoe UI Emoji';
            touch-action: manipulation;
        }
        /* Force white text inside ov-grid component (including descendants) */
        .ov-grid, .ov-grid * { color:#fff !important; }
        /* === Card Grid (restored full styling with gradients) === */
        .content{
            flex:1 1 auto; overflow-y:auto; padding:10px 10px calc(env(safe-area-inset-bottom) + 20px) 10px;
            background: radial-gradient(1200px 600px at 10% -10%, rgba(79,70,229,.35), transparent),
                        radial-gradient(900px 500px at 90% 10%, rgba(17,24,39,.7), transparent),
                        linear-gradient(180deg, #0b1020 0%, #0f172a 100%);
        }
        .section{display:none}
        .section.active{display:block}
        .title{font-size:1.6rem; text-align:center; margin:4px 0 6px}
        .debug{font-size:0.9rem; color:var(--muted); text-align:center; margin:0 0 16px}
        .card-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; width:100%; max-width:320px; margin:0 auto; justify-items:center; }
        .card{
            background:#1e293b; border:1px solid rgba(255,255,255,0.06);
            width:60px; height:60px;
            display:flex; align-items:center; justify-content:center;
            border-radius:12px;
            box-shadow:
                0 2px 4px rgba(0,0,0,.22),
                0 6px 14px rgba(0,0,0,.32),
                0 12px 28px rgba(0,0,0,.38);
            cursor:pointer; transition: transform .18s ease, box-shadow .22s ease;
            padding:6px 8px; outline:none; color:#ffffff; font-weight:500;
            position:relative; overflow:hidden;
        }
        .card:hover{
            transform: scale(1.08);
            box-shadow:
                0 4px 6px rgba(0,0,0,.28),
                0 10px 20px rgba(0,0,0,.40),
                0 18px 36px rgba(0,0,0,.46);
        }
        .card:active{
            transform: scale(0.97);
            box-shadow:
                0 2px 3px rgba(0,0,0,.30),
                0 6px 12px rgba(0,0,0,.36);
        }
        .thumb{ width:28px !important; height:28px !important; border-radius:8px; object-fit:cover !important; display:block; margin:0 auto; }
        .card--simulador{ flex-direction:column; gap:6px; align-items:center; justify-content:center; overflow:hidden; display:flex; height:100%; }
        .card--simulador .thumb{ width:28px !important; height:28px !important; border-radius:6px; object-fit:cover !important; display:block; margin:0 auto; }
        .card-label{ font-size:.70rem; line-height:1.1; user-select:none }
        @media (min-width:480px){
            .card{ width:72px; height:72px; padding:8px }
            .thumb{ width:34px !important; height:34px !important; }
            .card--simulador .thumb{ width:34px !important; height:34px !important; }
            .card--simulador{ gap:8px }
            .card-label{ font-size:.80rem }
            .card-grid{ max-width:360px }
        }
        @media (min-width:768px){
            .card-grid{ grid-template-columns: 1fr 1fr 1fr 1fr; max-width:480px }
        }
        @media (min-width:480px){
            .card-grid{ grid-template-columns: 1fr 1fr 1fr; max-width:360px }
        }
        /* Gradient palette for first six cards */
        .card-grid .card:nth-child(1){background:linear-gradient(135deg,#6366f1,#4338ca);}
        .card-grid .card:nth-child(2){background:linear-gradient(135deg,#0ea5e9,#0369a1);}
        .card-grid .card:nth-child(3){background:linear-gradient(135deg,#ec4899,#be185d);}
        .card-grid .card:nth-child(4){background:linear-gradient(135deg,#10b981,#047857);}
        .card-grid .card:nth-child(5){background:linear-gradient(135deg,#f59e0b,#b45309);}
        .card-grid .card:nth-child(6){background:linear-gradient(135deg,#8b5cf6,#6d28d9);}
        .card-grid .card::after{content:""; position:absolute; inset:0; background:linear-gradient(to bottom,rgba(0,0,0,0.12),rgba(0,0,0,0.35)); mix-blend-mode:overlay; pointer-events:none;}
        
        /* Cards espec√≠ficos com degrad√™ cinza */
        #card-exam-mock,
        #card-indicadores,
        #card-progresso-geral,
        #card-insights-ia,
        .card[aria-label="Simulador"],
        .card[aria-label="Dica do dia"],
        .card[aria-label="Estou pronto?"] {
            background: linear-gradient(135deg, #e8e8e8, #c0c0c0) !important;
            position: relative;
        }
        
        /* Efeito brilhante sutil ao passar o mouse */
        #card-exam-mock::before,
        #card-indicadores::before,
        #card-progresso-geral::before,
        #card-insights-ia::before,
        .card[aria-label="Simulador"]::before,
        .card[aria-label="Dica do dia"]::before,
        .card[aria-label="Estou pronto?"]::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.5),
                transparent
            );
            transition: left 0.6s ease;
            z-index: 1;
        }
        
        #card-exam-mock:hover::before,
        #card-indicadores:hover::before,
        #card-progresso-geral:hover::before,
        #card-insights-ia:hover::before,
        .card[aria-label="Simulador"]:hover::before,
        .card[aria-label="Dica do dia"]:hover::before,
        .card[aria-label="Estou pronto?"]:hover::before {
            left: 100%;
        }
        
        /* Labels desses cards em cor escura sem negrito */
        #card-exam-mock .card-label,
        #card-indicadores .card-label,
        #card-progresso-geral .card-label,
        #card-insights-ia .card-label,
        .card[aria-label="Simulador"] .card-label,
        .card[aria-label="Dica do dia"] .card-label,
        .card[aria-label="Estou pronto?"] .card-label {
            color: #111827 !important;
            font-weight: 400 !important;
            text-shadow: none !important;
            position: relative;
            z-index: 2;
        }
        
        /* Garantir que thumb tamb√©m fique acima do efeito */
        #card-exam-mock .thumb,
        #card-indicadores .thumb,
        #card-progresso-geral .thumb,
        #card-insights-ia .thumb,
        .card[aria-label="Simulador"] .thumb,
        .card[aria-label="Dica do dia"] .thumb,
        .card[aria-label="Estou pronto?"] .thumb {
            position: relative;
            z-index: 2;
        }
        
        /* Card labels and focus accessibility */
        .card-label{ color: #fff !important; text-shadow: 0 1px 2px rgba(0,0,0,.4) }
        .card--simulador .card-label{ font-size: .65rem !important }
        .card:focus-visible{ outline: 2px solid #fff; outline-offset: 3px }

        /* Bottom navigation bar */
        .bottom-nav{
            position: fixed; left: 0; right: 0; bottom: 0; height: 44px;
            background: var(--panel); border-top: 1px solid var(--border);
            display: flex; align-items: center; justify-content: center; z-index: 1000;
            gap: 14px;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item{
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0;
            min-width: 40px; min-height: 44px; padding: 1px 4px; border-radius: 8px; color: var(--muted);
            user-select: none; -webkit-tap-highlight-color: transparent; cursor: pointer; transition: color .15s ease, background .15s ease;
        }
        .nav-item.active{ color: var(--primary); background: rgba(79,70,229,0.08) }
        .nav-icon{ width: 16px; height: 16px; fill: currentColor; display: block }
        .nav-text{ display: none }

        @media (min-width: 640px){
            .bottom-nav{ height: 36px; gap: 12px }
            .nav-item{ min-height: 32px; min-width: 36px; padding: 1px 4px }
            .nav-icon{ width: 14px; height: 14px }
            .content{ padding-bottom: calc(env(safe-area-inset-bottom) + 40px) }
        }

        body.compact .bottom-nav{ height: 32px }
        body.compact .nav-item{ min-height: 32px; min-width: 32px; padding: 0 4px }
        body.compact .nav-icon{ width: 14px; height: 14px }
        body.compact .content{ padding-bottom: calc(env(safe-area-inset-bottom) + 36px) }

        /* Fullscreen overlay */
        .overlay{ position: fixed; inset: 0; background: #000; display: none; align-items: center; justify-content: center; z-index: 2000 }
        .overlay.active{ display: flex !important; }
        .overlay img{ max-width: 100vw; max-height: 100vh; object-fit: contain }
        .back-btn{
            position: fixed; top: 16px; left: 16px; width: 40px; height: 40px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.25);
            background: rgba(255,255,255,0.12); display: flex; align-items: center; justify-content: center; cursor: pointer; outline: none;
        }
        .back-btn svg{ width: 22px; height: 22px; fill: #fff }
        /* Force gradient background across body and main.content */
        html body{ 
            background: radial-gradient(1200px 600px at 10% -10%, rgba(79,70,229,.35), transparent),
                        radial-gradient(900px 500px at 90% 10%, rgba(17,24,39,.7), transparent),
                        linear-gradient(180deg, #0b1020 0%, #0f172a 100%) !important;
        }
        body > main.content{
            background: radial-gradient(1200px 600px at 10% -10%, rgba(79,70,229,.35), transparent),
                        radial-gradient(900px 500px at 90% 10%, rgba(17,24,39,.7), transparent),
                        linear-gradient(180deg, #0b1020 0%, #0f172a 100%) !important;
            color: #fff !important;
        }

        /* === Dica do dia modal === */
        .dica-modal{
            background: rgba(2,6,23,0.72) !important;
            z-index: 2147483647 !important;
            opacity: 1 !important;
            visibility: visible !important;
            pointer-events: auto !important;
            position: fixed !important;
            inset: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
        }
        .dica-card{
            width: min(720px, 92vw);
            background: linear-gradient(180deg, rgba(15,23,42,0.96), rgba(2,6,23,0.94));
            border-radius: 16px;
            position: relative;
            padding: 18px 18px 14px;
            box-shadow: 0 18px 60px rgba(0,0,0,0.55);
            color: var(--text);
        }
        .dica-card::before{
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 18px;
            background: linear-gradient(90deg, rgba(245,158,11,0.95), rgba(79,70,229,0.95), rgba(34,211,238,0.95));
            filter: drop-shadow(0 0 14px rgba(245,158,11,0.35));
            z-index: -1;
            opacity: 0.95;
        }
        .dica-header{ display:flex; align-items:center; justify-content:space-between; gap: 12px; margin-bottom: 10px; }
        .dica-title{ display:flex; align-items:center; gap:10px; font-weight: 800; letter-spacing: 0.2px; }
        .dica-title span{ font-size: 1.1rem; }
        .dica-bulb{
            width: 34px; height: 34px; border-radius: 12px;
            background: rgba(245,158,11,0.12);
            border: 1px solid rgba(245,158,11,0.28);
            display:flex; align-items:center; justify-content:center;
        }
        .dica-close{
            width: 36px; height: 36px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.16);
            background: rgba(255,255,255,0.06);
            color: rgba(255,255,255,0.86);
            cursor: pointer;
            font-size: 1.3rem;
            line-height: 1;
            display:flex; align-items:center; justify-content:center;
        }
        .dica-meta{ color: var(--muted); font-size: .82rem; margin: 2px 0 10px; }
        .dica-text{
            font-size: 1.02rem;
            line-height: 1.55;
            color: rgba(255,255,255,0.92);
            padding: 14px 14px;
            border-radius: 12px;
            background: rgba(15,23,42,0.55);
            border: 1px solid rgba(255,255,255,0.10);
            white-space: pre-wrap;
        }
        .dica-footer{ display:flex; gap: 10px; justify-content:flex-end; margin-top: 12px; flex-wrap: wrap; }
        .dica-btn{
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.16);
            background: rgba(255,255,255,0.06);
            color: rgba(255,255,255,0.92);
            cursor: pointer;
            font-weight: 800;
            font-size: .92rem;
        }
        .dica-btn.primary{
            border: none;
            background: linear-gradient(135deg, rgba(79,70,229,1), rgba(34,211,238,0.95));
            color: #06101f;
        }
        .dica-btn:disabled{ opacity: .65; cursor: not-allowed; }
    </style>
</head>
<body>
    <!-- Sidebar Mount (desktop only) -->
    <div id="sidebarMount" style="display: none;"></div>
    
    <!-- Modal de resultados de exames (aberto via card Hist√≥rico) -->
        <div id="examResultsModal" class="overlay" aria-hidden="true" style="display:none;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;">
            <div style="background:#fff;border-radius:12px;max-width:520px;width:92%;padding:16px;box-shadow:0 12px 40px rgba(0,0,0,0.35);color:#111827">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                    <h2 style="margin:0;font-size:1.2rem;">Hist√≥rico de exames</h2>
                    <button id="examResultsClose" type="button" aria-label="Fechar" style="background:none;border:none;font-size:1.6rem;color:#64748b;cursor:pointer;padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center">√ó</button>
                </div>
                <div style="display:grid;gap:10px;">
                    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
                        <div id="examHistoryListTitle" style="font-size:.9rem;color:#334155">Exames finalizados</div>
                        <select id="examHistoryStatusFilter" aria-label="Filtrar hist√≥rico" style="padding:6px 8px;border:1px solid #cbd5e1;border-radius:8px;background:#fff;color:#111827;font-size:.9rem;">
                            <option value="finished" selected>Finalizados</option>
                            <option value="unfinished">N√£o finalizados</option>
                        </select>
                    </div>
                    <div id="examList" style="display:flex;flex-direction:column;gap:8px;max-height:320px;overflow-y:auto"></div>
                </div>
            </div>
        </div>
    <!-- Auth guard: redirect to login if no session token -->
    <script>
    (function authGuard(){
        const token = (localStorage.getItem('sessionToken') || '').trim();
        if (!token) {
            // Redirecionar para login se n√£o houver token
            window.location.href = '/login.html';
            return;
        }
        
        // Fun√ß√£o para esconder spinner e prevenir loop
        function cleanupAfterReturn() {
            logger.info('[index.html] cleanupAfterReturn executado');
            
            // Marcar flag de retorno
            const wentToSetup = sessionStorage.getItem('wentToExamSetup') === 'true';
            if (wentToSetup) {
                logger.info('[index.html] Detectado retorno do examSetup');
                sessionStorage.setItem('justReturnedFromExamSetup', 'true');
                sessionStorage.removeItem('wentToExamSetup');
            }
            
            // SEMPRE esconder o spinner ao carregar index.html
            setTimeout(() => {
                const spinner = document.getElementById('redirectSpinner');
                if (spinner) {
                    spinner.remove(); // Remove completamente em vez de s√≥ esconder
                    logger.info('[index.html] Spinner removido');
                }
                
                // Fechar TODOS os modais/overlays que possam estar abertos
                const modalsToClose = [
                    'adminModal',
                    'examResultsModal',
                    'examSetupModal'
                ];
                
                modalsToClose.forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    if (modal) {
                        modal.classList.remove('active');
                        modal.setAttribute('aria-hidden', 'true');
                        modal.style.display = 'none';
                        logger.info('[index.html] Modal fechado:', modalId);
                    }
                });
                
                // Fechar qualquer overlay gen√©rico
                const overlays = document.querySelectorAll('.overlay.active');
                overlays.forEach(overlay => {
                    overlay.classList.remove('active');
                    overlay.setAttribute('aria-hidden', 'true');
                    overlay.style.display = 'none';
                    logger.info('[index.html] Overlay fechado');
                });
                
                // Restaurar scroll do body
                document.body.style.overflow = '';
            }, 0);
        }
        
        // Executar na carga
        cleanupAfterReturn();
        
        // Executar tamb√©m no pageshow (para detectar navega√ß√£o back/forward)
        window.addEventListener('pageshow', (event) => {
            logger.info('[index.html] pageshow event, persisted:', event.persisted);
            cleanupAfterReturn();
        });
    })();
    </script>
        <!-- Exam results modal logic (trigger via card Hist√≥rico) -->
        <script>
            (function(){
                const triggerCard = document.getElementById('card-historico');
                const modal = document.getElementById('examResultsModal');
                const closeBtn = document.getElementById('examResultsClose');
                const listEl = document.getElementById('examList');
                const filterEl = document.getElementById('examHistoryStatusFilter');
                const titleEl = document.getElementById('examHistoryListTitle');
                if (!modal || !closeBtn || !listEl) return;
                function open(){
                    modal.style.display='flex';
                    modal.setAttribute('aria-hidden','false');
                    try { closeBtn.focus(); } catch(_){}
                    // Prevent background interaction while modal is open
                    try { document.body.setAttribute('inert',''); } catch(_){}
                }
                function close(){
                    // Move focus away from elements that will become hidden
                    try {
                        if (document.activeElement && modal.contains(document.activeElement)) {
                            document.activeElement.blur();
                        }
                    } catch(_){ }
                    modal.style.display='none';
                    modal.setAttribute('aria-hidden','true');
                    // Restore background interaction
                    try { document.body.removeAttribute('inert'); } catch(_){}
                    // Return focus to trigger for accessibility
                    try { if (triggerCard) triggerCard.focus(); } catch(_){}
                }
                if (triggerCard) {
                    triggerCard.addEventListener('click', (e)=>{ try{ e.preventDefault(); e.stopPropagation(); if (e.stopImmediatePropagation) e.stopImmediatePropagation(); }catch(_){ } open(); loadHistory(); });
                }
                closeBtn.addEventListener('click', (e)=>{ e.preventDefault(); close(); });
                modal.addEventListener('click', (e)=>{ if (e.target === modal) close(); });

                if (filterEl) {
                    filterEl.addEventListener('change', ()=>{ loadHistory(); });
                }

                window.loadExamHistoryModal = loadHistory;

                function getHistoryStatus(){
                    const v = String((filterEl && filterEl.value) || 'finished').trim().toLowerCase();
                    return (v === 'unfinished' || v === 'finished') ? v : 'finished';
                }

                function updateHistoryTitle(status){
                    if (!titleEl) return;
                    titleEl.textContent = status === 'unfinished' ? 'Exames n√£o finalizados' : 'Exames finalizados';
                }

                async function isAdminForHistory(){
                    try {
                        if (window.__historyModalIsAdmin === true) return true;
                        if (window.__historyModalIsAdmin === false) return false;

                        const token = (localStorage.getItem('sessionToken') || '').trim();
                        const nomeUsuario = (localStorage.getItem('nomeUsuario') || '').trim();
                        const identity = (token || nomeUsuario || '').trim();
                        if (!identity) { window.__historyModalIsAdmin = false; return false; }

                        const jwtTok = (localStorage.getItem('jwtToken')||'').trim();
                        const jwtType = (localStorage.getItem('jwtTokenType')||'Bearer').trim()||'Bearer';

                        const headers = {};
                        headers['X-Session-Token'] = identity;
                        if (jwtTok) headers['Authorization'] = `${jwtType} ${jwtTok}`;

                        const probeUrl = `/api/admin/exams/probe?sessionToken=${encodeURIComponent(identity)}`;
                        const r = await fetch(probeUrl, { method: 'GET', headers, credentials: 'include' });
                        window.__historyModalIsAdmin = !!r.ok;
                        return window.__historyModalIsAdmin;
                    } catch(_){
                        window.__historyModalIsAdmin = false;
                        return false;
                    }
                }

                async function loadHistory(){
                    try {
                        const status = getHistoryStatus();
                        updateHistoryTitle(status);
                        const base = ((window.SIMULADOS_CONFIG && window.SIMULADOS_CONFIG.BACKEND_BASE) || 'http://localhost:3000').replace(/\/$/,'');
                        const url = base + '/api/exams/history?limit=50&status=' + encodeURIComponent(status);
                        const rawSession = (sessionStorage.getItem('X-Session-Token') || localStorage.getItem('sessionToken') || '').trim();
                        const jwtTok = (localStorage.getItem('jwtToken')||'').trim();
                        const jwtType = (localStorage.getItem('jwtTokenType')||'Bearer').trim()||'Bearer';
                        const headers = {};
                        if (jwtTok) headers['Authorization'] = jwtType + ' ' + jwtTok;
                        if (rawSession) headers['X-Session-Token'] = rawSession;
                        const r = await fetch(url + (url.includes('?') ? '&' : '?') + '_ts=' + Date.now(), { headers, cache: 'no-store', credentials: 'include' });
                        let list = [];
                        if (r.ok) {
                            list = await r.json();
                            logger.debug('[history] fetched attempts count=', Array.isArray(list)?list.length:'(non-array)', list);
                        } else {
                            // Silenced debug log for history HTTP status
                        }
                        if (!Array.isArray(list)) list = [];

                        const isAdmin = status === 'unfinished' ? await isAdminForHistory() : false;

                        // Sort according to current status
                        try {
                            if (status === 'unfinished') {
                                list.sort((a,b)=>{
                                    const af = a && a.startedAt ? new Date(a.startedAt).getTime() : 0;
                                    const bf = b && b.startedAt ? new Date(b.startedAt).getTime() : 0;
                                    return bf - af;
                                });
                            } else {
                                list.sort((a,b)=>{
                                    const af = a && a.finishedAt ? new Date(a.finishedAt).getTime() : 0;
                                    const bf = b && b.finishedAt ? new Date(b.finishedAt).getTime() : 0;
                                    return bf - af;
                                });
                            }
                        } catch(_){ }
                        listEl.innerHTML = '';
                        if (!list.length){
                            const isGuest = rawSession && /^guest_/i.test(rawSession);
                            const empty = document.createElement('div');
                            if (!rawSession) {
                                empty.textContent = 'Fa√ßa login para ver seu hist√≥rico';
                            } else if (isGuest) {
                                empty.textContent = 'Sess√£o convidado ‚Äî fa√ßa login para ver seu hist√≥rico';
                            } else {
                                empty.textContent = status === 'unfinished' ? 'Nenhuma tentativa n√£o finalizada encontrada' : 'Nenhum exame encontrado';
                            }
                            empty.style.cssText = 'padding:8px;border:1px dashed #cbd5e1;border-radius:8px;color:#64748b;text-align:center';
                            listEl.appendChild(empty);
                            if (isGuest){
                                const btn = document.createElement('button');
                                btn.type = 'button';
                                btn.textContent = 'Sair e reentrar';
                                btn.style.cssText = 'margin-top:8px;padding:8px 10px;border:1px solid #cbd5e1;border-radius:8px;background:#fff;color:#111827;cursor:pointer;font-size:.85rem';
                                btn.addEventListener('click', ()=>{ try{ localStorage.clear(); sessionStorage.clear(); }catch(_){} window.location.assign('/login.html'); });
                                listEl.appendChild(btn);
                            }
                            return;
                        }
                            for (const item of list){
                                const id = item && (item.examAttemptId || item.attemptId || item.id || item.Id || item._id || item.sessionId || item.examId);
                                if (!id) continue;
                                const mode = String((item && (item.examMode || item.mode)) || '').toLowerCase();
                            const title = item && (item.title || item.name) || (mode==='full' ? 'Exame Completo' : 'Quiz');
                            const itemStatus = String((item && (item.status || item.Status)) || (status === 'unfinished' ? 'in_progress' : status) || 'finished').toLowerCase();
                            const started = item && item.startedAt ? new Date(item.startedAt).toLocaleString('pt-BR') : '';
                            const finished = item && item.finishedAt ? new Date(item.finishedAt).toLocaleString('pt-BR') : '';
                            const pctNum = item && item.scorePercent != null ? Math.round(item.scorePercent) : null;
                            const btn = document.createElement('button');
                            btn.type = 'button';
                            btn.style.cssText = 'display:flex;align-items:center;justify-content:space-between;padding:10px;border:1px solid #cbd5e1;border-radius:8px;background:#f8fafc;color:#111827;font-size:.92rem;cursor:pointer';
                                btn.dataset.id = String(id);
                            btn.dataset.mode = mode || 'quiz';
                            const left = document.createElement('span'); left.textContent = title;
                            const right = document.createElement('span'); right.style.cssText = 'display:flex;gap:8px;color:#334155;font-size:.85rem';
                            const modeTag = document.createElement('span'); modeTag.textContent = (mode==='full'?'Full':'Quiz'); modeTag.style.cssText='padding:2px 6px;border-radius:6px;background:#eef2ff;color:#3730a3;font-weight:600'; right.appendChild(modeTag);
                            if (itemStatus === 'abandoned' || itemStatus === 'in_progress') {
                                const st = document.createElement('span');
                                st.textContent = (itemStatus === 'abandoned') ? 'Abandonado' : 'Em andamento';
                                st.style.cssText = 'padding:2px 6px;border-radius:6px;background:#eef2ff;color:#3730a3;font-weight:600';
                                right.appendChild(st);
                            }
                            if (pctNum != null){ const pctEl = document.createElement('span'); pctEl.textContent = pctNum + '%'; pctEl.style.cssText='color:#0f766e;font-weight:600'; right.appendChild(pctEl); }
                            if (itemStatus === 'abandoned' || itemStatus === 'in_progress') {
                                if (started){ const dt = document.createElement('span'); dt.textContent = 'In√≠cio: ' + started; dt.style.cssText='color:#64748b'; right.appendChild(dt); }
                            } else {
                                if (finished){ const dt = document.createElement('span'); dt.textContent = finished; dt.style.cssText='color:#64748b'; right.appendChild(dt); }
                            }

                            if (isAdmin && (itemStatus === 'abandoned' || itemStatus === 'in_progress')) {
                                const del = document.createElement('button');
                                del.type = 'button';
                                del.textContent = 'Excluir';
                                del.title = 'Excluir tentativa n√£o finalizada';
                                del.style.cssText = 'margin-left:8px;padding:2px 8px;border:1px solid #cbd5e1;border-radius:8px;background:#fff;color:#111827;cursor:pointer;font-size:.85rem;';
                                del.addEventListener('click', async (ev)=>{
                                    try { ev.preventDefault(); ev.stopPropagation(); if (ev.stopImmediatePropagation) ev.stopImmediatePropagation(); } catch(_){ }
                                    const ok = window.confirm('Excluir esta tentativa n√£o finalizada? Esta a√ß√£o n√£o pode ser desfeita.');
                                    if (!ok) return;

                                    const token = (localStorage.getItem('sessionToken') || '').trim();
                                    const nomeUsuario = (localStorage.getItem('nomeUsuario') || '').trim();
                                    const identity = (token || nomeUsuario || '').trim();

                                    const jwtTok = (localStorage.getItem('jwtToken')||'').trim();
                                    const jwtType = (localStorage.getItem('jwtTokenType')||'Bearer').trim()||'Bearer';
                                    const h = {};
                                    if (identity) h['X-Session-Token'] = identity;
                                    if (jwtTok) h['Authorization'] = `${jwtType} ${jwtTok}`;

                                    const delUrl = base + '/api/admin/exams/attempts/' + encodeURIComponent(String(id)) + '?sessionToken=' + encodeURIComponent(identity);
                                    const resp = await fetch(delUrl, { method: 'DELETE', headers: h, credentials: 'include' });
                                    if (!resp.ok) {
                                        const msg = await resp.text().catch(()=> '');
                                        window.alert('Falha ao excluir. ' + (msg || ('HTTP ' + resp.status)));
                                        return;
                                    }
                                    await loadHistory();
                                });
                                right.appendChild(del);
                            }

                            btn.appendChild(left); btn.appendChild(right);
                            if (itemStatus === 'finished') {
                                btn.addEventListener('click', ()=>{
                                    const path = mode === 'full' ? '/pages/examReviewFull.html' : '/pages/examReviewQuiz.html';
                                        const urlGo = `${path}?examId=${encodeURIComponent(String(id))}&mode=${encodeURIComponent(mode||'quiz')}`;
                                    window.location.assign(urlGo);
                                });
                            } else {
                                btn.style.cursor = 'default';
                            }
                            listEl.appendChild(btn);
                        }
                    } catch(e){
                        // Silenced debug log for history load failure
                        listEl.innerHTML = '';
                        const errBox = document.createElement('div');
                        errBox.textContent = 'Falha ao carregar';
                        errBox.style.cssText = 'padding:8px;border:1px solid #fecaca;border-radius:8px;background:#fee2e2;color:#991b1b;text-align:center';
                        listEl.appendChild(errBox);
                    }
                }

                // Itens da lista s√£o clic√°veis; sem bot√£o "Abrir"
            })();
        </script>
    <!-- Admin quick menu (rendered only if user has admin role) -->
    <button id="adminMenuBtn" type="button" aria-haspopup="true" aria-expanded="false" aria-label="Menu Admin" style="display:none;position:fixed;top:12px;left:12px;z-index:2300;padding:8px 10px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);background:#fff;color:#111827;cursor:pointer;box-shadow:0 6px 14px rgba(0,0,0,0.10);font-size:.85rem;font-weight:600;">Admin ‚ñæ</button>
    <button id="notifBellBtn" type="button" aria-label="Notifica√ß√µes" title="Notifica√ß√µes" style="position:fixed;top:12px;right:12px;z-index:2300;padding:8px 10px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);background:#fff;color:#111827;cursor:pointer;box-shadow:0 6px 14px rgba(0,0,0,0.08);font-size:.85rem;font-weight:600;display:none;">üîî <span id="notifBadge" style="background:#ef4444;color:#fff;border-radius:999px;padding:2px 6px;margin-left:6px;font-size:.7rem;display:none">0</span></button>
    <div id="notifPanel" aria-hidden="true" style="display:none;position:fixed;top:52px;right:12px;z-index:2299;min-width:260px;background:#ffffff;border:1px solid #d6d9e0;border-radius:10px;box-shadow:0 10px 24px rgba(0,0,0,0.18);padding:8px;max-height:320px;overflow:auto"></div>
    <nav id="adminMenuPanel" aria-label="A√ß√µes administrativas" aria-hidden="true" style="display:none;position:fixed;top:52px;left:12px;z-index:2299;min-width:200px;background:#ffffff;border:1px solid #d6d9e0;border-radius:10px;box-shadow:0 10px 24px rgba(0,0,0,0.18);padding:6px;">
        <a id="lnkAdminCadastrar" href="/pages/admin/questionForm.html" style="display:block;padding:6px 8px;border-radius:6px;color:#111827;text-decoration:none;font-size:.85rem;">Cadastrar quest√£o</a>
        <a id="lnkAdminBulk" href="/pages/admin/questionBulk.html" style="display:block;padding:6px 8px;border-radius:6px;color:#111827;text-decoration:none;font-size:.85rem;">Cadastrar quest√£o bulk</a>
        <a id="lnkAdminFeedbackResp" href="/pages/admin/feedbackResponses.html" style="display:block;padding:6px 8px;border-radius:6px;color:#111827;text-decoration:none;font-size:.85rem;">Responder feedbacks</a>
        <a id="lnkAdminNotifications" href="/pages/admin/notifications.html" style="display:block;padding:6px 8px;border-radius:6px;color:#111827;text-decoration:none;font-size:.85rem;">Notifica√ß√µes</a>
        <a id="lnkAdminChatHost" href="/chat/admin" target="_blank" rel="noopener noreferrer" style="display:block;padding:6px 8px;border-radius:6px;color:#111827;text-decoration:none;font-size:.85rem;">Chat (Admin)</a>
        <button id="btnAdminFixture" type="button" style="display:block;width:100%;text-align:left;padding:6px 8px;border:0;background:#f8fafc;color:#0d9488;font-size:.85rem;border-radius:6px;cursor:pointer;">Gerar tentativa fixture</button>
        <button id="btnAdminReconcile" type="button" style="display:block;width:100%;text-align:left;padding:6px 8px;border:0;background:#f8fafc;color:#4f46e5;font-size:.85rem;border-radius:6px;cursor:pointer;">Reconciliar estat√≠sticas</button>
        <button id="btnAdminPurge" type="button" style="display:block;width:100%;text-align:left;padding:6px 8px;border:0;background:#f8fafc;color:#b91c1c;font-size:.85rem;border-radius:6px;cursor:pointer;">Expurgar tentativas abandonadas</button>
        <button id="btnAdminMarkAbandoned" type="button" style="display:block;width:100%;text-align:left;padding:6px 8px;border:0;background:#f8fafc;color:#dc2626;font-size:.85rem;border-radius:6px;cursor:pointer;">Marcar abandonadas (inatividade)</button>
        <button id="btnAdminResetPassword" type="button" style="display:block;width:100%;text-align:left;padding:6px 8px;border:0;background:#f8fafc;color:#7c3aed;font-size:.85rem;border-radius:6px;cursor:pointer;">Resetar senha de usu√°rio</button>
        <button id="btnAdminLogout" type="button" style="display:block;width:100%;text-align:left;padding:6px 8px;border:0;background:#f1f5f9;color:#334155;font-size:.85rem;border-radius:6px;cursor:pointer;">Sair</button>
    </nav>
    <!-- i18n constants (can be extended or replaced per locale) -->
    <script>
        window.SIMULADOS_I18N = Object.assign({
            LAST_EXAM_TITLE: '√öltimo exame',
            WAITING_FULL_EXAMS_TITLE: 'Aguardando exames completos',
            HELP_NEED_3_FULL: 'Fa√ßa pelo menos 3 exames completos para ver seus indicadores',
            LABEL_CORRECT: 'Acertos',
            LABEL_FINISHED_AT: 'Finalizado em',
            LABEL_DURATION: 'Dura√ß√£o'
        }, window.SIMULADOS_I18N || {});
    </script>
    <script>
    // Notifications bell: simple click-to-open with on-demand refresh
    (function initNotifications(){
        const btn = document.getElementById('notifBellBtn');
        const badge = document.getElementById('notifBadge');
        const panel = document.getElementById('notifPanel');
        if (!btn || !badge || !panel) return;
        // Auth via httpOnly cookie, no localStorage token needed
        const jwtTok = (localStorage.getItem('jwtToken')||'').trim();
        const jwtType = (localStorage.getItem('jwtTokenType')||'Bearer').trim()||'Bearer';
        const headers = {}; if (jwtTok) headers['Authorization'] = `${jwtType} ${jwtTok}`;
        // === Observer Pattern: lightweight NotificationCenter ===
        const NotificationCenter = (function(){
            let state = { unread: 0, list: [], ts: Date.now() };
            const subs = new Set();
            function publish(partial){
                const prev = state;
                state = Object.assign({}, state, partial, { ts: Date.now() });
                subs.forEach(fn => { try { fn(state, prev); } catch(_){ } });
            }
            function subscribe(fn){ subs.add(fn); return () => subs.delete(fn); }
            function get(){ return state; }
            return { publish, subscribe, get };
        })();
        window.NotificationCenter = NotificationCenter; // expose for debugging

        let userClosedAt = 0; // timestamp user manually closed panel
        const SNOOZE_MS = 15000; // do not auto-open within 15s of manual close
        let autoOpenedYet = false; // avoid repeated auto-opens for same unread burst
        let lastListIds = new Set();

        async function refreshCount(){
            try { const r = await fetch('/api/notifications/unread-count', { headers, credentials: 'include' }); if (!r.ok) return; const d = await r.json(); const c = Number(d.count)||0; if (c>0){ badge.textContent = String(c); badge.style.display='inline-block'; } else { badge.style.display='none'; } btn.style.display = 'inline-flex'; }
            catch(_){ }
            try { NotificationCenter.publish({ unread: Number(badge.textContent)||0 }); } catch(_){ }
        }
        async function loadList(){
            try {
                const r = await fetch('/api/notifications?limit=20', { headers, credentials: 'include' });
                if (!r.ok) return;
                const list = await r.json();
                panel.innerHTML='';
                if (!Array.isArray(list) || !list.length){ panel.innerHTML = '<div style="color:#64748b">Sem notifica√ß√µes</div>'; return; }
                for (const it of list){
                    const row = document.createElement('div');
                    row.style.cssText='border-bottom:1px solid #e5e7eb;padding:6px 4px';
                    const cat = it.categoria||''; const t = it.titulo||''; const msg = it.mensagem||''; const read = !!it.readAt;
                    row.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><strong style="font-size:.85rem">${t}</strong><span style="font-size:.7rem;color:#6b7280">${cat}</span></div><div style="font-size:.80rem;color:#334155;margin-top:4px">${msg}</div><div style="margin-top:6px;"><button data-id="${it.id}" class="mark-read" style="background:${read?'#e5e7eb':'#4f46e5'};color:${read?'#111827':'#fff'};border:none;border-radius:6px;padding:4px 6px;font-size:.75rem;cursor:pointer">${read?'Lida':'Marcar como lida'}</button></div>`;
                    panel.appendChild(row);
                }
                panel.querySelectorAll('button.mark-read').forEach(btnEl => {
                    btnEl.addEventListener('click', async (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        try {
                            const rr = await fetch(`/api/notifications/${id}/read`, { method: 'POST', headers, credentials: 'include' });
                            if (rr.ok){ await refreshCount(); await loadList(); }
                        } catch(_){ }
                    });
                });
                try {
                    const ids = new Set(list.map(x => x && x.id));
                    NotificationCenter.publish({ list: list });
                    // Detect newly arrived IDs (simple heuristic)
                    let newCount = 0; ids.forEach(id => { if (id && !lastListIds.has(id)) newCount++; });
                    lastListIds = ids;
                    if (newCount > 0) {
                        // mark that future auto-open for new items is allowed again
                        autoOpenedYet = false;
                    }
                } catch(_){ }
            } catch(_){ panel.innerHTML = '<div style="color:#dc2626">Falha ao carregar</div>'; }
        }
        function close(){ panel.style.display='none'; panel.setAttribute('aria-hidden','true'); btn.setAttribute('aria-expanded','false'); userClosedAt = Date.now(); }
        function open(){ panel.style.display='block'; panel.setAttribute('aria-hidden','false'); btn.setAttribute('aria-expanded','true'); }
        // Click opens or closes with full refresh
        btn.addEventListener('click', (e)=>{ e.stopPropagation(); if (panel.style.display==='block') { close(); } else { refreshCount().then(loadList); open(); } });
        // Hover (mouseenter) auto-refresh + open (debounced) when closed
        let lastHoverOpen = 0;
        btn.addEventListener('mouseenter', (e)=>{
            if (panel.style.display === 'block') return; // already open
            const now = Date.now();
            if (now - lastHoverOpen < 1200) return; // debounce rapid hovers
            lastHoverOpen = now;
            refreshCount().then(loadList).finally(open);
        });
        document.addEventListener('click', (e)=>{ if (!panel.contains(e.target) && e.target !== btn) close(); });
        // Initial display: show bell and count once then start adaptive polling
        refreshCount();
        let pollTimer = null;
        function schedulePoll(nextMs){
            try { if (pollTimer) clearTimeout(pollTimer); } catch(_){}
            pollTimer = setTimeout(async () => {
                await refreshCount();
                const unreadNow = NotificationCenter.get().unread;
                // Faster polling when waiting for first unread, slower otherwise
                if (document.hidden){
                    // When tab hidden, back off further
                    schedulePoll(unreadNow === 0 ? 45000 : 90000);
                } else {
                    schedulePoll(unreadNow === 0 ? 15000 : 60000);
                }
            }, nextMs);
        }
        schedulePoll(15000);
        // Refresh count immediately when tab gains focus (helps near real-time)
        window.addEventListener('focus', () => { refreshCount(); });
        document.addEventListener('visibilitychange', () => { if (!document.hidden) refreshCount(); });

        // Observer subscription: auto-open when unread transitions 0 -> >0 or new unread entries appear
        NotificationCenter.subscribe((curr, prev) => {
            const now = Date.now();
            const snoozed = (now - userClosedAt) < SNOOZE_MS;
            const unreadIncreased = (prev.unread === 0 && curr.unread > 0);
            const newUnreadItems = (() => {
                try {
                    const prevIds = new Set((prev.list||[]).filter(x => !x.readAt).map(x => x.id));
                    const currUnreadIds = (curr.list||[]).filter(x => !x.readAt).map(x => x.id);
                    return currUnreadIds.some(id => id && !prevIds.has(id));
                } catch(_) { return false; }
            })();
            if (!snoozed && panel.style.display !== 'block' && !autoOpenedYet && (unreadIncreased || newUnreadItems)) {
                loadList().finally(() => { open(); autoOpenedYet = true; });
            }
        });
    })();
    </script>
    <!-- Admin menu logic: detect admin by probing an admin-only endpoint -->
    <script>
    (function initAdminMenu(){
        const btn = document.getElementById('adminMenuBtn');
        const panel = document.getElementById('adminMenuPanel');
        if (!btn || !panel) return;
        // Hidden by default; only admins can see it.
        try { btn.style.display = 'none'; } catch(_){ }
                const sessionForHeader = (window.Auth && typeof window.Auth.getSessionIdentity === 'function')
                    ? window.Auth.getSessionIdentity()
                    : ((localStorage.getItem('sessionToken') || '').trim() || (localStorage.getItem('nomeUsuario') || '').trim());
                if (!sessionForHeader) return; // no session => skip
                const headers = (window.Auth && typeof window.Auth.getAuthHeaders === 'function')
                    ? window.Auth.getAuthHeaders()
                    : {};

                // Primary: RBAC probe.
                const probeUrl = `/api/admin/exams/probe?sessionToken=${encodeURIComponent(sessionForHeader)}`;
                fetch(probeUrl, { headers, method: 'GET', credentials: 'include' })
                    .then(async (r) => {
                        let isAdmin = !!(r && (r.ok || r.status === 204));

                        if (!isAdmin) {
                            // Fallback: legacy /api/users/me.
                            try {
                                const r2 = await fetch('/api/users/me', { headers, method: 'GET', credentials: 'include' });
                                if (r2.ok) {
                                    const user = await r2.json().catch(()=>null);
                                    isAdmin = !!(user && (user.TipoUsuario === 'admin' || user.tipoUsuario === 'admin' || user.isAdmin === true));
                                }
                            } catch(_){ }
                        }

                        if (!isAdmin) return;
                        try { window.__isAdmin = true; } catch(_){ }

                        // Success => show menu
                        btn.style.display = 'inline-flex';
              function close(){ panel.style.display='none'; panel.setAttribute('aria-hidden','true'); btn.setAttribute('aria-expanded','false'); }
              function open(){ panel.style.display='block'; panel.setAttribute('aria-hidden','false'); btn.setAttribute('aria-expanded','true'); }
              btn.addEventListener('click', e => {
                  e.stopPropagation();
                  if (panel.style.display === 'block') close(); else open();
              });
              document.addEventListener('click', e => { if (!panel.contains(e.target) && e.target !== btn) close(); });

              // Wire admin lifecycle actions
              const purgeBtn = document.getElementById('btnAdminPurge');
              const markBtn = document.getElementById('btnAdminMarkAbandoned');
              const reconcileBtn = document.getElementById('btnAdminReconcile');
              const fixtureBtn = document.getElementById('btnAdminFixture');
              const logoutBtn = document.getElementById('btnAdminLogout');
              function getSessionIdentity(){
                  try { return (window.Auth && typeof window.Auth.getSessionIdentity === 'function') ? window.Auth.getSessionIdentity() : ''; }
                  catch(_){ return ''; }
              }
              async function adminPost(path){
                  const identity = getSessionIdentity();
                  const headers = (window.Auth && typeof window.Auth.getAuthHeaders === 'function')
                    ? window.Auth.getAuthHeaders({ contentType: 'application/json' })
                    : { 'Content-Type': 'application/json' };
                  if (!headers['X-Session-Token'] && identity) headers['X-Session-Token'] = identity;
                  const url = path + (path.includes('?') ? '&' : '?') + 'sessionToken=' + encodeURIComponent(identity);
                  const resp = await fetch(url,{method:'POST',headers, credentials: 'include'});
                  const data = await resp.json().catch(()=>({}));
                  return {ok:resp.ok,status:resp.status,data};
              }
              if (reconcileBtn){
                  reconcileBtn.addEventListener('click', ()=>{
                      close(); // Fecha o menu admin
                      const adminModal = document.getElementById('adminModal');
                      if (typeof window.openAdminModal === 'function') {
                          window.openAdminModal();
                      } else if (adminModal) {
                          adminModal.classList.add('active');
                          adminModal.setAttribute('aria-hidden', 'false');
                          const nav = document.querySelector('.bottom-nav');
                          if (nav) nav.style.display = 'none';
                      }
                      // scroll to reconcile section (first panel)
                      try { adminModal?.querySelector('h3')?.scrollIntoView({behavior:'smooth'}); } catch(_){ }
                  });
              }
              if (fixtureBtn){
                  fixtureBtn.addEventListener('click', ()=>{
                      close();
                      const adminModal = document.getElementById('adminModal');
                      if (typeof window.openAdminModal === 'function') {
                          window.openAdminModal();
                      } else if (adminModal){
                          adminModal.classList.add('active');
                          adminModal.setAttribute('aria-hidden','false');
                          const nav = document.querySelector('.bottom-nav'); if (nav) nav.style.display='none';
                          // Focus userId field & highlight fixture box
                          try {
                              const userField = document.getElementById('fxUserId');
                              if (userField){ userField.focus(); userField.scrollIntoView({behavior:'smooth', block:'center'}); }
                              const fixtureBox = userField?.closest('div[style*="Gerar Tentativa Fixture"]');
                              // fallback: select by heading text
                              const heading = Array.from(adminModal.querySelectorAll('h3')).find(h => /Gerar Tentativa Fixture/i.test(h.textContent||''));
                              const panel = heading ? heading.parentElement : null;
                              if (panel){
                                  panel.style.outline='2px solid #0d9488';
                                  setTimeout(()=>{ panel.style.outline=''; }, 2400);
                              }
                          } catch(_){}
                      }
                  });
              }
              if (purgeBtn){
                  purgeBtn.addEventListener('click', async ()=>{
                      if (!confirm('Confirma expurgo de tentativas abandonadas conforme pol√≠tica? Esta a√ß√£o √© permanente.')) return;
                      purgeBtn.disabled = true; purgeBtn.textContent = 'Expurgando...';
                      try {
                          const r = await adminPost('/api/admin/exams/purge-abandoned');
                          alert(r.ok ? `Expurgo: ${r.data.purged} purgadas (inspecionadas ${r.data.inspected}).` : `Falhou (${r.status}).`);
                      } catch(e){ alert('Erro ao expurgar: '+ e); }
                      purgeBtn.disabled = false; purgeBtn.textContent = 'Expurgar tentativas abandonadas';
                  });
              }
              if (markBtn){
                  markBtn.addEventListener('click', async ()=>{
                      if (!confirm('Executar marca√ß√£o de tentativas abandonadas por inatividade?')) return;
                      markBtn.disabled = true; markBtn.textContent = 'Marcando...';
                      try {
                          const r = await adminPost('/api/admin/exams/mark-abandoned');
                          alert(r.ok ? `Marcadas: timeout=${r.data.markedTimeout}, lowProgress=${r.data.markedLowProgress} (processadas ${r.data.processed}).` : `Falhou (${r.status}).`);
                      } catch(e){ alert('Erro ao marcar: ' + e); }
                      markBtn.disabled = false; markBtn.textContent = 'Marcar abandonadas (inatividade)';
                  });
              }
              // Reset Password button handler
              const resetPasswordBtn = document.getElementById('btnAdminResetPassword');
              logger.debug('[DEBUG] Reset password button:', resetPasswordBtn);
              if (resetPasswordBtn){
                  resetPasswordBtn.addEventListener('click', ()=>{
                      logger.debug('[DEBUG] Reset password clicked!');
                      close(); // Fecha o menu admin
                      const adminModal = (typeof window.openAdminModal === 'function') ? window.openAdminModal() : document.getElementById('adminModal');
                      logger.debug('[DEBUG] Admin modal element:', adminModal);
                      if (!adminModal) return;
                      // Focus email field & highlight reset password box
                      try {
                          const emailField = document.getElementById('resetEmail');
                          if (emailField){ emailField.focus(); emailField.scrollIntoView({behavior:'smooth', block:'center'}); }
                          // Find and highlight the reset password panel
                          const heading = Array.from(adminModal.querySelectorAll('h3')).find(h => /Resetar Senha de Usu√°rio/i.test(h.textContent||''));
                          const panel = heading ? heading.parentElement : null;
                          if (panel){
                              panel.style.outline='2px solid #7c3aed';
                              setTimeout(()=>{ panel.style.outline=''; }, 2400);
                          }
                      } catch(_){ }
                  });
              }
              // Logout button handler relocated from misplaced inline block
              if (logoutBtn){
                  logoutBtn.addEventListener('click', ()=>{
                      close();
                      if (window.performLogout) {
                          window.performLogout({ confirm: false, showNotification: true });
                      } else {
                          try { localStorage.clear(); } catch(_){ }
                          try { sessionStorage.clear(); } catch(_){ }
                          try { document.cookie = 'sessionToken=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT;'; } catch(_){ }
                          window.location.href = '/login.html';
                      }
                  });
              }
                            // Note: quit handler moved to global block to work for all users
          })
          .catch(()=>{});
    })();
    </script>
        <!-- Global logout handler for span#quit (works for admin and non-admin users) -->
        <script>
            (function bindGlobalQuit(){
                function setupQuitHandler(){
                    const quitEl = document.getElementById('quit');
                    if (!quitEl) return;
                    quitEl.style.cursor='pointer';
                    quitEl.setAttribute('role','button');
                    quitEl.setAttribute('aria-label','Encerrar sess√£o');
                    quitEl.addEventListener('click', (e)=>{
                        e.preventDefault();
                        e.stopPropagation();
                        if (window.performLogout) {
                            window.performLogout({ confirm: false, showNotification: false });
                            return;
                        }
                        try { localStorage.clear(); } catch(_){ }
                        try { sessionStorage.clear(); } catch(_){ }
                        try { document.cookie = 'sessionToken=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT;'; } catch(_){ }
                        try {
                            const n = document.createElement('div');
                            n.textContent='Sess√£o encerrada';
                            n.style.cssText='position:fixed;top:14px;right:14px;background:#334155;color:#fff;padding:8px 12px;border-radius:6px;font-size:.75rem;z-index:99999;box-shadow:0 4px 12px rgba(0,0,0,0.25)';
                            document.body.appendChild(n); setTimeout(()=>{ try{ n.remove(); }catch(_){ } },1200);
                        } catch(_){ }
                        setTimeout(()=>{ window.location.href='/login.html'; }, 300);
                    });
                }
                
                // Tenta configurar imediatamente e tamb√©m ap√≥s DOM ready
                if(document.readyState === 'loading'){
                    document.addEventListener('DOMContentLoaded', setupQuitHandler);
                } else {
                    setupQuitHandler();
                }
                
                // Tamb√©m observa mudan√ßas no DOM para quando o elemento aparecer
                const observer = new MutationObserver(()=>{
                    const quitEl = document.getElementById('quit');
                    if(quitEl && !quitEl.hasAttribute('data-quit-bound')){
                        quitEl.setAttribute('data-quit-bound', 'true');
                        setupQuitHandler();
                        observer.disconnect();
                    }
                });
                observer.observe(document.body, { childList: true, subtree: true });
            })();
        </script>
    
    <main class="content">
        <!-- Sections -->
        <section id="home" class="section active" aria-labelledby="tab-home">
            <!-- Header indicators row: PassProbability (left) + Last Exam Results (right) -->
            <div id="homeHeaderIndicators" style="display:flex; flex-direction:row; align-items:stretch; justify-content:center; gap:12px; width:100%; max-width:820px; margin:0 auto 12px auto;">
                <!-- PassProbability component mount (left) -->
                <div id="passProbabilityContainer" style="flex:1 1 360px; max-width:380px;"></div>
                <!-- lastExamResults mount (right) -->
                <div id="lastExamResultsMount" aria-live="polite" style="flex:1 1 360px; max-width:420px; box-sizing:border-box; transition: background .25s ease;"></div>
            </div>
            <div class="card-grid">
                 <div class="card card--simulador" aria-label="Simulador" role="button" tabindex="0">
                    <img src="assets/pc.png" alt="Personalizar Exame" class="thumb" />
                    <span class="card-label">Setup</span>
                </div>
                <div id="card-exam-mock" class="card card--simulador" data-card="exam-mock"  aria-label="Exame completo (Mock)" role="button" tabindex="0">
                    <img src="assets/exame.png" alt="Exame completo" class="thumb" />
                    <span class="card-label">Simulador</span>
                </div>
                <div id="card-dica-do-dia" class="card card--simulador" data-card="dica-do-dia" aria-label="Dica do dia" role="button" tabindex="0"
                     onclick="try{event.preventDefault();event.stopPropagation();if(event.stopImmediatePropagation)event.stopImmediatePropagation();if(window.openDicaDoDiaModal)window.openDicaDoDiaModal();else{if(window.showToast)window.showToast('Dica do dia: script n√£o carregou (recarregue a p√°gina).');else alert('Dica do dia: script n√£o carregou (recarregue a p√°gina).');}}catch(_){ }"
                     onkeydown="try{if(event.key==='Enter'||event.key===' '){event.preventDefault();event.stopPropagation();if(event.stopImmediatePropagation)event.stopImmediatePropagation();if(window.openDicaDoDiaModal)window.openDicaDoDiaModal();else{if(window.showToast)window.showToast('Dica do dia: script n√£o carregou (recarregue a p√°gina).');else alert('Dica do dia: script n√£o carregou (recarregue a p√°gina).');}}}catch(_){ }">
                    <img src="assets/adendo.png" alt="Dica do dia" class="thumb" />
                    <span class="card-label">Dica do dia</span>
                </div>
                <div id="card-indicadores" class="card card--simulador" data-card="indicadores" aria-label="Indicadores de desempenho" role="button" tabindex="0">
                    <img src="assets/kpi.png" alt="Indicadores" class="thumb" />
                    <span class="card-label">Indicadores</span>
                </div>
                <div id="card-progresso-geral" class="card card--simulador" data-card="progresso-geral" aria-label="Progresso geral" role="button" tabindex="0">
                    <img src="assets/historia.png" alt="Progresso geral" class="thumb" />
                    <span class="card-label">Hist√≥rico</span>
                </div>
                <div id="card-insights-ia" class="card card--simulador" data-card="insights-ia" aria-label="Insights da IA" role="button" tabindex="0">
                    <img src="assets/kpi.png" alt="Insights da IA" class="thumb" />
                    <span class="card-label">Insights IA</span>
                </div>
                <div class="card card--simulador" data-full="https://picsum.photos/800/800?random=6" aria-label="Estou pronto?" role="button" tabindex="0">
                    <img src="assets/pronto.png" alt="Estou pronto?" class="thumb" />
                    <span class="card-label">Estou pronto?</span>
                </div>
            </div>
        </section>

        <section id="search" class="section" aria-labelledby="tab-search">
            <h2 class="title">BUSCAR</h2>
            <p class="debug" id="debug-search">Cliques: 0</p>
            <div class="card-grid">
                <div class="card" data-full="https://picsum.photos/800/800?random=11" aria-label="Abrir imagem 1" role="button" tabindex="0"></div>
                <div class="card" data-full="https://picsum.photos/800/800?random=12" aria-label="Abrir imagem 2" role="button" tabindex="0"></div>
                <div class="card" data-full="https://picsum.photos/800/800?random=13" aria-label="Abrir imagem 3" role="button" tabindex="0"></div>
                <div class="card" data-full="https://picsum.photos/800/800?random=14" aria-label="Abrir imagem 4" role="button" tabindex="0"></div>
                <div class="card" data-full="https://picsum.photos/800/800?random=15" aria-label="Abrir imagem 5" role="button" tabindex="0"></div>
                <div class="card" data-full="https://picsum.photos/800/800?random=16" aria-label="Abrir imagem 6" role="button" tabindex="0"></div>
            </div>
        </section>

        <section id="favorites" class="section" aria-labelledby="tab-favorites">
            <h2 class="title">FAVORITOS</h2>
            <p class="debug" id="debug-favorites">Cliques: 0</p>
            <div class="card-grid">
                <div class="card" data-full="https://picsum.photos/800/800?random=21" aria-label="Abrir imagem 1" role="button" tabindex="0"></div>
                <div class="card" data-full="https://picsum.photos/800/800?random=22" aria-label="Abrir imagem 2" role="button" tabindex="0"></div>
                <div class="card" data-full="https://picsum.photos/800/800?random=23" aria-label="Abrir imagem 3" role="button" tabindex="0"></div>
                <div class="card" data-full="https://picsum.photos/800/800?random=24" aria-label="Abrir imagem 4" role="button" tabindex="0"></div>
                <div class="card" data-full="https://picsum.photos/800/800?random=25" aria-label="Abrir imagem 5" role="button" tabindex="0"></div>
                <div class="card" data-full="https://picsum.photos/800/800?random=26" aria-label="Abrir imagem 6" role="button" tabindex="0"></div>
            </div>
        </section>

        <section id="profile" class="section" aria-labelledby="tab-profile">
            <h2 class="title">PERFIL</h2>
            <p class="debug" id="debug-profile">Cliques: 0</p>
            <div class="card-grid">
                <div id="card-admin" class="card card--simulador" data-card="admin" aria-label="Administra√ß√£o" role="button" tabindex="0" style="display:none">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color:var(--primary)">
                        <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    <span class="card-label">Admin</span>
                </div>
                <div id="card-profile-settings" class="card card--settings" data-card="profile-settings" aria-label="Configura√ß√µes da conta" role="button" tabindex="0" style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
                    <span style="font-size: 2.5rem; line-height: 1;">‚öôÔ∏è</span>
                    <span class="card-label" style="margin-top: 4px;">Configura√ß√µes</span>
                </div>
                <div class="card" data-full="https://picsum.photos/800/800?random=32" aria-label="Abrir imagem 2" role="button" tabindex="0"></div>
                <div class="card" data-full="https://picsum.photos/800/800?random=33" aria-label="Abrir imagem 3" role="button" tabindex="0"></div>
                <div class="card" data-full="https://picsum.photos/800/800?random=34" aria-label="Abrir imagem 4" role="button" tabindex="0"></div>
                <div class="card" data-full="https://picsum.photos/800/800?random=35" aria-label="Abrir imagem 5" role="button" tabindex="0"><span id="quit">Sair</span></div>
            </div>
        </section>

        <section id="exam-setup" class="section" aria-label="Configura√ß√£o de Simulado">
            <!-- Content will be loaded dynamically from examSetup.html in desktop mode -->
        </section>

        <section id="progresso-geral" class="section" aria-label="Progresso Geral">
            <!-- Content will be loaded dynamically from progressoGeral.html in desktop mode -->
        </section>
        <section id="indicadores" class="section" aria-label="Indicadores">
            <!-- Content will be loaded dynamically from Indicadores.html in desktop mode -->
        </section>
    </main>

    <!-- Bottom navigation bar -->
    <div id="bottomNavMount"></div>
    <!-- Toast notification container -->
    <div id="toast" aria-live="polite" style="display:none;position:fixed;right:14px;bottom:14px;z-index:2600;background:#334155;color:#fff;padding:10px 14px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.4);font-size:.80rem;max-width:240px"></div>

    <!-- Fullscreen overlay for image -->
    <div id="fullOverlay" class="overlay" aria-hidden="true">
        <button id="backBtn" class="back-btn" aria-label="Voltar">
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
        </button>
        <img id="fullImg" alt="Imagem em tela cheia" />
    </div>

        <!-- Configura caminho absoluto para o fragmento do examSetup -->
        <script>
            window.SIMULADOS_CONFIG = Object.assign({}, window.SIMULADOS_CONFIG || {}, {
                EXAM_SETUP_PATH: '/pages/examSetup.html'
            });
        </script>
        <!-- DOMPurify for XSS protection -->
        <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
        <!-- Sanitization utilities -->
        <script src="./utils/sanitize.js"></script>
        <!-- Script global do app (necess√°rio para abrir o examSetup modal) -->
        <script src="./script.js" onerror="(function(){var s=document.createElement('script');s.src='./assets/build/script.js';document.body.appendChild(s);}())"></script>
        <!-- Load reusable full exam confirmation modal component -->
        <script>
            (function(){
                async function loadFullExamConfirm(){
                    try {
                        const resp = await fetch('./components/fullExamConfirm.html');
                        if (!resp.ok) return;
                        const html = await resp.text();
                        const wrap = document.createElement('div');
                        wrap.innerHTML = html;
                        const el = wrap.firstElementChild;
                        if (el) document.body.appendChild(el);
                    } catch(e){ /* ignore */ }
                }
                if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', loadFullExamConfirm); else loadFullExamConfirm();

                // Small helper mirroring examSetup's API
                window.showFullExamConfirm = function(onProceed){
                    try {
                        const modal = document.getElementById('fullExamConfirmModal');
                        const proceedBtn = document.getElementById('fullExamProceed');
                        const cancelBtn = document.getElementById('fullExamCancel');
                        if (!modal || !proceedBtn || !cancelBtn) return false;
                        modal.style.display = 'flex';
                        modal.setAttribute('aria-hidden','false');
                        const close = ()=>{ modal.style.display = 'none'; modal.setAttribute('aria-hidden','true'); };
                        cancelBtn.onclick = ()=>{ close(); };
                        proceedBtn.onclick = ()=>{ try{ close(); }catch(_){}; if (typeof onProceed==='function') onProceed(); };
                        return true;
                    } catch(_){ return false; }
                };
                // Toast helper (supports centered positioning)
                // Usage:
                //  - showToast('Mensagem')
                //  - showToast('Mensagem', 2000)
                //  - showToast('Mensagem', 2000, true) // center
                //  - showToast('Mensagem', 2000, { center:true })
                //  - showToast('Mensagem', 2000, { position:'center' })
                window.showToast = function(msg, ms, opts){
                    try {
                        const el = document.getElementById('toast');
                        if (!el) return;
                        const duration = (typeof ms === 'number' && ms > 0) ? ms : 2600;
                        const center = (opts === true) || (opts && (opts.center === true || opts.position === 'center'));

                        // cache original positioning once
                        if (!el.__posCached) {
                            el.__posCached = true;
                            el.__origRight = el.style.right;
                            el.__origBottom = el.style.bottom;
                            el.__origLeft = el.style.left;
                            el.__origTop = el.style.top;
                            el.__origTransform = el.style.transform;
                            el.__origMaxWidth = el.style.maxWidth;
                        }

                        if (center) {
                            el.style.left = '50%';
                            el.style.top = '50%';
                            el.style.right = 'auto';
                            el.style.bottom = 'auto';
                            el.style.transform = 'translate(-50%, -50%)';
                            el.style.maxWidth = '80vw';
                            el.style.textAlign = 'center';
                        } else {
                            el.style.right = el.__origRight || '14px';
                            el.style.bottom = el.__origBottom || '14px';
                            el.style.left = el.__origLeft || '';
                            el.style.top = el.__origTop || '';
                            el.style.transform = el.__origTransform || '';
                            el.style.maxWidth = el.__origMaxWidth || '240px';
                            el.style.textAlign = '';
                        }

                        el.textContent = msg || '';
                        el.style.display = 'block';
                        clearTimeout(window.__toastTimer);
                        window.__toastTimer = setTimeout(()=>{ try{ el.style.display='none'; }catch(_){ } }, duration);
                    } catch(_){ }
                };
            })();
        </script>

        <script>
            (function(){
                async function applyFeatureFlags(){
                    try {
                        const el = document.getElementById('card-insights-ia');
                        if (!el) return;
                        const base = ((window.SIMULADOS_CONFIG && window.SIMULADOS_CONFIG.BACKEND_BASE) || 'http://localhost:3000').replace(/\/$/,'');
                        const cfg = await fetch(base + '/api/meta/config', { cache: 'no-store', credentials: 'include' })
                            .then(r => r.ok ? r.json() : null)
                            .catch(() => null);
                        if (cfg && cfg.ollamaEnabled === false) {
                            el.style.display = 'none';
                        } else if (cfg && cfg.ollamaEnabled === true) {
                            el.style.display = '';
                        }
                    } catch(_e) {}
                }

                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', applyFeatureFlags);
                } else {
                    applyFeatureFlags();
                }
            })();
        </script>

        <!-- Load and mount PassProbability component below lastExamResults -->
        <script>
            (function(){
                async function loadPassProbability(){
                    try {
                        const mount = document.getElementById('passProbabilityContainer');
                        if (!mount) return;
                        const resp = await fetch('./components/PassProbability.html', { cache: 'no-store' });
                        if (!resp.ok) return;
                        const html = await resp.text();
                        mount.innerHTML = html;
                        // Execute embedded scripts from fragment
                        try {
                            const scripts = Array.from(mount.querySelectorAll('script'));
                            for (const old of scripts){
                                const s = document.createElement('script');
                                if (old.src) s.src = old.src; else s.textContent = old.textContent || '';
                                document.body.appendChild(s);
                                old.remove();
                            }
                        } catch(_){ }
                        async function isPremiumUser(){
                            try {
                                // Fast path: localStorage BloqueioAtivado already synced by script.js
                                const lsVal = (localStorage.getItem('BloqueioAtivado') || '').trim();
                                if (lsVal === 'true') return false;
                                if (lsVal === 'false') return true;

                                const token = (localStorage.getItem('sessionToken') || '').trim();
                                const nomeUsuario = (localStorage.getItem('nomeUsuario') || '').trim();
                                const identity = (token || nomeUsuario).trim();
                                if (!identity) return false;

                                const jwtTok = (localStorage.getItem('jwtToken')||'').trim();
                                const jwtType = (localStorage.getItem('jwtTokenType')||'Bearer').trim()||'Bearer';
                                const headers = { 'Accept':'application/json' };
                                headers['X-Session-Token'] = identity;
                                if (jwtTok) headers['Authorization'] = `${jwtType} ${jwtTok}`;

                                const r = await fetch('/api/users/me', { method:'GET', headers, credentials:'include' });
                                if (!r.ok) return false;
                                const data = await r.json().catch(()=>null);
                                const isPremium = !!(data && data.BloqueioAtivado === false);
                                try { localStorage.setItem('BloqueioAtivado', String(Boolean(data && data.BloqueioAtivado))); } catch(_){ }
                                return isPremium;
                            } catch(_){
                                return false;
                            }
                        }

                        // Make the whole component clickable to open Indicadores -> Probabilidade de Sucesso
                        try {
                            mount.style.cursor = 'pointer';
                            mount.addEventListener('click', async function(e){
                                try { if (e) { e.preventDefault(); e.stopPropagation(); if (e.stopImmediatePropagation) e.stopImmediatePropagation(); } } catch(_){ }
                                try {
                                    const okPremium = await isPremiumUser();
                                    if (!okPremium) {
                                        try { window.showToast && window.showToast('Somente para usu√°rio premium', 2400, { center: true }); } catch(_){ }
                                        return;
                                    }
                                } catch(_){
                                    try { window.showToast && window.showToast('Somente para usu√°rio premium', 2400, { center: true }); } catch(_){ }
                                    return;
                                }
                                try {
                                    // Prefer using the existing sidebar navigation (loads into main.content)
                                    try {
                                        var link = document.querySelector('#sidebarIndicadoresAccordion a[href*="tab=prob"]');
                                        if (link && typeof link.click === 'function') { link.click(); return; }
                                    } catch(_){ }

                                    // Fallback: persist nav state + load directly if available
                                    try {
                                        sessionStorage.setItem('currentSection', 'indicadores');
                                        sessionStorage.setItem('currentSubsection', 'prob');
                                    } catch(_){ }

                                    if (typeof window.loadIndicadoresIntoSection === 'function' && document.getElementById('indicadores')) {
                                        window.loadIndicadoresIntoSection('prob');
                                        try { document.getElementById('indicadores').scrollIntoView({ behavior:'smooth', block:'start' }); } catch(_){ }
                                        return;
                                    }

                                    // Last-resort: stay in index (do not redirect to Indicadores.html)
                                    (window.top || window).location.assign('/index.html');
                                } catch(_) {
                                    try {
                                        sessionStorage.setItem('currentSection', 'indicadores');
                                        sessionStorage.setItem('currentSubsection', 'prob');
                                    } catch(_){ }
                                    (window.top || window).location.assign('/index.html');
                                }
                            });
                        } catch(_){ }
                    } catch(_){ }
                }
                if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', loadPassProbability); else loadPassProbability();
            })();
        </script>

        <!-- Load and mount lastExamResults component at the top of Home -->
        <script>
            (function(){
                async function loadLastExamResults(){
                    try {
                        const mount = document.getElementById('lastExamResultsMount');
                        if (!mount) return;
                        const resp = await fetch('./components/lastExamResults.html', { cache: 'no-store' });
                        if (!resp.ok) return;
                        const html = await resp.text();
                        // Inject HTML and ensure embedded <script> runs (innerHTML doesn't execute scripts)
                        mount.innerHTML = html;
                        (function executeScripts(container){
                            try {
                                const scripts = Array.from(container.querySelectorAll('script'));
                                for (const old of scripts){
                                    const s = document.createElement('script');
                                    if (old.src) s.src = old.src; else s.textContent = old.textContent || '';
                                    // keep execution order by appending sequentially
                                    document.body.appendChild(s);
                                    old.remove();
                                }
                            } catch(_){ }
                        })(mount);

                        const host = mount.querySelector('.ler-card');
                        if (host && window.initLastExamResults){
                            // Attempt to fetch last attempt summary from backend
                            const base = (window.SIMULADOS_CONFIG && window.SIMULADOS_CONFIG.BACKEND_BASE) || 'http://localhost:3000';
                            let applied = false;
                            try {
                                const buildHeaders = () => {
                                    let h = {};
                                    try {
                                        const jwtTok = (localStorage.getItem('jwtToken')||'').trim();
                                        const jwtType = (localStorage.getItem('jwtTokenType')||'Bearer').trim()||'Bearer';
                                        const sessionTok = (localStorage.getItem('sessionToken')||'').trim();
                                        if (jwtTok) h['Authorization'] = jwtType + ' ' + jwtTok;
                                        if (sessionTok) h['X-Session-Token'] = sessionTok;
                                    } catch(_){ }
                                    return h;
                                };
                                const sessionPresent = (localStorage.getItem('sessionToken')||'').trim();
                                if (sessionPresent) {
                                    const url = base.replace(/\/$/, '') + '/api/exams/last';
                                    const r = await fetch(url, { headers: buildHeaders(), credentials: 'include' });
                                    if (r.status === 200) {
                                        const data = await r.json();
                                        if (data && typeof data === 'object' && data.total > 0) {
                                            const v = Number(data.correct || 0);
                                            const m = Number(data.total || 0);
                                            window.initLastExamResults(host, { value: v, max: m });
                                            // Show finished date, percent and duration if available
                                            try {
                                                const dateEl = host.querySelector('.ler-date');
                                                const pctEl = host.querySelector('.ler-percent');
                                                const durTxt = host.querySelector('.ler-dur .dur-text');
                                                const fmtDate = (iso)=>{ try{ const d=new Date(iso); if(isNaN(d)) return ''; return d.toLocaleString('pt-BR',{ day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'}); }catch(_){ return ''; } };
                                                const fmtDur = (sec)=>{ try{ sec=Math.max(0,Number(sec)||0); const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60); if(h>0) return `${h}h ${String(m).padStart(2,'0')}m`; return `${m}m`; }catch(_){ return ''; } };
                                                if (pctEl){ const pct = Number.isFinite(data.scorePercent) ? Math.round(Number(data.scorePercent)) : (m>0? Math.round((v*100)/m):0); pctEl.textContent = `(${pct}%)`; }
                                                if (dateEl && data.finishedAt){ const s = fmtDate(data.finishedAt); if (s) dateEl.textContent = s; }
                                                if (durTxt && (data.durationSeconds!=null)){ const s = fmtDur(data.durationSeconds); if (s) durTxt.textContent = s; }
                                            } catch(_){ }
                                            try { localStorage.setItem('lastExamValue', String(v)); localStorage.setItem('lastExamMax', String(m)); } catch(_){ }
                                            try { if (data && data.finishedAt) localStorage.setItem('lastExamFinishedAt', String(data.finishedAt)); } catch(_){ }
                                            try { if (data && data.durationSeconds!=null) localStorage.setItem('lastExamDurationSec', String(data.durationSeconds)); } catch(_){ }
                                            applied = true;
                                        }
                                    } else if (r.status === 204) {
                                        // No attempts yet; fall back to local storage or default
                                    }
                                }
                            } catch(_){ /* ignore network errors */ }
                            // After attempting single summary, fetch recent history to (a) gate by at least 3 FULL exams and (b) style background/icon using only FULL attempts
                            try {
                                const sessionPresent2 = (localStorage.getItem('sessionToken')||'').trim();
                                if (sessionPresent2){
                                    const url2 = base.replace(/\/$/, '') + '/api/exams/history?limit=10';
                                    const r2 = await fetch(url2 + (url2.includes('?') ? '&' : '?') + '_ts=' + Date.now(), { headers: buildHeaders(), cache: 'no-store', credentials: 'include' });
                                    if (r2.ok){
                                        const list = await r2.json();
                                        // Consider only FULL attempts for gating and calculations
                                        const full = Array.isArray(list) ? list.filter(x => x && String(x.examMode||'').toLowerCase() === 'full') : [];
                                        try {
                                            const dbg = {
                                                countAll: Array.isArray(list) ? list.length : -1,
                                                countFull: full.length,
                                                pctsFullTop3: full.slice(0,3).map(x => x && x.scorePercent),
                                                modesTop3: full.slice(0,3).map(x => x && x.examMode)
                                            };
                                            logger.debug('[gauge:lastExamResults] history debug', dbg);
                                        } catch(_){}
                                        const clearStyle = () => {
                                            try {
                                                const locked = mount && mount.dataset && mount.dataset.lerLocked;
                                                if (locked) { return; }
                                                // remove any previous thumb and clear mount/card backgrounds
                                                const oldThumb = host.querySelector('.ler-thumb');
                                                if (oldThumb && oldThumb.parentElement) oldThumb.parentElement.removeChild(oldThumb);
                                                try { mount.style.removeProperty('background'); } catch(_){ mount.style.background = ''; }
                                                try { host.style.removeProperty('background'); } catch(_){ host.style.background = ''; }
                                                mount.classList.remove('dark-perf');
                                                host.classList.remove('dark-perf');
                                                mount.classList.remove('perf-gt85');
                                                host.classList.remove('perf-gt85');
                                            } catch(_){ }
                                        };
                                        if (Array.isArray(full) && full.length >= 3){
                                            try {
                                                const titleEl = host.querySelector('.ler-text');
                                                if (titleEl) titleEl.textContent = (window.SIMULADOS_I18N && window.SIMULADOS_I18N.LAST_EXAM_TITLE) || '√öltimo exame';
                                            } catch(_){ }
                                            const pcts = full.slice(0,3).map(x => Number(x && x.scorePercent));
                                            const valid = pcts.every(x => Number.isFinite(x));
                                            if (valid){
                                                const allLt70 = pcts.every(x => x < 70);
                                                const allGte70Lt75 = pcts.every(x => x >= 70 && x < 75);
                                                const allGt85 = pcts.every(x => x > 85);
                                                const allGt75 = pcts.every(x => x > 75);
                                                try { logger.debug('[gauge:lastExamResults] branch', { pcts, allLt70, allGte70Lt75, allGt75, allGt85 }); } catch(_){}
                                                // Clear previous thumb if any
                                                const header = host.querySelector('.ler-header');
                                                const kpi = host.querySelector('.ler-icon');
                                                clearStyle();
                                                if (allGt85){
                                                    // Novo: >85% -> verde profundo com degrad√™ (#0A7A0A -> #006400) + rosto feliz verde
                                                    const grad = 'linear-gradient(90deg, #0A7A0A 0%, #006400 100%)';
                                                    try { if (mount && mount.dataset) mount.dataset.lerLocked = 'gt85'; } catch(_){}
                                                    // Global style lock to out-spec any external overrides
                                                    try {
                                                        let lock = document.getElementById('ler-style-lock');
                                                        if (!lock){
                                                            lock = document.createElement('style');
                                                            lock.id = 'ler-style-lock';
                                                            lock.textContent = [
                                                                '/* Strong lock for >85% state */',
                                                                '#lastExamResultsMount.perf-gt85,',
                                                                '#lastExamResultsMount.perf-gt85 .ler-card,',
                                                                '.ler-card.perf-gt85,',
                                                                '#home #lastExamResultsMount.perf-gt85,',
                                                                '#home #lastExamResultsMount.perf-gt85 .ler-card,',
                                                                '#home .ler-card.perf-gt85 {',
                                                                '  background-image: linear-gradient(90deg, #0A7A0A 0%, #006400 100%) !important;',
                                                                '  background-color: #0A7A0A !important;',
                                                                '  -webkit-background-clip: padding-box !important;',
                                                                '  background-clip: padding-box !important;',
                                                                '}',
                                                                '#lastExamResultsMount.dark-perf .ler-text, .ler-card.dark-perf .ler-text { color: #ECFDF5 !important; }',
                                                            ].join('\n');
                                                            document.head.appendChild(lock);
                                                        }
                                                    } catch(_){}
                                                    // Ensure a background layer inside the card to guarantee visibility
                                                    try {
                                                        let bg = host.querySelector('.ler-bg');
                                                        if (!bg) {
                                                            bg = document.createElement('div');
                                                            bg.className = 'ler-bg';
                                                            bg.style.cssText = 'position:absolute;inset:0;z-index:0;pointer-events:none;border-radius:10px;';
                                                            host.insertBefore(bg, host.firstChild);
                                                        }
                                                        bg.style.setProperty('background', grad, 'important');
                                                        bg.style.setProperty('backgroundImage', grad, 'important');
                                                    } catch(_){}
                                                    try { mount.style.setProperty('background', grad, 'important'); } catch(_){ mount.style.background = grad; }
                                                    try { host.style.setProperty('background', grad, 'important'); } catch(_){ host.style.background = grad; }
                                                    // Also set background-image and background-color to defeat overrides
                                                    try { mount.style.setProperty('background-image', grad, 'important'); } catch(_){ }
                                                    try { host.style.setProperty('background-image', grad, 'important'); } catch(_){ }
                                                    try { mount.style.setProperty('background-color', '#0A7A0A', 'important'); } catch(_){ }
                                                    try { host.style.setProperty('background-color', '#0A7A0A', 'important'); } catch(_){ }
                                                    try { logger.debug('[gauge:lastExamResults] applied perf-gt85', { background: grad }); } catch(_){}
                                                    mount.classList.add('perf-gt85');
                                                    host.classList.add('perf-gt85');
                                                    mount.classList.add('dark-perf');
                                                    host.classList.add('dark-perf');
                                                    // Reafirma estilos ap√≥s pr√≥ximo tick para evitar resets ocasionais
                                                    try {
                                                        setTimeout(() => {
                                                            try { mount.style.setProperty('background', grad, 'important'); } catch(_){ mount.style.background = grad; }
                                                            try { host.style.setProperty('background', grad, 'important'); } catch(_){ host.style.background = grad; }
                                                            try { mount.style.setProperty('background-image', grad, 'important'); } catch(_){ }
                                                            try { host.style.setProperty('background-image', grad, 'important'); } catch(_){ }
                                                            try { mount.style.setProperty('background-color', '#0A7A0A', 'important'); } catch(_){ }
                                                            try { host.style.setProperty('background-color', '#0A7A0A', 'important'); } catch(_){ }
                                                            mount.classList.add('perf-gt85','dark-perf');
                                                            host.classList.add('perf-gt85','dark-perf');
                                                            try {
                                                                const cm = window.getComputedStyle(mount);
                                                                const ch = window.getComputedStyle(host);
                                                                logger.debug('[gauge:lastExamResults] lock perf-gt85 background reapplied', { mountBg: cm.backgroundImage||cm.background, hostBg: ch.backgroundImage||ch.background });
                                                            } catch(_){ logger.debug('[gauge:lastExamResults] lock perf-gt85 background reapplied'); }
                                                        }, 0);
                                                    } catch(_){}
                                                    // Observa mudan√ßas e reaplica por alguns segundos, caso algo limpe estilos
                                                    try {
                                                        const startTs = Date.now();
                                                        const observer = new MutationObserver(() => {
                                                            const elapsed = Date.now() - startTs;
                                                            if (elapsed > 5000) { try { observer.disconnect(); } catch(_){} return; }
                                                            const mbg = mount.style.background || '';
                                                            const hbg = host.style.background || '';
                                                            const needMount = !/0A7A0A|006400/.test(mbg);
                                                            const needHost = !/0A7A0A|006400/.test(hbg);
                                                            if (needMount) { try { mount.style.setProperty('background', grad, 'important'); } catch(_){ mount.style.background = grad; } }
                                                            if (needHost) { try { host.style.setProperty('background', grad, 'important'); } catch(_){ host.style.background = grad; } }
                                                            try { mount.style.setProperty('background-image', grad, 'important'); } catch(_){ }
                                                            try { host.style.setProperty('background-image', grad, 'important'); } catch(_){ }
                                                            try { mount.style.setProperty('background-color', '#0A7A0A', 'important'); } catch(_){ }
                                                            try { host.style.setProperty('background-color', '#0A7A0A', 'important'); } catch(_){ }
                                                            mount.classList.add('perf-gt85','dark-perf');
                                                            host.classList.add('perf-gt85','dark-perf');
                                                        });
                                                        observer.observe(mount, { attributes: true, attributeFilter: ['style','class'] });
                                                        observer.observe(host, { attributes: true, attributeFilter: ['style','class'] });
                                                    } catch(_){}
                                                    if (header && kpi){
                                                        const span = document.createElement('span');
                                                        span.className = 'ler-thumb';
                                                        span.setAttribute('aria-label','Excelente desempenho');
                                                        span.style.cssText = 'display:inline-flex;align-items:center;justify-content:center;line-height:1;margin-right:6px;';
                                                        span.innerHTML = '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><circle cx="12" cy="12" r="9" stroke="#FFFFFF" stroke-width="2"/><path d="M8 14s1.5 2 4 2 4-2 4-2" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M9 10h.01M15 10h.01" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                                                        header.insertBefore(span, kpi);
                                                    }
                                                } else if (allGte70Lt75){
                                                    const grad = 'linear-gradient(90deg, #FFF7ED 0%, #FED7AA 100%)'; // light orange
                                                    try { if (mount && mount.dataset) mount.dataset.lerLocked = '70_74'; } catch(_){}
                                                    try { mount.style.setProperty('background', grad, 'important'); } catch(_){ mount.style.background = grad; }
                                                    try { host.style.setProperty('background', grad, 'important'); } catch(_){ host.style.background = grad; }
                                                    try { mount.style.setProperty('background-image', grad, 'important'); } catch(_){}
                                                    try { host.style.setProperty('background-image', grad, 'important'); } catch(_){}
                                                    try { logger.debug('[gauge:lastExamResults] applied 70-74', { background: grad }); } catch(_){}
                                                    mount.classList.remove('dark-perf');
                                                    host.classList.remove('dark-perf');
                                                } else if (allLt70){
                                                    const grad = 'linear-gradient(90deg, #FEE2E2 0%, #FCA5A5 100%)'; // red
                                                    try { if (mount && mount.dataset) mount.dataset.lerLocked = 'lt70'; } catch(_){}
                                                    try { mount.style.setProperty('background', grad, 'important'); } catch(_){ mount.style.background = grad; }
                                                    try { host.style.setProperty('background', grad, 'important'); } catch(_){ host.style.background = grad; }
                                                    try { mount.style.setProperty('background-image', grad, 'important'); } catch(_){}
                                                    try { host.style.setProperty('background-image', grad, 'important'); } catch(_){}
                                                    try { logger.debug('[gauge:lastExamResults] applied <70', { background: grad }); } catch(_){}
                                                    mount.classList.remove('dark-perf');
                                                    host.classList.remove('dark-perf');
                                                    if (header && kpi){
                                                        const span = document.createElement('span');
                                                        span.className = 'ler-thumb';
                                                        span.setAttribute('aria-label','Desempenho baixo');
                                                        span.style.cssText = 'display:inline-flex;align-items:center;justify-content:center;line-height:1;margin-right:6px;';
                                                        span.innerHTML = '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M10 3h6.25c.69 0 1.25.56 1.25 1.25v7.5c0 .69-.56 1.25-1.25 1.25H13l.38 1.9.02.21c0 .27-.11.52-.29.71L12.5 18l-3.4-3.4A1.25 1.25 0 0 1 8.5 13V4.25C8.5 3.56 9.06 3 9.75 3H10Z" stroke="#b91c1c" stroke-width="1.8" stroke-linejoin="round"/><path d="M5 3v10" stroke="#b91c1c" stroke-width="1.8" stroke-linecap="round"/></svg>';
                                                        header.insertBefore(span, kpi);
                                                    }
                                                } else if (allGt75){
                                                    const grad = 'linear-gradient(90deg, #66E166 0%, #32CD32 100%)'; // medium green gradient for 75-85%
                                                    try { if (mount && mount.dataset) mount.dataset.lerLocked = '75_85'; } catch(_){}
                                                    try { mount.style.setProperty('background', grad, 'important'); } catch(_){ mount.style.background = grad; }
                                                    try { host.style.setProperty('background', grad, 'important'); } catch(_){ host.style.background = grad; }
                                                    try { mount.style.setProperty('background-image', grad, 'important'); } catch(_){}
                                                    try { host.style.setProperty('background-image', grad, 'important'); } catch(_){}
                                                    try { logger.debug('[gauge:lastExamResults] applied 75-85', { background: grad }); } catch(_){}
                                                    mount.classList.add('dark-perf');
                                                    host.classList.add('dark-perf');
                                                     if (header && kpi){
                                                         const span = document.createElement('span');
                                                         span.className = 'ler-thumb';
                                                         span.setAttribute('aria-label','Bom desempenho');
                                                         span.style.cssText = 'display:inline-flex;align-items:center;justify-content:center;line-height:1;margin-right:6px;';
                                                         span.innerHTML = '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M10 21h6.25c.69 0 1.25-.56 1.25-1.25v-7.5c0-.69-.56-1.25-1.25-1.25H13l.38-1.9.02-.21c0-.27-.11-.52-.29-.71L12.5 6l-3.4 3.4c-.22.22-.35.52-.35.83v6.77c0 .69.56 1.25 1.25 1.25H10Z" stroke="#10b981" stroke-width="1.8" stroke-linejoin="round"/><path d="M5 21V11" stroke="#10b981" stroke-width="1.8" stroke-linecap="round"/></svg>';
                                                         header.insertBefore(span, kpi);
                                                     }
                                                } else {
                                                    // Not strictly matching any rule -> ensure no styling is applied
                                                    clearStyle();
                                                    mount.classList.remove('dark-perf');
                                                    host.classList.remove('dark-perf');
                                                    try { if (mount && mount.dataset) delete mount.dataset.lerLocked; } catch(_){}
                                                }

                                                // Override gauge numbers with the most recent FULL attempt
                                                try {
                                                    const top = full[0];
                                                                                                        if (top && window.initLastExamResults){
                                                        const v = Number(top.correct || 0);
                                                        const m = Number(top.total || 0);
                                                        window.initLastExamResults(host, { value: v, max: m });
                                                        try { logger.debug('[gauge:lastExamResults] set gauge from last FULL', { value: v, max: m, pct: m>0 ? Math.round((v*100)/m) : null }); } catch(_){}
                                                                                                                // Ensure help hidden and values visible when showing data
                                                                                                                try {
                                                                                                                    const help = host.querySelector('.ler-help'); if (help) help.style.display='none';
                                                                                                                    const vals = host.querySelector('.ler-vals'); if (vals) vals.style.display='inline';
                                                                                                                } catch(_){ }
                                                        const dateEl = host.querySelector('.ler-date');
                                                        const pctEl = host.querySelector('.ler-percent');
                                                        const durTxt = host.querySelector('.ler-dur .dur-text');
                                                        const fmtDate = (iso)=>{ try{ const d=new Date(iso); if(isNaN(d)) return ''; return d.toLocaleString('pt-BR',{ day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'}); }catch(_){ return ''; } };
                                                        const fmtDur = (sec)=>{ try{ sec=Math.max(0,Number(sec)||0); const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60); if(h>0) return `${h}h ${String(m).padStart(2,'0')}m`; return `${m}m`; }catch(_){ return ''; } };
                                                        if (pctEl){ const pct = Number.isFinite(top.scorePercent) ? Math.round(Number(top.scorePercent)) : (m>0? Math.round((v*100)/m):0); pctEl.textContent = `(${pct}%)`; }
                                                        if (dateEl && top.finishedAt){ const s = fmtDate(top.finishedAt); if (s) dateEl.textContent = s; }
                                                        if (durTxt && (top.durationSeconds!=null)){ const s = fmtDur(top.durationSeconds); if (s) durTxt.textContent = s; }
                                                    }
                                                } catch(_){ }
                                            } else {
                                                // Some percent missing/invalid -> ensure rule is not applied
                                                clearStyle();
                                                mount.classList.remove('dark-perf');
                                                host.classList.remove('dark-perf');
                                                try { if (mount && mount.dataset) delete mount.dataset.lerLocked; } catch(_){}
                                            }
                                        } else {
                                            // Less than 3 FULL attempts -> show neutral card and update title
                                            clearStyle();
                                            mount.classList.remove('dark-perf');
                                            host.classList.remove('dark-perf');
                                            try { if (mount && mount.dataset) delete mount.dataset.lerLocked; } catch(_){}
                                                                                        try {
                                              const titleEl = host.querySelector('.ler-text');
                                              if (titleEl) titleEl.textContent = (window.SIMULADOS_I18N && window.SIMULADOS_I18N.WAITING_FULL_EXAMS_TITLE) || 'Aguardando exames completos';
                                              const gaugeTxt = host.querySelector('.ler-gauge text'); if (gaugeTxt) gaugeTxt.textContent = '--%';
                                              const scoreEl = host.querySelector('.ler-score'); if (scoreEl) scoreEl.textContent = '‚Äî / ‚Äî';
                                              const pctEl = host.querySelector('.ler-percent'); if (pctEl) pctEl.textContent = '(‚Äî%)';
                                              const dateEl = host.querySelector('.ler-date'); if (dateEl) dateEl.textContent = '';
                                              const durTxt = host.querySelector('.ler-dur .dur-text'); if (durTxt) durTxt.textContent = '';
                                                                                            const help = host.querySelector('.ler-help'); if (help) { help.textContent = (window.SIMULADOS_I18N && window.SIMULADOS_I18N.HELP_NEED_3_FULL) || help.textContent || ''; help.style.display='inline'; }
                                                                                            const vals = host.querySelector('.ler-vals'); if (vals) vals.style.display='none';
                                            } catch(_){ }
                                            // Ensure the widget stays visible (no placeholders, just the waiting message)
                                            mount.style.display = '';
                                        }
                                    }
                                }
                            } catch(_){ /* silent */ }
                            // Final safeguard: if >85% was detected earlier, reassert styles after gauge and content updates
                            try {
                                const mount = document.getElementById('lastExamResultsMount');
                                const host2 = mount && mount.querySelector('.ler-card');
                                const hasPerf = mount && (mount.classList.contains('perf-gt85') || (mount.dataset && mount.dataset.lerLocked === 'gt85'));
                                if (mount && host2 && hasPerf) {
                                    const grad = 'linear-gradient(90deg, #0A7A0A 0%, #006400 100%)';
                                    mount.style.setProperty('background', grad, 'important');
                                    host2.style.setProperty('background', grad, 'important');
                                    mount.style.setProperty('background-image', grad, 'important');
                                    host2.style.setProperty('background-image', grad, 'important');
                                    mount.style.setProperty('background-color', '#0A7A0A', 'important');
                                    host2.style.setProperty('background-color', '#0A7A0A', 'important');
                                    mount.classList.add('dark-perf'); host2.classList.add('dark-perf');
                                    try {
                                        const cm = window.getComputedStyle(mount);
                                        const ch = window.getComputedStyle(host2);
                                        logger.debug('[gauge:lastExamResults] final lock', { mountBg: cm.backgroundImage||cm.background, hostBg: ch.backgroundImage||ch.background });
                                    } catch(_){}
                                }
                            } catch(_){}
                            if (!applied){
                                let v = null, m = null;
                                try { const vv = localStorage.getItem('lastExamValue'); if (vv != null) v = Number(vv); } catch(_){ }
                                try { const mm = localStorage.getItem('lastExamMax'); if (mm != null) m = Number(mm); } catch(_){ }
                                if (isFinite(v) && isFinite(m) && m > 0){
                                    window.initLastExamResults(host, { value: v, max: m });
                                    try {
                                        const dateEl = host.querySelector('.ler-date');
                                        const pctEl = host.querySelector('.ler-percent');
                                        const durTxt = host.querySelector('.ler-dur .dur-text');
                                        const iso = localStorage.getItem('lastExamFinishedAt');
                                        const fmtDate = (x)=>{ try{ const d=new Date(x); if(isNaN(d)) return ''; return d.toLocaleString('pt-BR',{ day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'}); }catch(_){ return ''; } };
                                        const fmtDur = (sec)=>{ try{ sec=Math.max(0,Number(sec)||0); const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60); if(h>0) return `${h}h ${String(m).padStart(2,'0')}m`; return `${m}m`; }catch(_){ return ''; } };
                                        if (pctEl){ const pct = m>0? Math.round((v*100)/m):0; pctEl.textContent = `(${pct}%)`; }
                                        if (dateEl && iso){ const s = fmtDate(iso); if (s) dateEl.textContent = s; }
                                        const dsec = localStorage.getItem('lastExamDurationSec');
                                        if (durTxt && dsec!=null){ const s = fmtDur(dsec); if (s) durTxt.textContent = s; }
                                    } catch(_){ }
                                } else {
                                    window.initLastExamResults(host, { value: 0, max: 100 });
                                }
                            }
                        }
                    } catch(_){ }
                }
                if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', loadLastExamResults); else loadLastExamResults();
            })();
        </script>

        

    <!-- Admin Modal -->
    <div id="adminModal" class="overlay" aria-hidden="true" style="background:rgba(0,0,0,0.75);align-items:flex-start;padding-top:20px;overflow-y:auto">
        <div style="background:var(--panel);border-radius:12px;max-width:500px;width:90%;margin:0 auto;padding:24px;box-shadow:0 12px 40px rgba(0,0,0,0.4);color:var(--text)">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
                <h2 style="margin:0;font-size:1.4rem;color:var(--text)">Administra√ß√£o</h2>
                <div style="display:flex;align-items:center;gap:10px">
                    <a id="lnkAdminChatHostModal" href="/chat/admin" target="_blank" rel="noopener noreferrer" style="display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);text-decoration:none;font-size:.85rem;font-weight:600;cursor:pointer;">Chat (Admin)</a>
                    <button id="adminModalClose" style="background:none;border:none;font-size:1.8rem;color:var(--muted);cursor:pointer;padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center" aria-label="Fechar">√ó</button>
                </div>
            </div>

            <!-- Accordion: Health Check (on-demand) -->
            <div class="admin-accordion" id="adminHealthAccordion" style="border:1px solid var(--border);border-radius:8px;margin-bottom:12px;overflow:hidden">
                <button class="admin-accordion-header" style="width:100%;display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:var(--bg);border:none;cursor:pointer;transition:background .2s">
                    <span style="font-size:1rem;font-weight:600;color:var(--text)">Health check</span>
                    <svg class="admin-accordion-chevron" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="transition:transform .3s;color:var(--muted)">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
                <div class="admin-accordion-content" style="display:none;padding:16px">
                    <p style="font-size:0.9rem;color:var(--muted);margin:0 0 12px;line-height:1.5">Diagn√≥stico de sess√£o/admin (RBAC + headers).</p>
                    <div style="display:flex;gap:10px;flex-wrap:wrap">
                        <button id="adminHealthCheckBtn" type="button" style="flex:1;min-width:220px;padding:10px;background:var(--primary);color:#fff;border:none;border-radius:6px;font-size:0.95rem;font-weight:600;cursor:pointer;transition:background .15s" onmouseover="this.style.background='var(--primary-press)'" onmouseout="this.style.background='var(--primary)'">Rodar Health Check</button>
                        <button id="adminHealthCopyBtn" type="button" style="flex:1;min-width:220px;padding:10px;background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:6px;font-size:0.95rem;font-weight:600;cursor:pointer;transition:background .15s">Copiar resultado</button>
                    </div>
                    <div id="adminHealthCheckOutput" style="margin-top:12px;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;font-family:monospace;font-size:0.8rem;color:var(--text);max-height:240px;overflow-y:auto;display:none;white-space:pre-wrap"></div>
                </div>
            </div>
            
            <!-- Accordion: Reconcilia√ß√£o de Estat√≠sticas -->
            <div class="admin-accordion" style="border:1px solid var(--border);border-radius:8px;margin-bottom:12px;overflow:hidden">
                <button class="admin-accordion-header" style="width:100%;display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:var(--bg);border:none;cursor:pointer;transition:background .2s">
                    <span style="font-size:1rem;font-weight:600;color:var(--text)">üìä Reconcilia√ß√£o de Estat√≠sticas</span>
                    <svg class="admin-accordion-chevron" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="transition:transform .3s;color:var(--muted)">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
                <div class="admin-accordion-content" style="display:none;padding:16px">
                <p style="font-size:0.9rem;color:var(--muted);margin:0 0 16px;line-height:1.5">Reconstruir ou corrigir as estat√≠sticas agregadas de tentativas de exames.</p>
                
                <div style="display:grid;gap:12px;margin-bottom:16px">
                    <div>
                        <label for="reconcileFromDate" style="display:block;font-size:0.85rem;color:var(--muted);margin-bottom:4px">Data Inicial</label>
                        <input type="date" id="reconcileFromDate" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:0.9rem" />
                    </div>
                    <div>
                        <label for="reconcileToDate" style="display:block;font-size:0.85rem;color:var(--muted);margin-bottom:4px">Data Final</label>
                        <input type="date" id="reconcileToDate" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:0.9rem" />
                    </div>
                    <div>
                        <label for="reconcileMode" style="display:block;font-size:0.85rem;color:var(--muted);margin-bottom:4px">Modo</label>
                        <select id="reconcileMode" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:0.9rem">
                            <option value="rebuild">Rebuild (sobrescrever)</option>
                            <option value="merge">Merge (incrementar)</option>
                        </select>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px">
                        <input type="checkbox" id="reconcileDryRun" style="width:18px;height:18px;cursor:pointer" />
                        <label for="reconcileDryRun" style="font-size:0.9rem;color:var(--text);cursor:pointer">Dry-run (simular sem alterar)</label>
                    </div>
                </div>
                
                <button id="reconcileBtn" style="width:100%;padding:10px;background:var(--primary);color:#fff;border:none;border-radius:6px;font-size:0.95rem;font-weight:600;cursor:pointer;transition:background .15s" onmouseover="this.style.background='var(--primary-press)'" onmouseout="this.style.background='var(--primary)'">Executar Reconcilia√ß√£o</button>
                
                <div id="reconcileOutput" style="margin-top:12px;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;font-family:monospace;font-size:0.8rem;color:var(--text);max-height:200px;overflow-y:auto;display:none;white-space:pre-wrap"></div>
            </div>

            <!-- Accordion: Gerar Tentativa Fixture -->
            <div class="admin-accordion" style="border:1px solid var(--border);border-radius:8px;margin-bottom:12px;overflow:hidden">
                <button class="admin-accordion-header" style="width:100%;display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:var(--bg);border:none;cursor:pointer;transition:background .2s">
                    <span style="font-size:1rem;font-weight:600;color:var(--text)">üîß Gerar Tentativa Fixture</span>
                    <svg class="admin-accordion-chevron" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="transition:transform .3s;color:var(--muted)">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
                <div class="admin-accordion-content" style="display:none;padding:16px">
                <p style="font-size:0.85rem;color:var(--muted);margin:0 0 14px;line-height:1.4">Cria uma tentativa finalizada diretamente no banco para testes. Pode especificar percentuais de desempenho por dom√≠nio (People, Process, Business). Os valores reais podem divergir levemente devido √† disponibilidade de quest√µes por dom√≠nio.</p>
                <form id="fixtureForm" style="display:grid;gap:10px;margin-bottom:12px">
                    <div style="display:flex;flex-direction:column;gap:4px">
                        <label for="fxUserId" style="font-size:0.75rem;color:var(--muted)">User ID *</label>
                        <input id="fxUserId" name="userId" type="number" min="1" required placeholder="ex: 123" style="padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:0.85rem" />
                    </div>
                    <div style="display:flex;flex-direction:column;gap:4px">
                        <label for="fxExamType" style="font-size:0.75rem;color:var(--muted)">Exam Type Slug</label>
                        <input id="fxExamType" name="examTypeSlug" type="text" value="pmp" placeholder="pmp" style="padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:0.85rem" />
                    </div>
                    <div style="display:flex;flex-direction:column;gap:4px">
                        <label for="fxTotal" style="font-size:0.75rem;color:var(--muted)">Total Quest√µes</label>
                        <input id="fxTotal" name="totalQuestions" type="number" min="1" max="500" value="180" style="padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:0.85rem" />
                    </div>
                    <div style="display:flex;flex-direction:column;gap:4px">
                        <label for="fxOverall" style="font-size:0.75rem;color:var(--muted)">% Geral *</label>
                        <input id="fxOverall" name="overallPct" type="number" min="0" max="100" value="65" required style="padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:0.85rem" />
                    </div>
                    <div style="display:flex;flex-direction:column;gap:4px">
                        <label for="fxPeople" style="font-size:0.75rem;color:var(--muted)">% People</label>
                        <input id="fxPeople" name="peoplePct" type="number" min="0" max="100" placeholder="opcional" style="padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:0.85rem" />
                    </div>
                    <div style="display:flex;flex-direction:column;gap:4px">
                        <label for="fxProcess" style="font-size:0.75rem;color:var(--muted)">% Process</label>
                        <input id="fxProcess" name="processPct" type="number" min="0" max="100" placeholder="opcional" style="padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:0.85rem" />
                    </div>
                    <div style="display:flex;flex-direction:column;gap:4px">
                        <label for="fxBusiness" style="font-size:0.75rem;color:var(--muted)">% Business</label>
                        <input id="fxBusiness" name="businessPct" type="number" min="0" max="100" placeholder="opcional" style="padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:0.85rem" />
                    </div>
                    <button type="submit" style="margin-top:4px;padding:10px;background:var(--primary);color:#fff;border:none;border-radius:6px;font-size:0.9rem;font-weight:600;cursor:pointer;transition:background .15s" onmouseover="this.style.background='var(--primary-press)'" onmouseout="this.style.background='var(--primary)'">Gerar Fixture</button>
                </form>
                <div id="fixtureOutput" style="display:none;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;font-family:monospace;font-size:0.75rem;color:var(--text);max-height:220px;overflow-y:auto;white-space:pre-wrap"></div>
            </div>

            <!-- Accordion: Vers√£o atual do exame (ECO) -->
            <div class="admin-accordion" style="border:1px solid var(--border);border-radius:8px;margin-bottom:12px;overflow:hidden">
                <button class="admin-accordion-header" style="width:100%;display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:var(--bg);border:none;cursor:pointer;transition:background .2s">
                    <span style="font-size:1rem;font-weight:600;color:var(--text)">üìö Vers√£o atual do exame (ECO)</span>
                    <svg class="admin-accordion-chevron" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="transition:transform .3s;color:var(--muted)">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
                <div class="admin-accordion-content" style="display:none;padding:16px">
                    <p style="font-size:0.85rem;color:var(--muted);margin:0 0 14px;line-height:1.4">
                        Define a vers√£o padr√£o do blueprint (ECO) por tipo de exame. Usu√°rios com compra espec√≠fica podem ter override por usu√°rio.
                    </p>
                    <div style="display:grid;gap:10px;margin-bottom:12px">
                        <div style="display:flex;flex-direction:column;gap:4px">
                            <label for="adminExamTypeSelect" style="font-size:0.75rem;color:var(--muted)">Tipo de Exame *</label>
                            <select id="adminExamTypeSelect" style="padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:0.85rem">
                                <option value="">Carregando...</option>
                            </select>
                        </div>
                        <div style="display:flex;flex-direction:column;gap:4px">
                            <label for="adminExamContentVersionSelect" style="font-size:0.75rem;color:var(--muted)">Vers√£o atual *</label>
                            <select id="adminExamContentVersionSelect" style="padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:0.85rem" disabled>
                                <option value="">Selecione um tipo de exame</option>
                            </select>
                        </div>
                        <button id="adminSetCurrentVersionBtn" type="button" style="margin-top:4px;padding:10px;background:var(--primary);color:#fff;border:none;border-radius:6px;font-size:0.9rem;font-weight:600;cursor:pointer;transition:background .15s" onmouseover="this.style.background='var(--primary-press)'" onmouseout="this.style.background='var(--primary)'">
                            Salvar vers√£o atual
                        </button>
                    </div>
                    <div id="adminExamContentVersionOutput" style="display:none;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;font-family:monospace;font-size:0.75rem;color:var(--text);max-height:220px;overflow-y:auto;white-space:pre-wrap"></div>
                </div>
            </div>

            <!-- Accordion: Override por Usu√°rio (compra) -->
            <div class="admin-accordion" style="border:1px solid var(--border);border-radius:8px;margin-bottom:12px;overflow:hidden">
                <button class="admin-accordion-header" style="width:100%;display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:var(--bg);border:none;cursor:pointer;transition:background .2s">
                    <span style="font-size:1rem;font-weight:600;color:var(--text)">üë§ Override por Usu√°rio (compra)</span>
                    <svg class="admin-accordion-chevron" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="transition:transform .3s;color:var(--muted)">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
                <div class="admin-accordion-content" style="display:none;padding:16px">
                    <p style="font-size:0.85rem;color:var(--muted);margin:0 0 14px;line-height:1.4">
                        Define uma vers√£o de ECO espec√≠fica para um usu√°rio (normalmente baseada na compra). Se removido, volta para a vers√£o vigente padr√£o.
                    </p>
                    <div style="display:grid;gap:10px;margin-bottom:12px">
                        <div style="display:flex;flex-direction:column;gap:6px">
                            <label for="adminUserSearchQuery" style="font-size:0.75rem;color:var(--muted)">Buscar usu√°rio</label>
                            <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
                                <input id="adminUserSearchQuery" type="text" placeholder="Digite nome, @usuario ou email" style="flex:1;min-width:220px;padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:0.85rem" />
                                <button id="adminUserSearchBtn" type="button" style="padding:10px 12px;background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:6px;font-size:0.9rem;font-weight:600;cursor:pointer">Buscar</button>
                            </div>
                            <select id="adminUserSearchSelect" style="padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:0.85rem" disabled>
                                <option value="">Digite acima e clique Buscar</option>
                            </select>
                            <div id="adminUserSearchStatus" style="font-size:0.72rem;color:var(--muted);min-height:1.1em"></div>
                        </div>
                        <div style="display:flex;flex-direction:column;gap:4px">
                            <label for="adminUserIdOverride" style="font-size:0.75rem;color:var(--muted)">User ID *</label>
                            <input id="adminUserIdOverride" type="number" min="1" placeholder="ex: 123" style="padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:0.85rem" />
                            <div id="adminUserIdOverrideHint" style="font-size:0.72rem;color:var(--muted);margin-top:4px;min-height:1.1em"></div>
                        </div>
                        <div style="display:flex;flex-direction:column;gap:4px">
                            <label for="adminUserExamTypeSelect" style="font-size:0.75rem;color:var(--muted)">Tipo de Exame *</label>
                            <select id="adminUserExamTypeSelect" style="padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:0.85rem">
                                <option value="">Carregando...</option>
                            </select>
                        </div>
                        <div style="display:flex;flex-direction:column;gap:4px">
                            <label for="adminUserExamContentVersionSelect" style="font-size:0.75rem;color:var(--muted)">Vers√£o ECO (override) *</label>
                            <select id="adminUserExamContentVersionSelect" style="padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:0.85rem" disabled>
                                <option value="">Selecione User ID + tipo de exame</option>
                            </select>
                        </div>
                        <div style="display:flex;gap:10px;flex-wrap:wrap">
                            <button id="adminSetUserOverrideBtn" type="button" style="flex:1;min-width:180px;margin-top:4px;padding:10px;background:var(--primary);color:#fff;border:none;border-radius:6px;font-size:0.9rem;font-weight:600;cursor:pointer;transition:background .15s" onmouseover="this.style.background='var(--primary-press)'" onmouseout="this.style.background='var(--primary)'">
                                Salvar override
                            </button>
                            <button id="adminClearUserOverrideBtn" type="button" style="flex:1;min-width:180px;margin-top:4px;padding:10px;background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:6px;font-size:0.9rem;font-weight:600;cursor:pointer">
                                Remover override
                            </button>
                        </div>
                    </div>
                    <div id="adminUserOverrideOutput" style="display:none;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;font-family:monospace;font-size:0.75rem;color:var(--text);max-height:220px;overflow-y:auto;white-space:pre-wrap"></div>
                </div>
            </div>
            
            <!-- Accordion: Resetar Senha -->
            <div class="admin-accordion" style="border:1px solid var(--border);border-radius:8px;margin-bottom:12px;overflow:hidden">
                <button class="admin-accordion-header" style="width:100%;display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:var(--bg);border:none;cursor:pointer;transition:background .2s">
                    <span style="font-size:1rem;font-weight:600;color:var(--text)">üîë Resetar Senha de Usu√°rio</span>
                    <svg class="admin-accordion-chevron" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="transition:transform .3s;color:var(--muted)">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
                <div class="admin-accordion-content" style="display:none;padding:16px">
                <p style="font-size:0.85rem;color:var(--muted);margin:0 0 14px;line-height:1.4">Redefine a senha de qualquer usu√°rio pelo email. A nova senha ser√° encriptada com SHA-256.</p>
                <form id="resetPasswordForm" style="display:grid;gap:10px;margin-bottom:12px">
                    <div style="display:flex;flex-direction:column;gap:4px">
                        <label for="resetEmail" style="font-size:0.75rem;color:var(--muted)">Email do Usu√°rio *</label>
                        <input id="resetEmail" name="email" type="email" autocomplete="email" required placeholder="usuario@exemplo.com" style="padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:0.85rem" />
                    </div>
                    <div style="display:flex;flex-direction:column;gap:4px">
                        <label for="resetNewPassword" style="font-size:0.75rem;color:var(--muted)">Nova Senha *</label>
                        <input id="resetNewPassword" name="newPassword" type="password" autocomplete="new-password" required placeholder="Digite a nova senha" style="padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:0.85rem" />
                    </div>
                    <button type="submit" style="margin-top:4px;padding:10px;background:var(--primary);color:#fff;border:none;border-radius:6px;font-size:0.9rem;font-weight:600;cursor:pointer;transition:background .15s" onmouseover="this.style.background='var(--primary-press)'" onmouseout="this.style.background='var(--primary)'">Resetar Senha</button>
                </form>
                <div id="resetPasswordOutput" style="display:none;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;font-size:0.85rem;color:var(--text);white-space:pre-wrap"></div>
            </div>

            <!-- Accordion: Snapshots di√°rios (Insights) -->
            <div class="admin-accordion" style="border:1px solid var(--border);border-radius:8px;margin-bottom:12px;overflow:hidden">
                <button class="admin-accordion-header" style="width:100%;display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:var(--bg);border:none;cursor:pointer;transition:background .2s">
                    <span style="font-size:1rem;font-weight:600;color:var(--text)">üïí Snapshots de Insights (pagantes)</span>
                    <svg class="admin-accordion-chevron" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="transition:transform .3s;color:var(--muted)">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
                <div class="admin-accordion-content" style="display:none;padding:16px">
                    <p style="font-size:0.85rem;color:var(--muted);margin:0 0 12px;line-height:1.4">
                        Mostra os registros da tabela <span style="font-family:monospace">user_daily_snapshot</span> (gravados 1x/dia quando o usu√°rio √© pagante: <span style="font-family:monospace">BloqueioAtivado=false</span>).
                    </p>
                    <div style="display:grid;gap:10px;margin-bottom:10px">
                        <div style="display:flex;gap:10px;flex-wrap:wrap">
                            <div style="flex:1;min-width:160px;display:flex;flex-direction:column;gap:4px">
                                <label for="adminSnapshotUserId" style="font-size:0.75rem;color:var(--muted)">User ID *</label>
                                <input id="adminSnapshotUserId" type="number" min="1" placeholder="ex: 123" style="padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:0.85rem" />
                            </div>
                            <div style="width:140px;display:flex;flex-direction:column;gap:4px">
                                <label for="adminSnapshotDays" style="font-size:0.75rem;color:var(--muted)">Dias</label>
                                <input id="adminSnapshotDays" type="number" min="1" max="365" value="90" style="padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:0.85rem" />
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px">
                            <input type="checkbox" id="adminSnapshotIncludePayload" style="width:18px;height:18px;cursor:pointer" />
                            <label for="adminSnapshotIncludePayload" style="font-size:0.9rem;color:var(--text);cursor:pointer">Incluir payload JSON (mais pesado)</label>
                        </div>
                        <div style="display:flex;gap:10px;flex-wrap:wrap">
                            <button id="adminLoadSnapshotsBtn" type="button" style="flex:1;min-width:180px;padding:10px;background:var(--primary);color:#fff;border:none;border-radius:6px;font-size:0.9rem;font-weight:600;cursor:pointer;transition:background .15s" onmouseover="this.style.background='var(--primary-press)'" onmouseout="this.style.background='var(--primary)'">Carregar snapshots</button>
                            <button id="adminUseOverrideUserIdBtn" type="button" style="flex:1;min-width:180px;padding:10px;background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:6px;font-size:0.9rem;font-weight:600;cursor:pointer">Usar User ID do Override</button>
                        </div>
                        <div id="adminSnapshotsStatus" style="font-size:0.72rem;color:var(--muted);min-height:1.1em"></div>
                    </div>
                    <div id="adminSnapshotsTable" style="display:none;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:8px;overflow:auto;max-height:420px"></div>
                </div>
            </div>

            <!-- Accordion: Limpeza de DB (n√£o-masterdata) -->
            <div class="admin-accordion" style="border:1px solid var(--border);border-radius:8px;margin-bottom:12px;overflow:hidden">
                <button class="admin-accordion-header" style="width:100%;display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:var(--bg);border:none;cursor:pointer;transition:background .2s">
                    <span style="font-size:1rem;font-weight:600;color:var(--text)">üßπ Limpeza do Banco (n√£o-masterdata)</span>
                    <svg class="admin-accordion-chevron" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="transition:transform .3s;color:var(--muted)">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
                <div class="admin-accordion-content" style="display:none;padding:16px">
                    <p style="font-size:0.85rem;color:var(--muted);margin:0 0 12px;line-height:1.4">
                        Remove dados transacionais (tentativas, stats, snapshots, etc.) preservando tabelas de masterdata/conte√∫do.
                        Use <b>Simular</b> para ver exatamente o que ser√° truncado. <b>Aten√ß√£o:</b> opera√ß√£o destrutiva.
                    </p>

                    <div style="display:grid;gap:10px;margin-bottom:10px">
                        <div style="display:flex;flex-wrap:wrap;gap:10px">
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                                <input type="checkbox" id="adminDbKeepUsers" checked style="width:18px;height:18px;cursor:pointer" />
                                <span style="font-size:0.9rem;color:var(--text)">Manter usu√°rios (se desmarcar, preserva Usuario.id=21)</span>
                            </label>
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                                <input type="checkbox" id="adminDbKeepRbac" checked style="width:18px;height:18px;cursor:pointer" />
                                <span style="font-size:0.9rem;color:var(--text)">Manter RBAC (roles/admin)</span>
                            </label>
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                                <input type="checkbox" id="adminDbKeepEntitlements" checked style="width:18px;height:18px;cursor:pointer" />
                                <span style="font-size:0.9rem;color:var(--text)">Manter compras/entitlements</span>
                            </label>
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                                <input type="checkbox" id="adminDbKeepComm" checked style="width:18px;height:18px;cursor:pointer" />
                                <span style="font-size:0.9rem;color:var(--text)">Manter comunica√ß√£o (recipients)</span>
                            </label>
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                                <input type="checkbox" id="adminDbKeepNotif" style="width:18px;height:18px;cursor:pointer" />
                                <span style="font-size:0.9rem;color:var(--text)">Manter notifica√ß√µes (draft/sent)</span>
                            </label>
                        </div>

                        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end">
                            <div style="flex:1;min-width:260px;display:flex;flex-direction:column;gap:4px">
                                <label for="adminDbConfirmText" style="font-size:0.75rem;color:var(--muted)">Confirma√ß√£o (para executar)</label>
                                <input id="adminDbConfirmText" type="text" placeholder="Digite: LIMPAR_NAO_MASTERDATA" style="padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:0.85rem" />
                            </div>
                            <button id="adminDbDryRunBtn" type="button" style="flex:1;min-width:180px;padding:10px;background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:6px;font-size:0.9rem;font-weight:600;cursor:pointer">Simular (dry-run)</button>
                            <button id="adminDbExecuteBtn" type="button" style="flex:1;min-width:180px;padding:10px;background:#b91c1c;color:#fff;border:none;border-radius:6px;font-size:0.9rem;font-weight:700;cursor:pointer">Executar limpeza</button>
                        </div>

                        <div id="adminDbCleanupStatus" style="font-size:0.72rem;color:var(--muted);min-height:1.1em"></div>
                    </div>

                    <div id="adminDbCleanupOutput" style="display:none;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;font-family:monospace;font-size:0.75rem;color:var(--text);max-height:260px;overflow-y:auto;white-space:pre-wrap"></div>
                </div>
            </div>

            <!-- Accordion: Emular Quest√µes por IDs -->
            <div class="admin-accordion" style="border:1px solid var(--border);border-radius:8px;margin-bottom:12px;overflow:hidden">
                <button class="admin-accordion-header" style="width:100%;display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:var(--bg);border:none;cursor:pointer;transition:background .2s">
                    <span style="font-size:1rem;font-weight:600;color:var(--text)">üß™ Emular Quest√µes (IDs)</span>
                    <svg class="admin-accordion-chevron" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="transition:transform .3s;color:var(--muted)">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
                <div class="admin-accordion-content" style="display:none;padding:16px">
                    <p style="font-size:0.85rem;color:var(--muted);margin:0 0 12px;line-height:1.4">
                        Inicia um exame completo usando exatamente os IDs informados (admin-only). Aceita separadores como v√≠rgula, espa√ßo e quebra de linha. M√°x: 200.
                    </p>
                    <div style="display:grid;gap:10px">
                        <textarea id="adminEmulatorQuestionIds" rows="4" placeholder="Ex: 123, 456, 789\n1011 1213" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:0.85rem;resize:vertical"></textarea>
                        <div style="display:flex;gap:10px;flex-wrap:wrap">
                            <button id="adminEmulatorStartBtn" type="button" style="flex:1;min-width:180px;padding:10px;background:var(--primary);color:#fff;border:none;border-radius:6px;font-size:0.9rem;font-weight:600;cursor:pointer;transition:background .15s" onmouseover="this.style.background='var(--primary-press)'" onmouseout="this.style.background='var(--primary)'">
                                Iniciar exame com esses IDs
                            </button>
                            <button id="adminEmulatorClearBtn" type="button" style="flex:1;min-width:180px;padding:10px;background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:6px;font-size:0.9rem;font-weight:600;cursor:pointer">
                                Limpar
                            </button>
                        </div>
                        <div id="adminEmulatorOutput" style="display:none;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;font-family:monospace;font-size:0.75rem;color:var(--text);max-height:220px;overflow-y:auto;white-space:pre-wrap"></div>
                    </div>
                </div>
            </div>
            
            <!-- Accordion: Outras Ferramentas -->
            <div id="adminAccordionTools" class="admin-accordion" style="border:1px solid var(--border);border-radius:8px;overflow:hidden">
                <button class="admin-accordion-header" style="width:100%;display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:var(--bg);border:none;cursor:pointer;transition:background .2s">
                    <span style="font-size:1rem;font-weight:600;color:var(--text)">üõ†Ô∏è Outras Ferramentas</span>
                    <svg class="admin-accordion-chevron" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="transition:transform .3s;color:var(--muted)">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
                <div class="admin-accordion-content" style="display:none;padding:16px">
                    <div style="display:grid;gap:10px">
                        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
                            <div style="font-size:0.95rem;font-weight:700;color:var(--text)">üì£ Comunica√ß√£o</div>
                            <button id="commRefreshRecipientsBtn" type="button" style="padding:8px 10px;background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:6px;font-size:0.85rem;font-weight:600;cursor:pointer">Atualizar</button>
                        </div>
                        <p style="font-size:0.85rem;color:var(--muted);margin:0;line-height:1.4">Cadastre os admins que recebem comunicados por e-mail. Voc√™ pode selecionar mais de 1.</p>

                        <select id="commAdminSelect" style="padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:0.85rem" disabled>
                            <option value="">Carregando admins...</option>
                        </select>
                        <div style="display:flex;gap:10px;flex-wrap:wrap">
                            <button id="commAddRecipientBtn" type="button" style="flex:1;min-width:180px;padding:10px;background:var(--primary);color:#fff;border:none;border-radius:6px;font-size:0.9rem;font-weight:600;cursor:pointer;transition:background .15s" onmouseover="this.style.background='var(--primary-press)'" onmouseout="this.style.background='var(--primary)'" disabled>Adicionar</button>
                        </div>
                        <div id="commRecipientsStatus" style="font-size:0.72rem;color:var(--muted);min-height:1.1em"></div>
                        <div id="commRecipientsList" style="display:grid;gap:8px"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dica do dia Modal -->
    <div id="dicaModal" class="overlay dica-modal" aria-hidden="true">
        <div class="dica-card" role="dialog" aria-modal="true" aria-label="Dica do dia">
            <div class="dica-header">
                <div class="dica-title">
                    <div class="dica-bulb" aria-hidden="true">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: rgba(245,158,11,0.95)">
                            <path d="M9 18h6" />
                            <path d="M10 22h4" />
                            <path d="M8 14c-1.5-1.2-2.5-3-2.5-5a6.5 6.5 0 1 1 13 0c0 2-1 3.8-2.5 5-.8.7-1.5 1.8-1.5 3H11c0-1.2-.7-2.3-1.5-3z" />
                        </svg>
                    </div>
                    <span>Dica do dia</span>
                </div>
                <button id="dicaModalClose" type="button" class="dica-close" aria-label="Fechar">√ó</button>
            </div>
            <div id="dicaModalMeta" class="dica-meta"></div>
            <div id="dicaModalText" class="dica-text">Carregando...</div>
            <div class="dica-footer">
                <button id="dicaModalAnother" type="button" class="dica-btn">Outra dica</button>
                <button id="dicaModalCopy" type="button" class="dica-btn primary">Copiar</button>
            </div>
        </div>
    </div>

    <script>
        (function(){
            const counters = { home: 1, search: 0, favorites: 0, profile: 0 };
            const sections = {
                home: document.getElementById('home'),
                search: document.getElementById('search'),
                favorites: document.getElementById('favorites'),
                profile: document.getElementById('profile')
            };
            const debugEls = {
                home: document.getElementById('debug-home'),
                search: document.getElementById('debug-search'),
                favorites: document.getElementById('debug-favorites'),
                profile: document.getElementById('debug-profile')
            };
            // bottom nav ser√° carregada dinamicamente via componente
            const nav = null; // placeholder
            const navItems = []; // placeholder
            const overlay = document.getElementById('fullOverlay');
            const fullImg = document.getElementById('fullImg');
            const backBtn = document.getElementById('backBtn');

            // Early fallback: allow Dica do dia to work even if other init fails/hasn't run yet.
            function getDicaHeadersEarly(){
                try {
                    if (window.Auth && typeof window.Auth.getAuthHeaders === 'function') {
                        return window.Auth.getAuthHeaders({ acceptJson: true });
                    }
                } catch(_){ }
                const headers = { 'Accept': 'application/json' };
                try {
                    const token = (localStorage.getItem('sessionToken') || '').trim();
                    const nomeUsuario = (localStorage.getItem('nomeUsuario') || '').trim();
                    const identity = token || nomeUsuario;
                    if (identity) headers['X-Session-Token'] = identity;
                } catch(_){ }
                try {
                    const jwtTok = (localStorage.getItem('jwtToken') || localStorage.getItem('jwt') || '').trim();
                    const jwtType = (localStorage.getItem('jwtTokenType') || localStorage.getItem('jwt_type') || 'Bearer').trim() || 'Bearer';
                    if (jwtTok) headers['Authorization'] = `${jwtType} ${jwtTok}`;
                } catch(_){ }
                return headers;
            }

            async function openDicaDoDiaModalEarly(){
                const dicaModal = document.getElementById('dicaModal');
                const dicaModalText = document.getElementById('dicaModalText');
                const dicaModalMeta = document.getElementById('dicaModalMeta');
                if (!dicaModal) {
                    try { if (window.showToast) window.showToast('Modal de dica n√£o encontrado no DOM.'); else alert('Modal de dica n√£o encontrado no DOM.'); } catch(_){ }
                    return;
                }
                try {
                    dicaModal.classList.add('active');
                    dicaModal.setAttribute('aria-hidden', 'false');
                    const navHide = document.querySelector('.bottom-nav');
                    if (navHide) navHide.style.display='none';
                    document.body.style.overflow = 'hidden';
                } catch(_){ }

                if (dicaModalText) dicaModalText.textContent = 'Carregando...';
                if (dicaModalMeta) dicaModalMeta.textContent = '';

                try {
                    const url = '/api/dicas/today?_ts=' + Date.now();
                    const r = await fetch(url, { method: 'GET', headers: getDicaHeadersEarly(), cache: 'no-store', credentials: 'include' });
                    const data = await r.json().catch(()=>null);
                    if (!r.ok) {
                        const errText = data && (data.message || data.error) ? String(data.message || data.error) : ('Falha ao carregar dica (HTTP ' + r.status + ')');
                        if (dicaModalText) dicaModalText.textContent = errText;
                        return;
                    }
                    const item = data && (data.item || data);
                    const txt = item && item.descricao != null ? String(item.descricao) : '';
                    const metaBits = [];
                    try {
                        if (item && item.versao_code) metaBits.push('Vers√£o: ' + String(item.versao_code));
                        else if (item && item.id_versao_pmbok != null) metaBits.push('Vers√£o #' + String(item.id_versao_pmbok));
                    } catch(_){ }
                    try { if (item && item.id != null) metaBits.push('ID: ' + String(item.id)); } catch(_){ }
                    if (dicaModalMeta) dicaModalMeta.textContent = metaBits.join(' ‚Ä¢ ');
                    if (dicaModalText) dicaModalText.textContent = txt || 'Dica vazia.';
                    try { dicaModal.dataset.lastDica = txt || ''; } catch(_){ }
                } catch(_){
                    if (dicaModalText) dicaModalText.textContent = 'Erro ao carregar dica.';
                }
            }

            try {
                if (typeof window.openDicaDoDiaModal !== 'function') {
                    window.openDicaDoDiaModal = openDicaDoDiaModalEarly;
                }
            } catch(_){ }

            function updateDebug(name){ if (debugEls[name]) debugEls[name].textContent = 'Cliques: ' + counters[name]; }

            function setActive(target){
                // update nav state
                navItems.forEach(it => it.classList.remove('active'));
                const btn = navItems.find(it => it.dataset.target === target);
                if (btn) btn.classList.add('active');

                // update sections
                Object.keys(sections).forEach(k => sections[k].classList.remove('active'));
                if (sections[target]) sections[target].classList.add('active');
            }

            // Initialize Home debug
            updateDebug('home');

            // Nav ser√° inicializada pelo componente bottomNav.html

            // Card click: Simulador abre examSetup; exam-mock abre fluxo completo; hist√≥rico abre modal; indicadores abre p√°gina dedicada
            document.addEventListener('click', (e) => {
                const card = e.target.closest && e.target.closest('.card');
                if (!card) return;

                // Dica do dia: abre modal com dica aleat√≥ria (n√£o navega para examSetup.html)
                const isDicaDoDia =
                    (card.id === 'card-dica-do-dia') ||
                    (card.getAttribute('data-card') === 'dica-do-dia') ||
                    (String(card.getAttribute('aria-label') || '').trim().toLowerCase() === 'dica do dia');
                if (isDicaDoDia) {
                    try { e.preventDefault(); e.stopPropagation(); if (e.stopImmediatePropagation) e.stopImmediatePropagation(); } catch(_) {}
                    try { if (typeof window.openDicaDoDiaModal === 'function') window.openDicaDoDiaModal(); } catch(_){ }
                    return;
                }

                try {
                    const log = (typeof logger !== 'undefined') ? logger : console;
                    if (log && typeof log.info === 'function') log.info('[index.html] Card clicado:', card.id, card.getAttribute('data-card'));
                } catch(_){ }
                
                // Prioridade: interceptar clique no exame completo (mock) antes do handler gen√©rico
                if (card.id === 'card-exam-mock' || card.getAttribute('data-card') === 'exam-mock'){
                    try { e.preventDefault(); e.stopPropagation(); if (e.stopImmediatePropagation) e.stopImmediatePropagation(); } catch(_) {}
                    const bloqueado = (window.BloqueioAtivado === true) || (localStorage.getItem('BloqueioAtivado') === 'true');
                    if (bloqueado){
                        window.showToast && window.showToast('Somente usu√°rio Premium.');
                        return;
                    }
                    const proceed = function(){
                        try {
                            localStorage.setItem('examQuestionCount', '180');
                            localStorage.setItem('examCountFromDefault', 'true');
                            sessionStorage.setItem('startExam', 'true');
                        } catch(_){ }
                        window.location.assign('/pages/examFull.html');
                    };
                    if (!(window.showFullExamConfirm && window.showFullExamConfirm(proceed))){ proceed(); }
                    return;
                }
                // Se for o card do Simulador, usar fluxo do script.js
                if (card.classList.contains('card--simulador') || card.classList.contains('card--settings')){
                    // Configura√ß√µes: intercepta e redireciona para p√°gina de settings (com verifica√ß√£o de senha)
                    const isSettings = (card.id === 'card-settings') || (card.id === 'card-profile-settings') || (card.getAttribute('data-card') === 'settings') || (card.getAttribute('data-card') === 'profile-settings');
                    if (isSettings) {
                        logger.info('[Settings Card] Clicked, card id:', card.id);
                        try { e.preventDefault(); e.stopPropagation(); if (e.stopImmediatePropagation) e.stopImmediatePropagation(); } catch(_) {}
                        
                        // Redirecionar diretamente para settings sem verifica√ß√£o de senha
                        // O usu√°rio j√° est√° autenticado com JWT token
                        logger.info('[Settings Card] Redirecting to settings page');
                        window.location.assign('/pages/settings.html');
                        return;
                    }
                    // Indicadores: intercepta antes de fluxo gen√©rico
                    const isIndicadores = (card.id === 'card-indicadores') || (card.getAttribute('data-card') === 'indicadores');
                    if (isIndicadores) {
                        // Verificar se acabou de vir de Indicadores (prevenir loop)
                        try {
                            const preventLoop = sessionStorage.getItem('preventIndicadoresLoop') === 'true';
                            const loopTime = parseInt(sessionStorage.getItem('preventIndicadoresLoopTime') || '0', 10);
                            const now = Date.now();
                            
                            if (preventLoop && (now - loopTime) < 2000) {
                                logger.info('[index.html] Detectado poss√≠vel loop para Indicadores, ignorando clique');
                                sessionStorage.removeItem('preventIndicadoresLoop');
                                sessionStorage.removeItem('preventIndicadoresLoopTime');
                                return;
                            }
                        } catch(_) {}
                        
                        try { e.preventDefault(); e.stopPropagation(); if (e.stopImmediatePropagation) e.stopImmediatePropagation(); } catch(_) {}
                        logger.info('[index.html] Abrindo Indicadores embutido (index)');
                        try {
                            // Preferir o mesmo caminho do sidebar (mant√©m comportamento consistente)
                            const link = document.querySelector('a.sidebar-link[href="/pages/Indicadores.html"], a.sidebar-link[href^="/pages/Indicadores.html?"]');
                            if (link) {
                                link.click();
                                return;
                            }
                        } catch(_){ }

                        try {
                            sessionStorage.setItem('currentSection', 'indicadores');
                            sessionStorage.removeItem('currentSubsection');
                        } catch(_){ }

                        try {
                            const section = document.getElementById('indicadores');
                            if (section && typeof window.loadIndicadoresIntoSection === 'function') {
                                window.loadIndicadoresIntoSection();
                                try { section.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch(_){ }
                                return;
                            }
                        } catch(_){ }

                        // √öltimo recurso: manter no index e deixar o restore via sessionStorage acontecer
                        window.location.assign('/index.html');
                        return;
                    }
                    // Insights da IA: abre p√°gina dedicada
                    const isInsightsAI = (card.id === 'card-insights-ia') || (card.getAttribute('data-card') === 'insights-ia');
                    if (isInsightsAI) {
                        try { e.preventDefault(); e.stopPropagation(); if (e.stopImmediatePropagation) e.stopImmediatePropagation(); } catch(_) {}
                        logger.info('[index.html] Navegando para InsightsIA.html');
                        window.location.assign('/pages/InsightsIA.html');
                        return;
                    }
                    // Exception: use this card for Hist√≥rico modal, not exam setup
                    const isHistorico = (card.id === 'card-progresso-geral') || (card.getAttribute('data-card') === 'progresso-geral');
                    if (isHistorico) {
                        try { e.preventDefault(); e.stopPropagation(); if (e.stopImmediatePropagation) e.stopImmediatePropagation(); } catch(_) {}
                        try {
                            const modal = document.getElementById('examResultsModal');
                            if (modal) {
                                modal.style.display = 'flex';
                                modal.setAttribute('aria-hidden','false');
                                if (typeof window.loadExamHistoryModal === 'function') {
                                    window.loadExamHistoryModal();
                                }
                            }
                        } catch(_){ }
                        return;
                    }
                    // Evita qualquer a√ß√£o/navega√ß√£o padr√£o e outros handlers paralelos
                    try { e.preventDefault(); } catch(_) {}
                    try { e.stopPropagation(); } catch(_) {}
                    try { if (typeof e.stopImmediatePropagation === 'function') e.stopImmediatePropagation(); } catch(_) {}
                    
                    // Verificar se acabou de voltar do examSetup
                    try {
                        const justReturned = sessionStorage.getItem('justReturnedFromExamSetup') === 'true';
                        if (justReturned) {
                            logger.info('[index.html] Card clicado mas usu√°rio acabou de voltar, ignorando');
                            sessionStorage.removeItem('justReturnedFromExamSetup');
                            return;
                        }
                    } catch(_) {}
                    
                    if (window.showExamSetupAndRedirect) {
                        // Usa caminho absoluto para consist√™ncia
                        window.showExamSetupAndRedirect('/pages/exam.html');
                    }
                    return;
                }
                // Abrir modal de Hist√≥rico de exames
                if (card.id === 'card-progresso-geral' || card.getAttribute('data-card') === 'progresso-geral') {
                    try { e.preventDefault(); e.stopPropagation(); if (e.stopImmediatePropagation) e.stopImmediatePropagation(); } catch(_) {}
                    try {
                        const modal = document.getElementById('examResultsModal');
                        const selectEl = document.getElementById('examSelect');
                        if (modal) {
                            modal.style.display = 'flex';
                            modal.setAttribute('aria-hidden','false');
                            // Carregar hist√≥rico
                            (async function loadHistory(){
                                try {
                                    const base = (window.SIMULADOS_CONFIG && window.SIMULADOS_CONFIG.BACKEND_BASE) || 'http://localhost:3000';
                                    const url = (base || '') + '/api/exams/history?limit=50';
                                    const token = (localStorage.getItem('sessionToken')||'').trim();
                                    const r = await fetch(url + (url.includes('?') ? '&' : '?') + '_ts=' + Date.now(), { headers: token ? { 'X-Session-Token': token } : {}, cache: 'no-store', credentials: 'include' });
                                    let list = [];
                                    if (r.ok) list = await r.json();
                                    if (!Array.isArray(list)) list = [];
                                    if (selectEl) {
                                        selectEl.innerHTML = '';
                                        if (!list.length){ selectEl.innerHTML = '<option value="" selected>Nenhum exame encontrado</option>'; return; }
                                        for (const item of list){
                                            const id = item && (item.id || item.sessionId || item.examId);
                                            const mode = String(item && item.examMode || '').toLowerCase();
                                            const title = item && (item.title || item.name) || (mode==='full' ? 'Exame Completo' : 'Quiz');
                                            const finished = item && item.finishedAt ? new Date(item.finishedAt).toLocaleString('pt-BR') : '';
                                            const pct = item && item.scorePercent != null ? ` (${Math.round(item.scorePercent)}%)` : '';
                                            const opt = document.createElement('option');
                                            opt.value = String(id);
                                            opt.setAttribute('data-mode', mode || 'quiz');
                                            opt.textContent = `${title}${pct}${finished? ' ‚Äî ' + finished : ''}`;
                                            selectEl.appendChild(opt);
                                        }
                                    }
                                } catch(_) { if (selectEl) selectEl.innerHTML = '<option value="" selected>Falha ao carregar</option>'; }
                            })();
                        }
                    } catch(_){ }
                    return;
                }
                // Abrir modal Admin
                if (card.id === 'card-admin' || card.getAttribute('data-card') === 'admin') {
                    try { e.preventDefault(); e.stopPropagation(); if (e.stopImmediatePropagation) e.stopImmediatePropagation(); } catch(_) {}
                    if (typeof window.openAdminModal === 'function') {
                        window.openAdminModal();
                    } else {
                        ensureAdminAccess().then((ok) => {
                            if (!ok) { denyAdminUi(); return; }
                            const adminModal = document.getElementById('adminModal');
                            if (adminModal) {
                                try { adminModal.removeAttribute('inert'); } catch(_){ }
                                adminModal.classList.add('active');
                                adminModal.setAttribute('aria-hidden', 'false');
                                adminModal.style.display = 'flex';
                                const navHide = document.querySelector('.bottom-nav');
                                if (navHide) navHide.style.display='none';
                            }
                        });
                    }
                    return;
                }
                const url = card.getAttribute('data-full');
                if (!url) return;
                fullImg.src = url;
                overlay.classList.add('active');
                overlay.setAttribute('aria-hidden', 'false');
                if (nav) nav.style.display = 'none';
                document.body.style.overflow = 'hidden';
            }, true); // capture phase para interceptar o clique o quanto antes

            // Close overlay
            backBtn.addEventListener('click', () => {
                overlay.classList.remove('active');
                overlay.setAttribute('aria-hidden', 'true');
                fullImg.removeAttribute('src');
                const navShow = document.querySelector('.bottom-nav');
                if (navShow) navShow.style.display='';
                document.body.style.overflow = '';
            });

            // Close overlay when clicking backdrop (except image/back button)
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) backBtn.click();
            });

            // Dica do dia modal handlers
            const dicaModal = document.getElementById('dicaModal');
            const dicaModalClose = document.getElementById('dicaModalClose');
            const dicaModalAnother = document.getElementById('dicaModalAnother');
            const dicaModalCopy = document.getElementById('dicaModalCopy');
            const dicaModalText = document.getElementById('dicaModalText');
            const dicaModalMeta = document.getElementById('dicaModalMeta');

            // Direct fallback listeners (extra robustness)
            try {
                const dicaCard = document.getElementById('card-dica-do-dia');
                if (dicaCard) {
                    dicaCard.addEventListener('click', (ev) => {
                        try { ev.preventDefault(); ev.stopPropagation(); if (ev.stopImmediatePropagation) ev.stopImmediatePropagation(); } catch(_){ }
                        try { if (typeof window.openDicaDoDiaModal === 'function') window.openDicaDoDiaModal(); } catch(_){ }
                    }, true);
                    dicaCard.addEventListener('keydown', (ev) => {
                        if (ev.key !== 'Enter' && ev.key !== ' ') return;
                        try { ev.preventDefault(); ev.stopPropagation(); if (ev.stopImmediatePropagation) ev.stopImmediatePropagation(); } catch(_){ }
                        try { if (typeof window.openDicaDoDiaModal === 'function') window.openDicaDoDiaModal(); } catch(_){ }
                    }, true);
                }
            } catch(_){ }

            function getUserHeaders(){
                try {
                    if (window.Auth && typeof window.Auth.getAuthHeaders === 'function') {
                        return window.Auth.getAuthHeaders({ acceptJson: true });
                    }
                } catch(_){ }
                const headers = { 'Accept': 'application/json' };
                try {
                    const token = (localStorage.getItem('sessionToken') || '').trim();
                    const nomeUsuario = (localStorage.getItem('nomeUsuario') || '').trim();
                    const sessionForHeader = token || nomeUsuario;
                    if (sessionForHeader) headers['X-Session-Token'] = sessionForHeader;
                } catch(_){ }
                try {
                    const jwtTok = (localStorage.getItem('jwtToken') || localStorage.getItem('jwt') || '').trim();
                    const jwtType = (localStorage.getItem('jwtTokenType') || localStorage.getItem('jwt_type') || 'Bearer').trim() || 'Bearer';
                    if (jwtTok) headers['Authorization'] = `${jwtType} ${jwtTok}`;
                } catch(_){ }
                return headers;
            }

            function escapeHtmlDica(s){
                return String(s ?? '')
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/\"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            }
            function renderMarkdownLinksSafeDica(raw){
                const escaped = escapeHtmlDica(raw ?? '');
                return escaped.replace(/\[([^\]]+)\]\(([^)\s]+)\)/g, (m, text, url) => {
                    const u = String(url || '').trim();
                    if (!/^https?:\/\//i.test(u)) return m;
                    return `<a href="${escapeHtmlDica(u)}" target="_blank" rel="noopener noreferrer">${escapeHtmlDica(text)}</a>`;
                });
            }

            function setDicaModalOpen(open){
                if (!dicaModal) return;
                if (open) {
                    dicaModal.classList.add('active');
                    dicaModal.setAttribute('aria-hidden', 'false');
                    const navHide = document.querySelector('.bottom-nav');
                    if (navHide) navHide.style.display='none';
                    document.body.style.overflow = 'hidden';
                } else {
                    dicaModal.classList.remove('active');
                    dicaModal.setAttribute('aria-hidden', 'true');
                    const navShow = document.querySelector('.bottom-nav');
                    if (navShow) navShow.style.display='';
                    document.body.style.overflow = '';
                }
            }

            async function loadRandomDica(){
                if (dicaModalText) dicaModalText.textContent = 'Carregando...';
                if (dicaModalMeta) dicaModalMeta.textContent = '';
                if (dicaModalAnother) dicaModalAnother.disabled = true;
                if (dicaModalCopy) dicaModalCopy.disabled = true;

                try {
                    const url = '/api/dicas/today?_ts=' + Date.now();
                    const r = await fetch(url, { method: 'GET', headers: getUserHeaders(), cache: 'no-store', credentials: 'include' });
                    if (!r.ok) {
                        const msg = (await r.json().catch(()=>null)) || null;
                        const errText = msg && (msg.message || msg.error) ? String(msg.message || msg.error) : ('Falha ao carregar dica (HTTP ' + r.status + ')');
                        if (dicaModalText) dicaModalText.textContent = errText;
                        return;
                    }
                    const data = await r.json().catch(()=>null);
                    const item = data && (data.item || data);
                    const txt = item && item.descricao != null ? String(item.descricao) : '';
                    const metaBits = [];
                    try {
                        if (item && item.versao_code) metaBits.push('Vers√£o: ' + String(item.versao_code));
                        else if (item && item.id_versao_pmbok != null) metaBits.push('Vers√£o #' + String(item.id_versao_pmbok));
                    } catch(_){ }
                    try { if (item && item.id != null) metaBits.push('ID: ' + String(item.id)); } catch(_){ }
                    if (dicaModalMeta) dicaModalMeta.textContent = metaBits.join(' ‚Ä¢ ');
                    if (dicaModalText) dicaModalText.innerHTML = renderMarkdownLinksSafeDica(txt || 'Dica vazia.');
                    try { if (dicaModal && dicaModal.dataset) dicaModal.dataset.lastDica = txt || ''; } catch(_){ }
                } catch (err) {
                    if (dicaModalText) dicaModalText.textContent = 'Erro ao carregar dica.';
                } finally {
                    if (dicaModalAnother) dicaModalAnother.disabled = false;
                    if (dicaModalCopy) dicaModalCopy.disabled = false;
                }
            }

            if (typeof window.openDicaDoDiaModal !== 'function') {
                window.openDicaDoDiaModal = function(){
                    setDicaModalOpen(true);
                    loadRandomDica();
                };
            }

            if (dicaModalClose) dicaModalClose.addEventListener('click', () => setDicaModalOpen(false));
            if (dicaModal) dicaModal.addEventListener('click', (e) => { if (e.target === dicaModal) setDicaModalOpen(false); });
            if (dicaModalAnother) dicaModalAnother.addEventListener('click', () => loadRandomDica());
            if (dicaModalCopy) dicaModalCopy.addEventListener('click', async () => {
                try {
                    const txt = (dicaModal && dicaModal.dataset && dicaModal.dataset.lastDica) ? String(dicaModal.dataset.lastDica) : (dicaModalText ? String(dicaModalText.textContent || '') : '');
                    if (!txt) return;
                    await navigator.clipboard.writeText(txt);
                    try { if (window.showToast) window.showToast('Dica copiada.'); } catch(_){ }
                } catch(_){
                    try { if (window.showToast) window.showToast('Falha ao copiar.'); } catch(_){ }
                }
            });
            document.addEventListener('keydown', (e) => {
                if (!dicaModal) return;
                const open = dicaModal.classList && dicaModal.classList.contains('active');
                if (!open) return;
                if (e.key === 'Escape') {
                    try { e.preventDefault(); e.stopPropagation(); } catch(_){ }
                    setDicaModalOpen(false);
                }
            });
            
            // Admin Modal handlers
            const adminModal = document.getElementById('adminModal');
            const adminModalClose = document.getElementById('adminModalClose');
            const reconcileBtn = document.getElementById('reconcileBtn');
            const reconcileOutput = document.getElementById('reconcileOutput');
            const reconcileFromDate = document.getElementById('reconcileFromDate');
            const reconcileToDate = document.getElementById('reconcileToDate');
            const reconcileMode = document.getElementById('reconcileMode');
            const reconcileDryRun = document.getElementById('reconcileDryRun');

            // Admin health check controls
            const adminHealthCheckBtn = document.getElementById('adminHealthCheckBtn');
            const adminHealthCopyBtn = document.getElementById('adminHealthCopyBtn');
            const adminHealthCheckOutput = document.getElementById('adminHealthCheckOutput');

            // Exam content version (ECO) admin controls
            const adminExamTypeSelect = document.getElementById('adminExamTypeSelect');
            const adminExamContentVersionSelect = document.getElementById('adminExamContentVersionSelect');
            const adminSetCurrentVersionBtn = document.getElementById('adminSetCurrentVersionBtn');
            const adminExamContentVersionOutput = document.getElementById('adminExamContentVersionOutput');

            // Per-user override controls
            const adminUserIdOverride = document.getElementById('adminUserIdOverride');
            const adminUserExamTypeSelect = document.getElementById('adminUserExamTypeSelect');
            const adminUserExamContentVersionSelect = document.getElementById('adminUserExamContentVersionSelect');
            const adminSetUserOverrideBtn = document.getElementById('adminSetUserOverrideBtn');
            const adminClearUserOverrideBtn = document.getElementById('adminClearUserOverrideBtn');
            const adminUserOverrideOutput = document.getElementById('adminUserOverrideOutput');
            const adminUserIdOverrideHint = document.getElementById('adminUserIdOverrideHint');
            const adminUserSearchQuery = document.getElementById('adminUserSearchQuery');
            const adminUserSearchBtn = document.getElementById('adminUserSearchBtn');
            const adminUserSearchSelect = document.getElementById('adminUserSearchSelect');
            const adminUserSearchStatus = document.getElementById('adminUserSearchStatus');

            // Insights snapshots (temporal model groundwork)
            const adminSnapshotUserId = document.getElementById('adminSnapshotUserId');
            const adminSnapshotDays = document.getElementById('adminSnapshotDays');
            const adminSnapshotIncludePayload = document.getElementById('adminSnapshotIncludePayload');
            const adminLoadSnapshotsBtn = document.getElementById('adminLoadSnapshotsBtn');
            const adminUseOverrideUserIdBtn = document.getElementById('adminUseOverrideUserIdBtn');
            const adminSnapshotsStatus = document.getElementById('adminSnapshotsStatus');
            const adminSnapshotsTable = document.getElementById('adminSnapshotsTable');

            // Communication recipients (admin communications)
            const commAdminSelect = document.getElementById('commAdminSelect');
            const commAddRecipientBtn = document.getElementById('commAddRecipientBtn');
            const commRecipientsList = document.getElementById('commRecipientsList');
            const commRecipientsStatus = document.getElementById('commRecipientsStatus');
            const commRefreshRecipientsBtn = document.getElementById('commRefreshRecipientsBtn');

            async function ensureAdminAccess(){
                try { if (window.__isAdmin === true) return true; } catch(_){ }

                try {
                    const base = (window.SIMULADOS_CONFIG && window.SIMULADOS_CONFIG.BACKEND_BASE) || 'http://localhost:3000';
                    const token = (localStorage.getItem('sessionToken') || '').trim();
                    const nomeUsuario = (localStorage.getItem('nomeUsuario') || '').trim();
                    const sessionForHeader = token || nomeUsuario;

                    const headers = {};
                    if (sessionForHeader) headers['X-Session-Token'] = sessionForHeader;
                    try {
                        const jwtTok = (localStorage.getItem('jwtToken')||'').trim();
                        const jwtType = (localStorage.getItem('jwtTokenType')||'Bearer').trim()||'Bearer';
                        if (jwtTok) headers['Authorization'] = `${jwtType} ${jwtTok}`;
                    } catch(_){ }
                    try {
                        const jwtTokB = (localStorage.getItem('jwt')||'').trim();
                        const jwtTypeB = (localStorage.getItem('jwt_type')||'Bearer').trim()||'Bearer';
                        if (!headers['Authorization'] && jwtTokB) headers['Authorization'] = `${jwtTypeB} ${jwtTokB}`;
                    } catch(_){ }

                    // Primary: probe admin-only endpoint (aligns with backend RBAC).
                    try {
                        const probeUrl = base + '/api/admin/exams/probe?sessionToken=' + encodeURIComponent(sessionForHeader || '');
                        const probeResp = await fetch(probeUrl, { headers, method: 'GET', credentials: 'include' });
                        if (probeResp.ok || probeResp.status === 204) {
                            try { window.__isAdmin = true; } catch(_){ }
                            try {
                                const adminCard = document.getElementById('card-admin');
                                if (adminCard) adminCard.style.display = '';
                            } catch(_){ }
                            return true;
                        }
                    } catch(_){ }

                    // Fallback: /api/users/me for legacy setups.
                    const resp = await fetch(base + '/api/users/me', { headers, credentials: 'include' });
                    if (!resp.ok) return false;
                    const user = await resp.json().catch(()=>null);
                    const ok = !!(user && (user.TipoUsuario === 'admin' || user.tipoUsuario === 'admin' || user.isAdmin === true));
                    if (ok) { try { window.__isAdmin = true; } catch(_){ } }

                    // Keep admin entry hidden unless confirmed.
                    try {
                        const adminCard = document.getElementById('card-admin');
                        if (adminCard) adminCard.style.display = ok ? '' : 'none';
                    } catch(_){ }

                    return ok;
                } catch(_){
                    return false;
                }
            }

            function denyAdminUi(){
                try { if (window.showToast) { window.showToast('Acesso restrito: somente admin.'); return; } } catch(_){ }
                try { alert('Acesso restrito: somente admin.'); } catch(_){ }
            }

            function getAdminHeaders(){
                try {
                    if (window.Auth && typeof window.Auth.getAuthHeaders === 'function') {
                        return window.Auth.getAuthHeaders({ acceptJson: true });
                    }
                } catch(_){ }
                const headers = { 'Accept': 'application/json' };
                try {
                    const token = (localStorage.getItem('sessionToken') || '').trim();
                    const nomeUsuario = (localStorage.getItem('nomeUsuario') || '').trim();
                    const sessionForHeader = token || nomeUsuario;
                    if (sessionForHeader) headers['X-Session-Token'] = sessionForHeader;
                } catch(_){ }
                try {
                    const jwtTok = (localStorage.getItem('jwtToken') || localStorage.getItem('jwt') || '').trim();
                    const jwtType = (localStorage.getItem('jwtTokenType') || localStorage.getItem('jwt_type') || 'Bearer').trim() || 'Bearer';
                    if (jwtTok) headers['Authorization'] = `${jwtType} ${jwtTok}`;
                } catch(_){ }
                return headers;
            }

            function fmtHealthLine(k, v){
                const key = String(k || '').padEnd(18, ' ');
                return `${key}: ${v}`;
            }

            async function runAdminHealthCheck(){
                const base = (window.SIMULADOS_CONFIG && window.SIMULADOS_CONFIG.BACKEND_BASE) || 'http://localhost:3000';
                const headers = getAdminHeaders();
                const identity = (window.Auth && typeof window.Auth.getSessionIdentity === 'function')
                    ? window.Auth.getSessionIdentity()
                    : ((localStorage.getItem('sessionToken') || '').trim() || (localStorage.getItem('nomeUsuario') || '').trim());

                const outLines = [];
                outLines.push('[admin-health] ' + new Date().toISOString());
                outLines.push(fmtHealthLine('base', base));
                outLines.push(fmtHealthLine('identity', identity ? String(identity) : '(none)'));
                outLines.push(fmtHealthLine('hasJWT', headers['Authorization'] ? 'yes' : 'no'));
                outLines.push(fmtHealthLine('hasX-Session', headers['X-Session-Token'] ? 'yes' : 'no'));

                // Sidebar version (helps diagnose cache/stale HTML)
                try {
                    const uiBase = (function(){
                        try { return String(window.location.origin || '').replace(/\/$/, ''); } catch(_){ return ''; }
                    })();
                    const sidebarMount = document.getElementById('sidebarMount');
                    const domHtml = sidebarMount ? String(sidebarMount.innerHTML || '') : '';
                    const domLen = domHtml.length;

                    let domVersion = '(none)';
                    try {
                        const aside = sidebarMount ? sidebarMount.querySelector('aside.sidebar[data-sidebar-version]') : null;
                        domVersion = aside ? String(aside.getAttribute('data-sidebar-version') || '(none)') : '(none)';
                    } catch(_){ domVersion = '(none)'; }

                    let remoteLen = '(n/a)';
                    let remoteVersion = '(n/a)';
                    try {
                        const resp = await fetch(uiBase + '/components/sidebar.html?v=' + Date.now(), { method: 'GET', cache: 'no-store', credentials: 'include' });
                        if (resp.ok) {
                            const txt = await resp.text();
                            remoteLen = txt.length;
                            const m = txt.match(/data-sidebar-version\s*=\s*"([^"]+)"/i);
                            remoteVersion = m && m[1] ? String(m[1]) : '(missing)';
                        } else {
                            remoteLen = '(http ' + resp.status + ')';
                            remoteVersion = '(http ' + resp.status + ')';
                        }
                    } catch(_){ }

                    const versionMatch = (domVersion !== '(none)' && remoteVersion !== '(n/a)' && remoteVersion !== '(missing)' && remoteVersion !== '(none)')
                        ? (String(domVersion) === String(remoteVersion) ? 'yes' : 'no')
                        : '(n/a)';

                    outLines.push('');
                    outLines.push('[sidebar]');
                    outLines.push(fmtHealthLine('uiBase', uiBase || '(none)'));
                    outLines.push(fmtHealthLine('mounted', (sidebarMount && sidebarMount.hasChildNodes()) ? 'yes' : 'no'));
                    outLines.push(fmtHealthLine('domLen', domLen));
                    outLines.push(fmtHealthLine('domVersion', domVersion));
                    outLines.push(fmtHealthLine('remoteLen', remoteLen));
                    outLines.push(fmtHealthLine('remoteVersion', remoteVersion));
                    outLines.push(fmtHealthLine('match', versionMatch));
                } catch(_){ }

                // 1) /api/users/me
                try {
                    const resp = await fetch(base + '/api/users/me', { method: 'GET', headers, credentials: 'include', cache: 'no-store' });
                    const body = await resp.json().catch(() => null);
                    outLines.push('');
                    outLines.push('[users/me]');
                    outLines.push(fmtHealthLine('status', resp.status));
                    outLines.push(fmtHealthLine('TipoUsuario', body && (body.TipoUsuario || body.tipoUsuario) ? (body.TipoUsuario || body.tipoUsuario) : '(none)'));
                    outLines.push(fmtHealthLine('Id', body && body.Id != null ? body.Id : '(none)'));
                    outLines.push(fmtHealthLine('Email', body && body.Email ? body.Email : '(none)'));
                } catch (e) {
                    outLines.push('');
                    outLines.push('[users/me] ERROR: ' + (e && e.message ? e.message : String(e)));
                }

                // 2) Admin probe (RBAC)
                try {
                    const probeUrl = base + '/api/admin/exams/probe' + (identity ? ('?sessionToken=' + encodeURIComponent(identity)) : '');
                    const resp = await fetch(probeUrl, { method: 'GET', headers, credentials: 'include', cache: 'no-store' });
                    outLines.push('');
                    outLines.push('[admin/exams/probe]');
                    outLines.push(fmtHealthLine('status', resp.status));
                    outLines.push(fmtHealthLine('ok', (resp.ok || resp.status === 204) ? 'yes' : 'no'));
                } catch (e) {
                    outLines.push('');
                    outLines.push('[admin/exams/probe] ERROR: ' + (e && e.message ? e.message : String(e)));
                }

                const text = outLines.join('\n');
                if (adminHealthCheckOutput) {
                    adminHealthCheckOutput.style.display = 'block';
                    adminHealthCheckOutput.textContent = text;
                }

                const ok = /\[admin\/exams\/probe\][\s\S]*ok\s*: yes/i.test(text) || /\[users\/me\][\s\S]*TipoUsuario\s*: admin/i.test(text);
                try {
                    if (window.showToast) window.showToast(ok ? 'Health check OK (admin)' : 'Health check: aten√ß√£o (n√£o-admin)');
                } catch(_){ }
                return ok;
            }

            window.runAdminHealthCheck = runAdminHealthCheck;

            // Allow other pages (sidebar) to redirect to /index.html and request opening a specific
            // admin modal section (e.g., fixture/reconcile).
            (function consumeAdminModalIntent(){
                let intent = '';
                try { intent = String(sessionStorage.getItem('adminModalIntent') || '').trim().toLowerCase(); } catch(_){ intent = ''; }
                if (!intent) return;
                try { sessionStorage.removeItem('adminModalIntent'); } catch(_){ }

                // Trigger open (may be async due to ensureAdminAccess())
                try { openAdminModal(); } catch(_){ }

                const startedAt = Date.now();
                const timer = setInterval(() => {
                    const m = document.getElementById('adminModal');
                    const isOpen = !!(m && m.classList.contains('active') && m.getAttribute('aria-hidden') === 'false');
                    if (!isOpen) {
                        if (Date.now() - startedAt > 6000) clearInterval(timer);
                        return;
                    }

                    try {
                        if (intent === 'fixture') {
                            const userField = document.getElementById('fxUserId');
                            if (userField) {
                                userField.focus();
                                userField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            } else {
                                const heading = Array.from(m.querySelectorAll('h3')).find(h => /Gerar\s+Tentativa\s+Fixture/i.test(h.textContent||''));
                                if (heading) heading.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }
                        } else if (intent === 'reconcile') {
                            const heading = Array.from(m.querySelectorAll('h3')).find(h => /Reconcilia/i.test(h.textContent||''));
                            if (heading) heading.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        } else if (intent === 'health-check' || intent === 'health') {
                            const acc = document.getElementById('adminHealthAccordion');
                            if (acc) acc.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            try { if (typeof window.runAdminHealthCheck === 'function') window.runAdminHealthCheck(); } catch(_){ }
                        }
                    } catch(_){ }

                    clearInterval(timer);
                }, 120);
            })();

            // Unified modal open/close to avoid click-through caused by lingering `inert`.
            function openAdminModal(){
                const m = document.getElementById('adminModal');
                if (!m) return null;

                const proceed = () => {
                    try { m.removeAttribute('inert'); } catch(_){ }
                    m.classList.add('active');
                    m.setAttribute('aria-hidden', 'false');
                    // Ensure visible even if an earlier close set inline display:none
                    m.style.display = 'flex';
                    // Ensure it captures clicks
                    m.style.pointerEvents = 'auto';
                    const navHide = document.querySelector('.bottom-nav');
                    if (navHide) navHide.style.display = 'none';
                    return m;
                };

                try { if (window.__isAdmin === true) return proceed(); } catch(_){ }

                // Verify admin before opening.
                ensureAdminAccess().then((ok) => {
                    if (ok) return proceed();
                    denyAdminUi();
                    return null;
                });
                return null;
            }
            function closeAdminModal(){
                const m = document.getElementById('adminModal');
                if (!m) return;
                m.classList.remove('active');
                m.setAttribute('aria-hidden', 'true');
                try { m.setAttribute('inert', ''); } catch(_){ }
                m.style.display = 'none';
                m.style.pointerEvents = '';
                const navShow = document.querySelector('.bottom-nav');
                if (navShow) navShow.style.display = '';
            }
            // Expose for sidebar component / other scripts
            window.openAdminModal = openAdminModal;
            window.closeAdminModal = closeAdminModal;

            // Global safety: block any admin UI triggers for non-admins (defense-in-depth).
            // This also protects against fallback/bundled handlers that might open the modal directly.
            document.addEventListener('click', (e) => {
                try {
                    const trigger = e && e.target && e.target.closest
                        ? e.target.closest('#card-admin,[data-card="admin"],#adminModalOpen,#adminMenuBtn,[data-admin-action]')
                        : null;
                    if (!trigger) return;
                    if (window.__isAdmin === true) return;
                    e.preventDefault();
                    e.stopPropagation();
                    if (typeof e.stopImmediatePropagation === 'function') e.stopImmediatePropagation();
                    denyAdminUi();
                } catch(_){ }
            }, true);
            
            // Set default dates (last 30 days)
            if (reconcileFromDate && reconcileToDate) {
                const today = new Date();
                const thirtyDaysAgo = new Date(today);
                thirtyDaysAgo.setDate(today.getDate() - 30);
                reconcileToDate.value = today.toISOString().split('T')[0];
                reconcileFromDate.value = thirtyDaysAgo.toISOString().split('T')[0];
            }
            
            // Check if user is admin on page load
            (async function checkAdmin() {
                try {
                    await ensureAdminAccess();
                } catch(e) {
                    logger.warn('Admin check failed:', e);
                }
            })();

            // Hook health check button
            if (adminHealthCheckBtn) {
                adminHealthCheckBtn.addEventListener('click', async () => {
                    const old = adminHealthCheckBtn.textContent;
                    adminHealthCheckBtn.disabled = true;
                    adminHealthCheckBtn.textContent = 'Rodando...';
                    try {
                        await runAdminHealthCheck();
                    } finally {
                        adminHealthCheckBtn.disabled = false;
                        adminHealthCheckBtn.textContent = old;
                    }
                });
            }

            // Copy health check output
            if (adminHealthCopyBtn) {
                adminHealthCopyBtn.addEventListener('click', async () => {
                    const text = (adminHealthCheckOutput && adminHealthCheckOutput.textContent)
                        ? String(adminHealthCheckOutput.textContent)
                        : '';
                    if (!text.trim()) {
                        try { if (window.showToast) window.showToast('Nada para copiar. Rode o health check primeiro.'); } catch(_){ }
                        return;
                    }

                    const old = adminHealthCopyBtn.textContent;
                    adminHealthCopyBtn.disabled = true;
                    adminHealthCopyBtn.textContent = 'Copiando...';

                    let ok = false;
                    try {
                        if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
                            await navigator.clipboard.writeText(text);
                            ok = true;
                        }
                    } catch(_){ ok = false; }

                    if (!ok) {
                        try {
                            const ta = document.createElement('textarea');
                            ta.value = text;
                            ta.setAttribute('readonly', '');
                            ta.style.position = 'fixed';
                            ta.style.left = '-9999px';
                            ta.style.top = '0';
                            document.body.appendChild(ta);
                            ta.select();
                            ok = document.execCommand('copy');
                            ta.remove();
                        } catch(_){ ok = false; }
                    }

                    try { if (window.showToast) window.showToast(ok ? 'Resultado copiado.' : 'Falha ao copiar.'); } catch(_){ }
                    adminHealthCopyBtn.disabled = false;
                    adminHealthCopyBtn.textContent = old;
                });
            }

            // Admin: view daily snapshots recorded from /api/ai/insights
            (function initAdminSnapshots(){
                if (!adminLoadSnapshotsBtn || !adminSnapshotsTable) return;

                function setStatus(msg){
                    if (!adminSnapshotsStatus) return;
                    adminSnapshotsStatus.textContent = msg || '';
                }

                function fmtNum(v, digits){
                    const n = Number(v);
                    if (!isFinite(n)) return '';
                    if (digits == null) return String(n);
                    return n.toFixed(digits);
                }

                function escapeHtml(s){
                    return String(s == null ? '' : s)
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#039;');
                }

                function render(items, includePayload){
                    if (!adminSnapshotsTable) return;
                    const list = Array.isArray(items) ? items : [];
                    if (!list.length){
                        adminSnapshotsTable.style.display = 'block';
                        adminSnapshotsTable.innerHTML = '<div style="font-size:.85rem;color:var(--muted)">Nenhum snapshot encontrado para este usu√°rio (ou n√£o √© pagante / ainda n√£o gerou insights hoje).</div>';
                        return;
                    }

                    const headStyle = 'padding:8px 10px;border-bottom:1px solid var(--border);text-align:left;font-size:.78rem;color:var(--muted);white-space:nowrap;';
                    const cellStyle = 'padding:8px 10px;border-bottom:1px solid rgba(148,163,184,0.2);font-size:.85rem;color:var(--text);vertical-align:top;white-space:nowrap;';

                    let html = '';
                    html += '<table style="width:100%;border-collapse:collapse">';
                    html += '<thead><tr>';
                    html += `<th style="${headStyle}">Data</th>`;
                    html += `<th style="${headStyle}">DaysToExam</th>`;
                    html += `<th style="${headStyle}">Readiness</th>`;
                    html += `<th style="${headStyle}">Consist√™ncia</th>`;
                    html += `<th style="${headStyle}">Avg%</th>`;
                    html += `<th style="${headStyle}">Prob%</th>`;
                    html += `<th style="${headStyle}">Overall%</th>`;
                    html += `<th style="${headStyle}">TrendŒî</th>`;
                    html += `<th style="${headStyle}">CompRate</th>`;
                    html += `<th style="${headStyle}">Abandon</th>`;
                    html += '</tr></thead><tbody>';

                    for (let i = 0; i < list.length; i++){
                        const r = list[i] || {};
                        const date = r.snapshot_date || r.snapshotDate || '';
                        const daysToExam = r.days_to_exam != null ? r.days_to_exam : r.daysToExam;
                        const readiness = r.readiness_score != null ? r.readiness_score : r.readinessScore;
                        const consistency = r.consistency_score != null ? r.consistency_score : r.consistencyScore;
                        const avg = r.avg_score_percent != null ? r.avg_score_percent : r.avgScorePercent;
                        const prob = r.pass_probability_percent != null ? r.pass_probability_percent : r.passProbabilityPercent;
                        const overall = r.pass_probability_overall_percent != null ? r.pass_probability_overall_percent : r.passProbabilityOverallPercent;
                        const trend = r.trend_delta_score7d != null ? r.trend_delta_score7d : r.trendDeltaScore7d;
                        const comp = r.completion_rate != null ? r.completion_rate : r.completionRate;
                        const abd = r.abandon_rate != null ? r.abandon_rate : r.abandonRate;

                        html += '<tr>';
                        html += `<td style="${cellStyle}">${escapeHtml(date)}</td>`;
                        html += `<td style="${cellStyle}">${escapeHtml(daysToExam == null ? '' : String(daysToExam))}</td>`;
                        html += `<td style="${cellStyle}">${escapeHtml(readiness == null ? '' : String(readiness))}</td>`;
                        html += `<td style="${cellStyle}">${escapeHtml(consistency == null ? '' : String(consistency))}</td>`;
                        html += `<td style="${cellStyle}">${escapeHtml(avg == null ? '' : fmtNum(avg, 2))}</td>`;
                        html += `<td style="${cellStyle}">${escapeHtml(prob == null ? '' : fmtNum(prob, 2))}</td>`;
                        html += `<td style="${cellStyle}">${escapeHtml(overall == null ? '' : fmtNum(overall, 2))}</td>`;
                        html += `<td style="${cellStyle}">${escapeHtml(trend == null ? '' : fmtNum(trend, 2))}</td>`;
                        html += `<td style="${cellStyle}">${escapeHtml(comp == null ? '' : fmtNum(comp, 4))}</td>`;
                        html += `<td style="${cellStyle}">${escapeHtml(abd == null ? '' : fmtNum(abd, 4))}</td>`;
                        html += '</tr>';

                        if (includePayload && r.payload != null){
                            const payloadId = 'snapPayload_' + i;
                            html += `<tr><td colspan="10" style="padding:8px 10px;border-bottom:1px solid rgba(148,163,184,0.2)">`;
                            html += `<details id="${payloadId}"><summary style="cursor:pointer;color:var(--muted);font-size:.82rem">payload JSON</summary>`;
                            html += `<pre style="white-space:pre-wrap;word-break:break-word;margin:8px 0 0;font-size:.75rem">${escapeHtml(JSON.stringify(r.payload, null, 2))}</pre>`;
                            html += `</details>`;
                            html += `</td></tr>`;
                        }
                    }

                    html += '</tbody></table>';
                    adminSnapshotsTable.style.display = 'block';
                    adminSnapshotsTable.innerHTML = html;
                }

                async function load(){
                    const uid = adminSnapshotUserId ? Number(adminSnapshotUserId.value) : null;
                    const days = adminSnapshotDays ? Number(adminSnapshotDays.value) : 90;
                    const includePayload = !!(adminSnapshotIncludePayload && adminSnapshotIncludePayload.checked);

                    if (!uid || !isFinite(uid) || uid <= 0){
                        alert('Preencha User ID.');
                        return;
                    }

                    setStatus('Carregando...');
                    adminLoadSnapshotsBtn.disabled = true;
                    const oldTxt = adminLoadSnapshotsBtn.textContent;
                    adminLoadSnapshotsBtn.textContent = 'Carregando...';

                    try {
                        const base = (window.SIMULADOS_CONFIG && window.SIMULADOS_CONFIG.BACKEND_BASE) || 'http://localhost:3000';
                        const url = base + '/api/admin/users/' + encodeURIComponent(String(uid)) + '/insights-snapshots'
                          + '?days=' + encodeURIComponent(String(isFinite(days) && days > 0 ? Math.min(Math.max(Math.floor(days), 1), 365) : 90))
                          + '&includePayload=' + (includePayload ? '1' : '0');

                        const resp = await fetch(url, { cache: 'no-store', credentials: 'include' });
                        const raw = await resp.text();
                        let data = null;
                        try { data = raw ? JSON.parse(raw) : null; } catch(_) { data = null; }
                        if (!resp.ok) throw new Error((data && (data.error || data.message)) || raw || (resp.status + ' ' + resp.statusText));

                        const items = data && Array.isArray(data.items) ? data.items : [];
                        setStatus(`OK ‚Äî ${items.length} registro(s).`);
                        render(items, includePayload);
                    } catch (e) {
                        setStatus((e && e.message) ? e.message : String(e));
                        adminSnapshotsTable.style.display = 'block';
                        adminSnapshotsTable.innerHTML = '<div style="font-family:monospace;font-size:.8rem;color:var(--text)">Erro ao carregar snapshots.</div>';
                    } finally {
                        adminLoadSnapshotsBtn.disabled = false;
                        adminLoadSnapshotsBtn.textContent = oldTxt;
                    }
                }

                adminLoadSnapshotsBtn.addEventListener('click', () => { load(); });

                if (adminUseOverrideUserIdBtn) {
                    adminUseOverrideUserIdBtn.addEventListener('click', () => {
                        const uid = adminUserIdOverride ? Number(adminUserIdOverride.value) : null;
                        if (adminSnapshotUserId && uid && isFinite(uid) && uid > 0) {
                            adminSnapshotUserId.value = String(uid);
                            setStatus('User ID preenchido a partir do Override.');
                        } else {
                            alert('Preencha User ID no accordion de Override (ou digite manualmente).');
                        }
                    });
                }
            })();

            // Admin: DB cleanup (truncate non-masterdata tables)
            (function initAdminDbCleanup(){
                const dryBtn = document.getElementById('adminDbDryRunBtn');
                const execBtn = document.getElementById('adminDbExecuteBtn');
                const outEl = document.getElementById('adminDbCleanupOutput');
                const statusEl = document.getElementById('adminDbCleanupStatus');
                const confirmEl = document.getElementById('adminDbConfirmText');

                const keepUsersEl = document.getElementById('adminDbKeepUsers');
                const keepRbacEl = document.getElementById('adminDbKeepRbac');
                const keepEntitlementsEl = document.getElementById('adminDbKeepEntitlements');
                const keepCommEl = document.getElementById('adminDbKeepComm');
                const keepNotifEl = document.getElementById('adminDbKeepNotif');

                if (!dryBtn || !execBtn || !outEl) return;

                function setStatus(msg){ if (statusEl) statusEl.textContent = msg || ''; }

                function showOut(obj){
                    outEl.style.display = 'block';
                    outEl.textContent = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2);
                }

                async function callApi(dryRun){
                    const base = (window.SIMULADOS_CONFIG && window.SIMULADOS_CONFIG.BACKEND_BASE) || 'http://localhost:3000';
                    const url = base + '/api/admin/db/cleanup/non-masterdata';

                    const options = {
                        keepUsers: keepUsersEl ? !!keepUsersEl.checked : true,
                        keepRbac: keepRbacEl ? !!keepRbacEl.checked : true,
                        keepEntitlements: keepEntitlementsEl ? !!keepEntitlementsEl.checked : true,
                        keepCommunication: keepCommEl ? !!keepCommEl.checked : true,
                        keepNotifications: keepNotifEl ? !!keepNotifEl.checked : false,
                    };

                    const payload = {
                        dryRun: !!dryRun,
                        confirm: confirmEl ? String(confirmEl.value || '').trim() : '',
                        options,
                    };

                    const resp = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                        credentials: 'include',
                    });

                    const raw = await resp.text();
                    let data = null;
                    try { data = raw ? JSON.parse(raw) : null; } catch(_) { data = null; }
                    if (!resp.ok) throw new Error((data && (data.error || data.message)) || raw || (resp.status + ' ' + resp.statusText));
                    return data;
                }

                async function runDry(){
                    setStatus('Simulando...');
                    dryBtn.disabled = true;
                    execBtn.disabled = true;
                    try {
                        const data = await callApi(true);
                        setStatus(`OK ‚Äî ${data && data.truncate ? data.truncate.length : 0} tabela(s) para truncar.`);
                        showOut(data);
                    } catch(e){
                        setStatus((e && e.message) ? e.message : String(e));
                        showOut((e && e.message) ? e.message : String(e));
                    } finally {
                        dryBtn.disabled = false;
                        execBtn.disabled = false;
                    }
                }

                async function runExec(){
                    const conf = confirmEl ? String(confirmEl.value || '').trim() : '';
                    if (conf !== 'LIMPAR_NAO_MASTERDATA') {
                        alert('Para executar, digite exatamente: LIMPAR_NAO_MASTERDATA');
                        return;
                    }

                    const ok = confirm('Esta opera√ß√£o TRUNCA tabelas (dados ser√£o perdidos). Deseja continuar?');
                    if (!ok) return;

                    setStatus('Executando limpeza...');
                    dryBtn.disabled = true;
                    execBtn.disabled = true;
                    try {
                        const data = await callApi(false);
                        setStatus(`OK ‚Äî truncadas ${data && data.truncated != null ? data.truncated : '?'} tabela(s).`);
                        showOut(data);
                    } catch(e){
                        setStatus((e && e.message) ? e.message : String(e));
                        showOut((e && e.message) ? e.message : String(e));
                    } finally {
                        dryBtn.disabled = false;
                        execBtn.disabled = false;
                    }
                }

                dryBtn.addEventListener('click', runDry);
                execBtn.addEventListener('click', runExec);
            })();

            // Admin: emulator (start exam from explicit question IDs)
            (function initAdminEmulator(){
                const idsEl = document.getElementById('adminEmulatorQuestionIds');
                const startBtn = document.getElementById('adminEmulatorStartBtn');
                const clearBtn = document.getElementById('adminEmulatorClearBtn');
                const outEl = document.getElementById('adminEmulatorOutput');
                if (!idsEl || !startBtn || !clearBtn || !outEl) return;

                function setOut(msg){
                    outEl.style.display = 'block';
                    outEl.textContent = msg || '';
                }

                function parseIds(text){
                    const s = String(text || '');
                    const m = s.match(/\d+/g) || [];
                    const raw = m.map(x => Math.floor(Number(x))).filter(n => Number.isFinite(n) && n > 0);
                    const seen = new Set();
                    const uniq = [];
                    for (const id of raw){
                        if (!seen.has(id)) { seen.add(id); uniq.push(id); }
                    }
                    return uniq;
                }

                function genTempSessionId(){
                    return 'tmp-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,8);
                }

                async function ensureAdmin(){
                    try { if (window.__isAdmin === true) return true; } catch(_){ }

                    const base = (window.SIMULADOS_CONFIG && window.SIMULADOS_CONFIG.BACKEND_BASE) || 'http://localhost:3000';
                    const headers = {};

                    // Prefer sending the same identity header the backend expects for auth.
                    try {
                        const identity = (localStorage.getItem('nomeUsuario') || localStorage.getItem('sessionToken') || '').trim();
                        if (identity) headers['X-Session-Token'] = identity;
                    } catch(_){ }

                    // Include JWT variants used across the codebase (best-effort).
                    try {
                        const jwtTokA = (localStorage.getItem('jwtToken')||'').trim();
                        const jwtTypeA = (localStorage.getItem('jwtTokenType')||'Bearer').trim()||'Bearer';
                        if (jwtTokA) headers['Authorization'] = `${jwtTypeA} ${jwtTokA}`;
                    } catch(_){ }
                    try {
                        const jwtTokB = (localStorage.getItem('jwt')||'').trim();
                        const jwtTypeB = (localStorage.getItem('jwt_type')||'Bearer').trim()||'Bearer';
                        if (!headers['Authorization'] && jwtTokB) headers['Authorization'] = `${jwtTypeB} ${jwtTokB}`;
                    } catch(_){ }

                    // Primary: RBAC/requireAdmin probe (aligns with backend enforcement)
                    try {
                        const resp = await fetch(base + '/api/admin/exams/probe', { method: 'GET', headers, credentials: 'include' });
                        if (resp.ok || resp.status === 204) {
                            try { window.__isAdmin = true; } catch(_){ }
                            return true;
                        }
                    } catch(_){ }

                    // Fallback: legacy derived flag (email/username-based)
                    try {
                        const resp2 = await fetch(base + '/api/users/me', { headers, credentials: 'include' });
                        if (!resp2.ok) return false;
                        const user = await resp2.json().catch(()=>null);
                        const ok = !!(user && user.TipoUsuario === 'admin');
                        if (ok) { try { window.__isAdmin = true; } catch(_){ } }
                        return ok;
                    } catch(_){
                        return false;
                    }
                }

                startBtn.addEventListener('click', async ()=>{
                    const isAdmin = await ensureAdmin();
                    if (!isAdmin){
                        alert('Somente admin pode emular exame por IDs.');
                        return;
                    }

                    const ids = parseIds(idsEl.value);
                    if (!ids.length){
                        setOut('Informe pelo menos 1 ID.');
                        return;
                    }
                    if (ids.length > 200){
                        setOut(`Muitos IDs: ${ids.length}. M√°ximo permitido: 200.`);
                        return;
                    }

                    try {
                        localStorage.setItem('examEmulatorQuestionIds', JSON.stringify(ids));
                        localStorage.setItem('examQuestionCount', String(ids.length));
                        // Force a fresh session so cached questions won't be reused
                        const oldSid = localStorage.getItem('currentSessionId') || '';
                        const newSid = genTempSessionId();
                        localStorage.setItem('tempSessionId', newSid);
                        localStorage.setItem('currentSessionId', newSid);
                        try { if (oldSid) localStorage.removeItem(`questions_${oldSid}`); } catch(_){ }
                        try { sessionStorage.setItem('startExam', 'true'); } catch(_){ }
                    } catch(e){
                        setOut('Falha ao gravar no localStorage: ' + (e && e.message ? e.message : String(e)));
                        return;
                    }

                    setOut(`OK. ${ids.length} ID(s) salvos. Redirecionando para o exame...`);
                    window.location.assign('/pages/examFull.html');
                });

                clearBtn.addEventListener('click', ()=>{
                    try { idsEl.value = ''; } catch(_){ }
                    try { localStorage.removeItem('examEmulatorQuestionIds'); } catch(_){ }
                    setOut('Limpo.');
                });
            })();
            
            if (adminModalClose && adminModal) {
                adminModalClose.addEventListener('click', () => {
                    closeAdminModal();
                });
            }
            
            // Admin Modal Accordions
            if (adminModal) {
                const accordions = adminModal.querySelectorAll('.admin-accordion');
                accordions.forEach(accordion => {
                    const header = accordion.querySelector('.admin-accordion-header');
                    const content = accordion.querySelector('.admin-accordion-content');
                    const chevron = accordion.querySelector('.admin-accordion-chevron');
                    
                    if (header && content) {
                        header.addEventListener('click', () => {
                            const isOpen = content.style.display === 'block';
                            
                            if (isOpen) {
                                content.style.display = 'none';
                                if (chevron) chevron.style.transform = 'rotate(0deg)';
                                header.style.background = 'var(--bg)';
                            } else {
                                content.style.display = 'block';
                                if (chevron) chevron.style.transform = 'rotate(180deg)';
                                header.style.background = 'rgba(79, 70, 229, 0.1)';
                            }
                        });
                        
                        // Hover effect
                        header.addEventListener('mouseenter', () => {
                            if (content.style.display !== 'block') {
                                header.style.background = 'rgba(148, 163, 184, 0.1)';
                            }
                        });
                        header.addEventListener('mouseleave', () => {
                            if (content.style.display !== 'block') {
                                header.style.background = 'var(--bg)';
                            }
                        });
                    }
                });
            }

            // Comunica√ß√£o: manage recipient admins
            (function initAdminCommunication(){
                const toolsAccordion = document.getElementById('adminAccordionTools');
                if (!commRecipientsStatus) return;

                function getCookie(name){
                    try {
                        const v = String(document.cookie || '');
                        const parts = v.split(';').map(s => s.trim());
                        for (const p of parts){
                            if (!p) continue;
                            const idx = p.indexOf('=');
                            const k = idx >= 0 ? p.slice(0, idx) : p;
                            const val = idx >= 0 ? p.slice(idx + 1) : '';
                            if (k === name) return decodeURIComponent(val || '');
                        }
                    } catch(_){ }
                    return '';
                }

                function getSessionIdentity(){
                    const nomeUsuario = (localStorage.getItem('nomeUsuario') || '').trim();
                    const sessionToken = (localStorage.getItem('sessionToken') || '').trim();
                    return sessionToken || nomeUsuario;
                }

                async function adminFetch(path, opts){
                    const options = opts || {};
                    const method = (options.method || 'GET').toUpperCase();
                    const identity = getSessionIdentity();

                    const base = (window.SIMULADOS_CONFIG && window.SIMULADOS_CONFIG.BACKEND_BASE) || 'http://localhost:3000';
                    const jwtTok = (localStorage.getItem('jwtToken')||'').trim();
                    const jwtType = (localStorage.getItem('jwtTokenType')||'Bearer').trim()||'Bearer';

                    const headers = Object.assign({}, options.headers || {});
                    if (identity) headers['X-Session-Token'] = identity;
                    if (jwtTok) headers['Authorization'] = `${jwtType} ${jwtTok}`;

                    // CSRF: ensure we have a csrfToken cookie for state-changing requests
                    if (!['GET','HEAD','OPTIONS'].includes(method)) {
                        let csrf = getCookie('csrfToken');
                        if (!csrf) {
                            try { await fetch(base + '/api/csrf-token', { method: 'GET', credentials: 'include' }); } catch(_){ }
                            csrf = getCookie('csrfToken');
                        }
                        if (csrf) headers['X-CSRF-Token'] = csrf;
                    }

                    const url = base + path + (identity ? ((path.includes('?') ? '&' : '?') + 'sessionToken=' + encodeURIComponent(identity)) : '');

                    const resp = await fetch(url, {
                        method,
                        headers,
                        credentials: 'include',
                        body: options.body
                    });
                    const data = await resp.json().catch(()=>({}));
                    return { ok: resp.ok, status: resp.status, data };
                }

                function setStatus(msg){
                    if (!commRecipientsStatus) return;
                    commRecipientsStatus.textContent = msg || '';
                }

                function renderRecipients(items){
                    if (!commRecipientsList) return;
                    commRecipientsList.innerHTML = '';
                    const list = Array.isArray(items) ? items : [];

                    if (!list.length){
                        const empty = document.createElement('div');
                        empty.style.fontSize = '0.85rem';
                        empty.style.color = 'var(--muted)';
                        empty.textContent = 'Nenhum destinat√°rio cadastrado.';
                        commRecipientsList.appendChild(empty);
                        return;
                    }

                    list.forEach(item => {
                        const row = document.createElement('div');
                        row.style.display = 'flex';
                        row.style.alignItems = 'center';
                        row.style.justifyContent = 'space-between';
                        row.style.gap = '10px';
                        row.style.padding = '10px';
                        row.style.border = '1px solid var(--border)';
                        row.style.borderRadius = '8px';
                        row.style.background = 'var(--bg)';

                        const left = document.createElement('div');
                        left.style.display = 'grid';
                        left.style.gap = '2px';

                        const name = document.createElement('div');
                        name.style.fontSize = '0.9rem';
                        name.style.fontWeight = '600';
                        name.style.color = 'var(--text)';
                        name.textContent = (item && item.Nome) ? String(item.Nome) : `User ${item && item.UserId ? item.UserId : ''}`;

                        const email = document.createElement('div');
                        email.style.fontSize = '0.8rem';
                        email.style.color = 'var(--muted)';
                        email.textContent = (item && item.Email) ? String(item.Email) : '';

                        left.appendChild(name);
                        left.appendChild(email);

                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.textContent = 'Remover';
                        btn.style.padding = '8px 10px';
                        btn.style.background = 'var(--bg)';
                        btn.style.color = 'var(--text)';
                        btn.style.border = '1px solid var(--border)';
                        btn.style.borderRadius = '6px';
                        btn.style.fontSize = '0.85rem';
                        btn.style.fontWeight = '600';
                        btn.style.cursor = 'pointer';

                        const uid = Number(item && item.UserId);
                        btn.addEventListener('click', async ()=>{
                            if (!uid) return;
                            btn.disabled = true;
                            setStatus('Removendo...');
                            const r = await adminFetch(`/api/admin/communication/recipients/${encodeURIComponent(uid)}`, { method: 'DELETE' });
                            if (!r.ok) {
                                setStatus(r.data && r.data.error ? r.data.error : `Falha ao remover (${r.status}).`);
                                btn.disabled = false;
                                return;
                            }
                            await loadRecipients();
                        });

                        row.appendChild(left);
                        row.appendChild(btn);
                        commRecipientsList.appendChild(row);
                    });
                }

                async function loadRecipients(){
                    setStatus('Carregando destinat√°rios...');
                    const r = await adminFetch('/api/admin/communication/recipients', { method: 'GET' });
                    if (!r.ok){
                        setStatus(r.data && r.data.error ? r.data.error : `Falha ao carregar (${r.status}).`);
                        renderRecipients([]);
                        return;
                    }
                    renderRecipients((r.data && r.data.items) || []);
                    setStatus('');
                }

                async function loadAdmins(){
                    if (!commAdminSelect) return;
                    commAdminSelect.disabled = true;
                    commAdminSelect.innerHTML = '<option value="">Carregando admins...</option>';
                    if (commAddRecipientBtn) commAddRecipientBtn.disabled = true;

                    const r = await adminFetch('/api/admin/communication/admins', { method: 'GET' });
                    if (!r.ok){
                        commAdminSelect.innerHTML = `<option value="">Falha (${r.status})</option>`;
                        setStatus(r.data && r.data.error ? r.data.error : 'Falha ao carregar admins.');
                        return;
                    }

                    const items = (r.data && r.data.items) || [];
                    if (!items.length){
                        commAdminSelect.innerHTML = '<option value="">Nenhum admin encontrado</option>';
                        return;
                    }

                    commAdminSelect.innerHTML = '<option value="" selected>Selecione um admin...</option>';
                    items.forEach(u => {
                        const opt = document.createElement('option');
                        opt.value = String(u.Id);
                        const nome = (u.Nome || u.NomeUsuario || `User ${u.Id}`);
                        const email = (u.Email || '');
                        opt.textContent = `${nome} ‚Äî ${email}`;
                        commAdminSelect.appendChild(opt);
                    });
                    commAdminSelect.disabled = false;
                    setStatus('');
                }

                async function addSelectedRecipient(){
                    if (!commAdminSelect) return;
                    const userId = Number(commAdminSelect.value);
                    if (!Number.isFinite(userId) || userId <= 0) return;
                    if (commAddRecipientBtn) commAddRecipientBtn.disabled = true;
                    setStatus('Adicionando...');

                    const r = await adminFetch('/api/admin/communication/recipients', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId })
                    });

                    if (!r.ok){
                        setStatus(r.data && r.data.error ? r.data.error : `Falha ao adicionar (${r.status}).`);
                        if (commAddRecipientBtn) commAddRecipientBtn.disabled = false;
                        return;
                    }

                    await loadRecipients();
                    setStatus('');
                    if (commAddRecipientBtn) commAddRecipientBtn.disabled = !String(commAdminSelect.value || '');
                }

                if (commAdminSelect) commAdminSelect.addEventListener('change', ()=>{
                    const v = String(commAdminSelect.value || '');
                    if (commAddRecipientBtn) commAddRecipientBtn.disabled = !v;
                });
                if (commAddRecipientBtn) commAddRecipientBtn.addEventListener('click', addSelectedRecipient);
                if (commRefreshRecipientsBtn) commRefreshRecipientsBtn.addEventListener('click', loadRecipients);

                // Lazy-load recipients when the tools accordion is opened
                if (toolsAccordion) {
                    const header = toolsAccordion.querySelector('.admin-accordion-header');
                    if (header) {
                        header.addEventListener('click', ()=>{
                            setTimeout(()=>{
                                try {
                                    const content = toolsAccordion.querySelector('.admin-accordion-content');
                                    if (content && content.style.display === 'block') {
                                        loadAdmins();
                                        loadRecipients();
                                    }
                                } catch(_){ }
                            }, 0);
                        });
                    }
                }
            })();
            
            if (reconcileBtn) {
                reconcileBtn.addEventListener('click', async () => {
                    const fromDate = reconcileFromDate.value;
                    const toDate = reconcileToDate.value;
                    const mode = reconcileMode.value;
                    const dryRun = reconcileDryRun.checked;
                    
                    if (!fromDate || !toDate) {
                        alert('Por favor, preencha as datas inicial e final.');
                        return;
                    }
                    
                    if (new Date(fromDate) > new Date(toDate)) {
                        alert('Data inicial deve ser anterior √† data final.');
                        return;
                    }
                    
                    reconcileOutput.style.display = 'block';
                    reconcileOutput.textContent = 'Executando reconcilia√ß√£o...\n';
                    reconcileBtn.disabled = true;
                    reconcileBtn.textContent = 'Processando...';
                    
                    try {
                        const base = (window.SIMULADOS_CONFIG && window.SIMULADOS_CONFIG.BACKEND_BASE) || 'http://localhost:3000';
                        const token = localStorage.getItem('sessionToken');
                        
                        const params = new URLSearchParams({
                            from: fromDate,
                            to: toDate,
                            mode: mode,
                            dryRun: dryRun ? 'true' : 'false'
                        });
                        
                        const resp = await fetch(base + '/api/admin/exams/reconcile-stats?' + params, {
                            method: 'POST',
                            headers: {
                                'Authorization': 'Bearer ' + (localStorage.getItem('jwt') || ''),
                                'X-Session-Token': token
                            }
                        });
                        
                        const result = await resp.json();
                        
                        if (resp.ok) {
                            reconcileOutput.textContent = 'Reconcilia√ß√£o conclu√≠da com sucesso!\n\n' + JSON.stringify(result, null, 2);
                        } else {
                            reconcileOutput.textContent = 'Erro na reconcilia√ß√£o:\n' + (result.error || resp.statusText);
                        }
                    } catch(e) {
                        reconcileOutput.textContent = 'Erro ao executar reconcilia√ß√£o:\n' + e.message;
                    } finally {
                        reconcileBtn.disabled = false;
                        reconcileBtn.textContent = 'Executar Reconcilia√ß√£o';
                    }
                });
            }

            // Load exam types and versions into the admin modal
            async function loadAdminExamTypes(){
                try {
                    const base = (window.SIMULADOS_CONFIG && window.SIMULADOS_CONFIG.BACKEND_BASE) || 'http://localhost:3000';
                    const resp = await fetch(base + '/api/exams/types', { cache: 'no-store', credentials: 'include' });
                    const list = resp.ok ? await resp.json() : [];
                    const types = Array.isArray(list) ? list : [];
                    const selects = [adminExamTypeSelect, adminUserExamTypeSelect].filter(Boolean);
                    selects.forEach(sel => {
                        sel.innerHTML = '';
                        const opt0 = document.createElement('option');
                        opt0.value = '';
                        opt0.textContent = 'Selecione...';
                        sel.appendChild(opt0);
                    });
                    for (const t of types){
                        const dbId = (t && t._dbId != null) ? Number(t._dbId) : null;
                        if (!dbId || !isFinite(dbId) || dbId <= 0) continue;
                        const slug = (t && t.id) ? String(t.id) : '';
                        const nome = (t && t.nome) ? String(t.nome) : slug;
                        selects.forEach(sel => {
                            const opt = document.createElement('option');
                            opt.value = String(dbId);
                            opt.textContent = nome + (slug ? ` (${slug})` : '');
                            sel.appendChild(opt);
                        });
                    }
                } catch(e){
                    const selects = [adminExamTypeSelect, adminUserExamTypeSelect].filter(Boolean);
                    selects.forEach(sel => {
                        sel.innerHTML = '';
                        const opt = document.createElement('option');
                        opt.value = '';
                        opt.textContent = 'Falha ao carregar tipos';
                        sel.appendChild(opt);
                    });
                }
            }

            async function loadAdminContentVersions(examTypeId){
                if (!adminExamContentVersionSelect) return;
                adminExamContentVersionSelect.disabled = true;
                adminExamContentVersionSelect.innerHTML = '';
                const opt = document.createElement('option');
                opt.value = '';
                opt.textContent = 'Carregando vers√µes...';
                adminExamContentVersionSelect.appendChild(opt);

                try {
                    const base = (window.SIMULADOS_CONFIG && window.SIMULADOS_CONFIG.BACKEND_BASE) || 'http://localhost:3000';
                    const url = base + '/api/admin/exams/content-versions?examTypeId=' + encodeURIComponent(String(examTypeId));
                    const resp = await fetch(url, { cache: 'no-store', credentials: 'include' });
                    const raw = await resp.text();
                    let data = null;
                    try { data = raw ? JSON.parse(raw) : null; } catch(_) { data = null; }
                    if (!resp.ok) throw new Error((data && (data.error || data.message)) || raw || (resp.status + ' ' + resp.statusText));

                    const versions = (data && Array.isArray(data.versions)) ? data.versions : [];
                    const currentId = (data && data.currentVersionId != null) ? Number(data.currentVersionId) : null;
                    adminExamContentVersionSelect.innerHTML = '';
                    const opt1 = document.createElement('option');
                    opt1.value = '';
                    opt1.textContent = versions.length ? 'Selecione...' : 'Nenhuma vers√£o cadastrada';
                    adminExamContentVersionSelect.appendChild(opt1);
                    for (const v of versions){
                        const id = (v && v.id != null) ? Number(v.id) : null;
                        if (!id || !isFinite(id) || id <= 0) continue;
                        const code = (v && v.code) ? String(v.code) : ('v' + id);
                        const eff = (v && v.effectiveFrom) ? String(v.effectiveFrom).split('T')[0] : '';
                        const label = eff ? `${code} - ${eff}` : code;
                        const o = document.createElement('option');
                        o.value = String(id);
                        o.textContent = label;
                        if (currentId && id === currentId) o.selected = true;
                        adminExamContentVersionSelect.appendChild(o);
                    }
                    adminExamContentVersionSelect.disabled = versions.length === 0;

                    if (adminExamContentVersionOutput){
                        adminExamContentVersionOutput.style.display = 'block';
                        adminExamContentVersionOutput.textContent = JSON.stringify({ examTypeId: Number(examTypeId), currentVersionId: currentId, versionsCount: versions.length }, null, 2);
                    }
                } catch(e){
                    adminExamContentVersionSelect.innerHTML = '';
                    const optE = document.createElement('option');
                    optE.value = '';
                    optE.textContent = 'Erro ao carregar vers√µes';
                    adminExamContentVersionSelect.appendChild(optE);
                    if (adminExamContentVersionOutput){
                        adminExamContentVersionOutput.style.display = 'block';
                        adminExamContentVersionOutput.textContent = 'Erro:\n' + (e && e.message ? e.message : String(e));
                    }
                }
            }

            if (adminExamTypeSelect) {
                adminExamTypeSelect.addEventListener('change', async () => {
                    const examTypeId = Number(adminExamTypeSelect.value);
                    if (!examTypeId) {
                        if (adminExamContentVersionSelect){
                            adminExamContentVersionSelect.disabled = true;
                            adminExamContentVersionSelect.innerHTML = '<option value="">Selecione um tipo de exame</option>';
                        }
                        return;
                    }
                    await loadAdminContentVersions(examTypeId);
                });
                // initial load
                loadAdminExamTypes();
            }

            async function maybeLoadUserOverride(){
                try {
                    const uid = adminUserIdOverride ? Number(adminUserIdOverride.value) : null;
                    const et = adminUserExamTypeSelect ? Number(adminUserExamTypeSelect.value) : null;
                    if (!uid || !et) return;
                    const base = (window.SIMULADOS_CONFIG && window.SIMULADOS_CONFIG.BACKEND_BASE) || 'http://localhost:3000';
                    const url = base + '/api/admin/exams/user-content-version?userId=' + encodeURIComponent(String(uid)) + '&examTypeId=' + encodeURIComponent(String(et));
                    const resp = await fetch(url, { cache: 'no-store', credentials: 'include' });
                    const raw = await resp.text();
                    let data = null;
                    try { data = raw ? JSON.parse(raw) : null; } catch(_) { data = null; }
                    if (!resp.ok) throw new Error((data && (data.error || data.message)) || raw || (resp.status + ' ' + resp.statusText));
                    const ov = data && data.override ? data.override : null;
                    if (ov && adminUserExamContentVersionSelect) {
                        const vid = Number(ov.examContentVersionId);
                        const opt = adminUserExamContentVersionSelect.querySelector('option[value="' + String(vid) + '"]');
                        if (opt) adminUserExamContentVersionSelect.value = String(vid);
                    }
                    if (adminUserOverrideOutput){
                        adminUserOverrideOutput.style.display = 'block';
                        adminUserOverrideOutput.textContent = JSON.stringify(data, null, 2);
                    }
                } catch(e){
                    if (adminUserOverrideOutput){
                        adminUserOverrideOutput.style.display = 'block';
                        adminUserOverrideOutput.textContent = 'Erro ao consultar override:\n' + (e && e.message ? e.message : String(e));
                    }
                }
            }

            async function loadAdminUserLabel(){
                if (!adminUserIdOverride || !adminUserIdOverrideHint) return;
                const uid = Number(adminUserIdOverride.value);
                if (!uid || !isFinite(uid) || uid <= 0){
                    adminUserIdOverrideHint.textContent = '';
                    return;
                }
                adminUserIdOverrideHint.textContent = 'Carregando usu√°rio...';
                try {
                    const base = (window.SIMULADOS_CONFIG && window.SIMULADOS_CONFIG.BACKEND_BASE) || 'http://localhost:3000';
                    const url = base + '/api/admin/users/' + encodeURIComponent(String(uid));
                    const resp = await fetch(url, { cache: 'no-store', credentials: 'include' });
                    const raw = await resp.text();
                    let data = null;
                    try { data = raw ? JSON.parse(raw) : null; } catch(_) { data = null; }
                    if (!resp.ok) {
                        adminUserIdOverrideHint.textContent = `Usu√°rio ${uid} n√£o encontrado`;
                        return;
                    }
                    const id = data && (data.Id != null ? data.Id : data.id);
                    const nome = data && (data.Nome || data.nome) ? String(data.Nome || data.nome) : '';
                    const usern = data && (data.NomeUsuario || data.nomeUsuario) ? String(data.NomeUsuario || data.nomeUsuario) : '';
                    const labelParts = [String(id || uid)];
                    if (nome) labelParts.push(nome);
                    if (usern) labelParts.push('(@' + usern + ')');
                    adminUserIdOverrideHint.textContent = labelParts.join(' - ');
                } catch(e){
                    adminUserIdOverrideHint.textContent = `Usu√°rio ${uid}`;
                }
            }

            function buildAdminUserLabel(u){
                const id = u && (u.Id != null ? u.Id : u.id);
                const nome = u && (u.Nome || u.nome) ? String(u.Nome || u.nome) : '';
                const usern = u && (u.NomeUsuario || u.nomeUsuario) ? String(u.NomeUsuario || u.nomeUsuario) : '';
                const email = u && (u.Email || u.email) ? String(u.Email || u.email) : '';
                const parts = [String(id || '')].filter(Boolean);
                if (nome) parts.push(nome);
                if (usern) parts.push('(@' + usern + ')');
                if (email) parts.push('<' + email + '>');
                return parts.join(' - ');
            }

            async function searchAdminUsers(){
                if (!adminUserSearchQuery || !adminUserSearchSelect) return;
                const q = String(adminUserSearchQuery.value || '').trim();
                if (adminUserSearchStatus) adminUserSearchStatus.textContent = '';

                adminUserSearchSelect.disabled = true;
                adminUserSearchSelect.innerHTML = '<option value="">Buscando...</option>';

                if (!q) {
                    adminUserSearchSelect.innerHTML = '<option value="">Digite nome, @usuario ou email</option>';
                    adminUserSearchSelect.disabled = true;
                    if (adminUserSearchStatus) adminUserSearchStatus.textContent = '';
                    return;
                }

                try {
                    const base = (window.SIMULADOS_CONFIG && window.SIMULADOS_CONFIG.BACKEND_BASE) || 'http://localhost:3000';
                    const url = base + '/api/admin/users/search?q=' + encodeURIComponent(q) + '&limit=25';
                    const resp = await fetch(url, { cache: 'no-store', credentials: 'include' });
                    const raw = await resp.text();
                    let data = null;
                    try { data = raw ? JSON.parse(raw) : null; } catch(_) { data = null; }
                    if (!resp.ok) throw new Error((data && (data.error || data.message)) || raw || (resp.status + ' ' + resp.statusText));

                    const items = (data && Array.isArray(data.items)) ? data.items : [];
                    adminUserSearchSelect.innerHTML = '';
                    const opt0 = document.createElement('option');
                    opt0.value = '';
                    opt0.textContent = items.length ? 'Selecione um usu√°rio...' : 'Nenhum usu√°rio encontrado';
                    adminUserSearchSelect.appendChild(opt0);

                    for (const u of items) {
                        const id = u && (u.Id != null ? Number(u.Id) : Number(u.id));
                        if (!id || !isFinite(id) || id <= 0) continue;
                        const o = document.createElement('option');
                        o.value = String(id);
                        o.textContent = buildAdminUserLabel(u);
                        adminUserSearchSelect.appendChild(o);
                    }

                    adminUserSearchSelect.disabled = items.length === 0;
                    if (adminUserSearchStatus) adminUserSearchStatus.textContent = items.length ? (items.length + ' resultado(s)') : '0 resultado';
                } catch (e) {
                    adminUserSearchSelect.innerHTML = '<option value="">Erro na busca</option>';
                    adminUserSearchSelect.disabled = true;
                    if (adminUserSearchStatus) adminUserSearchStatus.textContent = (e && e.message) ? e.message : String(e);
                }
            }

            if (adminUserSearchBtn) {
                adminUserSearchBtn.addEventListener('click', () => { searchAdminUsers(); });
            }
            if (adminUserSearchQuery) {
                adminUserSearchQuery.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        searchAdminUsers();
                    }
                });
            }
            if (adminUserSearchSelect) {
                adminUserSearchSelect.addEventListener('change', async () => {
                    const val = String(adminUserSearchSelect.value || '').trim();
                    const uid = Number(val);
                    if (!adminUserIdOverride || !uid || !isFinite(uid) || uid <= 0) return;
                    adminUserIdOverride.value = String(uid);
                    await loadAdminUserLabel();

                    const examTypeId = adminUserExamTypeSelect ? Number(adminUserExamTypeSelect.value) : null;
                    if (!examTypeId) return;
                    await loadAdminContentVersions(examTypeId);
                    if (adminUserExamContentVersionSelect && adminExamContentVersionSelect){
                        adminUserExamContentVersionSelect.innerHTML = adminExamContentVersionSelect.innerHTML;
                        adminUserExamContentVersionSelect.disabled = adminExamContentVersionSelect.disabled;
                    }
                    await maybeLoadUserOverride();
                });
            }

            if (adminUserExamTypeSelect) {
                adminUserExamTypeSelect.addEventListener('change', async () => {
                    const examTypeId = Number(adminUserExamTypeSelect.value);
                    const uid = adminUserIdOverride ? Number(adminUserIdOverride.value) : null;
                    if (!uid || !examTypeId) {
                        if (adminUserExamContentVersionSelect){
                            adminUserExamContentVersionSelect.disabled = true;
                            adminUserExamContentVersionSelect.innerHTML = '<option value="">Selecione User ID + tipo de exame</option>';
                        }
                        return;
                    }
                    await loadAdminContentVersions(examTypeId);
                    // copy list into user select
                    if (adminUserExamContentVersionSelect && adminExamContentVersionSelect){
                        adminUserExamContentVersionSelect.innerHTML = adminExamContentVersionSelect.innerHTML;
                        adminUserExamContentVersionSelect.disabled = adminExamContentVersionSelect.disabled;
                    }
                    await maybeLoadUserOverride();
                });
            }
            if (adminUserIdOverride) {
                adminUserIdOverride.addEventListener('blur', async () => {
                    // when user id becomes available, reload versions if exam type selected
                    const examTypeId = adminUserExamTypeSelect ? Number(adminUserExamTypeSelect.value) : null;
                    const uid = Number(adminUserIdOverride.value);
                    if (!uid || !examTypeId) return;
                    await loadAdminUserLabel();
                    await loadAdminContentVersions(examTypeId);
                    if (adminUserExamContentVersionSelect && adminExamContentVersionSelect){
                        adminUserExamContentVersionSelect.innerHTML = adminExamContentVersionSelect.innerHTML;
                        adminUserExamContentVersionSelect.disabled = adminExamContentVersionSelect.disabled;
                    }
                    await maybeLoadUserOverride();
                });
                adminUserIdOverride.addEventListener('change', () => { loadAdminUserLabel(); });
            }

            if (adminSetUserOverrideBtn) {
                adminSetUserOverrideBtn.addEventListener('click', async () => {
                    const uid = adminUserIdOverride ? Number(adminUserIdOverride.value) : null;
                    const examTypeId = adminUserExamTypeSelect ? Number(adminUserExamTypeSelect.value) : null;
                    const examContentVersionId = adminUserExamContentVersionSelect ? Number(adminUserExamContentVersionSelect.value) : null;
                    if (!uid || !examTypeId || !examContentVersionId){
                        alert('Preencha User ID, tipo de exame e vers√£o.');
                        return;
                    }
                    adminSetUserOverrideBtn.disabled = true;
                    const oldTxt = adminSetUserOverrideBtn.textContent;
                    adminSetUserOverrideBtn.textContent = 'Salvando...';
                    try {
                        const base = (window.SIMULADOS_CONFIG && window.SIMULADOS_CONFIG.BACKEND_BASE) || 'http://localhost:3000';
                        const url = base + '/api/admin/exams/user-content-version';
                        const resp = await fetch(url, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ userId: uid, examTypeId, examContentVersionId, source: 'adminModal' }),
                            credentials: 'include'
                        });
                        const raw = await resp.text();
                        let data = null;
                        try { data = raw ? JSON.parse(raw) : null; } catch(_) { data = null; }
                        if (!resp.ok) throw new Error((data && (data.error || data.message)) || raw || (resp.status + ' ' + resp.statusText));
                        if (adminUserOverrideOutput){
                            adminUserOverrideOutput.style.display = 'block';
                            adminUserOverrideOutput.textContent = 'OK\n' + JSON.stringify(data, null, 2);
                        }
                        await maybeLoadUserOverride();
                    } catch(e){
                        if (adminUserOverrideOutput){
                            adminUserOverrideOutput.style.display = 'block';
                            adminUserOverrideOutput.textContent = 'Erro ao salvar override:\n' + (e && e.message ? e.message : String(e));
                        }
                    } finally {
                        adminSetUserOverrideBtn.disabled = false;
                        adminSetUserOverrideBtn.textContent = oldTxt;
                    }
                });
            }

            if (adminClearUserOverrideBtn) {
                adminClearUserOverrideBtn.addEventListener('click', async () => {
                    const uid = adminUserIdOverride ? Number(adminUserIdOverride.value) : null;
                    const examTypeId = adminUserExamTypeSelect ? Number(adminUserExamTypeSelect.value) : null;
                    if (!uid || !examTypeId){
                        alert('Preencha User ID e tipo de exame.');
                        return;
                    }
                    adminClearUserOverrideBtn.disabled = true;
                    const oldTxt = adminClearUserOverrideBtn.textContent;
                    adminClearUserOverrideBtn.textContent = 'Removendo...';
                    try {
                        const base = (window.SIMULADOS_CONFIG && window.SIMULADOS_CONFIG.BACKEND_BASE) || 'http://localhost:3000';
                        const url = base + '/api/admin/exams/user-content-version?userId=' + encodeURIComponent(String(uid)) + '&examTypeId=' + encodeURIComponent(String(examTypeId));
                        const resp = await fetch(url, { method: 'DELETE', credentials: 'include' });
                        const raw = await resp.text();
                        let data = null;
                        try { data = raw ? JSON.parse(raw) : null; } catch(_) { data = null; }
                        if (!resp.ok) throw new Error((data && (data.error || data.message)) || raw || (resp.status + ' ' + resp.statusText));
                        if (adminUserOverrideOutput){
                            adminUserOverrideOutput.style.display = 'block';
                            adminUserOverrideOutput.textContent = 'OK\n' + JSON.stringify(data, null, 2);
                        }
                        await maybeLoadUserOverride();
                    } catch(e){
                        if (adminUserOverrideOutput){
                            adminUserOverrideOutput.style.display = 'block';
                            adminUserOverrideOutput.textContent = 'Erro ao remover override:\n' + (e && e.message ? e.message : String(e));
                        }
                    } finally {
                        adminClearUserOverrideBtn.disabled = false;
                        adminClearUserOverrideBtn.textContent = oldTxt;
                    }
                });
            }

            if (adminSetCurrentVersionBtn) {
                adminSetCurrentVersionBtn.addEventListener('click', async () => {
                    const examTypeId = adminExamTypeSelect ? Number(adminExamTypeSelect.value) : null;
                    const examContentVersionId = adminExamContentVersionSelect ? Number(adminExamContentVersionSelect.value) : null;
                    if (!examTypeId || !examContentVersionId){
                        alert('Selecione o tipo de exame e a vers√£o.');
                        return;
                    }
                    adminSetCurrentVersionBtn.disabled = true;
                    const oldTxt = adminSetCurrentVersionBtn.textContent;
                    adminSetCurrentVersionBtn.textContent = 'Salvando...';
                    try {
                        const base = (window.SIMULADOS_CONFIG && window.SIMULADOS_CONFIG.BACKEND_BASE) || 'http://localhost:3000';
                        const url = base + '/api/admin/exams/content-current';
                        const resp = await fetch(url, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ examTypeId, examContentVersionId }),
                            credentials: 'include'
                        });
                        const raw = await resp.text();
                        let data = null;
                        try { data = raw ? JSON.parse(raw) : null; } catch(_) { data = null; }
                        if (!resp.ok) throw new Error((data && (data.error || data.message)) || raw || (resp.status + ' ' + resp.statusText));
                        if (adminExamContentVersionOutput){
                            adminExamContentVersionOutput.style.display = 'block';
                            adminExamContentVersionOutput.textContent = 'OK\n' + JSON.stringify(data, null, 2);
                        }
                        // refresh list so selection reflects current
                        await loadAdminContentVersions(examTypeId);
                    } catch(e){
                        if (adminExamContentVersionOutput){
                            adminExamContentVersionOutput.style.display = 'block';
                            adminExamContentVersionOutput.textContent = 'Erro ao salvar:\n' + (e && e.message ? e.message : String(e));
                        }
                    } finally {
                        adminSetCurrentVersionBtn.disabled = false;
                        adminSetCurrentVersionBtn.textContent = oldTxt;
                    }
                });
            }

            // Fixture form submission
            const fixtureForm = document.getElementById('fixtureForm');
            const fixtureOutput = document.getElementById('fixtureOutput');
            if (fixtureForm) {
                // References
                const fxOverall = document.getElementById('fxOverall');
                const fxPeople = document.getElementById('fxPeople');
                const fxProcess = document.getElementById('fxProcess');
                const fxBusiness = document.getElementById('fxBusiness');
                // Add spread control UI (variation magnitude)
                if(fxOverall && !document.getElementById('fxSpreadControl')){
                    const wrap = fxOverall.parentElement;
                    if(wrap){
                        const spreadBox = document.createElement('div');
                        spreadBox.style.cssText='margin-top:6px;display:flex;align-items:center;gap:6px;flex-wrap:wrap';
                        spreadBox.innerHTML = '<label style="font-size:.65rem;color:#64748b;display:flex;align-items:center;gap:4px">Varia√ß√£o m√°x.<input id="fxSpreadControl" type="range" min="0" max="30" value="12" style="width:110px"></label><span id="fxSpreadValue" style="font-size:.65rem;color:#334155">¬±12%</span><label style="font-size:.65rem;color:#64748b;display:flex;align-items:center;gap:4px"><input id="fxLockDomains" type="checkbox"> Manter valores manualmente</label>';
                        wrap.appendChild(spreadBox);
                        const rng = spreadBox.querySelector('#fxSpreadControl');
                        const out = spreadBox.querySelector('#fxSpreadValue');
                        if(rng && out){ rng.addEventListener('input',()=>{ out.textContent='¬±'+rng.value+'%'; }); }
                    }
                }
                // Helper clamp
                function clampPct(v){ v = Math.round(Number(v)||0); if(v<0) v=0; if(v>100) v=100; return v; }
                function randomizeDomains(){
                    if(!fxOverall || !fxPeople || !fxProcess || !fxBusiness) return;
                    const lock = document.getElementById('fxLockDomains');
                    if(lock && lock.checked) return; // user locked manual values
                    const overall = clampPct(fxOverall.value);
                    const spreadEl = document.getElementById('fxSpreadControl');
                    const maxDev = spreadEl ? Number(spreadEl.value) : 12;
                    // Attempt random deviations ensuring bounds & mean constraint
                    let attempt=0; let chosen=null;
                    while(attempt<100){
                        attempt++;
                        // pick d1,d2 uniformly in [-maxDev,maxDev]
                        const d1 = (Math.random()*2-1)*maxDev;
                        const d2 = (Math.random()*2-1)*maxDev;
                        const d3 = -(d1+d2);
                        const a = clampPct(overall + d1);
                        const b = clampPct(overall + d2);
                        const c = clampPct(overall + d3);
                        const avg = (a+b+c)/3;
                        if(Math.abs(avg - overall) <= 0.75){ // tolerance
                            // ensure some variation (not all equal)
                            const distinct = (new Set([a,b,c])).size > 1;
                            if(distinct){ chosen=[a,b,c]; break; }
                        }
                    }
                    if(!chosen){ chosen=[overall,overall,overall]; }
                    fxPeople.value = String(chosen[0]);
                    fxProcess.value = String(chosen[1]);
                    fxBusiness.value = String(chosen[2]);
                }
                if(fxOverall){ fxOverall.addEventListener('input', randomizeDomains); }
                // Manual balance button & hint
                const overallWrapper = fxOverall && fxOverall.parentElement;
                if(overallWrapper){
                    const btn = document.createElement('button'); btn.type='button'; btn.textContent='Randomizar';
                    btn.style.cssText='margin-top:6px;padding:6px 8px;background:#0d9488;color:#fff;border:none;border-radius:4px;font-size:.7rem;cursor:pointer;';
                    btn.addEventListener('click', randomizeDomains); overallWrapper.appendChild(btn);
                    const hint = document.createElement('div');
                    hint.textContent='Geramos percentuais aleat√≥rios por dom√≠nio com m√©dia = % Geral. Use "Manter valores" para congelar.';
                    hint.style.cssText='margin-top:6px;font-size:.65rem;line-height:1.2;color:#64748b;'; overallWrapper.appendChild(hint);
                }
                // Initial random fill if empty
                randomizeDomains();
                fixtureForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const userId = document.getElementById('fxUserId').value.trim();
                    const examTypeSlug = document.getElementById('fxExamType').value.trim();
                    const totalQuestions = document.getElementById('fxTotal').value.trim();
                    const overallPct = document.getElementById('fxOverall').value.trim();
                    const peoplePct = document.getElementById('fxPeople').value.trim();
                    const processPct = document.getElementById('fxProcess').value.trim();
                    const businessPct = document.getElementById('fxBusiness').value.trim();
                    if (!userId || !overallPct) { alert('Preencha User ID e % Geral.'); return; }
                    const o = clampPct(overallPct);
                    const p = clampPct(peoplePct === '' ? o : peoplePct);
                    const pr = clampPct(processPct === '' ? o : processPct);
                    const b = clampPct(businessPct === '' ? o : businessPct);
                    const mean = (p+pr+b)/3;
                    if(Math.abs(mean - o) > 2){
                        alert(`Inconsist√™ncia: m√©dia dom√≠nios (${mean.toFixed(2)}%) difere de % Geral (${o}%). Ajuste ou clique em Randomizar.`);
                        return;
                    }
                    fixtureOutput.style.display='block';
                    const startedAt = new Date();
                    fixtureOutput.textContent='Gerando fixture...\n';
                    try {
                        const base = (window.SIMULADOS_CONFIG && window.SIMULADOS_CONFIG.BACKEND_BASE) || 'http://localhost:3000';
                        const payload = { userId: Number(userId), overallPct: Number(overallPct), totalQuestions: Number(totalQuestions), examTypeSlug: examTypeSlug || 'pmp' };
                        if (peoplePct !== '') payload.peoplePct = Number(peoplePct);
                        if (processPct !== '') payload.processPct = Number(processPct);
                        if (businessPct !== '') payload.businessPct = Number(businessPct);
                        const url = base + '/api/admin/exams/fixture-attempt';
                        const resp = await fetch(url, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload), credentials: 'include' });
                        const rawText = await resp.text();
                        let parsed; try { parsed = JSON.parse(rawText); } catch(_) { parsed = null; }
                        const ms = new Date() - startedAt;
                        if (resp.ok) {
                            fixtureOutput.textContent = 'Fixture criada com sucesso!\n' +
                              `Status: ${resp.status} ${resp.statusText}\n` +
                              `Tempo: ${ms}ms\n` +
                              'Payload enviado:\n' + JSON.stringify(payload,null,2) + '\n\n' +
                              'Resposta:\n' + (parsed ? JSON.stringify(parsed,null,2) : rawText);
                        } else {
                            fixtureOutput.textContent = 'Falha ao criar fixture\n' +
                              `Status: ${resp.status} ${resp.statusText}\n` +
                              `Tempo: ${ms}ms\n` +
                              'Endpoint: ' + url + '\n' +
                              'Payload enviado:\n' + JSON.stringify(payload,null,2) + '\n\n' +
                              'Corpo bruto:\n' + rawText.slice(0,4000);
                        }
                    } catch(err){
                        fixtureOutput.textContent='Erro de rede/execu√ß√£o:\n' + (err && err.stack ? err.stack : err.message || String(err));
                    }
                });
            }

            // Reset Password Form Handler
            const resetPasswordForm = document.getElementById('resetPasswordForm');
            const resetPasswordOutput = document.getElementById('resetPasswordOutput');
            if (resetPasswordForm) {
                resetPasswordForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('resetEmail').value.trim();
                    const newPassword = document.getElementById('resetNewPassword').value;
                    
                    if (!email || !newPassword) {
                        alert('Preencha email e nova senha.');
                        return;
                    }
                    
                    resetPasswordOutput.style.display = 'block';
                    resetPasswordOutput.textContent = 'Processando...\n';
                    
                    try {
                        // Hash password with SHA-256 client-side
                        const encoder = new TextEncoder();
                        const data = encoder.encode(newPassword);
                        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                        const hashArray = Array.from(new Uint8Array(hashBuffer));
                        const hashedPassword = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                        
                        const base = (window.SIMULADOS_CONFIG && window.SIMULADOS_CONFIG.BACKEND_BASE) || 'http://localhost:3000';
                        const token = localStorage.getItem('sessionToken');
                        const payload = { email, newPassword: hashedPassword };
                        const url = base + '/api/admin/users/reset-password';
                        
                        const resp = await fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Session-Token': token
                            },
                            body: JSON.stringify(payload)
                        });
                        
                        const result = await resp.json();
                        
                        if (resp.ok) {
                            resetPasswordOutput.style.color = 'var(--success, #22c55e)';
                            resetPasswordOutput.textContent = `‚úì Senha resetada com sucesso!\nUsu√°rio: ${result.email || email}\nNova senha SHA-256: ${hashedPassword.substring(0, 16)}...`;
                            resetPasswordForm.reset();
                        } else {
                            resetPasswordOutput.style.color = 'var(--danger, #ef4444)';
                            resetPasswordOutput.textContent = `‚úó Erro: ${result.error || 'Falha ao resetar senha'}\nStatus: ${resp.status}`;
                        }
                    } catch (err) {
                        resetPasswordOutput.style.color = 'var(--danger, #ef4444)';
                        resetPasswordOutput.textContent = `‚úó Erro de rede:\n${err.message || String(err)}`;
                    }
                });
            }
        })();
    </script>
    
    <!-- Service Worker Registration -->
    <script>
        // No-cache mode: do NOT register a Service Worker.
        // Also proactively unregister any previously-installed SW and clear Cache Storage
        // so the app never depends on stale cached assets.
        (function disableSW(){
            try {
                const isHttp = /^https?:$/i.test(window.location.protocol);
                if (!isHttp) return;
                if (!('serviceWorker' in navigator)) return;
                window.addEventListener('load', async () => {
                    let wasControlled = false;
                    try { wasControlled = !!(navigator.serviceWorker && navigator.serviceWorker.controller); } catch(_){ }
                    try {
                        const regs = await navigator.serviceWorker.getRegistrations();
                        await Promise.all((regs || []).map(r => r.unregister()));
                        try { logger.info('[SW] Unregistered existing registrations'); } catch(_){ }
                    } catch(e) {
                        try { logger.warn('[SW] Failed to unregister:', e); } catch(_){ }
                    }
                    try {
                        if (window.caches && typeof window.caches.keys === 'function') {
                            const keys = await window.caches.keys();
                            await Promise.all((keys || []).map(k => window.caches.delete(k)));
                            try { logger.info('[SW] Cleared Cache Storage'); } catch(_){ }
                        }
                    } catch(e) {
                        try { logger.warn('[SW] Failed to clear Cache Storage:', e); } catch(_){ }
                    }

                    // If this page was controlled by an old SW, reload once so it stops intercepting fetches.
                    try {
                        if (wasControlled) {
                            const k = '__swKillReloadAt';
                            const last = localStorage.getItem(k);
                            const now = Date.now();
                            const lastMs = last ? Date.parse(last) : NaN;
                            const recently = Number.isFinite(lastMs) && (now - lastMs) < (10 * 60 * 1000);
                            if (!recently) {
                                localStorage.setItem(k, new Date(now).toISOString());
                                setTimeout(() => {
                                    try { window.location.reload(); } catch(_){ }
                                }, 60);
                            }
                        }
                    } catch(_){ }
                });
            } catch(e){ /* ignore */ }
        })();
    </script>
                <!-- Dynamic load of bottom navigation component -->
                <script>
                (function loadBottomNav(){
                    async function mount(){
                        try {
                            const resp = await fetch('./components/bottomNav.html', { cache: 'no-store' });
                            if(!resp.ok) return;
                            const html = await resp.text();
                            const mountEl = document.getElementById('bottomNavMount');
                            if(mountEl){
                                mountEl.innerHTML = html;
                                // Execute any <script> tags inside the fetched fragment (innerHTML does not run them)
                                try {
                                    const scripts = Array.from(mountEl.querySelectorAll('script'));
                                    scripts.forEach(old => {
                                        const s = document.createElement('script');
                                        if (old.src) s.src = old.src; else s.textContent = old.textContent || '';
                                        old.parentNode.removeChild(old);
                                        // Append to mount to preserve relative execution context
                                        mountEl.appendChild(s);
                                    });
                                } catch(_){ /* silent */ }
                            }
                        } catch(_){}
                    }
                    if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', mount); else mount();
                })();
                </script>

                <!-- Password Verification Modal Mount Point -->
                <div id="settingsPasswordModalMount"></div>
                <script>
                (function(){
                    async function loadPasswordModal(){
                        try {
                            const resp = await fetch('/components/settingsPasswordVerification.html');
                            if(!resp.ok) return;
                            const html = await resp.text();
                            const mountEl = document.getElementById('settingsPasswordModalMount');
                            if(mountEl){
                                mountEl.innerHTML = html;
                                const scripts = Array.from(mountEl.querySelectorAll('script'));
                                scripts.forEach(old => {
                                    const s = document.createElement('script');
                                    if (old.src) s.src = old.src; else s.textContent = old.textContent || '';
                                    old.parentNode.removeChild(old);
                                    mountEl.appendChild(s);
                                });
                            }
                        } catch(_){}
                    }
                    if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', loadPasswordModal); else loadPasswordModal();
                })();
                </script>
</body>
</html>