<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>SimuladosBR</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Simulados completos para certificação PMP com questões reais e indicadores detalhados">
    <meta name="theme-color" content="#4f46e5">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SimuladosBR">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <!-- iOS/Apple Touch Icon -->
    <link rel="apple-touch-icon" sizes="192x192" href="/assets/icon-192.png">
    <!-- Standard Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="/assets/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/assets/icon-512.png">
    <style>
        :root{
            --bg: #0f172a;         /* slate-900 */
            --panel: #111827;      /* gray-900 */
            --text: #e5e7eb;       /* gray-200 */
            --muted: #94a3b8;      /* slate-400 */
            --primary: #4f46e5;    /* indigo-600 */
            --primary-press: #4338ca; /* indigo-700 */
            --border: #1f2937;     /* gray-800 */
            --shadow: 0 8px 20px rgba(0,0,0,.35);
        }
        *{box-sizing:border-box}
        html,body{height:100%}
        body{
            margin:0; padding:0;
            display:flex; flex-direction:column; min-height:100vh;
            background:#ffffff; color:#111827; /* fundo branco e texto escuro para melhor leitura */
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, 'Helvetica Neue', Arial, 'Apple Color Emoji','Segoe UI Emoji';
            touch-action: manipulation;
        }

        /* Main content area (scrollable above bottom nav) */
                    .content{
                        flex:1 1 auto; overflow-y:auto; padding:16px 16px calc(env(safe-area-inset-bottom) + 48px) 16px;
                    }
        .section{display:none}
        .section.active{display:block}
        .title{font-size:1.6rem; text-align:center; margin:4px 0 6px}
        .debug{font-size:0.9rem; color:var(--muted); text-align:center; margin:0 0 16px}

        /* Grid of 6 cards (2 x 3) */
            .card-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; width:100%; max-width:320px; margin:0 auto; justify-items:center; }
                .card{
                    background:#1e293b; border:1px solid rgba(255,255,255,0.06);
                    width:84px; height:84px; /* +40px total em relação ao original para caber imagem e texto com folga */
                    display:flex; align-items:center; justify-content:center;
                    border-radius:12px;
                    /* Sombras mais profundas em camadas para sensação de elevação */
                    box-shadow:
                        0 2px 4px rgba(0,0,0,.22),
                        0 6px 14px rgba(0,0,0,.32),
                        0 12px 28px rgba(0,0,0,.38);
                    cursor:pointer; transition: transform .18s ease, box-shadow .22s ease;
                    padding:6px 8px; outline:none; color:#ffffff; font-weight:500;
                    position:relative; overflow:hidden;
                }
            .card:hover{
                transform: scale(1.08);
                box-shadow:
                    0 4px 6px rgba(0,0,0,.28),
                    0 10px 20px rgba(0,0,0,.40),
                    0 18px 36px rgba(0,0,0,.46);
            }
            .card:active{
                transform: scale(0.97);
                box-shadow:
                    0 2px 3px rgba(0,0,0,.30),
                    0 6px 12px rgba(0,0,0,.36);
            }
                .thumb{ width:44px !important; height:44px !important; border-radius:8px; object-fit:cover !important; display:block; margin:0 auto; }
                    /* Simulador card variant: icon + label */
                    .card--simulador{ flex-direction:column; gap:6px; align-items:center; justify-content:center; overflow:hidden; display:flex; height:100%; }
                    .card--simulador .thumb{ width:44px !important; height:44px !important; border-radius:6px; object-fit:cover !important; display:block; margin:0 auto; }
                    .card-label{ font-size:.75rem; line-height:1.1; color:var(--muted); user-select:none }
                @media (min-width:480px){
                    .card{ width:104px; height:104px; padding:10px }
                        .thumb{ width:54px !important; height:54px !important; }
                        .card--simulador .thumb{ width:54px !important; height:54px !important; }
                        .card--simulador{ gap:8px }
                        .card-label{ font-size:.90rem }
                .card-grid{ max-width:340px }
            }

            /* Paleta distinta para cada card dentro de qualquer .card-grid (primeiros 6) */
            .card-grid .card:nth-child(1){
                background:linear-gradient(135deg,#6366f1,#4338ca);
            }
            .card-grid .card:nth-child(2){
                background:linear-gradient(135deg,#0ea5e9,#0369a1);
            }
            .card-grid .card:nth-child(3){
                background:linear-gradient(135deg,#ec4899,#be185d);
            }
            .card-grid .card:nth-child(4){
                background:linear-gradient(135deg,#10b981,#047857);
            }
            .card-grid .card:nth-child(5){
                background:linear-gradient(135deg,#f59e0b,#b45309);
            }
            .card-grid .card:nth-child(6){
                background:linear-gradient(135deg,#8b5cf6,#6d28d9);
            }
            /* Ajuste de texto e leve overlay para legibilidade */
            .card-grid .card::after{
                content:""; position:absolute; inset:0; background:linear-gradient(to bottom,rgba(0,0,0,0.12),rgba(0,0,0,0.35)); mix-blend-mode:overlay; pointer-events:none;
            }
            .card-label{color:#fff !important; text-shadow:0 1px 2px rgba(0,0,0,.4);}
            /* Fonte menor especificamente para labels em cards simulador */
            .card--simulador .card-label{ font-size:.65rem !important; }
            /* Acessibilidade foco */
            .card:focus-visible{ outline:2px solid #fff; outline-offset:3px; }

        /* Bottom navigation bar */
                    .bottom-nav{
                        position:fixed; left:0; right:0; bottom:0; height:44px;
            background:var(--panel); border-top:1px solid var(--border);
            display:flex; align-items:center; justify-content:center; z-index:1000;
            gap:14px;
            padding-bottom: env(safe-area-inset-bottom);
        }
                        .nav-item{
                            display:flex; flex-direction:column; align-items:center; justify-content:center; gap:0;
                            min-width:40px; min-height:44px; padding:1px 4px; border-radius:8px; color:var(--muted);
            user-select:none; -webkit-tap-highlight-color: transparent; cursor:pointer; transition: color .15s ease, background .15s ease;
        }
        .nav-item.active{ color: var(--primary); background: rgba(79,70,229,0.08) }
                        .nav-icon{ width:16px; height:16px; fill: currentColor; display:block }
                        .nav-text{ display:none }

                /* Desktop: reduzir ainda mais o bottom nav mantendo mobile confortável */
                @media (min-width: 640px){
                    .bottom-nav{ height:36px; gap:12px }
                    .nav-item{ min-height:32px; min-width:36px; padding:1px 4px }
                    .nav-icon{ width:14px; height:14px }
                    .content{ padding-bottom: calc(env(safe-area-inset-bottom) + 40px) }
                }

                /* Modo compacto opcional: aplique a classe .compact no <body> para forçar tamanho reduzido em qualquer tela */
                body.compact .bottom-nav{ height:32px }
                body.compact .nav-item{ min-height:32px; min-width:32px; padding:0 4px }
                body.compact .nav-icon{ width:14px; height:14px }
                body.compact .content{ padding-bottom: calc(env(safe-area-inset-bottom) + 36px) }

        /* Fullscreen overlay */
        .overlay{ position:fixed; inset:0; background:#000; display:none; align-items:center; justify-content:center; z-index:2000; }
        .overlay.active{ display:flex }
        .overlay img{ max-width:100vw; max-height:100vh; object-fit:contain }
        .back-btn{
            position:fixed; top:16px; left:16px; width:40px; height:40px; border-radius:999px; border:1px solid rgba(255,255,255,0.25);
            background: rgba(255,255,255,0.12); display:flex; align-items:center; justify-content:center; cursor:pointer; outline:none;
        }
        .back-btn svg{ width:22px; height:22px; fill:#fff }
    </style>
</head>
<body>
        <!-- Modal de resultados de exames (aberto via card Histórico) -->
        <div id="examResultsModal" class="overlay" aria-hidden="true" style="display:none;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;">
            <div style="background:#fff;border-radius:12px;max-width:520px;width:92%;padding:16px;box-shadow:0 12px 40px rgba(0,0,0,0.35);color:#111827">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                    <h2 style="margin:0;font-size:1.2rem;">Selecionar exame</h2>
                    <button id="examResultsClose" type="button" aria-label="Fechar" style="background:none;border:none;font-size:1.6rem;color:#64748b;cursor:pointer;padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center">×</button>
                </div>
                <div style="display:grid;gap:10px;">
                    <div style="font-size:.9rem;color:#334155">Exames finalizados</div>
                    <div id="examList" style="display:flex;flex-direction:column;gap:8px;max-height:320px;overflow-y:auto"></div>
                </div>
            </div>
        </div>
    <!-- Auth guard: redirect to login if no session token -->
    <script>
    (function authGuard(){
        const token = (localStorage.getItem('sessionToken') || '').trim();
        if (!token) {
            // Redirecionar para login se não houver token
            window.location.href = '/login.html';
        }
    })();
    </script>
        <!-- Exam results modal logic (trigger via card Histórico) -->
        <script>
            (function(){
                const triggerCard = document.getElementById('card-historico');
                const modal = document.getElementById('examResultsModal');
                const closeBtn = document.getElementById('examResultsClose');
                const listEl = document.getElementById('examList');
                if (!modal || !closeBtn || !listEl) return;
                function open(){ modal.style.display='flex'; modal.setAttribute('aria-hidden','false'); }
                function close(){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); }
                if (triggerCard) {
                    triggerCard.addEventListener('click', (e)=>{ try{ e.preventDefault(); e.stopPropagation(); if (e.stopImmediatePropagation) e.stopImmediatePropagation(); }catch(_){ } open(); loadHistory(); });
                }
                closeBtn.addEventListener('click', (e)=>{ e.preventDefault(); close(); });
                modal.addEventListener('click', (e)=>{ if (e.target === modal) close(); });

                async function loadHistory(){
                    try {
                        const base = ((window.SIMULADOS_CONFIG && window.SIMULADOS_CONFIG.BACKEND_BASE) || 'http://localhost:3000').replace(/\/$/,'');
                        const url = base + '/api/exams/history?limit=50';
                        const token = (sessionStorage.getItem('X-Session-Token') || localStorage.getItem('sessionToken') || '').trim();
                        const headers = token ? { 'X-Session-Token': token } : {};
                        const r = await fetch(url, { headers });
                        let list = [];
                        if (r.ok) {
                            list = await r.json();
                        } else {
                            console.warn('[history] HTTP', r.status, 'for', url);
                        }
                        if (!Array.isArray(list)) list = [];
                        // Sort by finishedAt desc if present
                        try {
                            list.sort((a,b)=>{
                                const af = a && a.finishedAt ? new Date(a.finishedAt).getTime() : 0;
                                const bf = b && b.finishedAt ? new Date(b.finishedAt).getTime() : 0;
                                return bf - af;
                            });
                        } catch(_){ }
                        listEl.innerHTML = '';
                        if (!list.length){
                            const isGuest = token && /^guest_/i.test(token);
                            const empty = document.createElement('div');
                            empty.textContent = token ? (isGuest ? 'Sessão convidado — faça login para ver seu histórico' : 'Nenhum exame encontrado') : 'Faça login para ver seu histórico';
                            empty.style.cssText = 'padding:8px;border:1px dashed #cbd5e1;border-radius:8px;color:#64748b;text-align:center';
                            listEl.appendChild(empty);
                            if (isGuest){
                                const btn = document.createElement('button');
                                btn.type = 'button';
                                btn.textContent = 'Sair e reentrar';
                                btn.style.cssText = 'margin-top:8px;padding:8px 10px;border:1px solid #cbd5e1;border-radius:8px;background:#fff;color:#111827;cursor:pointer;font-size:.85rem';
                                btn.addEventListener('click', ()=>{ try{ localStorage.clear(); sessionStorage.clear(); }catch(_){} window.location.assign('/login.html'); });
                                listEl.appendChild(btn);
                            }
                            return;
                        }
                            for (const item of list){
                                const id = item && (item.examAttemptId || item.attemptId || item.id || item._id || item.sessionId || item.examId);
                                if (!id) continue;
                                const mode = String((item && (item.examMode || item.mode)) || '').toLowerCase();
                            const title = item && (item.title || item.name) || (mode==='full' ? 'Exame Completo' : 'Quiz');
                            const finished = item && item.finishedAt ? new Date(item.finishedAt).toLocaleString('pt-BR') : '';
                            const pctNum = item && item.scorePercent != null ? Math.round(item.scorePercent) : null;
                            const btn = document.createElement('button');
                            btn.type = 'button';
                            btn.style.cssText = 'display:flex;align-items:center;justify-content:space-between;padding:10px;border:1px solid #cbd5e1;border-radius:8px;background:#f8fafc;color:#111827;font-size:.92rem;cursor:pointer';
                                btn.dataset.id = String(id);
                            btn.dataset.mode = mode || 'quiz';
                            const left = document.createElement('span'); left.textContent = title;
                            const right = document.createElement('span'); right.style.cssText = 'display:flex;gap:8px;color:#334155;font-size:.85rem';
                            const modeTag = document.createElement('span'); modeTag.textContent = (mode==='full'?'Full':'Quiz'); modeTag.style.cssText='padding:2px 6px;border-radius:6px;background:#eef2ff;color:#3730a3;font-weight:600'; right.appendChild(modeTag);
                            if (pctNum != null){ const pctEl = document.createElement('span'); pctEl.textContent = pctNum + '%'; pctEl.style.cssText='color:#0f766e;font-weight:600'; right.appendChild(pctEl); }
                            if (finished){ const dt = document.createElement('span'); dt.textContent = finished; dt.style.cssText='color:#64748b'; right.appendChild(dt); }
                            btn.appendChild(left); btn.appendChild(right);
                            btn.addEventListener('click', ()=>{
                                const path = mode === 'full' ? '/pages/examReviewFull.html' : '/pages/examReviewQuiz.html';
                                    const urlGo = `${path}?examId=${encodeURIComponent(String(id))}&mode=${encodeURIComponent(mode||'quiz')}`;
                                window.location.assign(urlGo);
                            });
                            listEl.appendChild(btn);
                        }
                    } catch(e){
                        console.error('[history] Falha ao carregar', e);
                        listEl.innerHTML = '';
                        const errBox = document.createElement('div');
                        errBox.textContent = 'Falha ao carregar';
                        errBox.style.cssText = 'padding:8px;border:1px solid #fecaca;border-radius:8px;background:#fee2e2;color:#991b1b;text-align:center';
                        listEl.appendChild(errBox);
                    }
                }

                // Itens da lista são clicáveis; sem botão "Abrir"
            })();
        </script>
    <!-- Admin quick menu (rendered only if user has admin role) -->
    <button id="adminMenuBtn" type="button" aria-haspopup="true" aria-expanded="false" aria-label="Menu Admin" style="display:none;position:fixed;top:12px;left:12px;z-index:2300;padding:8px 10px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);background:#fff;color:#111827;cursor:pointer;box-shadow:0 6px 14px rgba(0,0,0,0.10);font-size:.85rem;font-weight:600;">Admin ▾</button>
    <nav id="adminMenuPanel" aria-label="Ações administrativas" aria-hidden="true" style="display:none;position:fixed;top:52px;left:12px;z-index:2299;min-width:200px;background:#ffffff;border:1px solid #d6d9e0;border-radius:10px;box-shadow:0 10px 24px rgba(0,0,0,0.18);padding:6px;">
        <a id="lnkAdminCadastrar" href="/pages/admin/questionForm.html" style="display:block;padding:6px 8px;border-radius:6px;color:#111827;text-decoration:none;font-size:.85rem;">Cadastrar questão</a>
        <a id="lnkAdminBulk" href="/pages/admin/questionBulk.html" style="display:block;padding:6px 8px;border-radius:6px;color:#111827;text-decoration:none;font-size:.85rem;">Cadastrar questão bulk</a>
        <button id="btnAdminFixture" type="button" style="display:block;width:100%;text-align:left;padding:6px 8px;border:0;background:#f8fafc;color:#0d9488;font-size:.85rem;border-radius:6px;cursor:pointer;">Gerar tentativa fixture</button>
        <button id="btnAdminReconcile" type="button" style="display:block;width:100%;text-align:left;padding:6px 8px;border:0;background:#f8fafc;color:#4f46e5;font-size:.85rem;border-radius:6px;cursor:pointer;">Reconciliar estatísticas</button>
        <button id="btnAdminPurge" type="button" style="display:block;width:100%;text-align:left;padding:6px 8px;border:0;background:#f8fafc;color:#b91c1c;font-size:.85rem;border-radius:6px;cursor:pointer;">Expurgar tentativas abandonadas</button>
        <button id="btnAdminMarkAbandoned" type="button" style="display:block;width:100%;text-align:left;padding:6px 8px;border:0;background:#f8fafc;color:#dc2626;font-size:.85rem;border-radius:6px;cursor:pointer;">Marcar abandonadas (inatividade)</button>
        <button id="btnAdminLogout" type="button" style="display:block;width:100%;text-align:left;padding:6px 8px;border:0;background:#f1f5f9;color:#334155;font-size:.85rem;border-radius:6px;cursor:pointer;">Sair</button>
    </nav>
    <!-- i18n constants (can be extended or replaced per locale) -->
    <script>
        window.SIMULADOS_I18N = Object.assign({
            LAST_EXAM_TITLE: 'Último exame',
            WAITING_FULL_EXAMS_TITLE: 'Aguardando exames completos',
            HELP_NEED_3_FULL: 'Faça pelo menos 3 exames completos para ver seus indicadores',
            LABEL_CORRECT: 'Acertos',
            LABEL_FINISHED_AT: 'Finalizado em',
            LABEL_DURATION: 'Duração'
        }, window.SIMULADOS_I18N || {});
    </script>
    <!-- Admin menu logic: detect admin by probing an admin-only endpoint -->
    <script>
    (function initAdminMenu(){
        const btn = document.getElementById('adminMenuBtn');
        const panel = document.getElementById('adminMenuPanel');
        if (!btn || !panel) return;
        const token = (localStorage.getItem('sessionToken') || '').trim();
        if (!token) return; // no session => skip
        // Helper: append ?sessionToken= fallback if cookies not set
        function applyTokenFallback(){
            try {
                const q = encodeURIComponent(token);
                ['lnkAdminCadastrar','lnkAdminBulk'].forEach(id => {
                    const a = document.getElementById(id); if (!a) return;
                    const href = a.getAttribute('href') || '';
                    if (href.includes('sessionToken=')) return;
                    const sep = href.includes('?') ? '&' : '?';
                    a.setAttribute('href', href + sep + 'sessionToken=' + q);
                });
            } catch(_){}
        }
        // Probe a lightweight admin-only endpoint to confirm role (GET /api/admin/exams/probe => 204 if admin)
        const probeUrl = '/api/admin/exams/probe';
        fetch(probeUrl, { headers: { 'X-Session-Token': token }, method: 'GET' })
          .then(r => {
              if (!r.ok) return Promise.reject('Not admin'); // not admin
              // Success => show menu
              btn.style.display = 'inline-flex';
              // Provide fallback token if cookies absent
              applyTokenFallback();
              function close(){ panel.style.display='none'; panel.setAttribute('aria-hidden','true'); btn.setAttribute('aria-expanded','false'); }
              function open(){ panel.style.display='block'; panel.setAttribute('aria-hidden','false'); btn.setAttribute('aria-expanded','true'); }
              btn.addEventListener('click', e => {
                  e.stopPropagation();
                  if (panel.style.display === 'block') close(); else open();
              });
              document.addEventListener('click', e => { if (!panel.contains(e.target) && e.target !== btn) close(); });

              // Wire admin lifecycle actions
              const purgeBtn = document.getElementById('btnAdminPurge');
              const markBtn = document.getElementById('btnAdminMarkAbandoned');
              const reconcileBtn = document.getElementById('btnAdminReconcile');
              const fixtureBtn = document.getElementById('btnAdminFixture');
              const logoutBtn = document.getElementById('btnAdminLogout');
              function getToken(){ return (localStorage.getItem('sessionToken')||'').trim(); }
              async function adminPost(path){
                  const tk = getToken();
                  const resp = await fetch(path,{method:'POST',headers:{'Content-Type':'application/json','X-Session-Token':tk}});
                  const data = await resp.json().catch(()=>({}));
                  return {ok:resp.ok,status:resp.status,data};
              }
              if (reconcileBtn){
                  reconcileBtn.addEventListener('click', ()=>{
                      close(); // Fecha o menu admin
                      const adminModal = document.getElementById('adminModal');
                      if (adminModal) {
                          adminModal.classList.add('active');
                          adminModal.setAttribute('aria-hidden', 'false');
                          const nav = document.querySelector('.bottom-nav');
                          if (nav) nav.style.display = 'none';
                          // scroll to reconcile section (first panel)
                          try { adminModal.querySelector('h3')?.scrollIntoView({behavior:'smooth'}); } catch(_){}
                      }
                  });
              }
              if (fixtureBtn){
                  fixtureBtn.addEventListener('click', ()=>{
                      close();
                      const adminModal = document.getElementById('adminModal');
                      if (adminModal){
                          adminModal.classList.add('active');
                          adminModal.setAttribute('aria-hidden','false');
                          const nav = document.querySelector('.bottom-nav'); if (nav) nav.style.display='none';
                          // Focus userId field & highlight fixture box
                          try {
                              const userField = document.getElementById('fxUserId');
                              if (userField){ userField.focus(); userField.scrollIntoView({behavior:'smooth', block:'center'}); }
                              const fixtureBox = userField?.closest('div[style*="Gerar Tentativa Fixture"]');
                              // fallback: select by heading text
                              const heading = Array.from(adminModal.querySelectorAll('h3')).find(h => /Gerar Tentativa Fixture/i.test(h.textContent||''));
                              const panel = heading ? heading.parentElement : null;
                              if (panel){
                                  panel.style.outline='2px solid #0d9488';
                                  setTimeout(()=>{ panel.style.outline=''; }, 2400);
                              }
                          } catch(_){}
                      }
                  });
              }
              if (purgeBtn){
                  purgeBtn.addEventListener('click', async ()=>{
                      if (!confirm('Confirma expurgo de tentativas abandonadas conforme política? Esta ação é permanente.')) return;
                      purgeBtn.disabled = true; purgeBtn.textContent = 'Expurgando...';
                      try {
                          const r = await adminPost('/api/admin/exams/purge-abandoned');
                          alert(r.ok ? `Expurgo: ${r.data.purged} purgadas (inspecionadas ${r.data.inspected}).` : `Falhou (${r.status}).`);
                      } catch(e){ alert('Erro ao expurgar: '+ e); }
                      purgeBtn.disabled = false; purgeBtn.textContent = 'Expurgar tentativas abandonadas';
                  });
              }
              if (markBtn){
                  markBtn.addEventListener('click', async ()=>{
                      if (!confirm('Executar marcação de tentativas abandonadas por inatividade?')) return;
                      markBtn.disabled = true; markBtn.textContent = 'Marcando...';
                      try {
                          const r = await adminPost('/api/admin/exams/mark-abandoned');
                          alert(r.ok ? `Marcadas: timeout=${r.data.markedTimeout}, lowProgress=${r.data.markedLowProgress} (processadas ${r.data.processed}).` : `Falhou (${r.status}).`);
                      } catch(e){ alert('Erro ao marcar: ' + e); }
                      markBtn.disabled = false; markBtn.textContent = 'Marcar abandonadas (inatividade)';
                  });
              }
              // Logout button handler relocated from misplaced inline block
              if (logoutBtn){
                  logoutBtn.addEventListener('click', ()=>{
                      close();
                      try { localStorage.clear(); } catch(_){ }
                      try { sessionStorage.clear(); } catch(_){ }
                      try { document.cookie = 'sessionToken=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT;'; } catch(_){ }
                      try {
                          const n = document.createElement('div');
                          n.textContent='Sessão encerrada';
                          n.style.cssText='position:fixed;top:14px;right:14px;background:#334155;color:#fff;padding:8px 12px;border-radius:6px;font-size:.75rem;z-index:99999;box-shadow:0 4px 12px rgba(0,0,0,0.25)';
                          document.body.appendChild(n); setTimeout(()=>{ try{ n.remove(); }catch(_){ } },1200);
                      } catch(_){ }
                      setTimeout(()=>{ window.location.href='/login'; }, 300);
                  });
              }
                            // Note: quit handler moved to global block to work for all users
          })
          .catch(()=>{});
    })();
    </script>
        <!-- Global logout handler for span#quit (works for admin and non-admin users) -->
        <script>
            (function bindGlobalQuit(){
                const quitEl = document.getElementById('quit');
                if (!quitEl) return;
                quitEl.style.cursor='pointer';
                quitEl.setAttribute('role','button');
                quitEl.setAttribute('aria-label','Encerrar sessão');
                quitEl.addEventListener('click', (e)=>{
                    e.preventDefault();
                    try { localStorage.clear(); } catch(_){ }
                    try { sessionStorage.clear(); } catch(_){ }
                    try { document.cookie = 'sessionToken=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT;'; } catch(_){ }
                    try {
                        const n = document.createElement('div');
                        n.textContent='Sessão encerrada';
                        n.style.cssText='position:fixed;top:14px;right:14px;background:#334155;color:#fff;padding:8px 12px;border-radius:6px;font-size:.75rem;z-index:99999;box-shadow:0 4px 12px rgba(0,0,0,0.25)';
                        document.body.appendChild(n); setTimeout(()=>{ try{ n.remove(); }catch(_){ } },1200);
                    } catch(_){ }
                    setTimeout(()=>{ window.location.href='/login'; }, 300);
                });
            })();
        </script>
    <!-- Test button for lastExamResults (cycles through performance levels) -->
    <button id="lastExamTestBtn" aria-label="Testar últimos exames" title="Clicar para simular próximos níveis" style="position:fixed;right:12px;top:12px;z-index:2200;padding:8px 10px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);background:#fff;color:#111827;cursor:pointer;box-shadow:0 6px 14px rgba(0,0,0,0.08);">Simular: OFF</button>
    <main class="content">
        <!-- Sections -->
        <section id="home" class="section active" aria-labelledby="tab-home">
            <!-- lastExamResults alinhado com a largura dos cards (usa mesmas constraints de .card-grid) -->
            <div id="lastExamResultsMount" aria-live="polite" style="max-width:320px;margin:0 auto 8px auto; box-sizing:border-box; transition: background .25s ease;"></div>
            <div class="card-grid">
                 <div class="card card--simulador" data-full="" aria-label="Simulador" role="button" tabindex="0">
                    <img src="assets/pc.png" alt="Personalizar Exame" class="thumb" />
                    <span class="card-label">Setup</span>
                </div>
                <div id="card-exam-mock" class="card card--simulador" data-card="exam-mock"  aria-label="Exame completo (Mock)" role="button" tabindex="0">
                    <img src="assets/exame.png" alt="Exame completo" class="thumb" />
                    <span class="card-label">Simulador</span>
                </div>
                <div class="card card--simulador" data-full="https://picsum.photos/800/800?random=3" aria-label="Dica do dia" role="button" tabindex="0">
                    <img src="assets/adendo.png" alt="Dica do dia" class="thumb" />
                    <span class="card-label">Dica do dia</span>
                </div>
                <div id="card-indicadores" class="card card--simulador" data-card="indicadores" aria-label="Indicadores de desempenho" role="button" tabindex="0">
                    <img src="assets/kpi.png" alt="Indicadores" class="thumb" />
                    <span class="card-label">Indicadores</span>
                </div>
                <div id="card-progresso-geral" class="card card--simulador" data-card="progresso-geral" aria-label="Progresso geral" role="button" tabindex="0">
                    <img src="assets/historia.png" alt="Progresso geral" class="thumb" />
                    <span class="card-label">Histórico</span>
                </div>
                <div class="card card--simulador" data-full="https://picsum.photos/800/800?random=6" aria-label="Estou pronto?" role="button" tabindex="0">
                    <img src="assets/pronto.png" alt="Estou pronto?" class="thumb" />
                    <span class="card-label">Estou pronto?</span>
                </div>
            </div>
        </section>

        <section id="search" class="section" aria-labelledby="tab-search">
            <h2 class="title">BUSCAR</h2>
            <p class="debug" id="debug-search">Cliques: 0</p>
            <div class="card-grid">
                <div class="card" data-full="https://picsum.photos/800/800?random=11" aria-label="Abrir imagem 1" role="button" tabindex="0"></div>
                <div class="card" data-full="https://picsum.photos/800/800?random=12" aria-label="Abrir imagem 2" role="button" tabindex="0"></div>
                <div class="card" data-full="https://picsum.photos/800/800?random=13" aria-label="Abrir imagem 3" role="button" tabindex="0"></div>
                <div class="card" data-full="https://picsum.photos/800/800?random=14" aria-label="Abrir imagem 4" role="button" tabindex="0"></div>
                <div class="card" data-full="https://picsum.photos/800/800?random=15" aria-label="Abrir imagem 5" role="button" tabindex="0"></div>
                <div class="card" data-full="https://picsum.photos/800/800?random=16" aria-label="Abrir imagem 6" role="button" tabindex="0"></div>
            </div>
        </section>

        <section id="favorites" class="section" aria-labelledby="tab-favorites">
            <h2 class="title">FAVORITOS</h2>
            <p class="debug" id="debug-favorites">Cliques: 0</p>
            <div class="card-grid">
                <div class="card" data-full="https://picsum.photos/800/800?random=21" aria-label="Abrir imagem 1" role="button" tabindex="0"></div>
                <div class="card" data-full="https://picsum.photos/800/800?random=22" aria-label="Abrir imagem 2" role="button" tabindex="0"></div>
                <div class="card" data-full="https://picsum.photos/800/800?random=23" aria-label="Abrir imagem 3" role="button" tabindex="0"></div>
                <div class="card" data-full="https://picsum.photos/800/800?random=24" aria-label="Abrir imagem 4" role="button" tabindex="0"></div>
                <div class="card" data-full="https://picsum.photos/800/800?random=25" aria-label="Abrir imagem 5" role="button" tabindex="0"></div>
                <div class="card" data-full="https://picsum.photos/800/800?random=26" aria-label="Abrir imagem 6" role="button" tabindex="0"></div>
            </div>
        </section>

        <section id="profile" class="section" aria-labelledby="tab-profile">
            <h2 class="title">PERFIL</h2>
            <p class="debug" id="debug-profile">Cliques: 0</p>
            <div class="card-grid">
                <div id="card-admin" class="card card--simulador" data-card="admin" aria-label="Administração" role="button" tabindex="0" style="display:none">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color:var(--primary)">
                        <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    <span class="card-label">Admin</span>
                </div>
                <div class="card" data-full="https://picsum.photos/800/800?random=31" aria-label="Abrir imagem 1" role="button" tabindex="0"></div>
                <div class="card" data-full="https://picsum.photos/800/800?random=32" aria-label="Abrir imagem 2" role="button" tabindex="0"></div>
                <div class="card" data-full="https://picsum.photos/800/800?random=33" aria-label="Abrir imagem 3" role="button" tabindex="0"></div>
                <div class="card" data-full="https://picsum.photos/800/800?random=34" aria-label="Abrir imagem 4" role="button" tabindex="0"></div>
                <div class="card" data-full="https://picsum.photos/800/800?random=35" aria-label="Abrir imagem 5" role="button" tabindex="0"><span id="quit">Sair</span></div>
            </div>
        </section>
    </main>

    <!-- Bottom navigation bar -->
    <nav class="bottom-nav" aria-label="Navegação inferior">
        <button class="nav-item active" id="tab-home" data-target="home" aria-label="Home">
            <svg class="nav-icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3.172l8 7V20a1 1 0 0 1-1 1h-5v-6H10v6H5a1 1 0 0 1-1-1v-9.828l8-7zM21 10.414l-9-7.875-9 7.875V20a3 3 0 0 0 3 3h4a1 1 0 0 0 1-1v-6h4v6a1 1 0 0 0 1 1h4a3 3 0 0 0 3-3v-9.586z"/></svg>
            <span class="nav-text">Home</span>
        </button>
        <button class="nav-item" id="tab-search" data-target="search" aria-label="Buscar">
            <svg class="nav-icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M10 2a8 8 0 0 1 6.32 12.9l4.39 4.39a1 1 0 0 1-1.42 1.42l-4.39-4.39A8 8 0 1 1 10 2zm0 2a6 6 0 1 0 0 12A6 6 0 0 0 10 4z"/></svg>
            <span class="nav-text">Buscar</span>
        </button>
        <button class="nav-item" id="tab-favorites" data-target="favorites" aria-label="Favoritos">
            <svg class="nav-icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 21.35l-1.45-1.32C6 15.36 3 12.53 3 9.24 3 6.5 5.24 4.5 7.88 4.5c1.54 0 3.04.73 4.12 1.9a5.9 5.9 0 0 1 4.12-1.9C18.76 4.5 21 6.5 21 9.24c0 3.29-3 6.12-7.55 10.79L12 21.35z"/></svg>
            <span class="nav-text">Favoritos</span>
        </button>
        <button class="nav-item" id="tab-profile" data-target="profile" aria-label="Perfil">
            <svg class="nav-icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2a6 6 0 1 1 0 12A6 6 0 0 1 12 2zm0 14c4.42 0 8 2.24 8 5v1a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-1c0-2.76 3.58-5 8-5z"/></svg>
            <span class="nav-text">Perfil</span>
        </button>
    </nav>

    <!-- Fullscreen overlay for image -->
    <div id="fullOverlay" class="overlay" aria-hidden="true">
        <button id="backBtn" class="back-btn" aria-label="Voltar">
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
        </button>
        <img id="fullImg" alt="Imagem em tela cheia" />
    </div>

        <!-- Configura caminho absoluto para o fragmento do examSetup -->
        <script>
            window.SIMULADOS_CONFIG = Object.assign({}, window.SIMULADOS_CONFIG || {}, {
                EXAM_SETUP_PATH: '/pages/examSetup.html'
            });
        </script>
        <!-- Script global do app (necessário para abrir o examSetup modal) -->
        <script src="./script.js" onerror="(function(){var s=document.createElement('script');s.src='./assets/build/script.js';document.body.appendChild(s);}())"></script>
        <!-- Load reusable full exam confirmation modal component -->
        <script>
            (function(){
                async function loadFullExamConfirm(){
                    try {
                        const resp = await fetch('./components/fullExamConfirm.html');
                        if (!resp.ok) return;
                        const html = await resp.text();
                        const wrap = document.createElement('div');
                        wrap.innerHTML = html;
                        const el = wrap.firstElementChild;
                        if (el) document.body.appendChild(el);
                    } catch(e){ /* ignore */ }
                }
                if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', loadFullExamConfirm); else loadFullExamConfirm();

                // Small helper mirroring examSetup's API
                window.showFullExamConfirm = function(onProceed){
                    try {
                        const modal = document.getElementById('fullExamConfirmModal');
                        const proceedBtn = document.getElementById('fullExamProceed');
                        const cancelBtn = document.getElementById('fullExamCancel');
                        if (!modal || !proceedBtn || !cancelBtn) return false;
                        modal.style.display = 'flex';
                        modal.setAttribute('aria-hidden','false');
                        const close = ()=>{ modal.style.display = 'none'; modal.setAttribute('aria-hidden','true'); };
                        cancelBtn.onclick = ()=>{ close(); };
                        proceedBtn.onclick = ()=>{ try{ close(); }catch(_){}; if (typeof onProceed==='function') onProceed(); };
                        return true;
                    } catch(_){ return false; }
                };
            })();
        </script>

        <!-- Load and mount lastExamResults component at the top of Home -->
        <script>
            (function(){
                async function loadLastExamResults(){
                    try {
                        const mount = document.getElementById('lastExamResultsMount');
                        if (!mount) return;
                        const resp = await fetch('./components/lastExamResults.html', { cache: 'no-store' });
                        if (!resp.ok) return;
                        const html = await resp.text();
                        // Inject HTML and ensure embedded <script> runs (innerHTML doesn't execute scripts)
                        mount.innerHTML = html;
                        (function executeScripts(container){
                            try {
                                const scripts = Array.from(container.querySelectorAll('script'));
                                for (const old of scripts){
                                    const s = document.createElement('script');
                                    if (old.src) s.src = old.src; else s.textContent = old.textContent || '';
                                    // keep execution order by appending sequentially
                                    document.body.appendChild(s);
                                    old.remove();
                                }
                            } catch(_){ }
                        })(mount);

                        const host = mount.querySelector('.ler-card');
                        if (host && window.initLastExamResults){
                            // Attempt to fetch last attempt summary from backend
                            const base = (window.SIMULADOS_CONFIG && window.SIMULADOS_CONFIG.BACKEND_BASE) || 'http://localhost:3000';
                            let applied = false;
                            try {
                                const buildHeaders = () => {
                                    let h = {};
                                    try {
                                        const jwtTok = (localStorage.getItem('jwtToken')||'').trim();
                                        const jwtType = (localStorage.getItem('jwtTokenType')||'Bearer').trim()||'Bearer';
                                        const sessionTok = (localStorage.getItem('sessionToken')||'').trim();
                                        if (jwtTok) h['Authorization'] = jwtType + ' ' + jwtTok;
                                        if (sessionTok) h['X-Session-Token'] = sessionTok;
                                    } catch(_){ }
                                    return h;
                                };
                                const sessionPresent = (localStorage.getItem('sessionToken')||'').trim();
                                if (sessionPresent) {
                                    const url = base.replace(/\/$/, '') + '/api/exams/last';
                                    const r = await fetch(url, { headers: buildHeaders() });
                                    if (r.status === 200) {
                                        const data = await r.json();
                                        if (data && typeof data === 'object' && data.total > 0) {
                                            const v = Number(data.correct || 0);
                                            const m = Number(data.total || 0);
                                            window.initLastExamResults(host, { value: v, max: m });
                                            // Show finished date, percent and duration if available
                                            try {
                                                const dateEl = host.querySelector('.ler-date');
                                                const pctEl = host.querySelector('.ler-percent');
                                                const durTxt = host.querySelector('.ler-dur .dur-text');
                                                const fmtDate = (iso)=>{ try{ const d=new Date(iso); if(isNaN(d)) return ''; return d.toLocaleString('pt-BR',{ day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'}); }catch(_){ return ''; } };
                                                const fmtDur = (sec)=>{ try{ sec=Math.max(0,Number(sec)||0); const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60); if(h>0) return `${h}h ${String(m).padStart(2,'0')}m`; return `${m}m`; }catch(_){ return ''; } };
                                                if (pctEl){ const pct = Number.isFinite(data.scorePercent) ? Math.round(Number(data.scorePercent)) : (m>0? Math.round((v*100)/m):0); pctEl.textContent = `(${pct}%)`; }
                                                if (dateEl && data.finishedAt){ const s = fmtDate(data.finishedAt); if (s) dateEl.textContent = s; }
                                                if (durTxt && (data.durationSeconds!=null)){ const s = fmtDur(data.durationSeconds); if (s) durTxt.textContent = s; }
                                            } catch(_){ }
                                            try { localStorage.setItem('lastExamValue', String(v)); localStorage.setItem('lastExamMax', String(m)); } catch(_){ }
                                            try { if (data && data.finishedAt) localStorage.setItem('lastExamFinishedAt', String(data.finishedAt)); } catch(_){ }
                                            try { if (data && data.durationSeconds!=null) localStorage.setItem('lastExamDurationSec', String(data.durationSeconds)); } catch(_){ }
                                            applied = true;
                                        }
                                    } else if (r.status === 204) {
                                        // No attempts yet; fall back to local storage or default
                                    }
                                }
                            } catch(_){ /* ignore network errors */ }
                            // After attempting single summary, fetch recent history to (a) gate by at least 3 FULL exams and (b) style background/icon using only FULL attempts
                            try {
                                const sessionPresent2 = (localStorage.getItem('sessionToken')||'').trim();
                                if (sessionPresent2){
                                    const url2 = base.replace(/\/$/, '') + '/api/exams/history?limit=10';
                                    const r2 = await fetch(url2, { headers: buildHeaders() });
                                    if (r2.ok){
                                        const list = await r2.json();
                                        // Consider only FULL attempts for gating and calculations
                                        const full = Array.isArray(list) ? list.filter(x => x && String(x.examMode||'').toLowerCase() === 'full') : [];
                                        const clearStyle = () => {
                                            try {
                                                // remove any previous thumb and clear mount/card backgrounds
                                                const oldThumb = host.querySelector('.ler-thumb');
                                                if (oldThumb && oldThumb.parentElement) oldThumb.parentElement.removeChild(oldThumb);
                                                mount.style.background = '';
                                                host.style.background = '';
                                                mount.classList.remove('dark-perf');
                                                host.classList.remove('dark-perf');
                                            } catch(_){ }
                                        };
                                        if (Array.isArray(full) && full.length >= 3){
                                            try {
                                                const titleEl = host.querySelector('.ler-text');
                                                if (titleEl) titleEl.textContent = (window.SIMULADOS_I18N && window.SIMULADOS_I18N.LAST_EXAM_TITLE) || 'Último exame';
                                            } catch(_){ }
                                            const pcts = full.slice(0,3).map(x => Number(x && x.scorePercent));
                                            const valid = pcts.every(x => Number.isFinite(x));
                                            if (valid){
                                                const allLt70 = pcts.every(x => x < 70);
                                                const allGte70Lt75 = pcts.every(x => x >= 70 && x < 75);
                                                const allGt85 = pcts.every(x => x > 85);
                                                const allGt75 = pcts.every(x => x > 75);
                                                // Clear previous thumb if any
                                                const header = host.querySelector('.ler-header');
                                                const kpi = host.querySelector('.ler-icon');
                                                clearStyle();
                                                if (allGt85){
                                                    // Novo: >85% -> verde profundo com degradê (#0A7A0A -> #006400) + rosto feliz verde
                                                    const grad = 'linear-gradient(90deg, #0A7A0A 0%, #006400 100%)';
                                                    mount.style.background = grad;
                                                    host.style.background = grad;
                                                    mount.classList.add('dark-perf');
                                                    host.classList.add('dark-perf');
                                                    if (header && kpi){
                                                        const span = document.createElement('span');
                                                        span.className = 'ler-thumb';
                                                        span.setAttribute('aria-label','Excelente desempenho');
                                                        span.style.cssText = 'display:inline-flex;align-items:center;justify-content:center;line-height:1;margin-right:6px;';
                                                        span.innerHTML = '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><circle cx="12" cy="12" r="9" stroke="#FFFFFF" stroke-width="2"/><path d="M8 14s1.5 2 4 2 4-2 4-2" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M9 10h.01M15 10h.01" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                                                        header.insertBefore(span, kpi);
                                                    }
                                                } else if (allGte70Lt75){
                                                    const grad = 'linear-gradient(90deg, #FFF7ED 0%, #FED7AA 100%)'; // light orange
                                                    mount.style.background = grad;
                                                    host.style.background = grad;
                                                    mount.classList.remove('dark-perf');
                                                    host.classList.remove('dark-perf');
                                                } else if (allLt70){
                                                    const grad = 'linear-gradient(90deg, #FEE2E2 0%, #FCA5A5 100%)'; // red
                                                    mount.style.background = grad;
                                                    host.style.background = grad;
                                                    mount.classList.remove('dark-perf');
                                                    host.classList.remove('dark-perf');
                                                    if (header && kpi){
                                                        const span = document.createElement('span');
                                                        span.className = 'ler-thumb';
                                                        span.setAttribute('aria-label','Desempenho baixo');
                                                        span.style.cssText = 'display:inline-flex;align-items:center;justify-content:center;line-height:1;margin-right:6px;';
                                                        span.innerHTML = '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M10 3h6.25c.69 0 1.25.56 1.25 1.25v7.5c0 .69-.56 1.25-1.25 1.25H13l.38 1.9.02.21c0 .27-.11.52-.29.71L12.5 18l-3.4-3.4A1.25 1.25 0 0 1 8.5 13V4.25C8.5 3.56 9.06 3 9.75 3H10Z" stroke="#b91c1c" stroke-width="1.8" stroke-linejoin="round"/><path d="M5 3v10" stroke="#b91c1c" stroke-width="1.8" stroke-linecap="round"/></svg>';
                                                        header.insertBefore(span, kpi);
                                                    }
                                                } else if (allGt75){
                                                    const grad = 'linear-gradient(90deg, #66E166 0%, #32CD32 100%)'; // medium green gradient for 75-85%
                                                    mount.style.background = grad;
                                                    host.style.background = grad;
                                                    mount.classList.add('dark-perf');
                                                    host.classList.add('dark-perf');
                                                     if (header && kpi){
                                                         const span = document.createElement('span');
                                                         span.className = 'ler-thumb';
                                                         span.setAttribute('aria-label','Bom desempenho');
                                                         span.style.cssText = 'display:inline-flex;align-items:center;justify-content:center;line-height:1;margin-right:6px;';
                                                         span.innerHTML = '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M10 21h6.25c.69 0 1.25-.56 1.25-1.25v-7.5c0-.69-.56-1.25-1.25-1.25H13l.38-1.9.02-.21c0-.27-.11-.52-.29-.71L12.5 6l-3.4 3.4c-.22.22-.35.52-.35.83v6.77c0 .69.56 1.25 1.25 1.25H10Z" stroke="#10b981" stroke-width="1.8" stroke-linejoin="round"/><path d="M5 21V11" stroke="#10b981" stroke-width="1.8" stroke-linecap="round"/></svg>';
                                                         header.insertBefore(span, kpi);
                                                     }
                                                } else {
                                                    // Not strictly matching any rule -> ensure no styling is applied
                                                    clearStyle();
                                                    mount.classList.remove('dark-perf');
                                                    host.classList.remove('dark-perf');
                                                }

                                                // Override gauge numbers with the most recent FULL attempt
                                                try {
                                                    const top = full[0];
                                                                                                        if (top && window.initLastExamResults){
                                                        const v = Number(top.correct || 0);
                                                        const m = Number(top.total || 0);
                                                        window.initLastExamResults(host, { value: v, max: m });
                                                                                                                // Ensure help hidden and values visible when showing data
                                                                                                                try {
                                                                                                                    const help = host.querySelector('.ler-help'); if (help) help.style.display='none';
                                                                                                                    const vals = host.querySelector('.ler-vals'); if (vals) vals.style.display='inline';
                                                                                                                } catch(_){ }
                                                        const dateEl = host.querySelector('.ler-date');
                                                        const pctEl = host.querySelector('.ler-percent');
                                                        const durTxt = host.querySelector('.ler-dur .dur-text');
                                                        const fmtDate = (iso)=>{ try{ const d=new Date(iso); if(isNaN(d)) return ''; return d.toLocaleString('pt-BR',{ day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'}); }catch(_){ return ''; } };
                                                        const fmtDur = (sec)=>{ try{ sec=Math.max(0,Number(sec)||0); const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60); if(h>0) return `${h}h ${String(m).padStart(2,'0')}m`; return `${m}m`; }catch(_){ return ''; } };
                                                        if (pctEl){ const pct = Number.isFinite(top.scorePercent) ? Math.round(Number(top.scorePercent)) : (m>0? Math.round((v*100)/m):0); pctEl.textContent = `(${pct}%)`; }
                                                        if (dateEl && top.finishedAt){ const s = fmtDate(top.finishedAt); if (s) dateEl.textContent = s; }
                                                        if (durTxt && (top.durationSeconds!=null)){ const s = fmtDur(top.durationSeconds); if (s) durTxt.textContent = s; }
                                                    }
                                                } catch(_){ }
                                            } else {
                                                // Some percent missing/invalid -> ensure rule is not applied
                                                clearStyle();
                                                mount.classList.remove('dark-perf');
                                                host.classList.remove('dark-perf');
                                            }
                                        } else {
                                            // Less than 3 FULL attempts -> show neutral card and update title
                                            clearStyle();
                                            mount.classList.remove('dark-perf');
                                            host.classList.remove('dark-perf');
                                                                                        try {
                                              const titleEl = host.querySelector('.ler-text');
                                              if (titleEl) titleEl.textContent = (window.SIMULADOS_I18N && window.SIMULADOS_I18N.WAITING_FULL_EXAMS_TITLE) || 'Aguardando exames completos';
                                              const gaugeTxt = host.querySelector('.ler-gauge text'); if (gaugeTxt) gaugeTxt.textContent = '--%';
                                              const scoreEl = host.querySelector('.ler-score'); if (scoreEl) scoreEl.textContent = '— / —';
                                              const pctEl = host.querySelector('.ler-percent'); if (pctEl) pctEl.textContent = '(—%)';
                                              const dateEl = host.querySelector('.ler-date'); if (dateEl) dateEl.textContent = '';
                                              const durTxt = host.querySelector('.ler-dur .dur-text'); if (durTxt) durTxt.textContent = '';
                                                                                            const help = host.querySelector('.ler-help'); if (help) { help.textContent = (window.SIMULADOS_I18N && window.SIMULADOS_I18N.HELP_NEED_3_FULL) || help.textContent || ''; help.style.display='inline'; }
                                                                                            const vals = host.querySelector('.ler-vals'); if (vals) vals.style.display='none';
                                            } catch(_){ }
                                            // Ensure the widget stays visible (no placeholders, just the waiting message)
                                            mount.style.display = '';
                                        }
                                    }
                                }
                            } catch(_){ /* silent */ }
                            if (!applied){
                                let v = null, m = null;
                                try { const vv = localStorage.getItem('lastExamValue'); if (vv != null) v = Number(vv); } catch(_){ }
                                try { const mm = localStorage.getItem('lastExamMax'); if (mm != null) m = Number(mm); } catch(_){ }
                                if (isFinite(v) && isFinite(m) && m > 0){
                                    window.initLastExamResults(host, { value: v, max: m });
                                    try {
                                        const dateEl = host.querySelector('.ler-date');
                                        const pctEl = host.querySelector('.ler-percent');
                                        const durTxt = host.querySelector('.ler-dur .dur-text');
                                        const iso = localStorage.getItem('lastExamFinishedAt');
                                        const fmtDate = (x)=>{ try{ const d=new Date(x); if(isNaN(d)) return ''; return d.toLocaleString('pt-BR',{ day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'}); }catch(_){ return ''; } };
                                        const fmtDur = (sec)=>{ try{ sec=Math.max(0,Number(sec)||0); const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60); if(h>0) return `${h}h ${String(m).padStart(2,'0')}m`; return `${m}m`; }catch(_){ return ''; } };
                                        if (pctEl){ const pct = m>0? Math.round((v*100)/m):0; pctEl.textContent = `(${pct}%)`; }
                                        if (dateEl && iso){ const s = fmtDate(iso); if (s) dateEl.textContent = s; }
                                        const dsec = localStorage.getItem('lastExamDurationSec');
                                        if (durTxt && dsec!=null){ const s = fmtDur(dsec); if (s) durTxt.textContent = s; }
                                    } catch(_){ }
                                } else {
                                    window.initLastExamResults(host, { value: 0, max: 100 });
                                }
                            }
                        }
                    } catch(_){ }
                }
                if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', loadLastExamResults); else loadLastExamResults();
            })();
        </script>

        <!-- Simulator control: exposes a button to step through test cases for the lastExamResults widget -->
        <script>
        (function(){
            const btn = document.getElementById('lastExamTestBtn');
            if (!btn) return;
            const states = [
                { id: 'off', label: 'OFF', pcts: null },
                { id: 'lt70', label: '<70%', pcts: [60,58,65] },
                { id: '70_75', label: '70–74%', pcts: [71,73,70] },
                { id: '75_85', label: '75–85%', pcts: [76,80,78] },
                { id: 'gt85', label: '>85%', pcts: [86,88,90] }
            ];
            let idx = 0;
            try {
                const saved = localStorage.getItem('lastExamSimIdx');
                if (saved != null) {
                    const n = Number(saved);
                    if (Number.isInteger(n) && n >= 0 && n < states.length) idx = n;
                }
            } catch(_){ }

            function clearThumbAndReset(mount, host){
                try {
                    const old = host && host.querySelector && host.querySelector('.ler-thumb');
                    if (old && old.parentElement) old.parentElement.removeChild(old);
                    if (mount) mount.style.background = '';
                    if (host) host.style.background = '';
                    if (mount) mount.classList.remove('dark-perf');
                    if (host) host.classList.remove('dark-perf');
                } catch(_){ }
            }

            function applyPcts(pcts){
                const mount = document.getElementById('lastExamResultsMount');
                if (!mount) return;
                const host = mount.querySelector && mount.querySelector('.ler-card');
                if (!host) return;
                // if pcts null -> clear
                if (!Array.isArray(pcts) || pcts.length < 3){
                    clearThumbAndReset(mount, host);
                    // reset gauge to zero-ish
                    if (window.initLastExamResults) window.initLastExamResults(host, { value: 0, max: 100 });
                    return;
                }
                const p = pcts.slice(0,3).map(x => Number(x));
                if (!p.every(Number.isFinite)) { clearThumbAndReset(mount, host); return; }
                const allLt70 = p.every(x => x < 70);
                const allGte70Lt75 = p.every(x => x >=70 && x < 75);
                const allGt85 = p.every(x => x > 85);
                const allGt75 = p.every(x => x > 75);

                const header = host.querySelector('.ler-header');
                const kpi = host.querySelector('.ler-icon');
                clearThumbAndReset(mount, host);

                if (allGt85){
                    const grad = 'linear-gradient(90deg, #0A7A0A 0%, #006400 100%)';
                    mount.style.background = grad; host.style.background = grad;
                    mount.classList.add('dark-perf'); host.classList.add('dark-perf');
                    if (header && kpi){
                        const span = document.createElement('span'); span.className='ler-thumb'; span.setAttribute('aria-label','Excelente desempenho');
                        span.style.cssText = 'display:inline-flex;align-items:center;justify-content:center;line-height:1;margin-right:6px;';
                        span.innerHTML = '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><circle cx="12" cy="12" r="9" stroke="#FFFFFF" stroke-width="2"/><path d="M8 14s1.5 2 4 2 4-2 4-2" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M9 10h.01M15 10h.01" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                        header.insertBefore(span, kpi);
                    }
                } else if (allGte70Lt75){
                    const grad = 'linear-gradient(90deg, #FFF7ED 0%, #FED7AA 100%)'; mount.style.background = grad; host.style.background = grad;
                    mount.classList.remove('dark-perf'); host.classList.remove('dark-perf');
                } else if (allLt70){
                    const grad = 'linear-gradient(90deg, #FEE2E2 0%, #FCA5A5 100%)'; mount.style.background = grad; host.style.background = grad;
                    mount.classList.remove('dark-perf'); host.classList.remove('dark-perf');
                    if (header && kpi){ const span = document.createElement('span'); span.className='ler-thumb'; span.setAttribute('aria-label','Desempenho baixo'); span.style.cssText='display:inline-flex;align-items:center;justify-content:center;line-height:1;margin-right:6px;'; span.innerHTML='<svg viewBox="0 0 24 24" width="20" height="20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M10 3h6.25c.69 0 1.25.56 1.25 1.25v7.5c0 .69-.56 1.25-1.25 1.25H13l.38 1.9.02.21c0 .27-.11.52-.29.71L12.5 18l-3.4-3.4A1.25 1.25 0 0 1 8.5 13V4.25C8.5 3.56 9.06 3 9.75 3H10Z" stroke="#b91c1c" stroke-width="1.8" stroke-linejoin="round"/><path d="M5 3v10" stroke="#b91c1c" stroke-width="1.8" stroke-linecap="round"/></svg>'; header.insertBefore(span, kpi); }
                } else if (allGt75){
                    const grad = 'linear-gradient(90deg, #66E166 0%, #32CD32 100%)'; mount.style.background = grad; host.style.background = grad; mount.classList.add('dark-perf'); host.classList.add('dark-perf');
                    if (header && kpi){ const span = document.createElement('span'); span.className='ler-thumb'; span.setAttribute('aria-label','Bom desempenho'); span.style.cssText='display:inline-flex;align-items:center;justify-content:center;line-height:1;margin-right:6px;'; span.innerHTML='<svg viewBox="0 0 24 24" width="20" height="20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M10 21h6.25c.69 0 1.25-.56 1.25-1.25v-7.5c0-.69-.56-1.25-1.25-1.25H13l.38-1.9.02-.21c0-.27-.11-.52-.29-.71L12.5 6l-3.4 3.4c-.22.22-.35.52-.35.83v6.77c0 .69.56 1.25 1.25 1.25H10Z" stroke="#10b981" stroke-width="1.8" stroke-linejoin="round"/><path d="M5 21V11" stroke="#10b981" stroke-width="1.8" stroke-linecap="round"/></svg>'; header.insertBefore(span, kpi); }
                } else {
                    clearThumbAndReset(mount, host);
                }

                // Update gauge (use average percent as value over 100)
                try {
                    const avg = Math.round((p[0]+p[1]+p[2]) / 3);
                    if (window.initLastExamResults) window.initLastExamResults(host, { value: avg, max: 100 });
                    // fill percent text and duration area similar to loader
                    const pctEl = host.querySelector('.ler-percent'); if (pctEl) pctEl.textContent = `(${avg}%)`;
                    const scoreEl = host.querySelector('.ler-score'); if (scoreEl) scoreEl.textContent = avg + ' / 100';
                } catch(_){ }
            }

            // Apply saved state on load
            (function initSaved(){ try { const s=states[idx]; btn.textContent='Simular: '+s.label; applyPcts(s.pcts); } catch(_){ } })();

            btn.addEventListener('click', ()=>{
                idx = (idx + 1) % states.length;
                const s = states[idx];
                btn.textContent = 'Simular: ' + s.label;
                applyPcts(s.pcts);
                try { localStorage.setItem('lastExamSimIdx', String(idx)); } catch(_){ }
            });

            // expose for console/debug
            window._lastExamSimulator = { states, applyPcts };
        })();
        </script>

    <!-- Admin Modal -->
    <div id="adminModal" class="overlay" aria-hidden="true" style="background:rgba(0,0,0,0.75);align-items:flex-start;padding-top:20px;overflow-y:auto">
        <div style="background:var(--panel);border-radius:12px;max-width:500px;width:90%;margin:0 auto;padding:24px;box-shadow:0 12px 40px rgba(0,0,0,0.4);color:var(--text)">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
                <h2 style="margin:0;font-size:1.4rem;color:var(--text)">Administração</h2>
                <button id="adminModalClose" style="background:none;border:none;font-size:1.8rem;color:var(--muted);cursor:pointer;padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center" aria-label="Fechar">×</button>
            </div>
            
            <!-- Reconciliação de Estatísticas -->
            <div style="border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:16px">
                <h3 style="margin:0 0 12px;font-size:1.1rem;color:var(--primary)">Reconciliação de Estatísticas</h3>
                <p style="font-size:0.9rem;color:var(--muted);margin:0 0 16px;line-height:1.5">Reconstruir ou corrigir as estatísticas agregadas de tentativas de exames.</p>
                
                <div style="display:grid;gap:12px;margin-bottom:16px">
                    <div>
                        <label for="reconcileFromDate" style="display:block;font-size:0.85rem;color:var(--muted);margin-bottom:4px">Data Inicial</label>
                        <input type="date" id="reconcileFromDate" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:0.9rem" />
                    </div>
                    <div>
                        <label for="reconcileToDate" style="display:block;font-size:0.85rem;color:var(--muted);margin-bottom:4px">Data Final</label>
                        <input type="date" id="reconcileToDate" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:0.9rem" />
                    </div>
                    <div>
                        <label for="reconcileMode" style="display:block;font-size:0.85rem;color:var(--muted);margin-bottom:4px">Modo</label>
                        <select id="reconcileMode" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:0.9rem">
                            <option value="rebuild">Rebuild (sobrescrever)</option>
                            <option value="merge">Merge (incrementar)</option>
                        </select>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px">
                        <input type="checkbox" id="reconcileDryRun" style="width:18px;height:18px;cursor:pointer" />
                        <label for="reconcileDryRun" style="font-size:0.9rem;color:var(--text);cursor:pointer">Dry-run (simular sem alterar)</label>
                    </div>
                </div>
                
                <button id="reconcileBtn" style="width:100%;padding:10px;background:var(--primary);color:#fff;border:none;border-radius:6px;font-size:0.95rem;font-weight:600;cursor:pointer;transition:background .15s" onmouseover="this.style.background='var(--primary-press)'" onmouseout="this.style.background='var(--primary)'">Executar Reconciliação</button>
                
                <div id="reconcileOutput" style="margin-top:12px;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;font-family:monospace;font-size:0.8rem;color:var(--text);max-height:200px;overflow-y:auto;display:none;white-space:pre-wrap"></div>
            </div>

            <!-- Fixture Attempt (Distribuição por Domínio) -->
            <div style="border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:16px">
                <h3 style="margin:0 0 12px;font-size:1.1rem;color:var(--primary)">Gerar Tentativa Fixture</h3>
                <p style="font-size:0.85rem;color:var(--muted);margin:0 0 14px;line-height:1.4">Cria uma tentativa finalizada diretamente no banco para testes. Pode especificar percentuais de desempenho por domínio (People, Process, Business). Os valores reais podem divergir levemente devido à disponibilidade de questões por domínio.</p>
                <form id="fixtureForm" style="display:grid;gap:10px;margin-bottom:12px">
                    <div style="display:flex;flex-direction:column;gap:4px">
                        <label for="fxUserId" style="font-size:0.75rem;color:var(--muted)">User ID *</label>
                        <input id="fxUserId" name="userId" type="number" min="1" required placeholder="ex: 123" style="padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:0.85rem" />
                    </div>
                    <div style="display:flex;flex-direction:column;gap:4px">
                        <label for="fxExamType" style="font-size:0.75rem;color:var(--muted)">Exam Type Slug</label>
                        <input id="fxExamType" name="examTypeSlug" type="text" value="pmp" placeholder="pmp" style="padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:0.85rem" />
                    </div>
                    <div style="display:flex;flex-direction:column;gap:4px">
                        <label for="fxTotal" style="font-size:0.75rem;color:var(--muted)">Total Questões</label>
                        <input id="fxTotal" name="totalQuestions" type="number" min="1" max="500" value="180" style="padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:0.85rem" />
                    </div>
                    <div style="display:flex;flex-direction:column;gap:4px">
                        <label for="fxOverall" style="font-size:0.75rem;color:var(--muted)">% Geral *</label>
                        <input id="fxOverall" name="overallPct" type="number" min="0" max="100" value="65" required style="padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:0.85rem" />
                    </div>
                    <div style="display:flex;flex-direction:column;gap:4px">
                        <label for="fxPeople" style="font-size:0.75rem;color:var(--muted)">% People</label>
                        <input id="fxPeople" name="peoplePct" type="number" min="0" max="100" placeholder="opcional" style="padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:0.85rem" />
                    </div>
                    <div style="display:flex;flex-direction:column;gap:4px">
                        <label for="fxProcess" style="font-size:0.75rem;color:var(--muted)">% Process</label>
                        <input id="fxProcess" name="processPct" type="number" min="0" max="100" placeholder="opcional" style="padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:0.85rem" />
                    </div>
                    <div style="display:flex;flex-direction:column;gap:4px">
                        <label for="fxBusiness" style="font-size:0.75rem;color:var(--muted)">% Business</label>
                        <input id="fxBusiness" name="businessPct" type="number" min="0" max="100" placeholder="opcional" style="padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:0.85rem" />
                    </div>
                    <button type="submit" style="margin-top:4px;padding:10px;background:var(--primary);color:#fff;border:none;border-radius:6px;font-size:0.9rem;font-weight:600;cursor:pointer;transition:background .15s" onmouseover="this.style.background='var(--primary-press)'" onmouseout="this.style.background='var(--primary)'">Gerar Fixture</button>
                </form>
                <div id="fixtureOutput" style="display:none;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;font-family:monospace;font-size:0.75rem;color:var(--text);max-height:220px;overflow-y:auto;white-space:pre-wrap"></div>
            </div>
            
            <!-- Outras opções futuras -->
            <div style="border:1px solid var(--border);border-radius:8px;padding:16px">
                <h3 style="margin:0 0 8px;font-size:1.1rem;color:var(--primary)">Outras Ferramentas</h3>
                <p style="font-size:0.85rem;color:var(--muted);margin:0">Em breve: gestão de usuários, purga de dados, relatórios avançados.</p>
            </div>
        </div>
    </div>

    <script>
        (function(){
            const counters = { home: 1, search: 0, favorites: 0, profile: 0 };
            const sections = {
                home: document.getElementById('home'),
                search: document.getElementById('search'),
                favorites: document.getElementById('favorites'),
                profile: document.getElementById('profile')
            };
            const debugEls = {
                home: document.getElementById('debug-home'),
                search: document.getElementById('debug-search'),
                favorites: document.getElementById('debug-favorites'),
                profile: document.getElementById('debug-profile')
            };
            const nav = document.querySelector('.bottom-nav');
            const navItems = Array.from(document.querySelectorAll('.bottom-nav .nav-item'));
            const overlay = document.getElementById('fullOverlay');
            const fullImg = document.getElementById('fullImg');
            const backBtn = document.getElementById('backBtn');

            function updateDebug(name){ if (debugEls[name]) debugEls[name].textContent = 'Cliques: ' + counters[name]; }

            function setActive(target){
                // update nav state
                navItems.forEach(it => it.classList.remove('active'));
                const btn = navItems.find(it => it.dataset.target === target);
                if (btn) btn.classList.add('active');

                // update sections
                Object.keys(sections).forEach(k => sections[k].classList.remove('active'));
                if (sections[target]) sections[target].classList.add('active');
            }

            // Initialize Home debug
            updateDebug('home');

            // Nav click handling
            navItems.forEach(it => {
                it.addEventListener('click', () => {
                    const target = it.dataset.target;
                    if (!target) return;
                    counters[target] = (counters[target] || 0) + 1;
                    updateDebug(target);
                    setActive(target);
                });
            });

            // Card click: Simulador abre examSetup; exam-mock abre fluxo completo; histórico abre modal; indicadores abre página dedicada
            document.addEventListener('click', (e) => {
                const card = e.target.closest && e.target.closest('.card');
                if (!card) return;
                // Se for o card do Simulador, usar fluxo do script.js
                if (card.classList.contains('card--simulador')){
                    // Indicadores: intercepta antes de fluxo genérico
                    const isIndicadores = (card.id === 'card-indicadores') || (card.getAttribute('data-card') === 'indicadores');
                    if (isIndicadores) {
                        try { e.preventDefault(); e.stopPropagation(); if (e.stopImmediatePropagation) e.stopImmediatePropagation(); } catch(_) {}
                        window.location.assign('/pages/Indicadores.html');
                        return;
                    }
                    // Exception: use this card for Histórico modal, not exam setup
                    const isHistorico = (card.id === 'card-progresso-geral') || (card.getAttribute('data-card') === 'progresso-geral');
                    if (isHistorico) {
                        try { e.preventDefault(); e.stopPropagation(); if (e.stopImmediatePropagation) e.stopImmediatePropagation(); } catch(_) {}
                        try {
                            const modal = document.getElementById('examResultsModal');
                            const listEl = document.getElementById('examList');
                            if (modal) {
                                modal.style.display = 'flex';
                                modal.setAttribute('aria-hidden','false');
                                (async function loadHistory(){
                                    try {
                                        const base = (window.SIMULADOS_CONFIG && window.SIMULADOS_CONFIG.BACKEND_BASE) || 'http://localhost:3000';
                                        const url = (base || '') + '/api/exams/history?limit=50';
                                        const token = (localStorage.getItem('sessionToken')||'').trim();
                                        const r = await fetch(url, { headers: token ? { 'X-Session-Token': token } : {} });
                                        let list = [];
                                        if (r.ok) list = await r.json();
                                        if (!Array.isArray(list)) list = [];
                                        if (listEl) {
                                            listEl.innerHTML = '';
                                            if (!list.length){
                                                const empty = document.createElement('div');
                                                empty.textContent = 'Nenhum exame encontrado';
                                                empty.style.cssText = 'padding:8px;border:1px dashed #cbd5e1;border-radius:8px;color:#64748b;text-align:center';
                                                listEl.appendChild(empty);
                                                return;
                                            }
                                            for (const item of list){
                                                const id = item && (item.examAttemptId || item.attemptId || item.id || item._id || item.sessionId || item.examId);
                                                if (!id) continue;
                                                const mode = String((item && (item.examMode || item.mode)) || '').toLowerCase();
                                                const title = item && (item.title || item.name) || (mode==='full' ? 'Exame Completo' : 'Quiz');
                                                const finished = item && item.finishedAt ? new Date(item.finishedAt).toLocaleString('pt-BR') : '';
                                                const pctNum = item && item.scorePercent != null ? Math.round(item.scorePercent) : null;
                                                const btn = document.createElement('button');
                                                btn.type = 'button';
                                                btn.style.cssText = 'display:flex;align-items:center;justify-content:space-between;padding:10px;border:1px solid #cbd5e1;border-radius:8px;background:#f8fafc;color:#111827;font-size:.92rem;cursor:pointer';
                                                btn.dataset.id = String(id);
                                                btn.dataset.mode = mode || 'quiz';
                                                const left = document.createElement('span'); left.textContent = title;
                                                const right = document.createElement('span'); right.style.cssText = 'display:flex;gap:8px;color:#334155;font-size:.85rem';
                                                const modeTag = document.createElement('span'); modeTag.textContent = (mode==='full'?'Full':'Quiz'); modeTag.style.cssText='padding:2px 6px;border-radius:6px;background:#eef2ff;color:#3730a3;font-weight:600'; right.appendChild(modeTag);
                                                if (pctNum != null){ const pctEl = document.createElement('span'); pctEl.textContent = pctNum + '%'; pctEl.style.cssText='color:#0f766e;font-weight:600'; right.appendChild(pctEl); }
                                                if (finished){ const dt = document.createElement('span'); dt.textContent = finished; dt.style.cssText='color:#64748b'; right.appendChild(dt); }
                                                btn.appendChild(left); btn.appendChild(right);
                                                btn.addEventListener('click', ()=>{
                                                    const path = mode === 'full' ? '/pages/examReviewFull.html' : '/pages/examReviewQuiz.html';
                                                    const urlGo = `${path}?examId=${encodeURIComponent(String(id))}&mode=${encodeURIComponent(mode||'quiz')}`;
                                                    window.location.assign(urlGo);
                                                });
                                                listEl.appendChild(btn);
                                            }
                                        }
                                    } catch(_) { 
                                        if (listEl) {
                                            listEl.innerHTML = '';
                                            const err = document.createElement('div');
                                            err.textContent = 'Falha ao carregar';
                                            err.style.cssText = 'padding:8px;border:1px solid #fecaca;border-radius:8px;background:#fee2e2;color:#991b1b;text-align:center';
                                            listEl.appendChild(err);
                                        }
                                    }
                                })();
                            }
                        } catch(_){ }
                        return;
                    }
                    // Evita qualquer ação/navegação padrão e outros handlers paralelos
                    try { e.preventDefault(); } catch(_) {}
                    try { e.stopPropagation(); } catch(_) {}
                    try { if (typeof e.stopImmediatePropagation === 'function') e.stopImmediatePropagation(); } catch(_) {}
                    if (window.showExamSetupAndRedirect) {
                        // Usa caminho absoluto para consistência
                        window.showExamSetupAndRedirect('/pages/exam.html');
                    }
                    return;
                }
                // Se for o card do Exame Cmpleto (Mock)
                if (card.id === 'card-exam-mock' || card.getAttribute('data-card') === 'exam-mock'){
                    try { e.preventDefault(); e.stopPropagation(); if (e.stopImmediatePropagation) e.stopImmediatePropagation(); } catch(_) {}
                    const bloqueado = (localStorage.getItem('BloqueioAtivado') === 'true');
                    if (bloqueado){
                        try { if (typeof showToast === 'function') showToast('Somente usuário Premium.'); else alert('Somente usuário Premium.'); } catch(_) { alert('Somente usuário Premium.'); }
                        return;
                    }
                    // Premium: exibe modal de confirmação e, ao prosseguir, inicia o exame completo
                    const proceed = function(){
                        try {
                            localStorage.setItem('examQuestionCount', '180');
                            localStorage.setItem('examCountFromDefault', 'true');
                            sessionStorage.setItem('startExam', 'true');
                        } catch(_){ }
                        window.location.assign('/pages/examFull.html');
                    };
                    if (!(window.showFullExamConfirm && window.showFullExamConfirm(proceed))){
                        // Fallback: sem modal carregado, seguir direto
                        proceed();
                    }
                    return;
                }
                // Abrir modal de Histórico de exames
                if (card.id === 'card-progresso-geral' || card.getAttribute('data-card') === 'progresso-geral') {
                    try { e.preventDefault(); e.stopPropagation(); if (e.stopImmediatePropagation) e.stopImmediatePropagation(); } catch(_) {}
                    try {
                        const modal = document.getElementById('examResultsModal');
                        const selectEl = document.getElementById('examSelect');
                        if (modal) {
                            modal.style.display = 'flex';
                            modal.setAttribute('aria-hidden','false');
                            // Carregar histórico
                            (async function loadHistory(){
                                try {
                                    const base = (window.SIMULADOS_CONFIG && window.SIMULADOS_CONFIG.BACKEND_BASE) || 'http://localhost:3000';
                                    const url = (base || '') + '/api/exams/history?limit=50';
                                    const token = (localStorage.getItem('sessionToken')||'').trim();
                                    const r = await fetch(url, { headers: token ? { 'X-Session-Token': token } : {} });
                                    let list = [];
                                    if (r.ok) list = await r.json();
                                    if (!Array.isArray(list)) list = [];
                                    if (selectEl) {
                                        selectEl.innerHTML = '';
                                        if (!list.length){ selectEl.innerHTML = '<option value="" selected>Nenhum exame encontrado</option>'; return; }
                                        for (const item of list){
                                            const id = item && (item.id || item.sessionId || item.examId);
                                            const mode = String(item && item.examMode || '').toLowerCase();
                                            const title = item && (item.title || item.name) || (mode==='full' ? 'Exame Completo' : 'Quiz');
                                            const finished = item && item.finishedAt ? new Date(item.finishedAt).toLocaleString('pt-BR') : '';
                                            const pct = item && item.scorePercent != null ? ` (${Math.round(item.scorePercent)}%)` : '';
                                            const opt = document.createElement('option');
                                            opt.value = String(id);
                                            opt.setAttribute('data-mode', mode || 'quiz');
                                            opt.textContent = `${title}${pct}${finished? ' — ' + finished : ''}`;
                                            selectEl.appendChild(opt);
                                        }
                                    }
                                } catch(_) { if (selectEl) selectEl.innerHTML = '<option value="" selected>Falha ao carregar</option>'; }
                            })();
                        }
                    } catch(_){ }
                    return;
                }
                // Abrir modal Admin
                if (card.id === 'card-admin' || card.getAttribute('data-card') === 'admin') {
                    try { e.preventDefault(); e.stopPropagation(); if (e.stopImmediatePropagation) e.stopImmediatePropagation(); } catch(_) {}
                    const adminModal = document.getElementById('adminModal');
                    if (adminModal) {
                        adminModal.classList.add('active');
                        adminModal.setAttribute('aria-hidden', 'false');
                        if (nav) nav.style.display = 'none';
                    }
                    return;
                }
                const url = card.getAttribute('data-full');
                if (!url) return;
                fullImg.src = url;
                overlay.classList.add('active');
                overlay.setAttribute('aria-hidden', 'false');
                if (nav) nav.style.display = 'none';
                document.body.style.overflow = 'hidden';
            }, true); // capture phase para interceptar o clique o quanto antes

            // Close overlay
            backBtn.addEventListener('click', () => {
                overlay.classList.remove('active');
                overlay.setAttribute('aria-hidden', 'true');
                fullImg.removeAttribute('src');
                if (nav) nav.style.display = '';
                document.body.style.overflow = '';
            });

            // Close overlay when clicking backdrop (except image/back button)
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) backBtn.click();
            });
            
            // Admin Modal handlers
            const adminModal = document.getElementById('adminModal');
            const adminModalClose = document.getElementById('adminModalClose');
            const reconcileBtn = document.getElementById('reconcileBtn');
            const reconcileOutput = document.getElementById('reconcileOutput');
            const reconcileFromDate = document.getElementById('reconcileFromDate');
            const reconcileToDate = document.getElementById('reconcileToDate');
            const reconcileMode = document.getElementById('reconcileMode');
            const reconcileDryRun = document.getElementById('reconcileDryRun');
            
            // Set default dates (last 30 days)
            if (reconcileFromDate && reconcileToDate) {
                const today = new Date();
                const thirtyDaysAgo = new Date(today);
                thirtyDaysAgo.setDate(today.getDate() - 30);
                reconcileToDate.value = today.toISOString().split('T')[0];
                reconcileFromDate.value = thirtyDaysAgo.toISOString().split('T')[0];
            }
            
            // Check if user is admin on page load
            (async function checkAdmin() {
                try {
                    const base = (window.SIMULADOS_CONFIG && window.SIMULADOS_CONFIG.BACKEND_BASE) || 'http://localhost:3000';
                    const token = localStorage.getItem('sessionToken');
                    if (!token) return;
                    
                    const resp = await fetch(base + '/api/users/me', {
                        headers: { 'X-Session-Token': token }
                    });
                    
                    if (resp.ok) {
                        const user = await resp.json();
                        if (user && user.TipoUsuario === 'admin') {
                            const adminCard = document.getElementById('card-admin');
                            if (adminCard) adminCard.style.display = '';
                        }
                    }
                } catch(e) {
                    console.warn('Admin check failed:', e);
                }
            })();
            
            if (adminModalClose && adminModal) {
                adminModalClose.addEventListener('click', () => {
                    adminModal.classList.remove('active');
                    adminModal.setAttribute('aria-hidden', 'true');
                    if (nav) nav.style.display = '';
                });
            }
            
            if (reconcileBtn) {
                reconcileBtn.addEventListener('click', async () => {
                    const fromDate = reconcileFromDate.value;
                    const toDate = reconcileToDate.value;
                    const mode = reconcileMode.value;
                    const dryRun = reconcileDryRun.checked;
                    
                    if (!fromDate || !toDate) {
                        alert('Por favor, preencha as datas inicial e final.');
                        return;
                    }
                    
                    if (new Date(fromDate) > new Date(toDate)) {
                        alert('Data inicial deve ser anterior à data final.');
                        return;
                    }
                    
                    reconcileOutput.style.display = 'block';
                    reconcileOutput.textContent = 'Executando reconciliação...\n';
                    reconcileBtn.disabled = true;
                    reconcileBtn.textContent = 'Processando...';
                    
                    try {
                        const base = (window.SIMULADOS_CONFIG && window.SIMULADOS_CONFIG.BACKEND_BASE) || 'http://localhost:3000';
                        const token = localStorage.getItem('sessionToken');
                        
                        const params = new URLSearchParams({
                            from: fromDate,
                            to: toDate,
                            mode: mode,
                            dryRun: dryRun ? 'true' : 'false'
                        });
                        
                        const resp = await fetch(base + '/api/admin/exams/reconcile-stats?' + params, {
                            method: 'POST',
                            headers: {
                                'Authorization': 'Bearer ' + (localStorage.getItem('jwt') || ''),
                                'X-Session-Token': token
                            }
                        });
                        
                        const result = await resp.json();
                        
                        if (resp.ok) {
                            reconcileOutput.textContent = 'Reconciliação concluída com sucesso!\n\n' + JSON.stringify(result, null, 2);
                        } else {
                            reconcileOutput.textContent = 'Erro na reconciliação:\n' + (result.error || resp.statusText);
                        }
                    } catch(e) {
                        reconcileOutput.textContent = 'Erro ao executar reconciliação:\n' + e.message;
                    } finally {
                        reconcileBtn.disabled = false;
                        reconcileBtn.textContent = 'Executar Reconciliação';
                    }
                });
            }

            // Fixture form submission
            const fixtureForm = document.getElementById('fixtureForm');
            const fixtureOutput = document.getElementById('fixtureOutput');
            if (fixtureForm) {
                // References
                const fxOverall = document.getElementById('fxOverall');
                const fxPeople = document.getElementById('fxPeople');
                const fxProcess = document.getElementById('fxProcess');
                const fxBusiness = document.getElementById('fxBusiness');
                // Add spread control UI (variation magnitude)
                if(fxOverall && !document.getElementById('fxSpreadControl')){
                    const wrap = fxOverall.parentElement;
                    if(wrap){
                        const spreadBox = document.createElement('div');
                        spreadBox.style.cssText='margin-top:6px;display:flex;align-items:center;gap:6px;flex-wrap:wrap';
                        spreadBox.innerHTML = '<label style="font-size:.65rem;color:#64748b;display:flex;align-items:center;gap:4px">Variação máx.<input id="fxSpreadControl" type="range" min="0" max="30" value="12" style="width:110px"></label><span id="fxSpreadValue" style="font-size:.65rem;color:#334155">±12%</span><label style="font-size:.65rem;color:#64748b;display:flex;align-items:center;gap:4px"><input id="fxLockDomains" type="checkbox"> Manter valores manualmente</label>';
                        wrap.appendChild(spreadBox);
                        const rng = spreadBox.querySelector('#fxSpreadControl');
                        const out = spreadBox.querySelector('#fxSpreadValue');
                        if(rng && out){ rng.addEventListener('input',()=>{ out.textContent='±'+rng.value+'%'; }); }
                    }
                }
                // Helper clamp
                function clampPct(v){ v = Math.round(Number(v)||0); if(v<0) v=0; if(v>100) v=100; return v; }
                function randomizeDomains(){
                    if(!fxOverall || !fxPeople || !fxProcess || !fxBusiness) return;
                    const lock = document.getElementById('fxLockDomains');
                    if(lock && lock.checked) return; // user locked manual values
                    const overall = clampPct(fxOverall.value);
                    const spreadEl = document.getElementById('fxSpreadControl');
                    const maxDev = spreadEl ? Number(spreadEl.value) : 12;
                    // Attempt random deviations ensuring bounds & mean constraint
                    let attempt=0; let chosen=null;
                    while(attempt<100){
                        attempt++;
                        // pick d1,d2 uniformly in [-maxDev,maxDev]
                        const d1 = (Math.random()*2-1)*maxDev;
                        const d2 = (Math.random()*2-1)*maxDev;
                        const d3 = -(d1+d2);
                        const a = clampPct(overall + d1);
                        const b = clampPct(overall + d2);
                        const c = clampPct(overall + d3);
                        const avg = (a+b+c)/3;
                        if(Math.abs(avg - overall) <= 0.75){ // tolerance
                            // ensure some variation (not all equal)
                            const distinct = (new Set([a,b,c])).size > 1;
                            if(distinct){ chosen=[a,b,c]; break; }
                        }
                    }
                    if(!chosen){ chosen=[overall,overall,overall]; }
                    fxPeople.value = String(chosen[0]);
                    fxProcess.value = String(chosen[1]);
                    fxBusiness.value = String(chosen[2]);
                }
                if(fxOverall){ fxOverall.addEventListener('input', randomizeDomains); }
                // Manual balance button & hint
                const overallWrapper = fxOverall && fxOverall.parentElement;
                if(overallWrapper){
                    const btn = document.createElement('button'); btn.type='button'; btn.textContent='Randomizar';
                    btn.style.cssText='margin-top:6px;padding:6px 8px;background:#0d9488;color:#fff;border:none;border-radius:4px;font-size:.7rem;cursor:pointer;';
                    btn.addEventListener('click', randomizeDomains); overallWrapper.appendChild(btn);
                    const hint = document.createElement('div');
                    hint.textContent='Geramos percentuais aleatórios por domínio com média = % Geral. Use "Manter valores" para congelar.';
                    hint.style.cssText='margin-top:6px;font-size:.65rem;line-height:1.2;color:#64748b;'; overallWrapper.appendChild(hint);
                }
                // Initial random fill if empty
                randomizeDomains();
                fixtureForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const userId = document.getElementById('fxUserId').value.trim();
                    const examTypeSlug = document.getElementById('fxExamType').value.trim();
                    const totalQuestions = document.getElementById('fxTotal').value.trim();
                    const overallPct = document.getElementById('fxOverall').value.trim();
                    const peoplePct = document.getElementById('fxPeople').value.trim();
                    const processPct = document.getElementById('fxProcess').value.trim();
                    const businessPct = document.getElementById('fxBusiness').value.trim();
                    if (!userId || !overallPct) { alert('Preencha User ID e % Geral.'); return; }
                    const o = clampPct(overallPct);
                    const p = clampPct(peoplePct === '' ? o : peoplePct);
                    const pr = clampPct(processPct === '' ? o : processPct);
                    const b = clampPct(businessPct === '' ? o : businessPct);
                    const mean = (p+pr+b)/3;
                    if(Math.abs(mean - o) > 2){
                        alert(`Inconsistência: média domínios (${mean.toFixed(2)}%) difere de % Geral (${o}%). Ajuste ou clique em Randomizar.`);
                        return;
                    }
                    fixtureOutput.style.display='block';
                    const startedAt = new Date();
                    fixtureOutput.textContent='Gerando fixture...\n';
                    try {
                        const base = (window.SIMULADOS_CONFIG && window.SIMULADOS_CONFIG.BACKEND_BASE) || 'http://localhost:3000';
                        const token = localStorage.getItem('sessionToken');
                        const payload = { userId: Number(userId), overallPct: Number(overallPct), totalQuestions: Number(totalQuestions), examTypeSlug: examTypeSlug || 'pmp' };
                        if (peoplePct !== '') payload.peoplePct = Number(peoplePct);
                        if (processPct !== '') payload.processPct = Number(processPct);
                        if (businessPct !== '') payload.businessPct = Number(businessPct);
                        const url = base + '/api/admin/exams/fixture-attempt';
                        const resp = await fetch(url, { method:'POST', headers:{ 'Content-Type':'application/json','X-Session-Token': token }, body: JSON.stringify(payload) });
                        const rawText = await resp.text();
                        let parsed; try { parsed = JSON.parse(rawText); } catch(_) { parsed = null; }
                        const ms = new Date() - startedAt;
                        if (resp.ok) {
                            fixtureOutput.textContent = 'Fixture criada com sucesso!\n' +
                              `Status: ${resp.status} ${resp.statusText}\n` +
                              `Tempo: ${ms}ms\n` +
                              'Payload enviado:\n' + JSON.stringify(payload,null,2) + '\n\n' +
                              'Resposta:\n' + (parsed ? JSON.stringify(parsed,null,2) : rawText);
                        } else {
                            fixtureOutput.textContent = 'Falha ao criar fixture\n' +
                              `Status: ${resp.status} ${resp.statusText}\n` +
                              `Tempo: ${ms}ms\n` +
                              'Endpoint: ' + url + '\n' +
                              'Payload enviado:\n' + JSON.stringify(payload,null,2) + '\n\n' +
                              'Corpo bruto:\n' + rawText.slice(0,4000);
                        }
                    } catch(err){
                        fixtureOutput.textContent='Erro de rede/execução:\n' + (err && err.stack ? err.stack : err.message || String(err));
                    }
                });
            }
        })();
    </script>
    
    <!-- Service Worker Registration -->
    <script>
        // Register SW only in secure http/https contexts (not file://)
        (function registerSW(){
            try {
                const isHttp = /^https?:$/i.test(window.location.protocol);
                if (!('serviceWorker' in navigator) || !isHttp || !window.isSecureContext) return;
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/sw.js')
                        .then(registration => {
                            console.log('[SW] Registered successfully:', registration.scope);
                            registration.addEventListener('updatefound', () => {
                                const newWorker = registration.installing;
                                console.log('[SW] Update found');
                                newWorker.addEventListener('statechange', () => {
                                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                        console.log('[SW] New version available, reload to update');
                                    }
                                });
                            });
                        })
                        .catch(err => console.error('[SW] Registration failed:', err));
                });
            } catch(e){ /* ignore in unsupported contexts */ }
        })();
    </script>
</body>
</html>