<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Indicadores</title>
  <style>
    body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif; background:#f8fafc; color:#0f172a; }
    h1 { font-size:1.1rem; margin:16px; font-weight:600; padding-left:35px; margin-left:0; }
    .tabs-bar { background:#1e293b; width:100%; padding:12px 16px 12px 30px; box-sizing:border-box; }
    .tabs { display:flex; gap:8px; flex-wrap:wrap; }
    .tab-btn { background:#1e293b; padding:8px 16px; font-size:0.8rem; border-radius:6px; cursor:pointer; color:#cbd5e1; font-weight:600; line-height:1.2; transition:background .18s,color .18s,box-shadow .18s; position:relative; border:none; }
    .tab-btn:not(:first-child)::before { content:''; position:absolute; left:0; top:20%; bottom:20%; width:1px; background:#475569; pointer-events:none; }
    .tab-btn:hover:not(.active) { background:#334155; }
    .tab-btn:focus-visible { outline:2px solid #3b82f6; outline-offset:2px; }
    .tab-btn.active { background:#3b82f6; color:#fff; box-shadow:0 0 0 1px #3b82f6 inset; }
    .sections { padding:0 16px 24px; }
    .section { display:none; min-height:80px; border:1px dashed #e2e8f0; border-radius:6px; padding:12px; background:#ffffff; }
    .section.active { display:block; }
  </style>
  <style>
    .ov-wrapper{max-width:100%; overflow-x:auto;}
    .ov-grid{display:grid; grid-template-columns:minmax(160px,auto) repeat(10,minmax(80px,1fr)); border:1px solid #e2e8f0;}
    .cell{padding:10px 5px; box-sizing:border-box; box-shadow:inset -1px 0 0 #e2e8f0, inset 0 -1px 0 #e2e8f0; font-family:inherit; font-size:14px; text-align:center; position:relative;}
    .rowlabel{text-align:left;}
    .head,.subhead,.colhead{font-weight:normal;}
    .marker-toggle{ margin:6px 0; font-size:12px; color:#475569; }
    .ov-grid.show-markers .cell::after{ content: attr(data-cell); position:absolute; top:2px; right:4px; font-size:10px; color:#94a3b8; pointer-events:none; }
  </style>
  <style>
    /* Top-left menu button and simple dropdown panel */
    .menu-toggle {
      position: fixed;
      top: 8px;
      left: 8px;
      z-index: 1100;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: 1px solid #d6d9e0;
      background: #fff;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .menu-toggle:hover { background: #f7f9fc; }
    .ui-menu-icon-set-hamburger-mobile {
      display:inline-block;
      width: 18px;
      height: 2px;
      background: #333;
      border-radius: 2px;
      box-shadow: 0 6px 0 0 #333, 0 -6px 0 0 #333;
    }
    .menu-panel {
      position: fixed;
      top: 44px;
      left: 8px;
      z-index: 1099;
      background: #fff;
      border: 1px solid #d6d9e0;
      border-radius: 10px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.12);
      min-width: 180px;
      padding: 6px;
      display: none;
    }
    .menu-panel.open { display: block; }
    .menu-panel a {
      display: block;
      padding: 6px 8px;
      color: #222;
      text-decoration: none;
      border-radius: 6px;
    }
    .menu-panel a:hover { background: #f4f7fb; }
    @media (min-width: 640px){
      .menu-toggle { width: 28px; height: 28px; top: 6px; left: 6px; }
      .ui-menu-icon-set-hamburger-mobile { width: 16px; }
      .menu-panel { top: 40px; min-width: 160px; }
      .menu-panel a { padding: 5px 8px; }
    }
  </style>
</head>
<body>
  <!-- Top-left menu button and dropdown -->
  <button id="menuToggle" class="menu-toggle" type="button" aria-haspopup="true" aria-expanded="false" aria-label="Abrir menu">
    <span class="ui-menu-icon-set-hamburger-mobile" aria-hidden="true"></span>
  </button>
  <nav id="pageMenu" class="menu-panel" aria-hidden="true" aria-label="Menu rápido">
    <a href="/" rel="noopener">Início (Menu)</a>
    <a href="/pages/examSetup.html?examType=pmp" rel="noopener">Simulador PMP</a>
    <a href="/pages/examSetup.html?examType=cpm" rel="noopener">Simulador CPM</a>
    <a href="/pages/results.html" rel="noopener">Resultados</a>
    <a href="#" class="page-logout">Sair</a>
  </nav>
  <h1>Indicadores</h1>
  <div class="tabs-bar">
    <div class="tabs" role="tablist" aria-label="Categorias de Indicadores">
      <button class="tab-btn active" data-tab="geral" role="tab" aria-selected="true">Visão Geral</button>
      <button class="tab-btn" data-tab="grupos" role="tab" aria-selected="false">Grupo Processos</button>
      <button class="tab-btn" data-tab="topico" role="tab" aria-selected="false">Tópico</button>
      <button class="tab-btn" data-tab="abordagem" role="tab" aria-selected="false">Abordagem</button>
    </div>
  </div>
  <div class="sections">
    <section id="sec-geral" class="section active" aria-labelledby="tab-geral">
      <div class="marker-toggle"><label><input type="checkbox" id="toggleMarkers"> Mostrar marcadores</label></div>
      <div class="ov-wrapper">
        <div class="ov-grid">
          <div class="cell rowlabel" data-cell="OV-R1C1"></div>
          <div class="cell head" data-cell="OV-R1C2-6" style="grid-column: span 5;">Últimos 15 dias</div>
          <div class="cell head" data-cell="OV-R1C7-11" style="grid-column: span 5;">Últimos&nbsp;&nbsp;&nbsp;30 dias</div>

          <div class="cell rowlabel" data-cell="OV-R2C1"></div>
          <div class="cell subhead" data-cell="OV-R2C2-4" style="grid-column: span 3;">Você</div>
          <div class="cell subhead" data-cell="OV-R2C5-6" style="grid-column: span 2;">Outros candidatos</div>
          <div class="cell subhead" data-cell="OV-R2C7-9" style="grid-column: span 3;">Você</div>
          <div class="cell subhead" data-cell="OV-R2C10-11" style="grid-column: span 2;">Outros candidatos</div>

          <div class="cell rowlabel" data-cell="OV-R3C1"></div>
          <div class="cell colhead" data-cell="OV-R3C2">Total</div>
          <div class="cell colhead" data-cell="OV-R3C3">Aprovado</div>
          <div class="cell colhead" data-cell="OV-R3C4">Reprovado</div>
          <div class="cell colhead" data-cell="OV-R3C5">Aprovado</div>
          <div class="cell colhead" data-cell="OV-R3C6">Reprovado</div>
          <div class="cell colhead" data-cell="OV-R3C7">Total</div>
          <div class="cell colhead" data-cell="OV-R3C8">Aprovado</div>
          <div class="cell colhead" data-cell="OV-R3C9">Reprovado</div>
          <div class="cell colhead" data-cell="OV-R3C10">Aprovado</div>
          <div class="cell colhead" data-cell="OV-R3C11">Reprovado</div>

          <div class="cell rowlabel" data-cell="OV-R4C1">Exames realizados</div>
          <div class="cell" data-cell="OV-R4C2" data-key="last15.you.total">&nbsp;</div>
          <div class="cell" data-cell="OV-R4C3" data-format="percent" data-key="last15.you.aprovado">&nbsp;</div>
          <div class="cell" data-cell="OV-R4C4" data-format="percent" data-key="last15.you.reprovado">&nbsp;</div>
          <div class="cell" data-cell="OV-R4C5" data-key="last15.others.aprovado">&nbsp;</div>
          <div class="cell" data-cell="OV-R4C6" data-key="last15.others.reprovado">&nbsp;</div>
          <div class="cell" data-cell="OV-R4C7" data-key="last30.you.total">&nbsp;</div>
          <div class="cell" data-cell="OV-R4C8" data-key="last30.you.aprovado">&nbsp;</div>
          <div class="cell" data-cell="OV-R4C9" data-key="last30.you.reprovado">&nbsp;</div>
          <div class="cell" data-cell="OV-R4C10" data-key="last30.others.aprovado">&nbsp;</div>
          <div class="cell" data-cell="OV-R4C11" data-key="last30.others.reprovado">&nbsp;</div>

          <div class="cell rowlabel" data-cell="OV-R5C1">Quis&nbsp;&nbsp;&nbsp;realizados</div>
          <div class="cell" data-cell="OV-R5C2" data-key="last15.you.total">&nbsp;</div>
          <div class="cell" data-cell="OV-R5C3" data-key="last15.you.aprovado">&nbsp;</div>
          <div class="cell" data-cell="OV-R5C4" data-key="last15.you.reprovado">&nbsp;</div>
          <div class="cell" data-cell="OV-R5C5" data-key="last15.others.aprovado">&nbsp;</div>
          <div class="cell" data-cell="OV-R5C6" data-key="last15.others.reprovado">&nbsp;</div>
          <div class="cell" data-cell="OV-R5C7" data-key="last30.you.total">&nbsp;</div>
          <div class="cell" data-cell="OV-R5C8" data-key="last30.you.aprovado">&nbsp;</div>
          <div class="cell" data-cell="OV-R5C9" data-key="last30.you.reprovado">&nbsp;</div>
          <div class="cell" data-cell="OV-R5C10" data-key="last30.others.aprovado">&nbsp;</div>
          <div class="cell" data-cell="OV-R5C11" data-key="last30.others.reprovado">&nbsp;</div>
        </div>
      </div>
    </section>
    <section id="sec-grupos" class="section" aria-labelledby="tab-grupos"><!-- vazio --></section>
    <section id="sec-topico" class="section" aria-labelledby="tab-topico"><!-- vazio --></section>
    <section id="sec-abordagem" class="section" aria-labelledby="tab-abordagem"><!-- vazio --></section>
  </div>
  <script>
    // Lightweight menu toggle and logout for this page
    (function initTopMenu(){
      const btn = document.getElementById('menuToggle');
      const panel = document.getElementById('pageMenu');
      if (!btn || !panel) return;
      const close = ()=>{ panel.classList.remove('open'); panel.setAttribute('aria-hidden','true'); btn.setAttribute('aria-expanded','false'); };
      const open = ()=>{ panel.classList.add('open'); panel.setAttribute('aria-hidden','false'); btn.setAttribute('aria-expanded','true'); };
      btn.addEventListener('click', (e)=>{
        e.stopPropagation();
        if (panel.classList.contains('open')) close(); else open();
      });
      document.addEventListener('click', (e)=>{
        if (!panel.contains(e.target) && e.target !== btn) close();
      });
      const logout = panel.querySelector('.page-logout');
      if (logout) logout.addEventListener('click', (e)=>{
        e.preventDefault();
        try {
          localStorage.clear();
          sessionStorage.clear();
          document.cookie = 'sessionToken=; Max-Age=0; Path=/';
        } catch(_){ }
        window.location.assign('/login');
      });
    })();

    const tabButtons = Array.from(document.querySelectorAll('.tab-btn'));
    const sectionsMap = {
      geral: document.getElementById('sec-geral'),
      grupos: document.getElementById('sec-grupos'),
      topico: document.getElementById('sec-topico'),
      abordagem: document.getElementById('sec-abordagem')
    };
    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.getAttribute('data-tab');
        tabButtons.forEach(b => { b.classList.remove('active'); b.setAttribute('aria-selected','false'); });
        btn.classList.add('active'); btn.setAttribute('aria-selected','true');
        Object.keys(sectionsMap).forEach(k => sectionsMap[k].classList.remove('active'));
        sectionsMap[tab].classList.add('active');
      });
    });
    // Simple helper to build Authorization header from localStorage (JWT)
    function getAuthHeadersLocal(){
      try {
        const tok = localStorage.getItem('jwtToken');
        const typ = localStorage.getItem('jwtTokenType') || 'Bearer';
        return tok ? { Authorization: `${typ} ${tok}` } : {};
      } catch(_) { return {}; }
    }

    // Populate overview grid from /api/indicators/overview (uses JWT if present)
    async function loadOverview(){
      const target = sectionsMap.geral;
      if (!target) return;
      try {
        const headers = { 'Accept': 'application/json', ...getAuthHeadersLocal() };
        const res = await fetch('/api/indicators/overview', { headers });
        if (res.status === 401 || res.status === 403) {
          const note = document.createElement('div');
          note.style.marginTop = '8px';
          note.style.color = '#b91c1c';
          note.textContent = 'Faça login para visualizar seus indicadores.';
          target.appendChild(note);
          return;
        }
        if (!res.ok) return;
        const data = await res.json();
        const cells = target.querySelectorAll('[data-key]');
        const getByPath = (obj, path) => path.split('.').reduce((o,k) => (o && typeof o === 'object') ? o[k] : undefined, obj);
        cells.forEach(c => {
          const key = c.getAttribute('data-key');
          const val = getByPath(data, key);
          if (typeof val !== 'undefined' && val !== null) c.textContent = String(val);
        });
      } catch(_) { /* silent */ }
    }

    // Load overview on page display
    loadOverview();

    // Load detailed overview values for specific cells
    async function loadOverviewDetailed(){
      try {
        const headers = { 'Accept': 'application/json', ...getAuthHeadersLocal() };
        const url = '/api/indicators/overview-detailed?days=30&exam_mode=full';
        const res = await fetch(url, { headers });
        if (!res.ok) return;
        const data = await res.json();
        const cells = data && data.cells ? data.cells : {};
        Object.keys(cells).forEach(code => {
          const el = document.querySelector(`[data-cell="${code}"]`);
          if (el) {
            const fmt = el.getAttribute('data-format');
            const val = cells[code];
            let text = (val === null || typeof val === 'undefined') ? '' : String(val);
            if (fmt === 'percent' && text !== '') text = `${text}%`;
            el.textContent = text;
          }
        });
      } catch(_) { /* ignore */ }
    }

    loadOverviewDetailed();

    // Toggle markers visibility on the overview grid
    (function initMarkerToggle(){
      const toggle = document.getElementById('toggleMarkers');
      const grid = document.querySelector('.ov-grid');
      if (!toggle || !grid) return;
      toggle.addEventListener('change', (e)=>{
        grid.classList.toggle('show-markers', !!e.target.checked);
      });
    })();
  </script>
</body>
</html>