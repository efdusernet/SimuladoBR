<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Notifica√ß√µes (Admin)</title>
  <link rel="stylesheet" href="../../styles.css" />
  <style>
    body{ background:#0f172a; color:#e5e7eb; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans; }
    .wrap{ max-width:900px; margin:20px auto; padding:16px; background:#111827; border:1px solid #1f2937; border-radius:10px; }
    label{ display:block; font-size:.85rem; color:#94a3b8; margin:8px 0 4px; }
    input, select, textarea{ width:100%; padding:8px; border-radius:6px; border:1px solid #1f2937; background:#0f172a; color:#e5e7eb; }
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .btn{ padding:8px 12px; border-radius:6px; border:none; cursor:pointer; font-weight:600; }
    .btn-primary{ background:#16a34a; color:#fff; }
    .btn-muted{ background:#334155; color:#e5e7eb; }
    table{ width:100%; border-collapse:collapse; margin-top:16px; }
    th,td{ padding:8px; border-bottom:1px solid #1f2937; font-size:.9rem; text-align:left; }
    th{ color:#a5b4fc; }
    .status{ font-size:.85rem; color:#93c5fd; min-height:18px; }
    :root{ --bg: #0f172a; }
  </style>
  <script src="/utils/logout.js"></script>
</head>
<body>
  <div class="wrap">
  <script src="/utils/auth.js"></script>
    <h1 style="margin:0 0 10px;">Notifica√ß√µes</h1>
    <p style="color:#94a3b8">Crie e dispare notifica√ß√µes para todos os usu√°rios ou individualmente.</p>

    <!-- Bot√µes Admin e Notifica√ß√µes movidos para canto superior esquerdo (posi√ß√£o fixa) -->
    <button id="adminMenuBtn" type="button" aria-haspopup="true" aria-expanded="false" aria-label="Menu Admin" style="position:fixed;top:12px;left:12px;z-index:2400;display:none;padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:#1e293b;color:#e5e7eb;cursor:pointer;box-shadow:0 6px 14px rgba(0,0,0,0.45);font-size:.75rem;font-weight:600;">Admin ‚ñæ</button>
    <button id="notifBellBtn" type="button" aria-label="Notifica√ß√µes" title="Notifica√ß√µes" style="position:fixed;top:12px;left:92px;z-index:2400;display:none;padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:#1e293b;color:#e5e7eb;cursor:pointer;box-shadow:0 6px 14px rgba(0,0,0,0.45);font-size:.75rem;font-weight:600;">üîî <span id="notifBadge" style="background:#ef4444;color:#fff;border-radius:999px;padding:2px 6px;margin-left:6px;font-size:.60rem;display:none">0</span></button>
    <nav id="adminMenuPanel" aria-label="A√ß√µes administrativas" aria-hidden="true" style="display:none;position:fixed;top:52px;left:12px;z-index:2401;min-width:220px;background:#1e293b;border:1px solid #334155;border-radius:10px;box-shadow:0 10px 24px rgba(0,0,0,0.55);padding:6px;">
      <a id="lnkAdminCadastrar" href="/pages/admin/questionForm.html" style="display:block;padding:6px 8px;border-radius:6px;color:#e5e7eb;text-decoration:none;font-size:.72rem;">Cadastrar quest√£o</a>
      <a id="lnkAdminBulk" href="/pages/admin/questionBulk.html" style="display:block;padding:6px 8px;border-radius:6px;color:#e5e7eb;text-decoration:none;font-size:.72rem;">Cadastrar quest√£o bulk</a>
      <a id="lnkAdminFeedbackResp" href="/pages/admin/feedbackResponses.html" style="display:block;padding:6px 8px;border-radius:6px;color:#e5e7eb;text-decoration:none;font-size:.72rem;">Responder feedbacks</a>
      <a id="lnkAdminNotifications" href="/pages/admin/notifications.html" style="display:block;padding:6px 8px;border-radius:6px;color:#e5e7eb;text-decoration:none;font-size:.72rem;background:#334155;">Notifica√ß√µes</a>
      <button id="btnAdminFixture" type="button" style="display:block;width:100%;text-align:left;padding:6px 8px;border:0;background:#0d9488;color:#fff;font-size:.72rem;border-radius:6px;cursor:pointer;margin-top:4px;">Gerar tentativa fixture</button>
      <button id="btnAdminReconcile" type="button" style="display:block;width:100%;text-align:left;padding:6px 8px;border:0;background:#16a34a;color:#fff;font-size:.72rem;border-radius:6px;cursor:pointer;margin-top:4px;">Reconciliar estat√≠sticas</button>
      <button id="btnAdminPurge" type="button" style="display:block;width:100%;text-align:left;padding:6px 8px;border:0;background:#b91c1c;color:#fff;font-size:.72rem;border-radius:6px;cursor:pointer;margin-top:4px;">Expurgar tentativas abandonadas</button>
      <button id="btnAdminMarkAbandoned" type="button" style="display:block;width:100%;text-align:left;padding:6px 8px;border:0;background:#dc2626;color:#fff;font-size:.72rem;border-radius:6px;cursor:pointer;margin-top:4px;">Marcar abandonadas (inatividade)</button>
      <button id="btnAdminLogout" type="button" style="display:block;width:100%;text-align:left;padding:6px 8px;border:0;background:#f1f5f9;color:#334155;font-size:.72rem;border-radius:6px;cursor:pointer;margin-top:6px;">Sair</button>
    </nav>
    <!-- Legacy panel (kept for backward compatibility, no longer used) -->
    <div id="notifPanel" aria-hidden="true" style="display:none;position:fixed;top:52px;left:92px;z-index:2401;min-width:260px;background:#1e293b;border:1px solid #334155;border-radius:10px;box-shadow:0 10px 24px rgba(0,0,0,0.55);padding:8px;max-height:320px;overflow:auto"></div>

    <!-- Readable notifications modal (centered) -->
    <div id="notifModalOverlay" aria-hidden="true" style="display:none;position:fixed;inset:0;z-index:5000;background:rgba(15,23,42,.65);padding:16px;">
      <div id="notifModal" role="dialog" aria-modal="true" aria-labelledby="notifModalTitle" style="max-width:820px;width:100%;margin:6vh auto 0 auto;background:#0b1220;border:1px solid rgba(148,163,184,.25);border-radius:14px;box-shadow:0 24px 70px rgba(0,0,0,.55);overflow:hidden;">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 14px;border-bottom:1px solid rgba(148,163,184,.25);">
          <div style="display:flex;align-items:center;gap:10px;min-width:0;">
            <div style="font-weight:800;color:#e5e7eb">üîî</div>
            <div id="notifModalTitle" style="font-weight:800;color:#e5e7eb;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">Notifica√ß√µes</div>
            <div id="notifModalMeta" style="font-size:.82rem;color:#94a3b8"></div>
          </div>
          <div style="display:flex;align-items:center;gap:8px;">
            <button id="notifModalRefresh" type="button" style="border:1px solid rgba(148,163,184,.35);background:#111827;color:#e5e7eb;border-radius:10px;padding:8px 10px;font-size:.85rem;cursor:pointer">Atualizar</button>
            <button id="notifModalClose" type="button" aria-label="Fechar" style="border:1px solid rgba(148,163,184,.35);background:#0f172a;color:#e5e7eb;border-radius:10px;padding:8px 10px;font-size:.85rem;cursor:pointer">Fechar</button>
          </div>
        </div>
        <div id="notifModalBody" style="padding:10px 14px;max-height:68vh;overflow:auto;">
          <div id="notifModalStatus" style="font-size:.9rem;color:#94a3b8;padding:8px 0;"></div>
          <div id="notifModalList" style="display:flex;flex-direction:column;gap:10px;"></div>
        </div>
      </div>
    </div>

    <div id="status" class="status"></div>

    <form id="notifForm" style="display:grid; gap:12px; margin-bottom:16px;">
      <div class="row">
        <div>
          <label for="categoria">Categoria</label>
          <select id="categoria">
            <option value="Promocoes">Promo√ß√µes</option>
            <option value="Avisos">Avisos</option>
            <option value="Alertas">Alertas</option>
          </select>
        </div>
        <div>
          <label for="alcance">Alcance</label>
          <select id="alcance">
            <option value="all">Todos</option>
            <option value="user">Usu√°rio espec√≠fico</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div>
          <label for="titulo">T√≠tulo</label>
          <input id="titulo" type="text" maxlength="200" placeholder="T√≠tulo da notifica√ß√£o" />
        </div>
        <div>
          <label for="userSelect">Usu√°rio (se espec√≠fico)</label>
          <select id="userSelect" size="8" disabled>
            <option value="">Selecione um usu√°rio...</option>
          </select>
        </div>
      </div>
      <div>
        <label for="mensagem">Mensagem</label>
        <textarea id="mensagem" rows="4" placeholder="Conte√∫do da notifica√ß√£o"></textarea>
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button id="btnSalvar" type="button" class="btn btn-muted">Salvar rascunho</button>
        <button id="btnDisparar" type="button" class="btn btn-primary">Disparar</button>
      </div>
    </form>

    <table aria-label="Notifica√ß√µes recentes">
      <thead>
        <tr>
          <th>ID</th>
          <th>Categoria</th>
          <th>T√≠tulo</th>
          <th>Alvo</th>
          <th>Status</th>
          <th>Enviadas/Lidas</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>

  <div id="bottomNavMount"></div>
  <div id="toast" aria-live="polite" style="display:none;position:fixed;right:16px;bottom:16px;z-index:2500;background:#16a34a;color:#fff;padding:10px 14px;border-radius:8px;box-shadow:0 8px 18px rgba(0,0,0,0.45);font-size:.85rem;">
    Mensagem enviada com sucesso
  </div>

  <script>
    (function(){
      function showToast(text){
        const el = document.getElementById('toast');
        if (!el) return;
        el.textContent = text || 'Mensagem enviada com sucesso';
        el.style.display = 'block';
        clearTimeout(showToast._t);
        showToast._t = setTimeout(()=>{ el.style.display='none'; }, 2500);
      }
      // Constr√≥i cabe√ßalhos de autoriza√ß√£o replicando a l√≥gica do index.html (usa nomeUsuario como fallback)
      function headers(){
        const h = (() => {
          try {
            if (window.Auth && typeof window.Auth.getAuthHeaders === 'function') {
              return window.Auth.getAuthHeaders({ contentType: 'application/json' });
            }
          } catch(_){ }
          return { 'Content-Type': 'application/json' };
        })();

        const jwtTok = (localStorage.getItem('jwtToken')||'').trim();
        const jwtType = (localStorage.getItem('jwtTokenType')||'Bearer').trim()||'Bearer';
        const lsSession = (localStorage.getItem('sessionToken')||'').trim();
        const nomeUsuario = (localStorage.getItem('nomeUsuario')||'').trim();
        // Fallback: tentar extrair sessionToken/JWT da query string (caso abrimos a p√°gina via link compartilhado)
        const urlParams = new URLSearchParams(window.location.search);
        const qpSession = (urlParams.get('sessionToken')||'').trim();
        // Se query param parece um JWT, preferir para Authorization
        const jwtRegex = /^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+$/;

        // Authorization: query param JWT wins when local JWT is absent
        if (!jwtTok && jwtRegex.test(qpSession)) {
          h['Authorization'] = jwtType + ' ' + qpSession;
        } else if (jwtTok) {
          h['Authorization'] = jwtType + ' ' + jwtTok;
        }

        // Identidade para X-Session-Token: nomeUsuario > session localStorage > query param
        // (preserve legacy behavior for shared links)
        const identity = nomeUsuario || lsSession || (jwtRegex.test(qpSession)? '' : qpSession);
        if (identity) h['X-Session-Token'] = identity;
        return h;
      }
      async function loadList(){
        const rows = document.getElementById('rows');
        const status = document.getElementById('status');
        status.textContent = 'Carregando...';
        try{
          const r = await fetch('/api/admin/notifications', { headers: headers() });
          if (!r.ok){
            let msg='Falha ao carregar';
            try { const d=await r.json(); if (d && d.message) msg += ' ('+d.message+')'; } catch(_){}
            status.textContent = msg;
            return;
          }
          const list = await r.json();
          rows.innerHTML = '';
          if (!Array.isArray(list) || !list.length){ rows.innerHTML = '<tr><td colspan="6">Nenhuma notifica√ß√£o.</td></tr>'; status.textContent=''; return; }
          const frag = document.createDocumentFragment();
          for (const it of list){
            const tr = document.createElement('tr');
            const alvo = it.targetType === 'user' ? (it.targetUser && it.targetUser.display ? it.targetUser.display : ('user #' + (it.targetUserId||''))) : 'Todos';
            tr.innerHTML = `<td>${it.id}</td><td>${it.categoria}</td><td>${it.titulo}</td><td>${alvo}</td><td>${it.status}</td><td data-stats="${it.id}">‚Äî</td>`;
            frag.appendChild(tr);
            // Fetch stats
            try {
              const rs = await fetch('/api/admin/notifications/' + it.id, { headers: headers() });
              if (rs.ok){ const d = await rs.json(); const td = rows.querySelector(`td[data-stats="${it.id}"]`); if (td){ td.textContent = `${d.stats.total} / ${d.stats.read}`; } }
              else {
                const td = rows.querySelector(`td[data-stats="${it.id}"]`);
                if (td) td.textContent='erro';
              }
            } catch(_){ const td = rows.querySelector(`td[data-stats="${it.id}"]`); if (td) td.textContent='erro'; }
          }
          rows.appendChild(frag);
          status.textContent = '';
        } catch(e){ status.textContent = 'Erro ao carregar ('+(e && e.message? e.message : 'desconhecido')+')'; }
      }
      async function salvar(){
        const categoria = document.getElementById('categoria').value;
        const alcance = document.getElementById('alcance').value;
        const titulo = document.getElementById('titulo').value.trim();
        const mensagem = document.getElementById('mensagem').value.trim();
        const sel = document.getElementById('userSelect');
        const selectedId = Number((sel.value||'').trim());
        if (!categoria || !titulo || !mensagem){ alert('Preencha categoria, t√≠tulo e mensagem.'); return; }
        if (alcance === 'user' && (!Number.isInteger(selectedId) || selectedId <= 0)){ alert('Selecione um usu√°rio v√°lido.'); return; }
        try {
          if (alcance === 'user'){
            const body = { categoria, titulo, mensagem, targetType: 'user', targetUserId: selectedId };
            const r = await fetch('/api/admin/notifications', { method:'POST', headers: headers(), body: JSON.stringify(body) });
            if (!r.ok){ const d = await r.json().catch(()=>({})); alert('Falha ao salvar: ' + (d.error||r.statusText)); return; }
          } else {
            const body = { categoria, titulo, mensagem, targetType: 'all' };
            const r = await fetch('/api/admin/notifications', { method:'POST', headers: headers(), body: JSON.stringify(body) });
            if (!r.ok){ const d = await r.json().catch(()=>({})); alert('Falha: ' + (d.error||r.statusText)); return; }
            alert('Rascunho salvo');
          }
          loadList();
        } catch(e){ alert('Erro: '+ e); }
      }
      async function disparar(){
        const status = document.getElementById('status');
        status.textContent='Disparando...';
        try{
          // Create draft then send last created matching title (simplify UX for MVP)
          const categoria = document.getElementById('categoria').value;
          const alcance = document.getElementById('alcance').value;
          const titulo = document.getElementById('titulo').value.trim();
          const mensagem = document.getElementById('mensagem').value.trim();
          const sel = document.getElementById('userSelect');
          const selectedId = Number((sel.value||'').trim());
          if (!categoria || !titulo || !mensagem){ alert('Preencha categoria, t√≠tulo e mensagem.'); status.textContent=''; return; }
          if (alcance === 'user' && (!Number.isInteger(selectedId) || selectedId <= 0)){ alert('Selecione um usu√°rio v√°lido.'); status.textContent=''; return; }
          if (alcance === 'user'){
            const body = { categoria, titulo, mensagem, targetType: 'user', targetUserId: selectedId };
            const r1 = await fetch('/api/admin/notifications', { method:'POST', headers: headers(), body: JSON.stringify(body) });
            const created = await r1.json().catch(()=>null);
            if (!r1.ok || !created || !created.id){ status.textContent=''; return; }
            const r2 = await fetch(`/api/admin/notifications/${created.id}/send`, { method:'POST', headers: headers() });
            if (r2.ok) showToast('Mensagem enviada com sucesso');
          } else {
            const body = { categoria, titulo, mensagem, targetType: 'all' };
            const r1 = await fetch('/api/admin/notifications', { method:'POST', headers: headers(), body: JSON.stringify(body) });
            const created = await r1.json();
            if (!r1.ok){ alert('Falha ao salvar: ' + (created.error||r1.statusText)); status.textContent=''; return; }
            const r2 = await fetch(`/api/admin/notifications/${created.id}/send`, { method:'POST', headers: headers() });
            const sent = await r2.json();
            if (!r2.ok){ alert('Falha ao disparar: ' + (sent.error||r2.statusText)); status.textContent=''; return; }
            showToast('Mensagem enviada com sucesso');
          }
          status.textContent='';
          loadList();
        } catch(e){ alert('Erro: ' + e); status.textContent=''; }
      }
      document.getElementById('btnSalvar').addEventListener('click', salvar);
      document.getElementById('btnDisparar').addEventListener('click', disparar);
      // Carrega usu√°rios para o select quando alcance = user
      (function initUsersSelect(){
        const sel = document.getElementById('userSelect');
        const alcanceEl = document.getElementById('alcance');
        async function loadUsers(){
          try {
            const r = await fetch('/api/admin/users?limit=500', { headers: headers() });
            if (!r.ok) return;
            const list = await r.json();
            sel.innerHTML = '<option value="">Selecione um usu√°rio...</option>';
            if (Array.isArray(list)){
              list.forEach(u => {
                const id = u.Id || u.id;
                const nome = (u.Nome || '').trim() || (u.NomeUsuario || '').trim() || ('ID ' + id);
                const opt = document.createElement('option');
                opt.value = String(id);
                opt.textContent = `${nome} - ${id}`;
                sel.appendChild(opt);
              });
            }
          } catch(_){ /* ignore */ }
        }
        function toggle(){
          const isUser = alcanceEl.value === 'user';
          sel.disabled = !isUser;
          if (isUser && sel.options.length <= 1) loadUsers();
        }
        alcanceEl.addEventListener('change', toggle);
        toggle();
      })();
      loadList();
    })();
  </script>
  <script>
  // Inicializa menu admin (detec√ß√£o via endpoint e montagem simples)
  (function initAdminMenu(){
    const btn = document.getElementById('adminMenuBtn');
    const panel = document.getElementById('adminMenuPanel');
    if (!btn || !panel) return;
    const token = (localStorage.getItem('sessionToken')||'').trim();
    const nomeUsuario = (localStorage.getItem('nomeUsuario')||'').trim();
    const identity = token || nomeUsuario;
    if (!identity) return;
    const jwtTok = (localStorage.getItem('jwtToken')||'').trim();
    const jwtType = (localStorage.getItem('jwtTokenType')||'Bearer').trim()||'Bearer';
    const headers = {}; if (identity) headers['X-Session-Token'] = identity; if (jwtTok) headers['Authorization'] = jwtType + ' ' + jwtTok;
    fetch('/api/admin/exams/probe', { headers }).then(r => {
      if (!r.ok) return; // n√£o admin
      btn.style.display='inline-flex';
      function close(){ panel.style.display='none'; panel.setAttribute('aria-hidden','true'); btn.setAttribute('aria-expanded','false'); }
      function open(){ panel.style.display='block'; panel.setAttribute('aria-hidden','false'); btn.setAttribute('aria-expanded','true'); }
      btn.addEventListener('click', e => { e.stopPropagation(); if (panel.style.display==='block') close(); else open(); });
      document.addEventListener('click', e => { if (!panel.contains(e.target) && e.target !== btn) close(); });
      // Fun√ß√£o auxiliar para POST admin
      async function adminPost(path){
        const jwtTok2 = (localStorage.getItem('jwtToken')||'').trim();
        const jwtType2 = (localStorage.getItem('jwtTokenType')||'Bearer').trim()||'Bearer';
        const nomeUsuario2 = (localStorage.getItem('nomeUsuario')||'').trim();
        const token2 = (localStorage.getItem('sessionToken')||'').trim();
        const identity2 = token2 || nomeUsuario2;
        const h = { 'Content-Type':'application/json' };
        if (identity2) h['X-Session-Token'] = identity2;
        if (jwtTok2) h['Authorization'] = `${jwtType2} ${jwtTok2}`;
        const resp = await fetch(path,{method:'POST',headers:h});
        const data = await resp.json().catch(()=>({}));
        return { ok: resp.ok, status: resp.status, data };
      }
      // Bot√µes avan√ßados
      const purgeBtn = document.getElementById('btnAdminPurge');
      const markBtn = document.getElementById('btnAdminMarkAbandoned');
      const reconcileBtn = document.getElementById('btnAdminReconcile');
      const fixtureBtn = document.getElementById('btnAdminFixture');
      const logoutBtn = document.getElementById('btnAdminLogout');
      if (purgeBtn){
        purgeBtn.addEventListener('click', async ()=>{
          if (!confirm('Confirma expurgo de tentativas abandonadas?')) return;
          purgeBtn.disabled=true; purgeBtn.textContent='Expurgando...';
          try { const r = await adminPost('/api/admin/exams/purge-abandoned'); alert(r.ok?`Expurgo: ${r.data.purged} purgadas (inspecionadas ${r.data.inspected}).`:`Falhou (${r.status}).`); }
          catch(e){ alert('Erro: '+e); }
          purgeBtn.disabled=false; purgeBtn.textContent='Expurgar tentativas abandonadas';
        });
      }
      if (markBtn){
        markBtn.addEventListener('click', async ()=>{
          if (!confirm('Executar marca√ß√£o de tentativas abandonadas por inatividade?')) return;
          markBtn.disabled=true; markBtn.textContent='Marcando...';
          try { const r = await adminPost('/api/admin/exams/mark-abandoned'); alert(r.ok?`Marcadas: timeout=${r.data.markedTimeout}, lowProgress=${r.data.markedLowProgress} (processadas ${r.data.processed}).`:`Falhou (${r.status}).`); }
          catch(e){ alert('Erro: '+e); }
          markBtn.disabled=false; markBtn.textContent='Marcar abandonadas (inatividade)';
        });
      }
      if (reconcileBtn){
        reconcileBtn.addEventListener('click', ()=>{
          alert('A reconcilia√ß√£o completa est√° dispon√≠vel na p√°gina principal (index).');
        });
      }
      if (fixtureBtn){
        fixtureBtn.addEventListener('click', ()=>{
          alert('Gerar fixture: use ferramenta completa em index.html (Admin Modal).');
        });
      }
      if (logoutBtn){ logoutBtn.addEventListener('click', () => { if (window.performLogout) { window.performLogout({ confirm: false, showNotification: false }); } else { try{ localStorage.clear(); sessionStorage.clear(); document.cookie='sessionToken=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT;'; }catch(_){} window.location.href='/login.html'; } }); }
    }).catch(()=>{});
  })();
  // Sino de notifica√ß√µes reutilizando endpoint de unread-count e lista
  (function initBell(){
    const btn = document.getElementById('notifBellBtn');
    const badge = document.getElementById('notifBadge');
    const overlay = document.getElementById('notifModalOverlay');
    const modal = document.getElementById('notifModal');
    const closeBtn = document.getElementById('notifModalClose');
    const refreshBtn = document.getElementById('notifModalRefresh');
    const metaEl = document.getElementById('notifModalMeta');
    const statusEl = document.getElementById('notifModalStatus');
    const listEl = document.getElementById('notifModalList');
    if (!btn || !badge || !overlay || !modal || !closeBtn || !refreshBtn || !metaEl || !statusEl || !listEl) return;
    const token = (localStorage.getItem('sessionToken')||'').trim();
    if (!token) return;
    const jwtTok = (localStorage.getItem('jwtToken')||'').trim();
    const jwtType = (localStorage.getItem('jwtTokenType')||'Bearer').trim()||'Bearer';
    const headers = { 'X-Session-Token': token }; if (jwtTok) headers['Authorization'] = jwtType + ' ' + jwtTok;

    function isOpen(){ return overlay.style.display === 'block'; }
    function openModal(){
      overlay.style.display = 'block';
      overlay.setAttribute('aria-hidden', 'false');
      btn.setAttribute('aria-expanded', 'true');
      try { closeBtn.focus(); } catch(_){ }
    }
    function closeModal(){
      overlay.style.display = 'none';
      overlay.setAttribute('aria-hidden', 'true');
      btn.setAttribute('aria-expanded', 'false');
    }
    function escapeHtml(s){
      return String(s ?? '').replace(/[&<>"']/g, (c) => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
    }
    function renderList(list){
      listEl.innerHTML = '';
      if (!Array.isArray(list) || !list.length){
        statusEl.textContent = 'Sem notifica√ß√µes.';
        return;
      }
      statusEl.textContent = '';
      for (const it of list){
        const id = it && it.id;
        const cat = it && (it.categoria || it.Categoria) || '';
        const title = it && (it.titulo || it.Titulo) || '';
        const msg = it && (it.mensagem || it.Mensagem) || '';
        const createdAt = it && (it.createdAt || it.CreatedAt || it.dataCriacao || it.DataCriacao) || null;
        const read = !!(it && it.readAt);

        let createdLabel = '';
        try {
          if (createdAt) {
            const dt = new Date(createdAt);
            if (!Number.isNaN(dt.getTime())) createdLabel = dt.toLocaleString('pt-BR');
          }
        } catch(_){ }

        const card = document.createElement('div');
        card.style.cssText = `border:1px solid ${read ? 'rgba(148,163,184,.25)' : 'rgba(34,197,94,.55)'};background:${read ? '#0b1220' : '#052e16'};border-radius:12px;padding:10px 10px;`;
        card.innerHTML = `
          <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;">
            <div style="min-width:0;">
              <div style="font-weight:800;color:#e5e7eb;line-height:1.2;word-break:break-word">${escapeHtml(title)}</div>
              <div style="margin-top:4px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
                ${cat ? `<span style=\"font-size:.78rem;color:#cbd5e1;background:rgba(148,163,184,.12);border:1px solid rgba(148,163,184,.25);border-radius:999px;padding:2px 8px\">${escapeHtml(cat)}</span>` : ''}
                ${createdLabel ? `<span style=\"font-size:.78rem;color:#94a3b8\">${escapeHtml(createdLabel)}</span>` : ''}
                ${read ? `<span style=\"font-size:.78rem;color:#94a3b8\">Lida</span>` : `<span style=\"font-size:.78rem;color:#86efac\">Nova</span>`}
              </div>
            </div>
            <div style="flex:0 0 auto;display:flex;gap:8px;">
              <button data-id="${escapeHtml(id)}" class="notif-mark-read" style="background:${read?'#334155':'#16a34a'};color:${read?'#e2e8f0':'#fff'};border:none;border-radius:10px;padding:8px 10px;font-size:.82rem;cursor:pointer">${read?'Lida':'Marcar como lida'}</button>
            </div>
          </div>
          <div style="margin-top:10px;font-size:.92rem;color:#e2e8f0;white-space:pre-wrap;word-break:break-word;line-height:1.45">${escapeHtml(msg)}</div>
        `;
        listEl.appendChild(card);
      }
      listEl.querySelectorAll('button.notif-mark-read').forEach((btnEl) => {
        btnEl.addEventListener('click', async (e) => {
          e.preventDefault();
          e.stopPropagation();
          const id = e.currentTarget.getAttribute('data-id');
          if (!id) return;
          try {
            const rr = await fetch(`/api/notifications/${encodeURIComponent(String(id))}/read`, { method: 'POST', headers });
            if (rr.ok){
              await refreshCount();
              await loadList();
            }
          } catch(_){ }
        });
      });
    }

    async function refreshCount(){
      try{
        const r = await fetch('/api/notifications/unread-count', { headers });
        if(!r.ok) return;
        const d = await r.json();
        const c = Number(d.count)||0;
        if(c>0){ badge.textContent=String(c); badge.style.display='inline-block'; } else { badge.style.display='none'; }
        btn.style.display='inline-flex';
      }catch(_){}
    }
    async function loadList(){
      try{
        statusEl.textContent = 'Carregando...';
        metaEl.textContent = '';
        const r = await fetch('/api/notifications?limit=50', { headers });
        if(!r.ok){ statusEl.textContent = `Falha ao carregar (HTTP ${r.status}).`; return; }
        const list = await r.json();
        const unread = Array.isArray(list) ? list.filter(x => x && !x.readAt).length : 0;
        metaEl.textContent = Array.isArray(list) ? `${unread} n√£o lida(s) ‚Ä¢ ${list.length} carregada(s)` : '';
        renderList(list);
      }catch(_){ statusEl.textContent = 'Falha ao carregar.'; }
    }

    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      e.stopPropagation();
      if (isOpen()) { closeModal(); return; }
      await refreshCount();
      await loadList();
      openModal();
    });
    closeBtn.addEventListener('click', (e)=>{ e.preventDefault(); closeModal(); });
    refreshBtn.addEventListener('click', async (e)=>{ e.preventDefault(); await refreshCount(); await loadList(); });
    overlay.addEventListener('click', (e)=>{ if (e.target === overlay) closeModal(); });
    document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && isOpen()) closeModal(); });

    refreshCount(); setInterval(refreshCount, 90000);
  })();
  </script>
  <script>
  // Carrega componente de navega√ß√£o inferior reutiliz√°vel
  (function loadBottomNav(){
    async function mount(){
      try {
        const resp = await fetch('/components/bottomNav.html', { cache: 'no-store' });
        if(!resp.ok) return;
        const html = await resp.text();
        const mountEl = document.getElementById('bottomNavMount');
        if(mountEl){
          mountEl.innerHTML = html;
          try {
            const scripts = Array.from(mountEl.querySelectorAll('script'));
            scripts.forEach(old => {
              const s = document.createElement('script');
              if(old.src) s.src = old.src; else s.textContent = old.textContent || '';
              old.parentNode.removeChild(old);
              mountEl.appendChild(s);
            });
          } catch(_){ }
        }
      } catch(_){}
    }
    if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', mount); else mount();
  })();
  </script>
</body>
</html>
