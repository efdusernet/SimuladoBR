<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Planos do Produto (Admin)</title>
  <script src="/utils/logger.js"></script>
  <script src="/utils/auth.js"></script>
  <script src="/utils/csrf.js"></script>
  <script src="/utils/logout.js"></script>
  <link rel="stylesheet" href="../../styles.css" />
  <style>
    body{ background:#0b1220; color:#e5e7eb; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans; }
    .wrap{ max-width:1300px; margin:18px auto; padding:16px; background:#0f172a; border:1px solid #1f2937; border-radius:12px; }
    .topbar{ display:flex; align-items:flex-end; justify-content:space-between; gap: 12px; flex-wrap: wrap; }
    .topbar h1{ margin:0; font-size:1.15rem; }
    .muted{ color:#94a3b8; }
    .small{ font-size:.85rem; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .btn{ padding:8px 12px; border-radius:8px; border:1px solid #1f2937; background:#111827; color:#e5e7eb; cursor:pointer; font-weight:700; }
    .btn:hover{ border-color:#334155; }
    .btn-primary{ background:#16a34a; border-color:#15803d; }
    .btn-danger{ background:#b91c1c; border-color:#7f1d1d; }
    .btn-warn{ background:#f59e0b; border-color:#b45309; color:#111827; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .grid{ display:grid; grid-template-columns: 420px 1fr; gap: 14px; margin-top: 14px; }
    .card{ background:#0b1220; border:1px solid #1f2937; border-radius:12px; padding:12px; }

    label{ display:block; font-size:.82rem; color:#a3b2c5; margin:10px 0 6px; }
    select,input,textarea{ width:100%; padding:8px 10px; border-radius:8px; border:1px solid #1f2937; background:#0f172a; color:#e5e7eb; }
    textarea{ min-height: 110px; resize: vertical; }

    .row{ display:flex; gap:8px; }
    .row > * { flex: 1; }

    .list{ display:grid; gap:10px; }
    .item{ border:1px solid #1f2937; background:#0f172a; border-radius:12px; padding:10px; }
    .itemHead{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
    .itemTitle{ font-weight:900; }
    .pill{ display:inline-flex; align-items:center; gap:8px; border:1px solid #1f2937; background:#0b1220; padding:6px 10px; border-radius:999px; color:#cbd5e1; font-size:.78rem; }
    .pill.ok{ border-color: rgba(34,197,94,0.35); color:#bbf7d0; }
    .pill.off{ border-color: rgba(239,68,68,0.35); color:#fecaca; }
    .actions{ display:flex; gap:8px; flex-wrap: wrap; margin-top: 10px; }

    .status{ min-height: 18px; margin-top: 10px; color:#93c5fd; }
    .status.error{ color:#fecaca; }

    /* --- Preview (marketing card style from /#planos) --- */
    .previewPanel{ border:1px solid #1f2937; border-radius:12px; padding:12px; background:#0b1220; margin-top:14px; }
    .previewPanel h2{ margin:0 0 6px; font-size:1rem; }
    .previewPanel .previewHint{ color:#94a3b8; font-size:.85rem; }
    .previewControls{ display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-top:8px; }
    .previewControls .left{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .previewControls label{ display:inline-flex; align-items:center; gap:8px; color:#cbd5e1; font-size:.9rem; }
    .previewControls select{ background:#0f172a; color:#e5e7eb; border:1px solid #334155; border-radius:10px; padding:8px 10px; }
    .previewStage{ margin-top:10px; padding:22px 18px 34px; min-height: 560px; overflow: visible; border-radius:14px; border:1px solid rgba(148,163,184,0.22);
      background: radial-gradient(700px 380px at 10% 20%, rgba(37, 99, 235, 0.14), transparent 62%),
                  radial-gradient(700px 380px at 95% 0%, rgba(124, 58, 237, 0.12), transparent 62%),
                  rgba(255, 255, 255, 0.86);
    }
    .previewGrid{ display:grid; gap:14px; align-items:stretch; justify-content:center; grid-template-columns: 1fr; }
    @media (min-width: 980px){
      .previewGrid--2{ grid-template-columns: repeat(2, minmax(280px, 420px)); }
      .previewGrid--3{ grid-template-columns: repeat(3, minmax(260px, 420px)); }
    }
    .previewGridTitle{ font-weight:900; color: rgba(15, 23, 42, 0.76); text-transform:uppercase; letter-spacing:.08em; font-size:.72rem; margin: 2px 2px 8px; }
    .previewStage .pricing-card{ height:100%; border-radius:16px; border:1px solid rgba(15, 23, 42, 0.10); background:#fff; box-shadow: 0 16px 40px rgba(2, 6, 23, 0.10); display:flex; flex-direction:column; padding:12px; overflow:hidden; position:relative; max-width: 380px; margin: 0 auto; }
    .previewStage .pricing-card--featured{ border-color: rgba(37, 99, 235, 0.55); box-shadow: 0 22px 60px rgba(37, 99, 235, 0.18); }
    .previewStage .pricing-top{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px; }
    .previewStage .plan-tag{ display:inline-flex; align-items:center; gap:6px; padding:5px 9px; border-radius:999px; font-size:.68rem; font-weight:800; letter-spacing:.04em; text-transform:uppercase; border:1px solid rgba(15, 23, 42, 0.08); background: rgba(248, 250, 252, 0.9); color: rgba(15, 23, 42, 0.78); white-space:nowrap; }
    .previewStage .plan-tag--success{ background: rgba(34, 197, 94, 0.12); border-color: rgba(34, 197, 94, 0.28); color:#166534; }
    .previewStage .plan-tag--info{ background: rgba(37, 99, 235, 0.10); border-color: rgba(37, 99, 235, 0.28); color:#1d4ed8; }
    .previewStage .plan-tag--brand{ background: rgba(59, 130, 246, 0.10); border-color: rgba(59, 130, 246, 0.26); color:#1d4ed8; }
    .previewStage .plan-tag--purple{ background: rgba(124, 58, 237, 0.10); border-color: rgba(124, 58, 237, 0.26); color:#6d28d9; }
    .previewStage .plan-tag--featured{ background: rgba(249, 115, 22, 0.12); border-color: rgba(249, 115, 22, 0.30); color:#c2410c; }
    .previewStage .plan-badge{ display:inline-flex; align-items:center; justify-content:center; padding:5px 9px; border-radius:999px; font-size:.68rem; font-weight:900; letter-spacing:.02em; color:#fff; background: linear-gradient(90deg, #fb923c, #f97316); border:1px solid rgba(249, 115, 22, 0.35); white-space:nowrap; }
    .previewStage .pricing-main{ padding: 4px 6px 0; text-align:center; }
    .previewStage .plan-name{ font-weight:900; font-size:1.08rem; letter-spacing:-0.01em; color:#0f172a; }
    .previewStage .plan-price{ margin-top:8px; }
    .previewStage .plan-price-main{ font-weight:900; font-size:1.75rem; letter-spacing:-0.03em; color:#1d4ed8; }
    .previewStage [data-plan-id="start"] .plan-price-main{ color:#166534; }
    .previewStage .plan-installments{ margin-top:2px; font-size:.8rem; color: rgba(15, 23, 42, 0.62); min-height:18px; }
    .previewStage .plan-chip{ display:inline-flex; align-items:center; justify-content:center; margin-top:7px; padding:6px 9px; border-radius:999px; border:1px solid rgba(15, 23, 42, 0.08); background: rgba(248, 250, 252, 0.9); font-size:.75rem; color: rgba(15, 23, 42, 0.70); }
    .previewStage .plan-features{ list-style:none; padding-left:0; margin:8px 0 0; display:grid; gap:6px; text-align:left; font-size:.90rem; }
    .previewStage .plan-check{ display:inline-grid; place-items:center; width:20px; height:20px; border-radius:7px; margin-right:8px; background: rgba(37, 99, 235, 0.10); color:#1d4ed8; font-weight:900; font-size:.85rem; }
    .previewStage [data-plan-id="start"] .plan-check{ background: rgba(34, 197, 94, 0.14); color:#16a34a; }
    .previewStage .pricing-cta{ margin-top:auto; padding:10px 6px 0; }
    .previewStage .btn-plan{ width:100%; border-radius:13px; padding:10px 12px; font-weight:900; border:1px solid rgba(15, 23, 42, 0.10); cursor:pointer; }
    .previewStage .btn-plan--success{ background: linear-gradient(90deg, #16a34a, #22c55e); color:#fff; border-color: rgba(22, 163, 74, 0.35); }
    .previewStage .btn-plan--info{ background: linear-gradient(90deg, #2563eb, #3b82f6); color:#fff; border-color: rgba(37, 99, 235, 0.35); }
    .previewStage .btn-plan--brand{ background: linear-gradient(90deg, #2563eb, #4f46e5); color:#fff; border-color: rgba(37, 99, 235, 0.35); }
    .previewStage .btn-plan--purple{ background: linear-gradient(90deg, #7c3aed, #9333ea); color:#fff; border-color: rgba(124, 58, 237, 0.35); }
    .previewStage .btn-plan--featured{ background: linear-gradient(90deg, #3b82f6, #8b5cf6); color:#fff; border-color: rgba(59, 130, 246, 0.35); }
    .previewStage .btn-plan:hover{ filter: brightness(0.98); }
    .previewStage .plan-footnote{ margin-top:6px; font-size:.74rem; color: rgba(15, 23, 42, 0.60); text-align:center; }

    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>Planos do Produto (Admin)</h1>
        <div class="muted small">Gerencie os cards de planos/benefícios exibidos na Home do marketing. Salva via <span class="mono">/api/admin/product-plans</span> (CSRF automático).</div>
      </div>
      <div style="display:flex; gap:8px; align-items:end;">
        <button id="btnHome" class="btn">Home</button>
        <button id="btnLogout" class="btn btn-danger">Sair</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button id="btnReload" class="btn">Recarregar</button>
          <button id="btnSeed" class="btn btn-warn">Gerar arquivo com planos atuais</button>
          <button id="btnNew" class="btn btn-primary">Novo plano</button>
        </div>

        <div class="status" id="status"></div>

        <div class="list" id="list" style="margin-top:12px;"></div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 6px; font-size:1rem;">Editar plano</h2>
        <div class="muted small">IDs aceitam <span class="mono">a-z0-9-</span>. Para mudar o ID, crie um novo plano e apague o antigo.</div>

        <label for="inpId">ID</label>
        <input id="inpId" placeholder="ex: pro-90" />

        <label for="inpName">Nome</label>
        <input id="inpName" placeholder="ex: PRO 90 dias" />

        <label for="inpDesc">Descrição (opcional)</label>
        <input id="inpDesc" placeholder="ex: Acesso completo por 90 dias" />

        <div class="row">
          <div>
            <label for="inpPrice">Preço (R$)</label>
            <input id="inpPrice" inputmode="decimal" placeholder="ex: 396" />
          </div>
          <div>
            <label for="inpDays">Acesso (dias)</label>
            <input id="inpDays" inputmode="numeric" placeholder="ex: 90" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="selActive">Ativo</label>
            <select id="selActive">
              <option value="1">Sim</option>
              <option value="0">Não</option>
            </select>
          </div>
          <div>
            <label for="selFree">Grátis</label>
            <select id="selFree">
              <option value="0">Não</option>
              <option value="1">Sim</option>
            </select>
          </div>
          <div>
            <label for="selFeatured">Destaque</label>
            <select id="selFeatured">
              <option value="0">Não</option>
              <option value="1">Sim</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="inpOrder">Ordem (sort_order)</label>
            <input id="inpOrder" inputmode="numeric" placeholder="ex: 300" />
          </div>
          <div>
            <label for="inpTagText">Tag (texto)</label>
            <input id="inpTagText" placeholder="ex: Preparação intensiva" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="selTagVar">Tag (cor)</label>
            <select id="selTagVar">
              <option value="">(auto)</option>
              <option value="success">success</option>
              <option value="info">info</option>
              <option value="brand">brand</option>
              <option value="purple">purple</option>
              <option value="featured">featured</option>
            </select>
          </div>
          <div>
            <label for="inpCtaText">CTA (texto)</label>
            <input id="inpCtaText" placeholder="ex: Assinar agora" />
          </div>
          <div>
            <label for="selCtaVar">CTA (cor)</label>
            <select id="selCtaVar">
              <option value="">(auto)</option>
              <option value="success">success</option>
              <option value="info">info</option>
              <option value="brand">brand</option>
              <option value="purple">purple</option>
              <option value="featured">featured</option>
            </select>
          </div>
        </div>

        <label for="inpBadge">Badge (opcional)</label>
        <input id="inpBadge" placeholder="ex: Mais escolhido" />

        <label for="taFeatures">Benefícios (1 por linha)</label>
        <textarea id="taFeatures" placeholder="Ex:\nSimulados (quiz e completo)\nIndicadores e diagnóstico\nRevisão guiada da tentativa\nSuporte por e-mail"></textarea>

        <div class="actions">
          <button id="btnSave" class="btn btn-primary">Salvar</button>
          <button id="btnDuplicate" class="btn btn-warn">Duplicar</button>
          <button id="btnDelete" class="btn btn-danger">Excluir</button>
          <button id="btnClear" class="btn">Limpar</button>
        </div>

        <div class="status" id="statusForm"></div>
      </div>
    </div>

    <div class="previewPanel" aria-label="Prévia do card de planos">
      <h2>Prévia do card (marketing /#planos)</h2>
      <div class="previewHint">Atualiza automaticamente conforme você edita o formulário. Isso não salva nada — é só visual.</div>
      <div class="previewControls">
        <div class="left">
          <label for="selPreviewMode">Modo</label>
          <select id="selPreviewMode">
            <option value="1">1 card (plano atual)</option>
            <option value="2">2 cards (START + atual)</option>
            <option value="3" selected>3 cards (START + atual + destaque)</option>
          </select>
        </div>
        <div class="muted small">Dica: use isso pra checar consistência visual.</div>
      </div>
      <div class="previewStage">
        <div id="previewCardMount"></div>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = (id) => document.getElementById(id);

  const status = $('status');
  const statusForm = $('statusForm');
  const listEl = $('list');

  let items = [];
  let selectedId = null;

  const previewMount = $('previewCardMount');
  const previewMode = $('selPreviewMode');

  function escapeHtml(s){
    return String(s == null ? '' : s)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#039;');
  }

  function brl(cents){
    try {
      const v = Number(cents || 0) / 100;
      return 'R$ ' + v.toLocaleString('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    } catch(_){
      try { return 'R$ ' + ((Number(cents||0)/100).toFixed(0)); } catch(__){ return 'R$ 0'; }
    }
  }

  function installments(plan){
    try {
      if (plan && plan.is_free) return null;
      const days = Number(plan && plan.access_duration_days);
      if (!Number.isFinite(days) || days <= 0) return null;
      const months = Math.max(1, Math.round(days / 30));
      const count = Math.min(12, months * 2);
      const total = Number(plan && plan.price_cents);
      if (!Number.isFinite(total) || total <= 0) return null;
      const per = Math.round(total / count);
      return { count, per_cents: per };
    } catch(_){ return null; }
  }

  function gatherFormLoose(){
    const id = String(($('inpId') && $('inpId').value) || '').trim() || 'pro-90';
    const isFree = $('selFree') && $('selFree').value === '1';
    const name = String(($('inpName') && $('inpName').value) || '').trim() || 'PRO 90 dias';
    const desc = String(($('inpDesc') && $('inpDesc').value) || '').trim();
    const priceCents = (function(){
      const raw = String(($('inpPrice') && $('inpPrice').value) || '').trim();
      if (isFree) return 0;
      const n = Number(raw.replace(',', '.') || '0');
      return Number.isFinite(n) ? Math.max(0, Math.round(n * 100)) : 0;
    })();

    let days = String(($('inpDays') && $('inpDays').value) || '').trim();
    days = days ? Number(days) : null;
    if (!Number.isFinite(days) || days <= 0) days = null;

    const isFeatured = ($('selFeatured') && $('selFeatured').value === '1') || (!isFree && days === 90);

    const tagText = String(($('inpTagText') && $('inpTagText').value) || '').trim() || (isFree ? 'Comece agora - Zero risco' : 'Acesso completo');
    const tagVar = String(($('selTagVar') && $('selTagVar').value) || '').trim() || (isFeatured ? 'featured' : 'brand');

    const badgeText = String(($('inpBadge') && $('inpBadge').value) || '').trim() || (isFeatured ? 'Mais escolhido' : '');

    const ctaText = String(($('inpCtaText') && $('inpCtaText').value) || '').trim() || (isFree ? 'Começar grátis' : 'Assinar agora');
    const ctaVar = String(($('selCtaVar') && $('selCtaVar').value) || '').trim() || (isFeatured ? 'featured' : (isFree ? 'success' : 'brand'));

    const defaultFeatures = [
      'Simulados (quiz e completo)',
      'Indicadores e diagnóstico',
      'Revisão guiada da tentativa',
      'Suporte por e-mail',
    ];

    const features = normalizeLines(($('taFeatures') && $('taFeatures').value) || '');
    const featuresFinal = features.length ? features : defaultFeatures;

    return {
      id,
      name,
      description: desc,
      is_free: isFree,
      is_featured: isFeatured,
      access_duration_days: days,
      price_cents: priceCents,
      tag: { text: tagText, variant: tagVar },
      badge: { text: badgeText },
      cta: { text: ctaText, variant: ctaVar },
      features: featuresFinal,
    };
  }

  function renderPreview(plan){
    if (!previewMount) return;

    const days = (plan && plan.access_duration_days != null) ? Number(plan.access_duration_days) : null;
    const isFeatured = !!(plan && plan.is_featured);
    const tagText = plan && plan.tag && plan.tag.text ? String(plan.tag.text) : (plan.is_free ? 'Comece agora - Zero risco' : 'Acesso completo');
    const tagVariant = plan && plan.tag && plan.tag.variant ? String(plan.tag.variant) : (isFeatured ? 'featured' : 'brand');
    const badgeText = plan && plan.badge && plan.badge.text ? String(plan.badge.text) : (isFeatured ? 'Mais escolhido' : '');
    const ctaText = plan && plan.cta && plan.cta.text ? String(plan.cta.text) : (plan.is_free ? 'Começar grátis' : 'Assinar agora');
    const ctaVariant = plan && plan.cta && plan.cta.variant ? String(plan.cta.variant) : (isFeatured ? 'featured' : (plan.is_free ? 'success' : 'brand'));
    const inst = installments(plan);
    const features = (plan && Array.isArray(plan.features) && plan.features.length) ? plan.features : [];

    const safeVariant = /^(success|info|brand|purple|featured)$/.test(tagVariant) ? tagVariant : 'brand';
    const safeCtaVariant = /^(success|info|brand|purple|featured)$/.test(ctaVariant) ? ctaVariant : 'brand';

    let featsHtml = '';
    (features || []).forEach((f) => {
      featsHtml += `<li><span class="plan-check" aria-hidden="true">✓</span> ${escapeHtml(f)}</li>`;
    });

    return `
      <div class="pricing-card pricing-card--v2 ${isFeatured ? 'pricing-card--featured' : ''}" data-plan-id="${escapeHtml(plan.id || '')}">
        <div class="pricing-top">
          <span class="plan-tag plan-tag--${escapeHtml(safeVariant)}">${escapeHtml(tagText)}</span>
          ${badgeText ? `<span class="plan-badge">${escapeHtml(badgeText)}</span>` : ''}
        </div>

        <div class="pricing-main">
          <div class="plan-name">${escapeHtml(plan.name || '')}</div>

          <div class="plan-price">
            <div class="plan-price-main">${plan.is_free ? 'R$ 0' : escapeHtml(brl(plan.price_cents))}</div>
            ${inst && inst.count && inst.per_cents ? `<div class="plan-installments">ou <strong>${inst.count}x</strong> de <strong>${escapeHtml(brl(inst.per_cents))}</strong></div>` : `<div class="plan-installments">&nbsp;</div>`}
          </div>

          <div class="plan-chip">
            ${plan.is_free || days == null ? 'Acesso vitalício (START)' : `Acesso completo por <strong>${escapeHtml(days)}</strong> dias`}
          </div>

          <ul class="plan-features">${featsHtml}</ul>
        </div>

        <div class="pricing-cta">
          <button type="button" class="btn-plan btn-plan--${escapeHtml(safeCtaVariant)}" onclick="return false;">${escapeHtml(ctaText)}</button>
          <div class="plan-footnote">Sem fidelidade. Acesso por tempo do plano.</div>
        </div>
      </div>
    `.trim();
  }

  function buildStartPlan(){
    return {
      id: 'start',
      name: 'START',
      description: '',
      is_free: true,
      is_featured: false,
      access_duration_days: null,
      price_cents: 0,
      tag: { text: 'Comece agora - Zero risco', variant: 'success' },
      badge: { text: '' },
      cta: { text: 'Começar grátis', variant: 'success' },
      features: [
        'Simulados (quiz 25 questões)',
        'Indicadores e diagnóstico',
        'Flashcards (limitado)',
        'Acesso por tempo ilimitado',
      ]
    };
  }

  function buildFeaturedFrom(plan){
    const p = JSON.parse(JSON.stringify(plan || {}));
    p.id = (p.id && String(p.id).includes('start')) ? 'pro-90' : (p.id || 'pro-90');
    p.is_free = false;
    p.is_featured = true;
    p.tag = p.tag || {};
    p.tag.variant = 'featured';
    p.tag.text = String((p.tag && p.tag.text) || '').trim() || 'Mais custo-benefício';
    p.badge = p.badge || {};
    p.badge.text = String((p.badge && p.badge.text) || '').trim() || 'Mais escolhido';
    p.cta = p.cta || {};
    p.cta.variant = 'featured';
    p.cta.text = String((p.cta && p.cta.text) || '').trim() || 'Assinar agora';
    return p;
  }

  function renderPreviewGrid(plans, mode){
    if (!previewMount) return;
    const m = String(mode || '1');
    const cls = (m === '3') ? 'previewGrid previewGrid--3' : (m === '2') ? 'previewGrid previewGrid--2' : 'previewGrid';
    let html = `<div class="${cls}">`;
    plans.forEach((it) => {
      html += `<div>`;
      if (it && it._label) html += `<div class="previewGridTitle">${escapeHtml(it._label)}</div>`;
      html += renderPreview(it);
      html += `</div>`;
    });
    html += `</div>`;
    previewMount.innerHTML = html;
  }

  function updatePreview(){
    try {
      const p = gatherFormLoose();
      const mode = previewMode ? String(previewMode.value || '3') : '1';
      if (mode === '1'){
        p._label = 'Plano atual';
        renderPreviewGrid([p], mode);
      } else if (mode === '2'){
        const start = buildStartPlan();
        start._label = 'START';
        p._label = 'Plano atual';
        renderPreviewGrid([start, p], mode);
      } else {
        const start = buildStartPlan();
        start._label = 'START';
        p._label = 'Plano atual';
        const featured = buildFeaturedFrom(p);
        featured._label = 'Destaque';
        renderPreviewGrid([start, p, featured], mode);
      }
    } catch(_){
      if (previewMount) previewMount.innerHTML = '<div class="muted small">Prévia indisponível.</div>';
    }
  }

  function setStatus(el, msg, isErr){
    el.textContent = msg || '';
    el.className = 'status' + (isErr ? ' error' : '');
  }

  function priceToCents(brl){
    const s = String(brl || '').trim().replace(',', '.');
    if (!s) return 0;
    const n = Number(s);
    if (!Number.isFinite(n)) return NaN;
    return Math.round(n * 100);
  }

  function centsToBrl(cents){
    const n = Number(cents || 0) / 100;
    if (!Number.isFinite(n)) return '';
    // keep simple for editing
    return String(Math.round(n));
  }

  function normalizeLines(txt){
    return String(txt || '')
      .split(/\r?\n/)
      .map(s => s.trim())
      .filter(Boolean);
  }

  function renderList(){
    listEl.innerHTML = '';
    if (!items.length) {
      const d = document.createElement('div');
      d.className = 'muted small';
      d.textContent = 'Nenhum plano encontrado.';
      listEl.appendChild(d);
      return;
    }

    items.forEach(p => {
      const div = document.createElement('div');
      div.className = 'item';

      const head = document.createElement('div');
      head.className = 'itemHead';

      const left = document.createElement('div');
      const title = document.createElement('div');
      title.className = 'itemTitle';
      title.textContent = p.name + ' (' + p.id + ')';

      const meta = document.createElement('div');
      meta.className = 'muted small';
      const days = (p.access_duration_days == null) ? 'vitalício' : (String(p.access_duration_days) + ' dias');
      const price = p.is_free ? 'R$ 0' : ('R$ ' + (Number(p.price_cents||0)/100).toFixed(2).replace('.', ','));
      meta.textContent = price + ' • ' + days;

      const badges = document.createElement('div');
      badges.style.marginTop = '8px';
      badges.style.display = 'flex';
      badges.style.gap = '8px';
      badges.style.flexWrap = 'wrap';

      const pillA = document.createElement('span');
      pillA.className = 'pill ' + (p.is_active ? 'ok' : 'off');
      pillA.textContent = p.is_active ? 'ATIVO' : 'INATIVO';
      badges.appendChild(pillA);

      if (p.is_featured) {
        const pillF = document.createElement('span');
        pillF.className = 'pill';
        pillF.textContent = 'DESTAQUE';
        badges.appendChild(pillF);
      }

      left.appendChild(title);
      left.appendChild(meta);
      left.appendChild(badges);

      const right = document.createElement('div');
      const btn = document.createElement('button');
      btn.className = 'btn';
      btn.textContent = (selectedId === p.id) ? 'Editando' : 'Editar';
      btn.disabled = (selectedId === p.id);
      btn.onclick = () => selectPlan(p.id);
      right.appendChild(btn);

      head.appendChild(left);
      head.appendChild(right);
      div.appendChild(head);

      listEl.appendChild(div);
    });
  }

  async function api(path, options){
    const h = window.Auth && window.Auth.getAuthHeaders ? window.Auth.getAuthHeaders({ acceptJson: true }) : {};
    const headers = { ...h, 'Content-Type': 'application/json' };
    const opts = { credentials: 'include', ...(options||{}), headers: { ...headers, ...((options||{}).headers||{}) } };
    const r = await fetch(path, opts);
    const text = await r.text();
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch(_){ data = { raw: text }; }
    return { ok: r.ok, status: r.status, data };
  }

  async function load(){
    setStatus(status, 'Carregando...', false);
    const r = await api('/api/admin/product-plans');
    if (!r.ok) {
      setStatus(status, 'Falha ao carregar (' + r.status + '): ' + (r.data && (r.data.message||r.data.error||r.data.code) ? (r.data.message||r.data.error||r.data.code) : ''), true);
      return;
    }
    items = (r.data && r.data.items) ? r.data.items : [];
    setStatus(status, 'OK (' + items.length + ' planos). Fonte: ' + (r.data.source || ''), false);
    renderList();
  }

  async function seedDefaults(){
    const ok = confirm('Isso vai gravar os planos atuais (defaults) em backend/data/productPlans.json.\n\nSe o arquivo já existir, será necessário confirmar sobrescrita.');
    if (!ok) return;

    setStatus(status, 'Gerando arquivo...', false);
    let r = await api('/api/admin/product-plans/seed-defaults', { method:'POST' });
    if (!r.ok && r.data && r.data.code === 'PLANS_FILE_ALREADY_EXISTS') {
      const ok2 = confirm('O arquivo já existe. Deseja SOBRESCREVER com os defaults?');
      if (!ok2) { setStatus(status, 'Cancelado.', false); return; }
      r = await api('/api/admin/product-plans/seed-defaults?force=1', { method:'POST' });
    }

    if (!r.ok) {
      setStatus(status, 'Falha ao gerar (' + r.status + '): ' + (r.data && (r.data.message||r.data.error||r.data.code) ? (r.data.message||r.data.error||r.data.code) : ''), true);
      return;
    }

    setStatus(status, 'Arquivo gerado. (' + (r.data && r.data.count ? r.data.count : '?') + ' planos)', false);
    await load();
  }

  function clearForm(){
    selectedId = null;
    $('inpId').value = '';
    $('inpId').disabled = false;
    $('inpName').value = '';
    $('inpDesc').value = '';
    $('inpPrice').value = '';
    $('inpDays').value = '';
    $('selActive').value = '1';
    $('selFree').value = '0';
    $('selFeatured').value = '0';
    $('inpOrder').value = '';
    $('inpTagText').value = '';
    $('selTagVar').value = '';
    $('inpCtaText').value = '';
    $('selCtaVar').value = '';
    $('inpBadge').value = '';
    $('taFeatures').value = '';
    setStatus(statusForm, '', false);
    renderList();
    updatePreview();
  }

  function selectPlan(id){
    const p = items.find(x => x.id === id);
    if (!p) return;
    selectedId = id;
    $('inpId').value = p.id || '';
    $('inpId').disabled = true;
    $('inpName').value = p.name || '';
    $('inpDesc').value = p.description || '';
    $('inpPrice').value = p.is_free ? '0' : centsToBrl(p.price_cents);
    $('inpDays').value = (p.access_duration_days == null) ? '' : String(p.access_duration_days);
    $('selActive').value = p.is_active ? '1' : '0';
    $('selFree').value = p.is_free ? '1' : '0';
    $('selFeatured').value = p.is_featured ? '1' : '0';
    $('inpOrder').value = (p.sort_order == null) ? '' : String(p.sort_order);

    $('inpTagText').value = (p.tag && p.tag.text) ? p.tag.text : '';
    $('selTagVar').value = (p.tag && p.tag.variant) ? p.tag.variant : '';

    $('inpCtaText').value = (p.cta && p.cta.text) ? p.cta.text : '';
    $('selCtaVar').value = (p.cta && p.cta.variant) ? p.cta.variant : '';

    $('inpBadge').value = (p.badge && p.badge.text) ? p.badge.text : '';

    $('taFeatures').value = Array.isArray(p.features) ? p.features.join('\n') : '';

    setStatus(statusForm, 'Editando: ' + p.id, false);
    renderList();
    updatePreview();
  }

  function gatherForm(overrideId){
    const id = (overrideId || $('inpId').value || '').trim();
    const priceCents = priceToCents($('inpPrice').value);
    if (!id) throw new Error('ID obrigatório');
    if (!/^[a-z0-9][a-z0-9-]{1,40}$/.test(id)) throw new Error('ID inválido');
    if (!($('inpName').value||'').trim()) throw new Error('Nome obrigatório');
    if (!Number.isFinite(priceCents)) throw new Error('Preço inválido');

    const isFree = $('selFree').value === '1';

    let days = ($('inpDays').value||'').trim();
    days = days ? Number(days) : null;
    if (days !== null && (!Number.isFinite(days) || days <= 0)) throw new Error('Dias inválido');

    const plan = {
      id,
      name: ($('inpName').value||'').trim(),
      description: ($('inpDesc').value||'').trim(),
      is_active: $('selActive').value === '1',
      is_free: isFree,
      is_featured: $('selFeatured').value === '1',
      access_duration_days: days,
      price_cents: isFree ? 0 : priceCents,
      sort_order: ($('inpOrder').value||'').trim() ? Number(($('inpOrder').value||'').trim()) : undefined,
      tag: {
        text: ($('inpTagText').value||'').trim(),
        variant: ($('selTagVar').value||'').trim()
      },
      cta: {
        text: ($('inpCtaText').value||'').trim(),
        variant: ($('selCtaVar').value||'').trim()
      },
      badge: {
        text: ($('inpBadge').value||'').trim()
      },
      features: normalizeLines($('taFeatures').value)
    };

    // Clean empty objects
    if (!plan.tag.text && !plan.tag.variant) delete plan.tag;
    if (!plan.cta.text && !plan.cta.variant) delete plan.cta;
    if (!plan.badge.text) delete plan.badge;

    return plan;
  }

  async function save(){
    setStatus(statusForm, 'Salvando...', false);
    let plan;
    try {
      plan = gatherForm(selectedId || null);
    } catch(e) {
      setStatus(statusForm, e.message || String(e), true);
      return;
    }

    let r;
    if (selectedId) {
      r = await api('/api/admin/product-plans/' + encodeURIComponent(selectedId), { method:'PUT', body: JSON.stringify(plan) });
    } else {
      r = await api('/api/admin/product-plans', { method:'POST', body: JSON.stringify(plan) });
    }

    if (!r.ok) {
      setStatus(statusForm, 'Falha ao salvar (' + r.status + '): ' + (r.data && (r.data.message||r.data.error||r.data.code) ? (r.data.message||r.data.error||r.data.code) : ''), true);
      return;
    }

    setStatus(statusForm, 'Salvo com sucesso.', false);
    await load();
    selectPlan(plan.id);
  }

  async function del(){
    if (!selectedId) { setStatus(statusForm, 'Selecione um plano.', true); return; }
    const ok = confirm('Excluir o plano ' + selectedId + '?');
    if (!ok) return;

    setStatus(statusForm, 'Excluindo...', false);
    const r = await api('/api/admin/product-plans/' + encodeURIComponent(selectedId), { method:'DELETE' });
    if (!r.ok) {
      setStatus(statusForm, 'Falha ao excluir (' + r.status + ')', true);
      return;
    }
    setStatus(statusForm, 'Excluído.', false);
    await load();
    clearForm();
  }

  function duplicate(){
    if (!selectedId) { setStatus(statusForm, 'Selecione um plano.', true); return; }
    const base = selectedId;
    const suggested = base + '-copy';
    $('inpId').value = suggested;
    $('inpId').disabled = false;
    selectedId = null;
    setStatus(statusForm, 'Duplicação pronta. Ajuste o ID e clique Salvar.', false);
    renderList();
  }

  $('btnReload').onclick = load;
  $('btnSeed').onclick = seedDefaults;
  $('btnNew').onclick = clearForm;
  $('btnClear').onclick = clearForm;
  $('btnSave').onclick = save;
  $('btnDelete').onclick = del;
  $('btnDuplicate').onclick = duplicate;

  $('btnHome').onclick = () => { window.location.href = '/index.html'; };
  $('btnLogout').onclick = async () => { try { await window.Logout.logout(); } catch(_) {} };

  // live preview
  ;[
    'inpId','inpName','inpDesc','inpPrice','inpDays','selFree','selFeatured','inpTagText','selTagVar','inpCtaText','selCtaVar','inpBadge','taFeatures'
  ].forEach((id) => {
    const el = $(id);
    if (!el) return;
    el.addEventListener('input', () => { updatePreview(); });
    el.addEventListener('change', () => { updatePreview(); });
  });

  if (previewMode){
    previewMode.addEventListener('change', () => { updatePreview(); });
  }

  // bootstrap
  updatePreview();
  load().catch(e => setStatus(status, e.message||String(e), true));
})();
</script>
</body>
</html>
