<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Carga de Questões (JSON/XML)</title>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    .container{ max-width: 900px; margin: 24px auto; padding: 16px; background:#fff; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,.06);} 
    .row{ margin-bottom: 12px; }
    label{ display:block; font-weight:600; margin-bottom:6px; }
    textarea, select, input[type="file"]{ width:100%; padding:8px 10px; border:1px solid #ddd; border-radius:8px; }
    .actions{ display:flex; gap:12px; margin-top: 16px; }
    .btn{ background:#2b6cb0; color:#fff; border:none; border-radius:8px; padding:10px 14px; cursor:pointer; }
    .btn.secondary{ background:#edf2f7; color:#2b6cb0; border:1px solid #c6d3ff; }
    .hint{ font-size:.9rem; color:#555; }
    .inline{ display:flex; gap:12px; align-items:flex-start; flex-wrap: wrap; }
    .inline > *{ flex: 1 1 240px; }
    code{ background:#f6f8fa; padding:2px 4px; border-radius:4px; }
    pre{ background:#f6f8fa; padding:10px; border-radius:8px; overflow:auto; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Carga de Questões (JSON/XML)</h1>

    <div class="row inline">
      <div>
        <label for="mode">Modo</label>
        <select id="mode">
          <option value="json">JSON (colar no campo abaixo)</option>
          <option value="file-json">Arquivo JSON (.json)</option>
          <option value="file-xml">Arquivo XML (.xml)</option>
        </select>
      </div>
      <div>
        <label for="examType">Tipo de exame (padrão do lote)</label>
        <select id="examType"></select>
        <div class="hint">Cada questão também pode especificar seu <code>examTypeSlug</code> próprio no JSON/XML. Se ausente, usa o do lote.</div>
      </div>
    </div>

    <div class="row inline">
      <div>
        <label for="idtask">Task (padrão opcional do lote)</label>
        <select id="idtask"></select>
        <div class="hint">Aplicado a todas questões que não especificarem <code>id_task</code> próprio.</div>
      </div>
    </div>

    <div class="row" id="fileRow" style="display:none;">
      <label for="file">Arquivo</label>
      <input type="file" id="file" accept=".json,.xml" />
    </div>

    <div class="row" id="jsonRow">
      <label for="json">Conteúdo JSON</label>
      <textarea id="json" rows="14" placeholder='{"examType":"pmp","questions":[{"descricao":"Texto...","tiposlug":"single","options":[{"descricao":"A","correta":true},{"descricao":"B"}]}]}'></textarea>
    </div>

    <div class="actions">
      <button class="btn" id="send">Enviar</button>
      <a class="btn secondary" href="/">Voltar</a>
    </div>

    <div id="status" class="row"></div>

    <div class="row">
      <h3>Formatos aceitos</h3>
      <p><strong>JSON (objeto com lote):</strong></p>
      <pre>{
  "examType": "pmp",
  "iddominio": 1,                    // opcional padrão do lote
  "codareaconhecimento": 1,          // opcional padrão do lote
  "codgrupoprocesso": 1,             // opcional padrão do lote
  "iddominiogeral": 1,               // opcional padrão do lote
  "id_task": 1,                      // opcional padrão do lote
  "dica": "opcional",
  "questions": [
    {
      "descricao": "Enunciado...",
      "tiposlug": "single",        // ou "multi"
      "options": [
        { "descricao": "A", "correta": true },
        { "descricao": "B" }
      ],
      "examTypeSlug": "pmp",       // pode vir aqui também; se ausente, usa o do lote
      "iddominio": 1,               // overrides do lote
      "codareaconhecimento": 2,
      "codgrupoprocesso": 3,
      "iddominiogeral": 1,
      "id_task": 2,                 // opcional, override do lote
      "dica": "opcional",
      "explicacao": "opcional"
    }
  ]
}</pre>
      <p><strong>JSON (array):</strong> [ { question }, { question } ] — cada item deve ter <code>examTypeSlug</code> ou <code>examTypeId</code>.</p>
      <p><strong>XML:</strong></p>
      <pre>&lt;questions examType="pmp"&gt;
  &lt;question&gt;
    &lt;descricao&gt;Enunciado...&lt;/descricao&gt;
    &lt;tipo&gt;single&lt;/tipo&gt;
    &lt;alternativas&gt;
      &lt;alternativa correta="true"&gt;Texto A&lt;/alternativa&gt;
      &lt;alternativa&gt;Texto B&lt;/alternativa&gt;
    &lt;/alternativas&gt;
    &lt;explicacao&gt;Opcional&lt;/explicacao&gt;
  &lt;/question&gt;
&lt;/questions&gt;</pre>
    </div>
  </div>

  <script>
    const $ = (id)=> document.getElementById(id);
    const BACKEND_BASE = (window.SIMULADOS_CONFIG && window.SIMULADOS_CONFIG.BACKEND_BASE) || '';

    function toggleMode(){
      const mode = $('mode').value;
      $('fileRow').style.display = (mode === 'file-json' || mode === 'file-xml') ? '' : 'none';
      $('jsonRow').style.display = (mode === 'json') ? '' : 'none';
    }
    $('mode').addEventListener('change', toggleMode);

    async function loadExamTypes(){
      try {
        const sel = $('examType');
        const resp = await fetch((BACKEND_BASE||'').replace(/\/$/,'') + '/api/exams/types');
        const list = await resp.json();
        sel.innerHTML = '';
        const none = document.createElement('option'); none.value = ''; none.textContent = '— Selecione —'; sel.appendChild(none);
        (list||[]).forEach(t=>{ const o = document.createElement('option'); o.value = t.id; o.textContent = t.nome||t.id; sel.appendChild(o); });
        try { if (!sel.value && sel.options.length > 1) sel.selectedIndex = 1; } catch(e){}
      } catch(e) {
        const sel = $('examType'); sel.innerHTML = '<option value="pmp">PMP</option>';
      }
    }

    async function loadTasks(){
      try {
        const sel = $('idtask');
        const resp = await fetch((BACKEND_BASE||'').replace(/\/$/,'') + '/api/meta/tasks');
        const list = await resp.json();
        sel.innerHTML = '';
        const none = document.createElement('option'); none.value = ''; none.textContent = '— Selecione —'; sel.appendChild(none);
        (list||[]).forEach(t=>{ const o = document.createElement('option'); o.value = t.id; o.textContent = t.descricao; sel.appendChild(o); });
      } catch(e) {
        console.error('[loadTasks] error:', e);
      }
    }

    $('send').onclick = async function(){
      const token = localStorage.getItem('sessionToken') || '';
      const base = (BACKEND_BASE||'');
      const mode = $('mode').value;
      const examTypeSlug = ($('examType').value||'').trim();
      const url = base + '/api/questions/bulk';
      $('status').textContent = 'Enviando...';
      try {
        let resp;
        if (mode === 'json') {
          let data;
          try { data = JSON.parse($('json').value || ''); } catch(e){ $('status').textContent = 'JSON inválido'; return; }
          // If batch-level not present, apply from selectors
          if (data && !Array.isArray(data)) {
            if (!data.examType && examTypeSlug) data.examType = examTypeSlug;
            const idtask = ($('idtask').value||'').trim();
            if (idtask && !data.id_task) data.id_task = Number(idtask);
          }
          resp = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Session-Token': token }, body: JSON.stringify(data) });
        } else {
          const f = $('file').files[0];
          if (!f){ $('status').textContent = 'Selecione um arquivo'; return; }
          const fd = new FormData();
          fd.append('file', f, f.name);
          // We can optionally include top-level examType when using file
          if (examTypeSlug) fd.append('examType', examTypeSlug);
          resp = await fetch(url, { method: 'POST', headers: { 'X-Session-Token': token }, body: fd });
        }
        const txt = await resp.text(); let data = null; try { data = txt ? JSON.parse(txt) : null; } catch{ data = null; }
        if (!resp.ok) { $('status').textContent = 'Erro: ' + (data && data.error || txt || resp.status); return; }
        $('status').textContent = `Concluído: inseridos ${data.inserted}/${data.total}`;
      } catch (e) {
        $('status').textContent = 'Falha no envio: ' + (e && e.message || e);
      }
    };

    loadExamTypes();
    loadTasks();
    toggleMode();
  </script>
</body>
</html>
<!-- Bottom navigation bar (consistent with index.html) -->
<nav class="bottom-nav" aria-label="Navegação inferior" style="position:fixed;left:0;right:0;bottom:0;height:44px;background:#111827;border-top:1px solid #1f2937;display:flex;align-items:center;justify-content:center;z-index:1000;gap:14px;padding-bottom: env(safe-area-inset-bottom);">
  <a class="nav-item" href="/index.html" aria-label="Home" style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-width:40px;min-height:44px;padding:1px 4px;border-radius:8px;color:#94a3b8;text-decoration:none;">
    <svg class="nav-icon" viewBox="0 0 24 24" aria-hidden="true" style="width:16px;height:16px;fill: currentColor"><path d="M12 3.172l8 7V20a1 1 0 0 1-1 1h-5v-6H10v6H5a1 1 0 0 1-1-1v-9.828l8-7zM21 10.414l-9-7.875-9 7.875V20a3 3 0 0 0 3 3h4a1 1 0 0 0 1-1v-6h4v6a1 1 0 0 0 1 1h4a3 3 0 0 0 3-3v-9.586z"></path></svg>
    <span class="nav-text" style="display:none">Home</span>
  </a>
  <a class="nav-item active" aria-label="Admin" style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-width:40px;min-height:44px;padding:1px 4px;border-radius:8px;color:#4f46e5;background: rgba(79,70,229,0.08);text-decoration:none;">
    <svg class="nav-icon" viewBox="0 0 24 24" aria-hidden="true" style="width:16px;height:16px;fill: currentColor"><path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"></path><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
    <span class="nav-text" style="display:none">Admin</span>
  </a>
</nav>
</html>
