<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simulado — Questão</title>
  <link rel="stylesheet" href="../styles.css" />
</head>
<body>
  <header id="userHeader" style="display:none; padding:12px; background:#f4f4f4; border-bottom:1px solid #ddd;">
    <div style="max-width:900px;margin:0 auto;">Bem-vindo, <strong id="userNameHeader"></strong></div>
  </header>
  <p id="status" style="max-width:900px;margin:10px auto 0;display:none;padding:0 18px;color:#333"></p>
  <div id="autosaveIndicator" style="max-width:900px;margin:4px auto 0;padding:0 18px;color:var(--muted);font-size:0.95rem;display:none;"></div>
  <div id="toast" class="toast" aria-live="polite" style="display:none"></div>

  <main class="exam-container" role="main">
    <header class="exam-header">
      <div class="header-left" aria-hidden="true"></div>

      <div class="header-center" id="centerHeader">
        <div class="knowledge-area" id="knowledgeArea" aria-live="polite">Exemplo</div>
        <div class="timer" id="timerBox" aria-live="polite" title="Tempo decorrido">
          <span id="timerDisplay">00:00</span>
        </div>
      </div>

      <div class="header-right controls">
        <div class="font-control">
          <button id="fontToggle" class="icon-btn" aria-expanded="false" aria-controls="fontSlider" title="Ajustar tamanho da fonte">Aa</button>
          <div id="fontSlider" class="font-slider" hidden>
            <label for="fontRange">Tamanho da fonte</label>
            <input id="fontRange" type="range" min="12" max="24" value="16" />
          </div>
        </div>
      </div>
    </header>

    <section class="question-panel" aria-labelledby="questionNumber">
      <div class="meta-row">
        <div id="qStatus" class="q-status">Questão <span id="questionNumber">1</span> / <span id="totalQuestions">1</span></div>
        <div class="feedback-buttons">
          <button id="likeBtn" class="icon-like" aria-pressed="false" title="Gostei" aria-label="Gostei">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 21s-6.716-4.35-9.062-7.018C-0.413 10.983 2.973 6 7.5 6c1.84 0 3.515.756 4.5 2.01C13.985 6.756 15.66 6 17.5 6 22.027 6 25.413 10.983 21.062 13.982 18.716 16.65 12 21 12 21z" stroke="currentColor" stroke-width="1.2" fill="currentColor"/></svg>
          </button>
          <button id="dislikeBtn" class="icon-dislike" aria-pressed="false" title="Não gostei" aria-label="Não gostei">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 3s6.716 4.35 9.062 7.018C24.413 13.017 21.027 18 16.5 18c-1.84 0-3.515-.756-4.5-2.01C10.015 17.244 8.34 18 6.5 18 1.973 18 -1.413 13.017 2.938 10.018 5.284 7.35 12 3 12 3z" stroke="currentColor" stroke-width="1.2" fill="currentColor"/></svg>
          </button>
        </div>
      </div>

      <article class="question-content" id="questionContent">
        <p id="questionText" class="question-text">Carregando pergunta...</p>

        <form id="answersForm" class="answers-form" autocomplete="off" novalidate>
          <div class="option">
            <label>
              <input type="radio" name="answer" value="0" />
              <span class="option-text" id="opt0">Opção A</span>
            </label>
          </div>
          <div class="option">
            <label>
              <input type="radio" name="answer" value="1" />
              <span class="option-text" id="opt1">Opção B</span>
            </label>
          </div>
          <div class="option">
            <label>
              <input type="radio" name="answer" value="2" />
              <span class="option-text" id="opt2">Opção C</span>
            </label>
          </div>
          <div class="option">
            <label>
              <input type="radio" name="answer" value="3" />
              <span class="option-text" id="opt3">Opção D</span>
            </label>
          </div>
        </form>

        <div class="actions-row">
          <button id="backBtn" class="primary-btn" style="display:none;margin-right:8px;">Voltar</button>
          <button id="continueBtn" class="primary-btn">Continuar</button>
        </div>
      </article>
    </section>
  </main>
  <!-- define session vars required by exam pages -->
  <script>
    try {
  // tempoExame (minutos totais para o exame completo): 180 questões = 230 minutos
  const _tempoExame = 230; // minutos
  // FullExam: número total de questões do exame completo
  const _FullExam = 180;
      sessionStorage.setItem('tempoExame', JSON.stringify(_tempoExame));
      sessionStorage.setItem('FullExam', JSON.stringify(_FullExam));
      // também expor como variáveis globais numéricas para uso imediato no script
      window.tempoExame = _tempoExame;
      window.FullExam = _FullExam;
    } catch (e) {
      console.warn('Falha ao definir variáveis de sessão:', e);
    }
  </script>

  <!-- registration/session script must run before exam script -->
  <script src="../script.js"></script>
  <script src="../script_exam.js"></script>

  <!-- initialize global QtdQuestoes and timer behavior -->
  <script>
    (function(){
      try {
        // Session guard: require non-guest identity; else send to registration entrypoint
        try {
          const token = localStorage.getItem('sessionToken') || '';
          const hasIdentity = !!(localStorage.getItem('userId') || localStorage.getItem('nomeUsuario') || localStorage.getItem('nome'));
          if ((!token && !hasIdentity) || ((token && token.endsWith('#')) && !hasIdentity)) {
            window.location.replace('http://localhost:3000');
            return;
          }
        } catch(e) {}

        // Read chosen question count from localStorage (set by examSetup)
        let q = null;
        try { q = localStorage.getItem('examQuestionCount'); } catch(e) { q = null; }
        const parsed = q ? Number(q) : null;
        // fallback to FullExam if not set
        const full = (typeof window.FullExam === 'number') ? window.FullExam : (sessionStorage.getItem('FullExam') ? JSON.parse(sessionStorage.getItem('FullExam')) : null);
        const qtd = (parsed && !isNaN(parsed)) ? parsed : 0;
        // Guard: se não houver quantidade definida pelo setup e não vier com startExam, encaminhar para a configuração
        const shouldStart = (sessionStorage.getItem('startExam') === 'true');
        if (!qtd && !shouldStart) {
          try { window.location.replace('/pages/examSetup.html'); } catch(e) { window.location.href = '/pages/examSetup.html'; }
          return;
        }
        const finalQtd = qtd || (full || 0);
        // expose as global numeric
        window.QtdQuestoes = Number(finalQtd);
        // update totalQuestions display on the exam page to reflect selection
        try {
          const totalEl = document.getElementById('totalQuestions');
          if (totalEl) totalEl.textContent = String(window.QtdQuestoes);
        } catch(e) { console.warn('update totalQuestions failed', e); }

        // Confirmação de exame completo (180) é tratada apenas na examSetup. Aqui iniciamos normalmente.

        // helper to format seconds to MM:SS or H:MM:SS if large
        function fmtSeconds(s){
          s = Math.max(0, Math.floor(s));
          if (s >= 3600) {
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60).toString().padStart(2,'0');
            const sec = (s % 60).toString().padStart(2,'0');
            return `${h}:${m}:${sec}`;
          }
          const m = Math.floor(s/60).toString().padStart(2,'0');
          const sec = (s % 60).toString().padStart(2,'0');
          return `${m}:${sec}`;
        }

        // compute total seconds proportional to quantidade selecionada:
        // 180 questões equivalem a 230 minutos => segundos = (QtdQuestoes / 180) * 230(min) * 60
        function computeSeconds() {
          const tempo = (typeof window.tempoExame === 'number') ? window.tempoExame : (sessionStorage.getItem('tempoExame') ? JSON.parse(sessionStorage.getItem('tempoExame')) : null); // minutos do exame completo
          const fullNum = (typeof window.FullExam === 'number') ? window.FullExam : (sessionStorage.getItem('FullExam') ? JSON.parse(sessionStorage.getItem('FullExam')) : null);
          const qtdNum = Number(window.QtdQuestoes) || 0;
          if (!tempo || !fullNum || !qtdNum) return 0;
          const totalMinutes = (qtdNum * tempo) / fullNum; // minutos proporcionais
          const seconds = totalMinutes * 60;
          return Math.max(0, Math.round(seconds));
        }

        // countdown state
        let _timerInterval = null;

        function startCountdown() {
          try {
            if (_timerInterval) return; // already running
            // allow resuming from persisted remaining seconds if available
            let remaining = computeSeconds();
            try {
              const progRaw = (window.currentSessionId && localStorage.getItem(`progress_${window.currentSessionId}`)) || null;
              if (progRaw) {
                const prog = JSON.parse(progRaw);
                if (prog && typeof prog === 'object' && prog.remainingSeconds !== undefined && prog.remainingSeconds !== null) {
                  remaining = Number(prog.remainingSeconds) || remaining;
                }
              }
            } catch(e) { /* ignore */ }
            const display = document.getElementById('timerDisplay');
            if (!display) return;
            display.textContent = fmtSeconds(remaining);
            _timerInterval = setInterval(() => {
              remaining -= 1;
              if (remaining <= 0) {
                display.textContent = fmtSeconds(0);
                clearInterval(_timerInterval);
                _timerInterval = null;
                // exam finished - you may want to auto-submit or notify
                try { alert('Tempo esgotado.'); } catch(e){}
                return;
              }
              display.textContent = fmtSeconds(remaining);
              // persist remaining seconds for resume
              try {
                if (window.currentSessionId) {
                  const key = `progress_${window.currentSessionId}`;
                  const cur = JSON.parse(localStorage.getItem(key) || '{}') || {};
                  cur.remainingSeconds = remaining;
                  localStorage.setItem(key, JSON.stringify(cur));
                  localStorage.setItem(`${key}_savedAt`, new Date().toISOString());
                }
              } catch(e) {}
            }, 1000);
          } catch (e) { console.warn('startCountdown error', e); }
        }

        // Auto-start if the user clicked "Iniciar Exame" (examSetup set sessionStorage.startExam = 'true')
        if (shouldStart) {
          // clear flag and begin
          try { sessionStorage.removeItem('startExam'); } catch(e){}
          startCountdown();
        }

        // Also expose start function globally so other UI can trigger it
        window.startExamCountdown = startCountdown;

      } catch (e) { console.warn('Init exam timer error', e); }
    })();
  </script>

  <!-- Registration modal (copied from index.html/modal) -->
  <div id="emailModal" class="modal" aria-hidden="true" style="display:none;">
    <div class="modal-content">
      <h2>Registro obrigatório</h2>
      <p>Por favor, informe seu nome e e-mail para registrar o aplicativo.</p>
      <input id="nameInput" type="text" placeholder="Seu nome completo" />
      <input id="emailInput" type="email" placeholder="seu@exemplo.com" />
  <input id="passwordInput" type="password" placeholder="Senha (mínimo 6 caracteres)" />
  <input id="verifyTokenInput" type="text" placeholder="Código de verificação (se recebeu por e-mail)" style="display:none;" />
      <div class="modal-actions">
        <button id="submitEmail">Registrar</button>
        <button id="toggleModeBtn" class="secondary-btn" type="button">Já tenho conta</button>
      </div>
      <p id="modalError" style="color:crimson;display:none;"></p>
    </div>
  </div>
</body>
</html>
