<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Personalização de Simulado</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f7f9fc;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 800px;
      margin: 40px auto;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 30px;
    }

    header h1 {
      font-size: 1.6rem;
      margin-bottom: 10px;
      color: #222;
    }

    header p {
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 15px;
    }

    .input-group {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .input-group input {
      width: 80px;
      padding: 6px 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 1rem;
    }

    /* Tabs */
    .tabs {
      display: flex;
      border-bottom: 2px solid #e0e0e0;
      margin-bottom: 15px;
    }

    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      color: #555;
      transition: 0.3s;
    }

    .tab.active {
      color: #007bff;
      border-color: #007bff;
      font-weight: bold;
    }

    /* Checklist */
    .checklist {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-bottom: 25px;
    }

    .check-btn {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #fff;
      text-align: left;
      cursor: pointer;
      transition: all 0.2s;
    }

    .check-btn:hover {
      background: #f0f8ff;
    }

    .check-btn.active {
      background: #007bff;
      color: #fff;
      border-color: #007bff;
    }

    /* Resumo */
    .resumo {
      border-top: 1px solid #eee;
      padding-top: 15px;
    }

    .resumo h3 {
      margin-bottom: 8px;
      font-size: 1.1rem;
      color: #333;
    }

    .resumo p {
      font-size: 0.9rem;
      color: #555;
    }
  </style>
  </head>
  <body>

  <div class="container">
    <!-- HEADER -->
    <header>
      <h1>Como você deseja estruturar seu simulado?</h1>
      <p id="limite-texto"></p>

      <div class="input-group">
        <label for="quantidade">Quantidade de questões:</label>
        <input type="number" id="quantidade" min="1" />
        <span id="limite-info"></span>
      </div>
    </header>

    <!-- TABS -->
    <div class="tabs" role="tablist" aria-label="Filtros do simulado">
      <button class="tab active" role="tab" aria-selected="true" tabindex="0" data-aba="dominios" id="tab-dominios">Domínios <span class="badge" id="badge-dominios" aria-hidden="true"></span></button>
      <button class="tab" role="tab" aria-selected="false" tabindex="-1" data-aba="grupos" id="tab-grupos">Grupo de Processos <span class="badge" id="badge-grupos" aria-hidden="true"></span></button>
      <button class="tab" role="tab" aria-selected="false" tabindex="-1" data-aba="areas" id="tab-areas">Área de Conhecimento <span class="badge" id="badge-areas" aria-hidden="true"></span></button>
    </div>

    <!-- CHECKLIST -->
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
      <div style="color:#666;font-size:0.9rem">Selecione os itens da aba ativa</div>
      <button id="clearTabBtn" type="button" style="background:#eef3ff;color:#2b6cb0;border:1px solid #c6d3ff;border-radius:6px;padding:6px 10px;cursor:pointer">Limpar</button>
    </div>
    <div id="checklist" class="checklist" role="region" aria-live="polite" aria-label="Itens selecionáveis"></div>

    <!-- RESUMO -->
    <div class="resumo">
  <h3>Resumo da Personalização</h3>
  <p>Quantidade de questões: <span id="resumo-qtd">-</span></p>
  <p>Focos selecionados: <span id="resumo-focos">Nenhum selecionado</span></p>
  <p id="resumo-detalhes" style="margin-top:4px;color:#444"></p>
  <div id="availabilityWarning" style="display:none;margin-top:8px;padding:10px;border:1px solid #ffd2cc;background:#fff4f2;border-radius:8px;color:#a23a2a"></div>
      <div style="margin-top:12px; display:flex; gap:10px; align-items:center;">
        <button id="startExamBtn" style="background:#007bff;color:#fff;border:0;border-radius:8px;padding:10px 14px;cursor:pointer;">Iniciar simulado</button>
        <span id="startError" style="color:crimson; display:none;"></span>
      </div>
    </div>
  </div>

  <script>
    // Resolve backend base if window.SIMULADOS_CONFIG is present (optional)
  const BACKEND_BASE = (window.SIMULADOS_CONFIG && window.SIMULADOS_CONFIG.BACKEND_BASE) || '';

    const quantidadeInput = document.getElementById('quantidade');
    const resumoQtd = document.getElementById('resumo-qtd');
    const resumoFocos = document.getElementById('resumo-focos');
    const checklistDiv = document.getElementById('checklist');
    const tabs = document.querySelectorAll('.tab');
  const startBtn = document.getElementById('startExamBtn');
    const startError = document.getElementById('startError');

    // Determine limits from BloqueioAtivado in localStorage: 'true' => free user (limit 40), else premium (200)
    const bloqueado = (localStorage.getItem('BloqueioAtivado') === 'true');
    const limiteQuestoes = bloqueado ? 25 : 180;
    document.getElementById('limite-texto').textContent = bloqueado
      ? 'Usuário gratuito: limite de 25 questões.'
      : 'Usuário pagante: limite de 180 questões.';
    document.getElementById('limite-info').textContent = `(máx. ${limiteQuestoes})`;
    quantidadeInput.setAttribute('max', String(limiteQuestoes));
    quantidadeInput.setAttribute('min', '1');
    if (bloqueado) {
      quantidadeInput.title = 'Limite de 25 questões para usuários gratuitos.';
    }

    // State for meta lists and selections
    let abaAtual = 'dominios';
  let meta = { dominios: [], grupos: [], areas: [] };
    let selecionados = { dominios: [], grupos: [], areas: [] }; // arrays of ids

    // Try to rehydrate saved filters
    try {
      const raw = localStorage.getItem('examFilters');
      if (raw) {
        const parsed = JSON.parse(raw);
        if (parsed && typeof parsed === 'object') {
          if (Array.isArray(parsed.dominios)) selecionados.dominios = parsed.dominios.map(Number).filter(n=>!Number.isNaN(n));
          if (Array.isArray(parsed.grupos)) selecionados.grupos = parsed.grupos.map(Number).filter(n=>!Number.isNaN(n));
          if (Array.isArray(parsed.areas)) selecionados.areas = parsed.areas.map(Number).filter(n=>!Number.isNaN(n));
          if (parsed.activeTab && (parsed.activeTab === 'dominios' || parsed.activeTab === 'grupos' || parsed.activeTab === 'areas')) abaAtual = parsed.activeTab;
        }
      }
    } catch(e) {}

    function renderChecklist(items) {
      checklistDiv.innerHTML = '';
      const sel = selecionados[abaAtual] || [];
      items.forEach(item => {
        const idVal = Number(item.id);
        const text = item.descricao || item.label || String(item.id);
        const wrap = document.createElement('div');
        wrap.classList.add('check-btn');
        wrap.style.display = 'flex';
        wrap.style.alignItems = 'center';
        wrap.style.gap = '8px';

        const input = document.createElement('input');
        const inputId = `chk-${abaAtual}-${idVal}`;
        input.type = 'checkbox';
        input.id = inputId;
        input.value = String(idVal);
        input.checked = sel.includes(idVal);
        input.addEventListener('change', () => {
          const arr = selecionados[abaAtual];
          const v = Number(input.value);
          const idx = arr.indexOf(v);
          if (input.checked && idx === -1) arr.push(v);
          if (!input.checked && idx >= 0) arr.splice(idx, 1);
          atualizarResumo();
          salvarSelecoes();
          updateBadges();
        });

        const label = document.createElement('label');
        label.setAttribute('for', inputId);
        label.textContent = text;

        wrap.appendChild(input);
        wrap.appendChild(label);
        checklistDiv.appendChild(wrap);
      });
      updateBadges();
    }

    function atualizarResumo() {
      resumoQtd.textContent = quantidadeInput.value || '-';
      const nomesDom = idsToNames(meta.dominios, selecionados.dominios);
      const nomesGrp = idsToNames(meta.grupos, selecionados.grupos);
      const nomesArs = idsToNames(meta.areas, selecionados.areas);
      const nomes = [...nomesDom, ...nomesGrp, ...nomesArs];
      resumoFocos.textContent = nomes.length ? nomes.join(', ') : 'Nenhum selecionado';
      const detalhes = [];
      if (nomesDom.length) detalhes.push(`Domínios: ${nomesDom.join(', ')}`);
      if (nomesGrp.length) detalhes.push(`Grupos: ${nomesGrp.join(', ')}`);
      if (nomesArs.length) detalhes.push(`Áreas: ${nomesArs.join(', ')}`);
      document.getElementById('resumo-detalhes').textContent = detalhes.length ? `${quantidadeInput.value || '-'} questões — Filtros: ${detalhes.join(' | ')}` : `${quantidadeInput.value || '-'} questões`;
    }

    function idsToNames(list, ids) {
      const map = new Map(list.map(x => [Number(x.id), (x.descricao || x.label || String(x.id))]));
      return (ids || []).map(Number).filter(v => map.has(v)).map(v => map.get(v));
    }

    function salvarSelecoes() {
      try {
        const payload = { dominios: selecionados.dominios, grupos: selecionados.grupos, areas: selecionados.areas, activeTab: abaAtual };
        localStorage.setItem('examFilters', JSON.stringify(payload));
      } catch(e) {}
    }

    // Tab switching
    function activateTab(tabEl) {
      tabs.forEach(t => { t.classList.remove('active'); t.setAttribute('aria-selected','false'); t.setAttribute('tabindex','-1'); });
      tabEl.classList.add('active');
      tabEl.setAttribute('aria-selected','true');
      tabEl.setAttribute('tabindex','0');
      tabEl.focus();
      abaAtual = tabEl.dataset.aba;
      salvarSelecoes();
      if (abaAtual === 'dominios') renderChecklist(meta.dominios);
      if (abaAtual === 'grupos') renderChecklist(meta.grupos);
      if (abaAtual === 'areas') renderChecklist(meta.areas);
    }
    tabs.forEach(tab => {
      tab.addEventListener('click', () => activateTab(tab));
      tab.addEventListener('keydown', (e) => {
        const idx = Array.from(tabs).indexOf(tab);
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); activateTab(tab); }
        if (e.key === 'ArrowRight') { e.preventDefault(); const next = tabs[(idx+1)%tabs.length]; activateTab(next); }
        if (e.key === 'ArrowLeft') { e.preventDefault(); const prev = tabs[(idx-1+tabs.length)%tabs.length]; activateTab(prev); }
      });
    });

    // Quantity input with clamping
    quantidadeInput.addEventListener('input', e => {
      let valor = parseInt(e.target.value, 10);
      if (Number.isNaN(valor)) { resumoQtd.textContent = '-'; return; }
      valor = Math.max(1, Math.min(limiteQuestoes, valor));
      e.target.value = String(valor);
      atualizarResumo();
    });

    // Clear current tab selections
    document.getElementById('clearTabBtn').addEventListener('click', () => {
      selecionados[abaAtual] = [];
      salvarSelecoes();
      if (abaAtual === 'dominios') renderChecklist(meta.dominios);
      if (abaAtual === 'grupos') renderChecklist(meta.grupos);
      if (abaAtual === 'areas') renderChecklist(meta.areas);
      atualizarResumo();
    });

    // Start button: validate, persist, and redirect
    async function checkAvailability(count) {
      const base = (BACKEND_BASE || '').replace(/\/$/, '');
      const url = base + '/api/exams/select';
      const token = localStorage.getItem('sessionToken') || '';
      const payload = { count: Number(count) || 0, onlyCount: true };
      if (selecionados.areas.length) payload.areas = selecionados.areas;
      if (selecionados.grupos.length) payload.grupos = selecionados.grupos;
      if (selecionados.dominios.length) payload.dominios = selecionados.dominios;
      try {
        const resp = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Session-Token': token }, body: JSON.stringify(payload) });
        const txt = await resp.text();
        let data; try { data = txt ? JSON.parse(txt) : null; } catch { data = null; }
        if (resp.ok && data && typeof data.available === 'number') return { ok: true, available: data.available };
        if (!resp.ok && data && typeof data.available === 'number') return { ok: false, available: data.available };
        return { ok: resp.ok, available: null };
      } catch (e) { return { ok: false, available: null }; }
    }

    function showAvailabilityWarning(available) {
      const box = document.getElementById('availabilityWarning');
      box.style.display = '';
      const decId = 'decAvailBtn';
      const clrId = 'clrFiltersBtn';
      box.innerHTML = `Não há questões suficientes para sua seleção. Disponíveis: <strong>${available}</strong>.<br/>`+
        `<div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">`+
        `<button id="${decId}" type="button" style="background:#ffe3de;color:#a23a2a;border:1px solid #ffb5a7;border-radius:6px;padding:6px 10px;cursor:pointer">Diminuir para ${available}</button>`+
        `<button id="${clrId}" type="button" style="background:#f0f4ff;color:#2b6cb0;border:1px solid #c6d3ff;border-radius:6px;padding:6px 10px;cursor:pointer">Limpar filtros</button>`+
        `</div>`;
      document.getElementById(decId).onclick = () => {
        quantidadeInput.value = String(available);
        atualizarResumo();
        box.style.display = 'none';
      };
      document.getElementById(clrId).onclick = () => {
        selecionados.dominios = [];
        selecionados.grupos = [];
        selecionados.areas = [];
        salvarSelecoes();
        renderChecklist(meta[abaAtual]);
        updateBadges();
        atualizarResumo();
        box.style.display = 'none';
      };
    }

    function updateBadges() {
      const bDom = document.getElementById('badge-dominios');
      const bGrp = document.getElementById('badge-grupos');
      const bArs = document.getElementById('badge-areas');
      const setBadge = (el, n) => { if (!el) return; el.textContent = n ? `(${n})` : ''; };
      setBadge(bDom, selecionados.dominios.length);
      setBadge(bGrp, selecionados.grupos.length);
      setBadge(bArs, selecionados.areas.length);
    }

    startBtn.addEventListener('click', async () => {
      startError.style.display = 'none';
      const val = Number(quantidadeInput.value);
      if (!val || Number.isNaN(val) || val < 1) {
        startError.textContent = 'Informe a quantidade de questões.';
        startError.style.display = 'inline';
        return;
      }
      if (val > limiteQuestoes) {
        startError.textContent = `Quantidade acima do limite (${limiteQuestoes}).`;
        startError.style.display = 'inline';
        return;
      }
      // Preflight availability check
      const avail = await checkAvailability(val);
      if (avail && typeof avail.available === 'number' && avail.available < val) {
        showAvailabilityWarning(avail.available);
        return;
      }
      try { localStorage.setItem('examQuestionCount', String(val)); } catch(e) {}
      salvarSelecoes();
      try { sessionStorage.setItem('startExam', 'true'); } catch(e) {}
      // redirect to exam page (same folder)
      window.location.href = './exam.html';
    });

    async function fetchJson(url){
      const resp = await fetch(url, { headers: { 'X-Session-Token': (localStorage.getItem('sessionToken') || '') } });
      if (!resp.ok) throw new Error(`GET ${url} -> ${resp.status}`);
      return await resp.json();
    }

    async function loadMeta(){
      try {
        const base = (BACKEND_BASE || '').replace(/\/$/, '');
        const [doms, grps, ars] = await Promise.all([
          fetchJson(base + '/api/meta/dominios'),
          fetchJson(base + '/api/meta/grupos'),
          fetchJson(base + '/api/meta/areas')
        ]);
        meta.dominios = Array.isArray(doms) ? doms : [];
        meta.grupos = Array.isArray(grps) ? grps : [];
        meta.areas = Array.isArray(ars) ? ars : [];
      } catch (e) {
        console.warn('Falha ao carregar metadados, usando listas vazias.', e);
        meta.dominios = meta.dominios || [];
        meta.grupos = meta.grupos || [];
        meta.areas = meta.areas || [];
      }
      // set default quantity: use existing localStorage selection or default caps (25/180)
      try {
        const saved = localStorage.getItem('examQuestionCount');
        if (saved) quantidadeInput.value = String(Math.max(1, Math.min(limiteQuestoes, Number(saved))));
      } catch(e) {}
      // activate tab per saved state
      tabs.forEach(t => t.classList.remove('active'));
      const tabEl = document.querySelector(`.tab[data-aba="${abaAtual}"]`) || document.querySelector('.tab[data-aba="dominios"]');
      if (tabEl) tabEl.classList.add('active');
      // render current tab
      if (abaAtual === 'dominios') renderChecklist(meta.dominios);
      if (abaAtual === 'grupos') renderChecklist(meta.grupos);
      if (abaAtual === 'areas') renderChecklist(meta.areas);
      atualizarResumo();
    }

    // Kick off
    loadMeta();
  </script>
  </body>
  </html>
