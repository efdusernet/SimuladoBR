<%- include('../partials/head', { title }) %>
<%- include('../partials/admin_nav') %>

<div class="container py-4">
  <div class="d-flex flex-wrap align-items-end justify-content-between gap-2">
    <div>
      <h1 class="h3 fw-bold mb-1">Pedidos / Pagamentos</h1>
      <div class="text-secondary small">Filtros por created_at (padrão) ou paid_at.</div>
    </div>
    <a class="btn btn-sm btn-outline-secondary" href="?<%= new URLSearchParams({ ...query, format: 'csv' }).toString() %>">Exportar CSV</a>
  </div>

  <form class="row g-2 mt-2" method="get" action="/admin/finance/orders">
    <div class="col-12 col-md-2">
      <label class="form-label small mb-1">Date field</label>
      <select class="form-select form-select-sm" name="dateField">
        <option value="created_at" <%= (query.dateField !== 'paid_at') ? 'selected' : '' %>>created_at</option>
        <option value="paid_at" <%= (query.dateField === 'paid_at') ? 'selected' : '' %>>paid_at</option>
      </select>
    </div>
    <div class="col-12 col-md-3">
      <label class="form-label small mb-1">De</label>
      <input class="form-control form-control-sm" type="datetime-local" name="from" value="<%= query.from ? String(query.from).slice(0,16) : '' %>" />
    </div>
    <div class="col-12 col-md-3">
      <label class="form-label small mb-1">Até</label>
      <input class="form-control form-control-sm" type="datetime-local" name="to" value="<%= query.to ? String(query.to).slice(0,16) : '' %>" />
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label small mb-1">Status</label>
      <input class="form-control form-control-sm" name="status" value="<%= query.status ?? '' %>" placeholder="paid" />
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label small mb-1">Plano</label>
      <input class="form-control form-control-sm" name="planId" value="<%= query.planId ?? '' %>" placeholder="aprovacao_pmp" />
    </div>
    <div class="col-12 col-md-4">
      <label class="form-label small mb-1">Email (contains)</label>
      <input class="form-control form-control-sm" name="email" value="<%= query.email ?? '' %>" placeholder="cliente@..." />
    </div>
    <div class="col-12 col-md-4">
      <label class="form-label small mb-1">Busca (orderId/paymentRef)</label>
      <input class="form-control form-control-sm" name="q" value="<%= query.q ?? '' %>" placeholder="uuid ou payment_reference" />
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label small mb-1">Page</label>
      <input class="form-control form-control-sm" type="number" name="page" value="<%= query.page ?? result.page %>" min="1" />
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label small mb-1">Page size</label>
      <input class="form-control form-control-sm" type="number" name="pageSize" value="<%= query.pageSize ?? result.pageSize %>" min="1" max="200" />
    </div>
    <div class="col-12 col-md-2 d-flex align-items-end">
      <button class="btn btn-sm btn-primary w-100" type="submit">Filtrar</button>
    </div>
  </form>

  <div class="text-secondary small mt-2">Total: <%= result.total %></div>

  <div class="table-responsive mt-2">
    <table class="table table-sm align-middle">
      <thead>
        <tr>
          <th>Pedido</th>
          <th>Status</th>
          <th>Email</th>
          <th>Plano</th>
          <th>Valor</th>
          <th>Created</th>
          <th>Paid</th>
          <th>payment_reference</th>
          <th>asaasEvent</th>
        </tr>
      </thead>
      <tbody>
        <% for (const o of result.rows) { %>
          <tr>
            <td><a href="/admin/finance/orders/<%= o.id %>"><%= o.id.slice(0, 8) %>…</a></td>
            <td><span class="badge text-bg-light"><%= o.status %></span></td>
            <td><%= o.buyer_email %></td>
            <td><%= o.plan_name %></td>
            <td><%= fmt.moneyBRL(o.amount_cents) %></td>
            <td class="text-nowrap"><%= o.created_at ? new Date(o.created_at).toLocaleString('pt-BR') : '' %></td>
            <td class="text-nowrap"><%= o.paid_at ? new Date(o.paid_at).toLocaleString('pt-BR') : '' %></td>
            <td class="text-nowrap"><%= o.payment_reference ?? '' %></td>
            <td class="text-nowrap"><%= o.payment_metadata?.asaasEvent ?? '' %></td>
          </tr>
        <% } %>
      </tbody>
    </table>
  </div>
</div>

<%- include('../partials/footer') %>
