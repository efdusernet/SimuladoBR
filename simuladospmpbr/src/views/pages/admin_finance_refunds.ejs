<%- include('../partials/head', { title }) %>
<%- include('../partials/admin_nav') %>

<div class="container py-4">
  <div class="d-flex flex-wrap align-items-end justify-content-between gap-2">
    <div>
      <h1 class="h3 fw-bold mb-1">Reembolsos / Chargebacks</h1>
      <div class="text-secondary small">MVP: baseado no último evento salvo em orders.payment_metadata.</div>
    </div>
    <a class="btn btn-sm btn-outline-secondary" href="?<%= new URLSearchParams({ ...query, format: 'csv' }).toString() %>">Exportar CSV</a>
  </div>

  <form class="row g-2 mt-2" method="get" action="/admin/finance/refunds">
    <div class="col-12 col-md-3">
      <label class="form-label small mb-1">De (updated_at)</label>
      <input class="form-control form-control-sm" type="datetime-local" name="from" value="<%= query.from ? String(query.from).slice(0,16) : '' %>" />
    </div>
    <div class="col-12 col-md-3">
      <label class="form-label small mb-1">Até (updated_at)</label>
      <input class="form-control form-control-sm" type="datetime-local" name="to" value="<%= query.to ? String(query.to).slice(0,16) : '' %>" />
    </div>
    <div class="col-12 col-md-4">
      <label class="form-label small mb-1">Email (contains)</label>
      <input class="form-control form-control-sm" name="email" value="<%= query.email ?? '' %>" />
    </div>
    <div class="col-6 col-md-1">
      <label class="form-label small mb-1">Page</label>
      <input class="form-control form-control-sm" type="number" name="page" value="<%= query.page ?? result.page %>" min="1" />
    </div>
    <div class="col-6 col-md-1">
      <label class="form-label small mb-1">Size</label>
      <input class="form-control form-control-sm" type="number" name="pageSize" value="<%= query.pageSize ?? result.pageSize %>" min="1" max="200" />
    </div>
    <div class="col-12 col-md-2 d-flex align-items-end">
      <button class="btn btn-sm btn-primary w-100" type="submit">Filtrar</button>
    </div>
  </form>

  <div class="text-secondary small mt-2">Total: <%= result.total %></div>

  <div class="table-responsive mt-2">
    <table class="table table-sm align-middle">
      <thead>
        <tr>
          <th>Pedido</th>
          <th>Tipo</th>
          <th>Status</th>
          <th>Email</th>
          <th>Plano</th>
          <th>Valor</th>
          <th>Event at</th>
          <th>Asaas</th>
        </tr>
      </thead>
      <tbody>
        <% for (const r of result.rows) { %>
          <tr>
            <td><a href="/admin/finance/orders/<%= r.order_id %>"><%= r.order_id.slice(0, 8) %>…</a></td>
            <td><span class="badge text-bg-light"><%= r.asaas_event === 'PAYMENT_CHARGEBACK' ? 'chargeback' : 'refund' %></span></td>
            <td><%= r.order_status %></td>
            <td><%= r.buyer_email %></td>
            <td><%= r.plan_name %></td>
            <td><%= fmt.moneyBRL(r.amount_cents) %></td>
            <td class="text-nowrap"><%= r.event_at ? new Date(r.event_at).toLocaleString('pt-BR') : '' %></td>
            <td class="text-nowrap"><%= r.asaas_event %></td>
          </tr>
        <% } %>
      </tbody>
    </table>
  </div>
</div>

<%- include('../partials/footer') %>
